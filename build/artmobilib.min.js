var compatibility=function(){var e=0,t=!0,n=window.URL||window.webkitURL||window.mozURL||window.msURL,i=function(t,n){var i=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,n){var i=(new Date).getTime(),o=Math.max(0,16-(i-e)),r=window.setTimeout(function(){t(i+o)},o);return e=i+o,r};return i.call(window,t,n)},o=function(e){var t=window.cancelAnimationFrame||function(e){clearTimeout(e)};return t.call(window,e)},r=function(e,t,n){var i=window.navigator.getUserMedia||window.navigator.mozGetUserMedia||window.navigator.webkitGetUserMedia||window.navigator.msGetUserMedia||function(e,t,n){n()};return i.call(window.navigator,e,t,n)},a=function(){var e=new ArrayBuffer(8),n=new Uint32Array(e);return n[0]=4278190080,t=!0,255===e[0]&&(t=!1),t};return{URL:n,requestAnimationFrame:i,cancelAnimationFrame:o,getUserMedia:r,detectEndian:a,isLittleEndian:t}}();navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL;var AM=AM||{};AM.FrontCamGrabbing=function(){function e(){d.readyState===d.HAVE_ENOUGH_DATA?(c=!1,r&&r()):window.requestAnimationFrame(e)}function t(t){return function(n){for(var i={video:!0,audio:!1},r=0;r!=n.length;++r){var a=n[r];"video"==a.kind&&"environment"==a.facing&&(i.video={optional:[{sourceId:a.id}]})}navigator.getUserMedia(i,function(t){o=t,d.src=window.URL.createObjectURL(t),e()},function(e){console.error("Cant getUserMedia()! due to ",e),t&&t()})}}function n(e){"undefined"!=typeof MediaStreamTrack&&"undefined"!=typeof MediaStreamTrack.getSources?MediaStreamTrack.getSources(t(e)):e&&e()}function i(e){"undefined"!=typeof navigator.mediaDevices&&"undefined"!=typeof navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(t(e)):e&&e()}var o,r,a,s=this,d=document.createElement("video"),c=!1;d.setAttribute("autoplay",!0),d.style.zIndex=-1,d.style.position="absolute",d.style.top="0px",d.style.left="0px",d.style.width="100%",d.style.height="100%",this.domElement=d,this.Start=function(e,t){s.IsActive()||c?e():(c=!0,r=e,a=t,n(function(){i(function(){a&&a(),r&&r()})}))},this.Stop=function(){o&&(o.getTracks()[0].stop(),o=void 0)},this.IsActive=function(){return void 0!==o}};var AM=AM||{};AM.ImageDebugger=function(){var e,t,n,i,o,r,a;this.DrawCorners=function(t,n){if(a&&t&&(i=t.screen_corners,r=t.profiler,i.length)){e.fillStyle="red";for(var o=0;o<i.length;++o){var s=i[o];e.beginPath(),e.arc(s.x*n,s.y*n,5,0,2*Math.PI),e.fill()}}},this.DrawMatches=function(e,i){a&&e&&i&&(n=e.corners,o=e.matches,t=i)},this.SetData=function(t,n){e=t,a=n||!1}};var AM=AM||{};AM.ImageLoader=function(){var e=document.createElement("canvas"),t=e.getContext("2d");this.GetImageData=function(n,i,o){var r=new Image;r.onload=function(n,i,o){return function(){if(o){var r=Math.max(n.width,n.height),a=(r-n.width)/2,s=(r-n.height)/2;e.width=r,e.height=r,t.drawImage(n,a,s)}else e.width=n.width,e.height=n.height,t.drawImage(n,0,0,e.width,e.height);var d=t.getImageData(0,0,e.width,e.height);i(d)}}(r,i,o),r.src=n}};var AM=AM||{};AM.JsonLoader=function(){function e(e,t){u=!1,a=void 0,r=void 0,o=void 0,d=void 0,s=void 0,c.progress=0,e&&e(t)}function t(){try{c.json=JSON.parse(d.responseText),e(o)}catch(t){c.json={},e(r,"failed to parse file: "+s)}}function n(t){var n="JsonLoader failed to open file: "+s;console.log(n),e(r,n)}function i(e){c.progress=e.loaded/e.total*100,a&&a()}var o,r,a,s,d,c=this,u=!1;this.json={},this.progress=0,this.IsLoading=function(){return u},this.Load=function(e,c,h,l){u||(u=!0,o=c,r=h,a=l,s=e,d=new XMLHttpRequest,d.onprogress=i,d.open("GET",e,!0),d.onload=t,d.onerror=n,d.send(null))}},AM.LoadJson=function(e){return new Promise(function(t,n){var i=new AM.JsonLoader;i.Load(e,function(){t(i.json)},n)})};var AM=AM||{};AM.LoadingManager=function(){function e(e){for(var t=0,n=e.length;n>t;++t)e[t]()}var t=[],n=[],i=0;this.Start=function(t){t=t||1,i+=t,e(n)},this.End=function(o){o=o||1,i>0&&(i-=o,e(n)),0>=i&&(i=0,e(t),t.length=0,n.length=0)},this.OnEnd=function(e){i>0?t.push(e):e()},this.OnProgress=function(e){i>0?n.push(e):e()},this.IsLoading=function(){return i>0},this.GetRemaining=function(){return i}};var AM=AM||{};!function(){var e=function(){"use strict";function e(){this.start_time=0,this.stop_time=0,this.run_time=0,this.running=!1}return e.prototype.start=function(){this.start_time=(new Date).getTime(),this.running=!0},e.prototype.stop=function(){this.stop_time=(new Date).getTime(),this.run_time=this.stop_time-this.start_time,this.running=!1},e.prototype.get_runtime=function(){return this.run_time},e.prototype.reset=function(){this.run_time=0},e}(),t=function(){"use strict";function e(e){this.arr=new Int32Array(e),this.begin=0,this.end=-1,this.num_el=0,this.arr_size=e}return e.prototype.push_back=function(e){this.num_el<this.arr_size?(this.end++,this.arr[this.end]=e,this.num_el++):(this.end=(this.end+1)%this.arr_size,this.begin=(this.begin+1)%this.arr_size,this.arr[this.end]=e)},e.prototype.get=function(e){return this.arr[(this.begin+e)%this.arr_size]},e.prototype.size=function(){return this.num_el},e}(),n=function(){"use strict";function n(){this.fps=0,this.timers=[],this.frame_timer=new e}var i=0,o=new t(20);return n.prototype.add=function(t){this.timers.push([t,new e])},n.prototype.new_frame=function(){++i;var e=0,t=0|this.timers.length;for(e=0;t>e;++e){var n=this.timers[e][1];n.reset()}if(i>=1){this.frame_timer.stop(),o.push_back(this.frame_timer.get_runtime());var r=o.size(),a=0;for(e=0;r>e;++e)a+=o.get(e);this.fps=r/a*1e3,this.frame_timer.start()}},n.prototype.find_task=function(e){var t=0|this.timers.length,n=0;for(n=0;t>n;++n){var i=this.timers[n];if(i[0]===e)return i}return null},n.prototype.start=function(e){var t=this.find_task(e);t[1].start()},n.prototype.stop=function(e){var t=this.find_task(e);t[1].stop()},n.prototype.log=function(){var e=0|this.timers.length,t=0,n="<strong>FPS: "+this.fps.toFixed(2)+"</strong>";for(t=0;e>t;++t){var i=this.timers[t];n+="<br/>"+i[0]+": "+i[1].get_runtime()+"ms"}return n},n.prototype.log2=function(){var e=0|this.timers.length,t=0,n="FPS: "+this.fps.toFixed(2)+"  ";for(t=0;e>t;++t){var i=this.timers[t];n+=i[0]+": "+i[1].get_runtime()+"ms  "}return n},n.prototype.GetProfiler=function(){return{fps:this.fps,timers:this.timers}},n}();AM.Profiler=n}();var AM=AM||{};AM.DeviceLockScreenOrientation=function(){function e(){window.cordova?(t(),a=!0):s=!1}function t(){for(var e=0,t=d.length;t>e;++e)d[e]();d.length=0}function n(e){s&&(a?e():d.push(e))}function i(){screen.lockOrientation("landscape-primary")}function o(){screen.lockOrientation("portrait-primary")}function r(){screen.unlockOrientation()}var a=!1,s=!0,d=[];document.addEventListener("deviceready",e,!1),this.LockLandscape=function(){n(i)},this.LockPortrait=function(){n(o)},this.Unlock=function(){n(r)}};var AM=AM||{};AM.DeviceOrientationControl=function(e){var t=this;this.object=e,this.object.rotation.reorder("YXZ");var n=!1,i=!1,o=0,r=new this.CoefMethod,a=function(e){n?(r.OnOrientationChange(e),i=!0):n=!0},s=function(){o=window.orientation||0};this.Connect=function(){s(),window.addEventListener("orientationchange",s,!1),window.addEventListener("deviceorientation",a,!1)},this.Disconnect=function(){window.removeEventListener("orientationchange",s,!1),window.removeEventListener("deviceorientation",a,!1),i=!1},this.Update=function(){var e=function(){var e=new THREE.Vector3(0,0,1),t=new THREE.Euler,n=new THREE.Quaternion,i=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));return function(o,r,a,s,d){t.set(a,r,-s,"YXZ"),o.setFromEuler(t),o.multiply(i),o.multiply(n.setFromAxisAngle(e,-d))}}();if(i){var n=o?THREE.Math.degToRad(o):0;r.Update(),e(t.object.quaternion,r.alpha,r.beta,r.gamma,n)}}},AM.DeviceOrientationControl.prototype.PowerMethod=function(){function e(e,t,n){var i=AM.DeviceOrientationControl.prototype.Mod2Pi(t-e),o=Math.sign(i),r=Math.abs(i/Math.PI);return r=Math.pow(r,n),AM.DeviceOrientationControl.prototype.Mod2Pi(e+r*Math.PI*o)}var t,n=this,i=2;this.alpha=0,this.beta=0,this.gamma=0,this.OnOrientationChange=function(e){t=e},this.Update=function(){n.alpha=e(n.alpha,THREE.Math.degToRad(t.alpha),i),n.beta=e(n.beta,THREE.Math.degToRad(t.beta),i),n.gamma=e(n.gamma,THREE.Math.degToRad(t.gamma),i)}},AM.DeviceOrientationControl.prototype.CoefMethod=function(){function e(e,t,n){return e+AM.DeviceOrientationControl.prototype.Mod2Pi(t-e)*n}var t=this;this.coef=.2,this.alpha=0,this.beta=0,this.gamma=0;var n=!1;this.OnOrientationChange=function(e){n=e},this.Update=function(){if(n){var i=e(t.alpha,THREE.Math.degToRad(n.alpha),t.coef),o=e(t.beta,THREE.Math.degToRad(n.beta),t.coef),r=e(t.gamma,THREE.Math.degToRad(n.gamma),t.coef);t.alpha=i,t.beta=o,t.gamma=r}}},AM.DeviceOrientationControl.prototype.AverageMethod=function(){var e=this;this.history=[],this.history_max=10,this.alpha=0,this.beta=0,this.gamma=0,this.OnOrientationChange=function(t){e.history.length>e.history_max&&e.history.shift(),e.history.push(t)},this.Update=function(t,n,i){var t=0,n=0,i=0;if(0!=e.history.length){for(var o=0,r=e.history.length;r>o;o++)t+=AM.DeviceOrientationControl.prototype.Mod360(e.history[o].alpha),n+=AM.DeviceOrientationControl.prototype.Mod360(e.history[o].beta),i+=AM.DeviceOrientationControl.prototype.Mod360(e.history[o].gamma);t/=e.history.length,n/=e.history.length,i/=e.history.length,e.alpha=THREE.Math.degToRad(t),e.beta=THREE.Math.degToRad(n),e.gamma=THREE.Math.degToRad(i)}}},AM.DeviceOrientationControl.prototype.Mod2Pi=function(){var e=Math.PI,t=2*Math.PI;return function(n){if(n>e){do n-=t;while(n>e)}else if(-e>n)do n+=t;while(-e>n);return n}}(),AM.DeviceOrientationControl.prototype.Mod360=function(e){return e%=360,180>e?e:e-360};var AM=AM||{};AM.GeographicCoordinatesConverter=function(e,t){var n=this,i={latitude:0,longitude:0};this.GetLocalCoordinates=function(e,t){var o=(i.latitude+e)/2,r={x:0,y:0};return r.x=(t-i.longitude)*n.EARTH_RADIUS*Math.cos(o),r.y=(e-i.latitude)*-n.EARTH_RADIUS,r},this.GetLocalCoordinatesFromDegres=function(e,t){return n.GetLocalCoordinates(THREE.Math.degToRad(e),THREE.Math.degToRad(t))},this.SetOrigin=function(e,t){i.latitude=e,i.longitude=t},this.SetOriginFromDegres=function(e,t){i.latitude=THREE.Math.degToRad(e),i.longitude=THREE.Math.degToRad(t)},this.GetOrigin=function(){return i},this.SetOrigin(e||0,t||0)},AM.GeographicCoordinatesConverter.prototype.EARTH_RADIUS=6371e3;var AM=AM||{};AM.GeolocationControl=function(e,t){function n(e){a.copy(d.GetLocalCoordinatesFromDegres(e.coords.latitude,e.coords.longitude)),r=!0}function i(e){console.warn("geolocation failed: "+e.message),window.setTimeout(o.Connect,o.retry_connection_ms)}var o=this,r=!1,a=new THREE.Vector3,s=0,d=t,c=.1;this.object=e,this.interpolation_coefficient=.02,this.retry_connection_ms=1e3,this.Connect=function(){s=navigator.geolocation.watchPosition(n,i)},this.Disconnect=function(){navigator.geolocation.clearWatch(s),r=!1},this.Update=function(){if(r){var e=a.x-o.object.position.x,t=a.z-o.object.position.z,n=e*e+t*t;c*c>n?r=!1:(e*=o.interpolation_coefficient,t*=o.interpolation_coefficient,o.object.position.x+=e,o.object.position.z+=t)}}};var AM=AM||{};AM.Detection=function(){function e(e,t){var n=e*t;if(n>i.length)for(;--n>=0;)i[n]=new jsfeat.keypoint_t}var t={laplacian_threshold:30,eigen_threshold:25,detection_corners_max:500,border_size:15,fast_threshold:20},n=!1,i=[],o=0,r=new jsfeat.matrix_t(32,t.detection_corners_max,jsfeat.U8_t|jsfeat.C1_t);this.Detect=function(a){e(a.cols,a.rows),o=AM.DetectKeypointsYape06(a,i,t.detection_corners_max,t.laplacian_threshold,t.eigen_threshold,t.border_size),jsfeat.orb.describe(a,i,o,r),n&&console.log("Learn : "+o+" corners")},this.SetParameters=function(e){for(name in e)"undefined"!=typeof t[name]&&(t[name]=e[name])},this.GetDescriptors=function(){return r},this.GetNumCorners=function(){return o},this.GetCorners=function(){return i}},AM.IcAngle=function(){var e=new Int32Array([15,15,15,15,14,14,14,13,13,12,11,10,9,8,6,3,0]),t=Math.PI/2;return function(n,i,o){var r=15,a=0,s=0,d=n.data,c=n.cols,u=0,h=0,l=o*c+i|0,f=0,m=0,E=0,p=0;for(u=-r;r>=u;++u)s+=u*d[l+u];for(h=1;r>=h;++h){for(f=0,m=e[h],u=-m;m>=u;++u)E=d[l+u+h*c],p=d[l+u-h*c],f+=E-p,s+=u*(E+p);a+=h*f}return AM.DiamondAngle(a,s)*t}}(),AM.DiamondAngle=function(e,t){return e>=0?t>=0?e/(t+e):1-t/(-t+e):0>t?2-e/(-t-e):3+t/(t-e)},AM.DetectKeypointsPostProc=function(e,t,n,i){n>i&&(jsfeat.math.qsort(t,0,n-1,function(e,t){return t.score<e.score}),n=i);for(var o=0;n>o;++o)t[o].angle=AM.IcAngle(e,t[o].x,t[o].y);return n},AM.DetectKeypointsYape06=function(e,t,n,i,o,r){jsfeat.yape06.laplacian_threshold=i,jsfeat.yape06.min_eigen_value_threshold=o;var a=jsfeat.yape06.detect(e,t,r);return a=AM.DetectKeypointsPostProc(e,t,a,n)},AM.DetectKeypointsFast=function(e,t,n,i,o){jsfeat.fast_corners.set_threshold(i);var r=jsfeat.fast_corners.detect(e,t,o||3);return r=AM.DetectKeypointsPostProc(e,t,r,n)};var AM=AM||{};AM.ImageFilter=function(){var e,t={blur_size:3,blur:!0};this.Filter=function(n){var i=n.width,o=n.height;e?e.resize(i,o,jsfeat.U8_t|jsfeat.C1_t):e=new jsfeat.matrix_t(i,o,jsfeat.U8_t|jsfeat.C1_t),jsfeat.imgproc.grayscale(n.data,i,o,e),t.blur&&jsfeat.imgproc.gaussian_blur(e,e,t.blur_size)},this.GetFilteredImage=function(){return e},this.SetParameters=function(e){for(name in e)"undefined"!=typeof t[name]&&(t[name]=e[name])}};var AM=AM||{};AM.MarkerTracker=function(){var e,t=new AM.Training,n={},i=new AM.ImageFilter,o=new AM.Detection,r=new AM.Matching,a=new AM.Pose,s=!1,d={match_min:8},c=!1,u=new AM.Profiler;u.add("filter"),u.add("detection"),u.add("matching"),u.add("pose"),this.ComputeImage=function(e){u.new_frame(),u.start("filter"),i.Filter(e),u.stop("filter"),u.start("detection"),o.Detect(i.GetFilteredImage()),u.stop("detection")},this.Match=function(){u.start("matching"),s=!1,e=void 0,r.SetScreenDescriptors(o.GetDescriptors());for(uuid in n){var t=n[uuid];if(t.IsActive()){r.Match(t.GetDescriptorsLevels());var i=r.GetNumMatches();if(s=i>=d.match_min,c&&console.log("nbMatches : "+i),s){var h=a.Pose(r.GetMatches(),i,o.GetCorners(),t.GetCornersLevels());if(s=h>=d.match_min,c&&console.log(" goodMatches : "+h),s){e=t;break}}}}return u.stop("matching"),s},this.GetMatchUuid=function(){return e.GetUuid()},this.GetPose=function(){if(s){u.start("pose");var t=a.GetPoseCorners(e.GetWidth(),e.GetHeight());return u.stop("pose"),t}},this.AddMarker=function(e,i){t.Train(e);var o=new AM.TrainedImage(i);t.SetResultToTrainedImage(o),t.Empty(),n[i]=o},this.RemoveMarker=function(e){n[e]&&delete n[e]},this.ActiveMarker=function(e,t){n[e]&&n[e].Active(t)},this.ActiveAllMarkers=function(e){for(uuid in n)n[uuid].Active(e)},this.ClearMarkers=function(){n={}},this.GetScreenCorners=function(){return o.GetCorners()},this.GetNumScreenCorners=function(){return o.GetNumCorners()},this.Getmatches=function(){return r.GetMatches()},this.GetProfiler=function(){return u.GetProfiler()},this.GetTrainedCorners=function(){var e=n[uuid];return e.GetCornersLevels()},this.Log=function(){console.log(u.log()+(s?"<br/>match found":""))},this.SetParameters=function(e){for(name in e)"undefined"!=typeof d[name]&&(d[name]=e[name]);t.SetParameters(e),i.SetParameters(e),o.SetParameters(e),r.SetParameters(e)}};var AM=AM||{};AM.Matching=function(){function e(e){return e-=e>>1&1431655765,e=(858993459&e)+(e>>2&858993459),16843009*(e+(e>>4)&252645135)>>24}function t(e,t){var n=e.rows,i=e.buffer.i32,o=0,d=0;r=[];for(var c=0;n>c;++c){for(var u=256,h=256,l=-1,f=-1,m=0,E=t.length;E>m;++m)for(var p=t[m],g=p.rows,v=p.buffer.i32,T=0,y=0;g>y;++y){for(var w=0,R=0;8>R;++R)w+=s(i[o+R]^v[T+R]);u>w?(h=u,u=w,f=m,l=y):h>w&&(h=w),T+=8}if(u<a.match_threshold){for(;r.length<=d;)r.push(new AM.match_t);r[d].screen_idx=c,r[d].pattern_lev=f,r[d].pattern_idx=l,d++}o+=8}return r.length=d,d}var n,o,r=[],a={match_threshold:48};this.SetScreenDescriptors=function(e){n=e},this.Match=function(e){return o=t(n,e)};var s=(function(){var e=[0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8],t=255;return function(n){var i=e[n&t];return n>>=8,i+=e[n&t],n>>=8,i+=e[n&t],n>>=8,i+=e[n&t]}}(),function(){var t=[];for(i=0;i<65536;++i)t.push(e(i));var n=65535;return function(e){var i=t[e&n];return e>>=16,i+=t[e&n]}}());this.GetMatches=function(){return r},this.GetNumMatches=function(){return o},this.SetParameters=function(e){for(name in e)"undefined"!=typeof a[name]&&(a[name]=e[name])}},AM.match_t=function(e,t,n,i){this.screen_idx=e||0,this.pattern_lev=t||0,this.pattern_idx=n||0,this.distance=i||0};var AM=AM||{};AM.Pose=function(){function e(e,t,n,i,o,r){for(var a=new jsfeat.motion_model.homography2d,s=4,d=3,c=new jsfeat.ransac_params_t(s,d,.5,.99),u=[],h=[],l=0;t>l;++l){var f=e[l],m=o[f.screen_idx],E=r[f.pattern_lev][f.pattern_idx];u[l]={x:E.x,y:E.y},h[l]={x:m.x,y:m.y}}var p=!1;p=jsfeat.motion_estimator.ransac(c,a,u,h,t,n,i,1e3);var g=0;if(p){for(var l=0;t>l;++l)i.data[l]&&(u[g].x=u[l].x,u[g].y=u[l].y,h[g].x=h[l].x,h[g].y=h[l].y,g++);a.run(u,h,n,g)}else jsfeat.matmath.identity_3x3(n,1);return g}function t(e,t,n){for(var i=[{x:0,y:0},{x:t,y:0},{x:t,y:n},{x:0,y:n}],o=0,r=0,a=0,s=0;4>s;++s)r=e[0]*i[s].x+e[1]*i[s].y+e[2],a=e[3]*i[s].x+e[4]*i[s].y+e[5],o=e[6]*i[s].x+e[7]*i[s].y+e[8],i[s].x=r/o,i[s].y=a/o;return i}var n=0,i=new jsfeat.matrix_t(3,3,jsfeat.F32C1_t),o=new jsfeat.matrix_t(500,1,jsfeat.U8C1_t);this.Pose=function(t,r,a,s){return n=e(t,r,i,o,a,s)},this.GetGoodCount=function(){return n},this.GetPoseCorners=function(e,n){return t(i.data,e,n)}},AM.PosePosit=function(){this.posit=new POS.Posit(10,1),this.pose},AM.PosePosit.prototype.Set=function(e,t,n,i){t=t||35;for(var o=[],r=0;r<e.length;++r){var a=e[r].x-n/2,s=i/2-e[r].y;o.push({x:a,y:s})}this.pose=this.posit.pose(o)},AM.PosePosit.prototype.SetFocalLength=function(e){this.posit.focalLength=e},AM.PoseThree=function(){this.position=new THREE.Vector3,this.rotation=new THREE.Euler,this.quaternion=new THREE.Quaternion,this.scale=new THREE.Vector3},AM.PoseThree.prototype.Set=function(e,t){t=t||35;var n=e.bestRotation,i=e.bestTranslation;this.scale.x=t,this.scale.y=t,this.scale.z=t,this.rotation.x=-Math.asin(-n[1][2]),this.rotation.y=-Math.atan2(n[0][2],n[2][2]),this.rotation.z=Math.atan2(n[1][0],n[1][1]),this.position.x=i[0],this.position.y=i[1],this.position.z=-i[2],this.quaternion.setFromEuler(this.rotation)};var AM=AM||{};AM.TrainedImage=function(e){var t=!0,n=[],i=[],o=0,r=0,a=e,s=!0;this.GetCorners=function(e){return n[e]},this.GetDescriptors=function(e){return i[e]},this.GetLevelNbr=function(){return Math.min(i.length,n.length)},this.GetCornersLevels=function(){return n},this.GetDescriptorsLevels=function(){return i},this.GetWidth=function(){return o},this.GetHeight=function(){return r},this.Set=function(e,a,s,d){t=!1,n=e,i=a,o=s,r=d},this.IsEmpty=function(){return t},this.Empty=function(){t=!0,n=[],i=[]},this.SetUuid=function(e){a=e},this.GetUuid=function(){return a},this.Active=function(e){s=e===!0},this.IsActive=function(){return s}};var AM=AM||{};AM.Training=function(){function e(e,n,a,s){var c=r[a],u=o[a];0!==a?(t(e,n,s),jsfeat.imgproc.gaussian_blur(n,n,d.blur_size)):jsfeat.imgproc.gaussian_blur(e,n,d.blur_size);var h=AM.DetectKeypointsYape06(n,c,d.training_corners_max,d.laplacian_threshold,d.eigen_threshold);if(c.length=h,jsfeat.orb.describe(n,c,h,u),0!==a)for(i=0;i<h;++i)c[i].x*=1/s,c[i].y*=1/s;console.log("train "+n.cols+"x"+n.rows+" points: "+h)}function t(e,t,n){if(1>n){var i=Math.round(e.cols*n),o=Math.round(e.rows*n);jsfeat.imgproc.resample(e,t,i,o)}else t.resize(e.cols,e.rows),e.copy_to(t)}function n(e,t){for(var n=0;n<d.num_train_levels;++n){r[n]=[];for(var i=r[n],a=e*t>>n;--a>=0;)i[a]=new jsfeat.keypoint_t(0,0,0,0,-1);o[n]=new jsfeat.matrix_t(32,d.training_corners_max,jsfeat.U8_t|jsfeat.C1_t)}}var o,r,a=0,s=0,d={num_train_levels:3,blur_size:3,image_size_max:512,training_corners_max:200,laplacian_threshold:30,eigen_threshold:25},c=Math.sqrt(2);this.Train=function(i){var u=0,h=1;o=[],r=[];var l=new jsfeat.matrix_t(i.width,i.height,jsfeat.U8_t|jsfeat.C1_t);jsfeat.imgproc.grayscale(i.data,i.width,i.height,l,jsfeat.COLOR_RGBA2GRAY);var f=Math.min(d.image_size_max/i.width,d.image_size_max/i.height),m=new jsfeat.matrix_t(i.width*f,i.height*f,jsfeat.U8_t|jsfeat.C1_t);a=m.cols,s=m.rows,t(l,m,f),n(m.cols,m.rows);var E=new jsfeat.matrix_t(m.cols,m.rows,jsfeat.U8_t|jsfeat.C1_t);for(e(m,E,0,h),u=1;u<d.num_train_levels;++u)h/=c,e(m,E,u,h)},this.SetResultToTrainedImage=function(e){e.Set(r,o,a,s)},this.IsEmpty=function(){return!o||!r},this.Empty=function(){o=void 0,r=void 0},this.SetParameters=function(e){for(name in e)"undefined"!=typeof d[name]&&(d[name]=e[name])}};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.GifTexture=function(e){THREE.Texture.call(this),this.minFilter=THREE.NearestMipMapNearestFilter,this.imageElement=document.createElement("img");var t=document.getElementsByTagName("script");t=t[t.length-1],t.parentNode.appendChild(this.imageElement),this.imageElement.width=this.imageElement.naturalWidth,this.imageElement.height=this.imageElement.naturalHeight,e&&this.setGif(e)},AMTHREE.GifTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.GifTexture.prototype.constructor=AMTHREE.GifTexture,AMTHREE.GifTexture.prototype.play=function(){this.anim.play(),this.image=this.gifCanvas},AMTHREE.GifTexture.prototype.update=function(){this.needsUpdate=!0},AMTHREE.GifTexture.prototype.stop=function(){this.anim.move_to(0),this.image=void 0},AMTHREE.GifTexture.prototype.pause=function(){this.anim.pause()},AMTHREE.GifTexture.prototype.setGif=function(e){this.imageElement.src=e,this.anim=new SuperGif({gif:this.imageElement,auto_play:!1}),this.anim.load(),this.gifCanvas=this.anim.get_canvas(),this.gifCanvas.style.display="none"}):AMTHREE.GifTexture=function(){console.warn("GifTexture.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.ImagePlane=function(e){THREE.Mesh.call(this),this.geometry=new THREE.PlaneGeometry(1,1),this.material=new THREE.MeshBasicMaterial({side:2}),e&&this.setUrl(e)},AMTHREE.ImagePlane.prototype=Object.create(THREE.Mesh.prototype),AMTHREE.ImagePlane.prototype.constructor=AMTHREE.ImagePlane,AMTHREE.ImagePlane.prototype.clone=function(){var e=new this.constructor(this.src).copy(this);return e.material.map=this.material.map.clone(),e},AMTHREE.ImagePlane.prototype.setUrl=function(e){this.url=e,this.material.map=(new THREE.TextureLoader).load(e,function(e){e.minFilter=THREE.NearestMipMapLinearFilter,e.needsUpdate=!0})}):AMTHREE.ImagePlane=function(){console.warn("ImagePlane.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?AMTHREE.ObjectLoader=function(e){var t=this;this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.constants={},this.geometries={},this.materials={},this.animations=[],this.images={},this.videos={},this.textures={},this.json={},this.root,this.Load=function(e,n){var i=new THREE.XHRLoader(t.manager);i.load(e,function(e){return function(n){t.json=JSON.parse(n),e(t.Parse(t.json))}}(n))},this.Parse=function(e){t.json=e,t.ParseConstants(e.constants),t.ParseGeometries(e.geometries),t.ParseImages(e.images),t.ParseVideos(e.videos),t.ParseTextures(e.textures),t.ParseMaterials(e.materials),t.ParseAnimations(e.animations);var n=t.ParseObject(e.object);return n.animations=t.animations,n},this.ParseConstants=function(e){data=void 0!==e?e:{},t.constants.asset_path=t.root?t.root+"/":"",data.asset_path&&(t.constants.asset_path=t.constants.asset_path+data.asset_path+"/"),t.constants.image_path=t.constants.asset_path+(void 0!==data.image_path?data.image_path:""),t.constants.video_path=t.constants.asset_path+(void 0!==data.video_path?data.video_path:""),t.constants.model_path=t.constants.asset_path+(void 0!==data.model_path?data.model_path:"")},this.ParseMaterials=function(e){if(void 0!==e){var n=new THREE.MaterialLoader;n.setTextures(t.textures);for(var i=0,o=e.length;o>i;i++){var r=n.parse(e[i]);t.materials[r.uuid]=r}}},this.ParseAnimations=function(e){if(void 0!==e){t.animations=[];for(var n=0;n<e.length;n++){var i=THREE.AnimationClip.parse(e[n]);t.animations.push(i)}}},this.ParseImages=function(e){function n(e){return t.manager.itemStart(e),o.load(e,function(){t.manager.itemEnd(e)})}if(void 0!==e&&e.length>0)for(var i=new THREE.LoadingManager,o=new THREE.ImageLoader(i),r=0,a=e.length;a>r;r++){var s=e[r];if(void 0===s.url)console.warn('AMTHREE.ObjectLoader: no "url" specified for image '+r);else if(void 0===s.uuid)console.warn('AMTHREE.ObjectLoader: no "uuid" specified for image '+r);else{var d=t.constants.image_path+"/"+s.url;t.images[s.uuid]=n(d)}}},this.ParseVideos=function(e){if(void 0!==e)for(var n=0,i=e.length;i>n;n++){var o=e[n];if(void 0===o.url)console.warn('AMTHREE.ObjectLoader: no "url" specified for video '+n);else if(void 0===o.uuid)console.warn('AMTHREE.ObjectLoader: no "uuid" specified for video '+n);else{var r={url:t.constants.video_path+"/"+o.url,uuid:o.uuid,width:o.width||640,height:o.height||480};t.videos[o.uuid]=r}}},this.ParseTextures=function(e){function n(e){return"number"==typeof e?e:(console.warn("AMTHREE.ObjectLoader.parseTexture: Constant should be in numeric form.",e),THREE[e])}if("undefined"==typeof SuperGif&&console.warn("AMTHREE.ObjectLoader: SuperGif is undefined"),void 0!==e)for(var i=0,o=e.length;o>i;i++){var r=e[i];if(void 0!==r.image||void 0!==r.video){if(void 0!==r.image){if(void 0===t.images[r.image]){console.warn("AMTHREE.ObjectLoader: Undefined image",r.image);continue}var a=t.images[r.image];if(void 0!==r.animated&&r.animated){if("undefined"==typeof SuperGif)continue;var s=new AMTHREE.GifTexture(a.src)}else{var s=new THREE.Texture(a);s.needsUpdate=!0}}else{if(void 0===t.videos[r.video]){console.warn("AMTHREE.ObjectLoader: Undefined video",r.video);continue}var d=t.videos[r.video],s=new AMTHREE.VideoTexture({src:d.url,width:d.width,height:d.height,loop:r.loop,autoplay:r.autoplay})}s.uuid=r.uuid,void 0!==r.name&&(s.name=r.name),void 0!==r.mapping&&(s.mapping=n(r.mapping)),void 0!==r.offset&&(s.offset=new THREE.Vector2(r.offset[0],r.offset[1])),void 0!==r.repeat&&(s.repeat=new THREE.Vector2(r.repeat[0],r.repeat[1])),void 0!==r.minFilter?s.minFilter=n(r.minFilter):s.minFilter=THREE.LinearFilter,void 0!==r.magFilter&&(s.magFilter=n(r.magFilter)),void 0!==r.anisotropy&&(s.anisotropy=r.anisotropy),Array.isArray(r.wrap)&&(s.wrapS=n(r.wrap[0]),s.wrapT=n(r.wrap[1])),t.textures[r.uuid]=s}else console.warn('AMTHREE.ObjectLoader: No "image" nor "video" specified for',r.uuid)}},this.ParseGeometries=function(e){if(void 0!==e)for(var n=new THREE.JSONLoader,i=new THREE.BufferGeometryLoader,o=0,r=e.length;r>o;o++){var a,s=e[o];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":a=new THREE[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"CubeGeometry":a=new THREE.BoxGeometry(s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleBufferGeometry":a=new THREE.CircleBufferGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CircleGeometry":a=new THREE.CircleGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":a=new THREE.CylinderGeometry(s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"SphereGeometry":a=new THREE.SphereGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"SphereBufferGeometry":a=new THREE.SphereBufferGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":a=new THREE.DodecahedronGeometry(s.radius,s.detail);break;case"IcosahedronGeometry":a=new THREE.IcosahedronGeometry(s.radius,s.detail);break;case"OctahedronGeometry":a=new THREE.OctahedronGeometry(s.radius,s.detail);break;case"TetrahedronGeometry":a=new THREE.TetrahedronGeometry(s.radius,s.detail);break;case"RingGeometry":a=new THREE.RingGeometry(s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":a=new THREE.TorusGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":a=new THREE.TorusKnotGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.p,s.q,s.heightScale);break;case"BufferGeometry":a=i.parse(s);break;case"Geometry":a=n.parse(s.data,this.texturePath).geometry;break;default:console.warn('AMTHREE.ObjectLoader: Unsupported geometry type "'+s.type+'"');continue}a.uuid=s.uuid,void 0!==s.name&&(a.name=s.name),t.geometries[s.uuid]=a}},this.ParseObject=function(){function n(e,t){var n=new THREE.Matrix4;e.uuid=t.uuid,void 0!==t.name&&(e.name=t.name),void 0!==t.matrix?(n.fromArray(t.matrix),n.decompose(e.position,e.quaternion,e.scale)):(void 0!==t.position&&e.position.fromArray(t.position),void 0!==t.rotation&&e.rotation.fromArray(t.rotation),void 0!==t.scale&&e.scale.fromArray(t.scale),void 0!==t.scaleXYZ&&(e.scale.x*=t.scaleXYZ,e.scale.y*=t.scaleXYZ,e.scale.z*=t.scaleXYZ)),void 0!==t.castShadow&&(e.castShadow=t.castShadow),void 0!==t.receiveShadow&&(e.receiveShadow=t.receiveShadow),void 0!==t.visible&&(e.visible=t.visible),void 0!==t.userData&&(e.userData=t.userData)}if(THREE.ColladaLoader){var i=new THREE.ColladaLoader;i.options.convertUpAxis=!0}else console.warn("AMTHREE.ObjectLoader: THREE.ColladaLoader undefined");if(THREE.OBJLoader)var o=new THREE.OBJLoader;else console.warn("AMTHREE.ObjectLoader: THREE.OBJLoader undefined");if(THREE.OBJMTLLoader)var r=new THREE.OBJMTLLoader;else console.warn("AMTHREE.ObjectLoader: THREE.OBJMTLLoader undefined");return function(a,s){function d(e){return void 0!==e?(void 0===t.geometries[e]&&console.warn("AMTHREE.ObjectLoader: Undefined geometry",e),t.geometries[e]):void 0}function c(e){return void 0!==e?(void 0===t.materials[e]&&console.warn("AMTHREE.ObjectLoader: Undefined material",e),t.materials[e]):void 0}var u;switch(a.type){case"Scene":u=new THREE.Scene;break;case"PerspectiveCamera":u=new THREE.PerspectiveCamera(a.fov,a.aspect,a.near,a.far);break;case"OrthographicCamera":u=new THREE.OrthographicCamera(a.left,a.right,a.top,a.bottom,a.near,a.far);break;case"AmbientLight":u=new THREE.AmbientLight(a.color);break;case"DirectionalLight":u=new THREE.DirectionalLight(a.color,a.intensity);break;case"PointLight":u=new THREE.PointLight(a.color,a.intensity,a.distance,a.decay);break;case"SpotLight":u=new THREE.SpotLight(a.color,a.intensity,a.distance,a.angle,a.exponent,a.decay);break;case"HemisphereLight":u=new THREE.HemisphereLight(a.color,a.groundColor,a.intensity);break;case"Mesh":u=new THREE.Mesh(d(a.geometry),c(a.material));break;case"LOD":u=new THREE.LOD;break;case"Line":u=new THREE.Line(d(a.geometry),c(a.material),a.mode);break;case"PointCloud":case"Points":u=new THREE.Points(d(a.geometry),c(a.material));break;case"Sprite":u=new THREE.Sprite(c(a.material));break;case"Group":u=new THREE.Group;break;case"OBJ":if("undefined"==typeof o)return void console.warn("AMTHREE.ObjectLoader: failed to load "+a.uuid+": THREE.OBJLoader is undefined");u=new THREE.Object3D;var h=t.constants.model_path+"/"+a.url;t.manager.itemStart(h),o.load(h,function(e,t,i,o){return function(r){e.copy(r),e.traverse(function(e){e.geometry&&e.geometry.computeBoundingSphere()}),n(e,t),i.itemEnd(o)}}(u,a,t.manager,h));break;case"OBJMTL":if("undefined"==typeof r)return void console.warn("AMTHREE.ObjectLoader: failed to load "+a.uuid+": THREE.OBJMTLLoader is undefined");
u=new THREE.Group;var l=t.constants.model_path+"/"+a.objUrl,f=t.constants.model_path+"/"+a.mtlUrl;t.manager.itemStart(l),t.manager.itemStart(f),r.load(l,f,function(e,t,i,o,r){return function(a){e.copy(a),e.traverse(function(e){e.geometry&&e.geometry.computeBoundingSphere()}),n(e,t),i.itemEnd(o),i.itemEnd(r)}}(u,a,t.manager,l,f));break;case"Collada":if("undefined"==typeof i)return void console.warn("ObjectLoader: failed to load "+a.uuid+": THREE.ColladaLoader is undefined");u=new THREE.Group;var h=t.constants.model_path+"/"+a.url;t.manager.itemStart(h),i.load(h,function(e,t,i,o){return function(r){var a=r.scene;e.copy(a),"undefined"!=typeof THREE.Animation&&e.traverse(function(e){if(e instanceof THREE.SkinnedMesh){var t=new THREE.Animation(e,e.geometry.animation);t.play()}}),n(e,t),i.itemEnd(o)}}(u,a,e,h));case"Sound":u=new AMTHREE.Sound(a.url);break;case"ImagePlane":var h;h=t.constants.image_path?t.constants.image_path+"/"+a.url:a.url,u=new AMTHREE.ImagePlane(h);break;default:u=new THREE.Object3D}if(n(u,a),void 0!==a.children)for(var m in a.children){var E=t.ParseObject(a.children[m],u);void 0!==E&&u.add(E)}if("LOD"===a.type)for(var p=a.levels,g=0;g<p.length;g++){var v=p[g],m=u.getObjectByProperty("uuid",v.object);void 0!==m&&u.addLevel(m,v.distance)}return void 0!==s&&s.add(u),u}}()}:AMTHREE.ObjectLoader=function(){console.warn("ObjectLoader.js: THREE undefined")};var AMTHREE=AMTHREE||{};!function(){function e(e){e=e||{};var t={};return t.asset_path=e.asset_path?e.asset_path+"/":"./",t.image_path=t.asset_path+(e.image_path?e.image_path:""),t.video_path=t.asset_path+(e.video_path?e.video_path:""),t.model_path=t.asset_path+(e.model_path?e.model_path:""),t}function t(e,t){var n={};if(e instanceof Array){var i=new THREE.MaterialLoader;i.setTextures(t);for(var o=0,r=e.length;r>o;o++){var a=i.parse(e[o]);n[a.uuid]=a}}else console.log("materials parsing failed: json not an array");return n}function n(e){var t=[];if(e instanceof Array)for(var n=0;n<e.length;n++){var i=THREE.AnimationClip.parse(e[n]);t.push(i)}else console.log("animations parsing failed: json not an array");return t}function o(e,t){return new Promise(function(n,o){var r={};if(e instanceof Array){var a=new THREE.ImageLoader;return Promise.all(e.map(function(e){return new Promise(function(n,o){if(void 0===e.url)console.warn('AMTHREE.ObjectLoader: no "url" specified for image '+i);else{if(void 0!==e.uuid){var s=t+"/"+e.url;return void(r[e.uuid]=a.load(s,n))}console.warn('AMTHREE.ObjectLoader: no "uuid" specified for image '+i)}n()})})).then(n(r),o)}o("images parsing failed: json not an array")})}function r(e,t){var n={};if(e instanceof Array)for(var i=0,o=e.length;o>i;i++){var r=e[i];if(void 0===r.url)console.warn('AMTHREE.ObjectLoader: no "url" specified for video '+i);else if(void 0===r.uuid)console.warn('AMTHREE.ObjectLoader: no "uuid" specified for video '+i);else{var a={url:t+"/"+r.url,uuid:r.uuid,width:r.width||640,height:r.height||480};n[r.uuid]=a}}return n}function a(e,t,n){function i(e){return"number"==typeof e?e:(console.warn("AMTHREE.ObjectLoader.parseTexture: Constant should be in numeric form.",e),THREE[e])}var o={};if("undefined"==typeof SuperGif&&console.warn("AMTHREE.ObjectLoader: SuperGif is undefined"),"undefined"!=typeof e)for(var r=0,a=e.length;a>r;r++){var s=e[r];if(void 0!==s.image||void 0!==s.video){if(void 0!==s.image){if(void 0===t[s.image]){console.warn("AMTHREE.ObjectLoader: Undefined image",s.image);continue}var d=t[s.image];if(void 0!==s.animated&&s.animated){if("undefined"==typeof SuperGif)continue;var c=new AMTHREE.GifTexture(d.src)}else{var c=new THREE.Texture(d);c.needsUpdate=!0}}else{if(void 0===n[s.video]){console.warn("AMTHREE.ObjectLoader: Undefined video",s.video);continue}var u=n[s.video],c=new AMTHREE.VideoTexture({src:u.url,width:u.width,height:u.height,loop:s.loop,autoplay:s.autoplay})}c.uuid=s.uuid,void 0!==s.name&&(c.name=s.name),void 0!==s.mapping&&(c.mapping=i(s.mapping)),void 0!==s.offset&&(c.offset=new THREE.Vector2(s.offset[0],s.offset[1])),void 0!==s.repeat&&(c.repeat=new THREE.Vector2(s.repeat[0],s.repeat[1])),void 0!==s.minFilter?c.minFilter=i(s.minFilter):c.minFilter=THREE.LinearFilter,void 0!==s.magFilter&&(c.magFilter=i(s.magFilter)),void 0!==s.anisotropy&&(c.anisotropy=s.anisotropy),Array.isArray(s.wrap)&&(c.wrapS=i(s.wrap[0]),c.wrapT=i(s.wrap[1])),o[s.uuid]=c}else console.warn('AMTHREE.ObjectLoader: No "image" nor "video" specified for'+s.uuid)}return o}function s(e){var t={};if("undefined"!=typeof e)for(var n=new THREE.JSONLoader,i=new THREE.BufferGeometryLoader,o=0,r=e.length;r>o;o++){var a,s=e[o];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":a=new THREE[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"CubeGeometry":a=new THREE.BoxGeometry(s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleBufferGeometry":a=new THREE.CircleBufferGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CircleGeometry":a=new THREE.CircleGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":a=new THREE.CylinderGeometry(s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"SphereGeometry":a=new THREE.SphereGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"SphereBufferGeometry":a=new THREE.SphereBufferGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":a=new THREE.DodecahedronGeometry(s.radius,s.detail);break;case"IcosahedronGeometry":a=new THREE.IcosahedronGeometry(s.radius,s.detail);break;case"OctahedronGeometry":a=new THREE.OctahedronGeometry(s.radius,s.detail);break;case"TetrahedronGeometry":a=new THREE.TetrahedronGeometry(s.radius,s.detail);break;case"RingGeometry":a=new THREE.RingGeometry(s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":a=new THREE.TorusGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":a=new THREE.TorusKnotGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.p,s.q,s.heightScale);break;case"BufferGeometry":a=i.parse(s);break;case"Geometry":a=n.parse(s.data,this.texturePath).geometry;break;default:console.warn('AMTHREE.ObjectLoader: Unsupported geometry type "'+s.type+'"');continue}a.uuid=s.uuid,void 0!==s.name&&(a.name=s.name),t[s.uuid]=a}return t}function d(e,t){return new Promise(function(n,i){var o=new AM.JsonLoader;o.Load(e,function(){t(o.json).then(n,i)},function(){i("failed to load object: "+e)})})}function c(e){return d(e,l)}function u(e){return d(e,f)}function h(i){var d=e(i.constants);return o(i.images,d.image_path).then(function(e){var o=r(i.videos||[],d.video_path),c=a(i.textures||[],e,o),u=n(i.animations||[]),h=t(i.materials||[],c),l=s(i.geometries||[]),f={constants:d,videos:o,images:e,textures:c,animations:u,materials:h,geometries:l};return f})}function l(e){return h(e).then(function(t){return g(e.object,t.materials,t.geometries,t.constants.model_path).then(function(e){e.animations=t.animations,resolve(e)})})}function f(e){return h(e).then(function(t){return v(e.objects,t.materials,t.geometries,t.constants.model_path)})}function m(e,t,n,i,o){var r=new THREE.Matrix4;if(e.uuid=t.uuid,void 0!==t.name&&(e.name=t.name),void 0!==t.matrix?(r.fromArray(t.matrix),r.decompose(e.position,e.quaternion,e.scale)):(void 0!==t.position&&e.position.fromArray(t.position),void 0!==t.rotation&&e.rotation.fromArray(t.rotation),void 0!==t.scale&&e.scale.fromArray(t.scale),void 0!==t.scaleXYZ&&(e.scale.x*=t.scaleXYZ,e.scale.y*=t.scaleXYZ,e.scale.z*=t.scaleXYZ)),void 0!==t.castShadow&&(e.castShadow=t.castShadow),void 0!==t.receiveShadow&&(e.receiveShadow=t.receiveShadow),void 0!==t.visible&&(e.visible=t.visible),void 0!==t.userData&&(e.userData=t.userData),"LOD"===t.type)for(var a=t.levels,s=0;s<a.length;s++){var d=a[s],c=e.getObjectByProperty("uuid",d.object);void 0!==c&&e.addLevel(c,d.distance)}return void 0!==t.children?v(t.children,n,i,o).then(function(t){for(var n=0,i=t.length;i>n;++n)e.add(t[n]);return e}):Promise.resolve(e)}function E(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get geometry: no id provided"):console.warn("failed to get geometry: no such geometry: "+e))}function p(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get material: no id provided"):console.warn("failed to get material: no such material: "+e))}function g(e,t,n,i){var o;switch(e.type){case"OBJ":if(THREE.OBJLoader){var r=new THREE.OBJLoader,a=i+"/"+e.url;r.load(a,function(o){o.traverse(function(e){e.geometry&&e.geometry.computeBoundingSphere()}),m(o,e,t,n,i).then(resolve,reject)})}else reject("failed to load "+e.uuid+": THREE.OBJLoader is undefined");return;case"OBJMTL":if(THREE.OBJMTLLoader){var s=new THREE.OBJMTLLoader,d=i+"/"+e.objUrl,c=i+"/"+e.mtlUrl;s.load(d,c,function(o){o.traverse(function(e){e.geometry&&e.geometry.computeBoundingSphere()}),m(o,e,t,n,i).then(resolve,reject)})}else reject("failed to load "+e.uuid+": THREE.OBJMTLLoader is undefined");return;case"Collada":if(THREE.ColladaLoader){var u=new THREE.ColladaLoader;u.options.convertUpAxis=!0;var a=i+"/"+e.url;u.load(a,function(o){var r=o.scene;m(r,e,t,n,i).then(resolve,reject)})}else reject("failed to load "+e.uuid+": THREE.ColladaLoader is undefined");return;case"Sound":o=new AMTHREE.Sound(e.url);break;case"Scene":o=new THREE.Scene;break;case"PerspectiveCamera":o=new THREE.PerspectiveCamera(e.fov,e.aspect,e.near,e.far);break;case"OrthographicCamera":o=new THREE.OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far);break;case"AmbientLight":o=new THREE.AmbientLight(e.color);break;case"DirectionalLight":o=new THREE.DirectionalLight(e.color,e.intensity);break;case"PointLight":o=new THREE.PointLight(e.color,e.intensity,e.distance,e.decay);break;case"SpotLight":o=new THREE.SpotLight(e.color,e.intensity,e.distance,e.angle,e.exponent,e.decay);break;case"HemisphereLight":o=new THREE.HemisphereLight(e.color,e.groundColor,e.intensity);break;case"Mesh":o=new THREE.Mesh(E(e.geometry,n),p(e.material,t));break;case"LOD":o=new THREE.LOD;break;case"Line":o=new THREE.Line(E(e.geometry,n),p(e.material,t),e.mode);break;case"PointCloud":case"Points":o=new THREE.Points(E(e.geometry,n),p(e.material,t));break;case"Sprite":o=new THREE.Sprite(p(e.material,t));break;case"Group":o=new THREE.Group;break;default:o=new THREE.Object3D}return m(o,e,t,n,i)}function v(e,t,n,i){return e instanceof Array?Promise.all(e.map(function(e){return g(e,t,n,i)})):Promise.reject("failed to parse object array: json not an array")}function T(e){var t=new THREE.Box3,n=new THREE.Sphere,i=new THREE.Object3D;i.add(elem),t.setFromObject(elem),t.getBoundingSphere(n),i.scale.multiplyScalar(1/n.radius),n.center.divideScalar(n.radius),i.position.sub(n.center);var o=new THREE.Object3D;return o.add(i),o}"undefined"!=typeof THREE&&(AMTHREE.ParseObject=l,AMTHREE.ParseObjectArray=f,AMTHREE.LoadObject=c,AMTHREE.LoadObjectArray=u,AMTHREE.NormalizeObject=T)}();var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?AMTHREE.Scene=function(e){function t(){s.aspect=window.innerWidth/window.innerHeight,s.updateProjectionMatrix(),r.setSize(window.innerWidth,window.innerHeight)}function n(e){if(o.gps_converter&&void 0!==e.userData&&void 0!==e.position){var t=e.userData;if(void 0!==t.latitude&&void 0!==t.longitude){var n=o.gps_converter(t.latitude,t.longitude);e.position.z=n.y,e.position.x=n.x}void 0!==t.altitude&&(e.position.y=t.altitude)}}"undefined"==typeof AMTHREE.ObjectLoader&&console.warn("AMTHREE.Scene: AMTHREE.ObjectLoader undefined"),e=e||{};var i,o=this,r=new THREE.WebGLRenderer({alpha:!0,canvas:e.canvas}),a=new THREE.Scene,s=new THREE.PerspectiveCamera(e.fov||80,r.domElement.width/r.domElement.height,1e-4,1e4),d=new THREE.Object3D,c=new THREE.LoadingManager;d.add(s),a.add(d),e.canvas||(r.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(r.domElement)),r.setClearColor(10066383,0),"undefined"!=typeof AMTHREE.ObjectLoader&&(i=new AMTHREE.ObjectLoader(c)),this.gps_converter=e.gps_converter,this.Clear=function(){a.children=[],a.copy(new THREE.Scene,!1)},this.SetFullWindow=function(){window.addEventListener("resize",t,!1),t()},this.StopFullWindow=function(){window.removeEventListener("resize",t,!1)},this.Render=function(){r.render(a,s)},this.Update=function(){var e=new THREE.Clock;return function(){THREE.AnimationHandler&&THREE.AnimationHandler.update(e.getDelta()),AMTHREE.UpdateAnimatedTextures(a)}}(),this.AddObject=function(e){n(e),a.add(e)},this.RemoveObject=function(e){a.remove(e)};var u=function(e){return function(t){var n=function(t){return function(){for(;t.children.length;){var n=t.children[0];t.remove(n),o.AddObject(n)}a.copy(t,!1),AMTHREE.PlayAnimations(a),e&&e()}}(t);c.onLoad=n}};this.Parse=function(e,t){if(i){var n=new u(t),o=i.parse(e);n(o)}else console.warn("AMTHREE.Scene: Parse failed: AMTHREE.ObjectLoader undefined")},this.Load=function(e,t){i?i.Load(e,new u(t)):console.warn("AMTHREE.Scene: Load failed: AMTHREE.ObjectLoader undefined")},this.GetCamera=function(){return s},this.GetCameraBody=function(){return d},this.GetScene=function(){return a},this.GetRenderer=function(){return r},this.ResizeRenderer=function(e,t){r.setSize(e,t),s.aspect=r.domElement.width/r.domElement.height,s.updateProjectionMatrix()}}:AMTHREE.Scene=function(){console.warn("Scene.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Sound=function(e){THREE.Object3D.call(this),this.src=e,this.audio=new Audio,this.audio.loop=!0,this.playing=!1},AMTHREE.Sound.prototype=Object.create(THREE.Object3D.prototype),AMTHREE.Sound.prototype.constructor=AMTHREE.Sound,AMTHREE.Sound.prototype.play=function(){this.playing=!0,this.audio.src=this.src,this.audio.play()},AMTHREE.Sound.prototype.stop=function(){this.audio.src="",this.playing=!1},AMTHREE.Sound.prototype.pause=function(){this.audio.pause(),this.playing=!1},AMTHREE.Sound.prototype.setSrc=function(e){this.src=e,this.isPlaying()&&this.play()},AMTHREE.Sound.prototype.isPlaying=function(){return this.playing},AMTHREE.Sound.prototype.clone=function(){return new AMTHREE.Sound(this.src)},AMTHREE.Sound.prototype.copy=function(e){this.setSrc(e.src)},AMTHREE.SoundsCall=function(e,t){e.traverse(function(e){e instanceof AMTHREE.Sound&&e[t]&&e[t]()})},AMTHREE.PlaySounds=function(e){AMTHREE.SoundsCall(e,"play")},AMTHREE.PauseSounds=function(e){AMTHREE.SoundsCall(e,"pause")},AMTHREE.StopSounds=function(e){AMTHREE.SoundsCall(e,"stop")}):AMTHREE.Sound=function(){console.warn("Sound.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.TrackedObjManager=function(e){function t(e,t,n){e.position.lerp(t.position,n),e.quaternion.slerp(t.quaternion,n),e.scale.lerp(t.scale,n)}function n(){r.ForEach(function(e){e.enabled&&t(e.object,e.target,i.lerp_factor)})}e=e||{};var i=this,o=new THREE.Clock(!0),r=new AMTHREE.TrackedObjManager.prototype.Holder,a=n;this.camera=e.camera,this.lerp_factor=e.lerp_factor||.8,this.timeout=e.timeout||6,this.Add=function(e,t,n,i){r.Add(e,t,n,i)},this.Remove=function(e){r.Remove(e)},this.Clear=function(){r.Clear()},this.Update=function(){r.UpdateElapsed(o.getDelta()),r.CheckTimeout(i.timeout),a()},this.Track=function(){var e=new THREE.Matrix4,n=new THREE.Object3D;return function(o,a){if(i.camera){var s=r.Get(o);if(s){var d=s.target;return e.copy(i.camera.matrixWorld),e.multiply(a),s.enabled?(e.decompose(n.position,n.quaternion,n.scale),t(d,n,i.lerp_factor)):(e.decompose(d.position,d.quaternion,d.scale),e.decompose(s.object.position,s.object.quaternion,s.object.scale)),r.Track(o),!0}console.warn("TrackedObjManager: object "+o+" not found")}else console.warn("TrackedObjManager: camera is undefined");return!1}}(),this.TrackCompose=function(){var e=new THREE.Matrix4;return function(t,n,o,r){return e.compose(n,o,r),i.Track(t,e)}}(),this.TrackComposePosit=function(){var e=new THREE.Vector3,t=new THREE.Euler,n=new THREE.Quaternion,o=new THREE.Vector3;return function(r,a,s,d){return e.x=a[0],e.y=a[1],e.z=-a[2],t.x=-Math.asin(-s[1][2]),t.y=-Math.atan2(s[0][2],s[2][2]),t.z=Math.atan2(s[1][0],s[1][1]),o.x=d,o.y=d,o.z=d,n.setFromEuler(t),i.TrackCompose(r,e,n,o)}}(),this.GetObject=function(e){var t=r.get(e);return t?t.object:void 0}},AMTHREE.TrackedObjManager.prototype.Holder=function(){var e=this,t={};this.Add=function(e,n,i,o){t[n]={object:e,target:{position:e.position.clone(),quaternion:e.quaternion.clone(),scale:e.scale.clone()},elapsed:0,on_enable:i,on_disable:o,enabled:!1}},this.Remove=function(e){var n=t[e];n.enabled&&n.on_disable&&n.on_disable(n.object),delete t[e]},this.Clear=function(){for(uuid in t)e.Remove(uuid)},this.Track=function(e){var n=t[e];n.elapsed=0,n.enabled||(n.enabled=!0,n.on_enable&&n.on_enable(n.object))},this.UpdateElapsed=function(e){for(uuid in t)t[uuid].elapsed+=e},this.CheckTimeout=function(e){for(uuid in t){var n=t[uuid];n.enabled&&n.elapsed>e&&(n.on_disable&&n.on_disable(n.object),n.enabled=!1)}},this.ForEach=function(e){for(uuid in t)e(t[uuid])},this.Get=function(e){return t[e]}}):AMTHREE.TrackedObjManager=function(){console.warn("TrackedObjManager.js: THREE undefined")};var AMTHREE=AMTHREE||{};AMTHREE.AnimatedTextureCall=function(e,t){e.traverse(function(e){e.material&&e.material.map&&e.material.map[t]&&e.material.map[t]()})},AMTHREE.PlayAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"play")},AMTHREE.StopAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"stop")},AMTHREE.PauseAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"pause")},AMTHREE.UpdateAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"update")},AMTHREE.WorldToCanvasPosition=function(e,t,n){var i=new THREE.Vector3;i.copy(e),i.project(t);var o=Math.round((i.x+1)*n.width/2),r=Math.round((-i.y+1)*n.height/2);return{x:o,y:r,z:i.z}},AMTHREE.PlayAnimations=function(e){e.traverse(function(e){if(e instanceof THREE.SkinnedMesh){var t=new THREE.Animation(e,e.geometry.animation);t.play()}})};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.VideoTexture=function(e){THREE.Texture.call(this),this.minFilter=THREE.NearestMipMapNearestFilter,this.videoElement=document.createElement("video"),this.setVideo(e)},AMTHREE.VideoTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.VideoTexture.prototype.constructor=AMTHREE.VideoTexture,AMTHREE.VideoTexture.prototype.copy=function(e){THREE.Texture.prototype.copy.call(this,e);var t={};return e.videoElement&&(t.width=e.videoElement.width,t.height=e.videoElement.height,t.loop=e.videoElement.loop,t.autoplay=e.videoElement.autoplay),t.src=e.src,this.setVideo(t),this},AMTHREE.VideoTexture.prototype.clone=function(){return(new this.constructor).copy(this)},AMTHREE.VideoTexture.prototype.play=function(){this.videoElement&&!this.playing&&(this.paused||(this.videoElement.src=this.src),this.videoElement.setAttribute("crossorigin","anonymous"),this.videoElement.play(),this.image=this.videoElement,this.playing=!0)},AMTHREE.VideoTexture.prototype.update=function(){this.videoElement&&this.videoElement.readyState==this.videoElement.HAVE_ENOUGH_DATA&&(this.needsUpdate=!0)},AMTHREE.VideoTexture.prototype.pause=function(){this.videoElement&&!this.videoElement.paused&&(this.videoElement.pause(),this.playing=!1)},AMTHREE.VideoTexture.prototype.stop=function(){this.videoElement&&(this.pause(),this.videoElement.src="",this.image=void 0,this.needsUpdate=!0)},AMTHREE.VideoTexture.prototype.setVideo=function(e){this.stop(),e&&(this.src=e.src,this.videoElement.width=e.width,this.videoElement.height=e.height,this.videoElement.autoplay="undefined"!=typeof e.autoplay?e.autoplay:!1,this.videoElement.loop="undefined"!=typeof e.loop?e.loop:!0),this.playing=!1,this.videoElement.autoplay&&this.play()}):AMTHREE.VideoTexture=function(){console.warn("VideoTexture.js: THREE undefined")};