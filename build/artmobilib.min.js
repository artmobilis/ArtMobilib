var compatibility=function(){var e=0,t=!0,i=window.URL||window.webkitURL||window.mozURL||window.msURL,n=function(t,i){var n=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,i){var n=(new Date).getTime(),r=Math.max(0,16-(n-e)),a=window.setTimeout(function(){t(n+r)},r);return e=n+r,a};return n.call(window,t,i)},r=function(e){var t=window.cancelAnimationFrame||function(e){clearTimeout(e)};return t.call(window,e)},a=function(e,t,i){var n=window.navigator.getUserMedia||window.navigator.mozGetUserMedia||window.navigator.webkitGetUserMedia||window.navigator.msGetUserMedia||function(e,t,i){i()};return n.call(window.navigator,e,t,i)},o=function(){var e=new ArrayBuffer(8),i=new Uint32Array(e);return i[0]=4278190080,t=!0,255===e[0]&&(t=!1),t};return{URL:i,requestAnimationFrame:n,cancelAnimationFrame:r,getUserMedia:a,detectEndian:o,isLittleEndian:t}}();!function(){AM=AM||{};var e=function(){this._listeners={}};e.prototype.AddListener=function(e,t){return"string"==typeof e&&("undefined"==typeof this._listeners[e]&&(this._listeners[e]=[]),-1==this._listeners[e].indexOf(t))?(this._listeners[e].push(t),!0):!1},e.prototype.RemoveListener=function(e,t){if("string"==typeof e){var i=this._listeners[e];if("undefined"!=typeof i){var n=i.indexOf(t);if(-1!=n)return 1!=i.length?i.splice(n,1):delete this._listeners[e],!0}}return!1},e.prototype.Fire=function(e,t){if("string"==typeof e){var i=this._listeners[e];if("undefined"!=typeof i){for(var n=0,r=i.length;r>n;++n)"function"==typeof i[n]&&i[n].apply(this,t);return!0}}return!1},AM.EventManager=e}(),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL;var AM=AM||{};!function(){function e(){function e(){return h||(a&&a.Dispose(),h=!0,a=new t(s),o=a.Load().then(function(e){r=e})),o}function i(){r&&(r.getTracks()[0].stop(),r=void 0),a&&(a.Dispose(),a=void 0),o=Promise.resolve(),h=!1}function n(){return h}var r,a,o,s=document.createElement("video"),h=!1;s.setAttribute("autoplay",!0),s.style.position="absolute",s.style.top="0px",s.style.left="0px",s.style.width="100%",s.style.height="auto",this.domElement=s,i(),this.Start=e,this.Stop=i,this.IsActive=n}function t(e){function t(e){return new Promise(function(t,i){!function n(){h&&i("loader interrupted"),e.readyState===e.HAVE_ENOUGH_DATA?t():window.requestAnimationFrame(n)}()})}function i(i){var n=new Promise(function(e,t){h&&t("loader interrupted");for(var n={video:!0,audio:!1},r=0;r!=i.length;++r){var a=i[r];"video"==a.kind&&"environment"==a.facing&&(n.video={optional:[{sourceId:a.id}]})}navigator.getUserMedia(n,e,t)});return n=n.then(function(i){return e.src=window.URL.createObjectURL(i),t(e).then(function(){return i})})}function n(e){return new Promise(function(e,t){return h&&t("loader interrupted"),MediaStreamTrack.getSources(e)})}function r(e){return Promise.resolve(function(){return h&&reject("loader interrupted"),navigator.mediaDevices.enumerateDevices()})}function a(){return s=!0,new Promise(function(e,t){h&&t("loader interrupted");var a=n();a=a.then(function(t){i(t).then(e)}),a["catch"](function(){r().then(function(t){i(t).then(e)})["catch"](t)})})}function o(){h=!0}var s=!1,h=!1;this.Load=a,this.Dispose=o}AM.FrontCamGrabbing=e}();var AM=AM||{};getGradientGreenRedColor=function(e,t){function i(e){var t=parseInt(e).toString(16);return t.length<2?"0"+t:t}var n=255*e/t,r=255*(t-e)/t;return"#"+i(n)+i(r)+"00"},AM.ImageDebugger=function(){var e,t,i,n,r,a,o,s,h,c,u,l,d,f,p,m,g,v,E,y,T=new AM.Training,w=44,b=[],M=[],A=new AM.ImageLoader,R=!1,x=!0;this.DrawCorners=function(t){var i,n;if(R&&t&&(a=t.screen_corners,h=t.profiles,c=t.image_data,a.length)){for(e.fillStyle="red",i=0;i<a.length;++i)n=a[i],e.beginPath(),e.arc(n.x*l+d,n.y*l+f,3,0,2*Math.PI),e.fill();for(e.putImageData(c,m-c.width,w),i=0;i<a.length;++i)n=a[i],e.beginPath(),e.arc(n.x+m-c.width,n.y+w,3,0,2*Math.PI),e.fill();e.font="30px Arial",e.fillStyle="red",e.textAlign="left";var r="FPS: "+h.fps.toFixed(2)+"  ";for(i=0;i<h.timers.length;++i){var o=h.timers[i];r+=o[0]+": "+o[1].run_time+"ms  "}e.fillText(r,10,p-5-w)}},this.DebugMatching=function(e,t){R&&e&&t&&(n=e.corners,r=e.trained_corners,o=e.matches,s=e.matches_mask,i=t,e.uuid!=E&&(E=e.uuid,A.GetImageData(t,function(e){y=e,correctTrainingImageOffsets(),displayTrainingImages(!0),drawContour(),drawMatches(),x&&(displayTrainingImages(!1),drawTrainedCorners())},!1)),y&&(correctTrainingImageOffsets(),displayTrainingImages(!0),drawContour(),drawMatches(),x&&(displayTrainingImages(!1),drawTrainedCorners())))},correctTrainingImageOffsets=function(){var e;y.width>y.height?(e=y.width-y.height,g=0,v=-Math.round(e/2)):(e=y.height-y.width,g=-Math.round(e/2),v=0)},drawContour=function(){e.strokeStyle="green",e.lineWidth=5,e.beginPath(),e.moveTo(n[0].x*l+d,n[0].y*l+f),e.lineTo(n[1].x*l+d,n[1].y*l+f),e.lineTo(n[2].x*l+d,n[2].y*l+f),e.lineTo(n[3].x*l+d,n[3].y*l+f),e.lineTo(n[0].x*l+d,n[0].y*l+f),e.stroke()},drawMatches=function(t){"undefined"==typeof t&&(t=!1),e.lineWidth=2;for(var i=0;i<o.length;++i){var n=o[i],h=s.data[i],c=r[n.pattern_lev],u=c[n.pattern_idx],p=a[n.screen_idx];h?(e.fillStyle="blue",e.strokeStyle="blue"):(e.fillStyle="red",e.strokeStyle="red");var m=u.x+g,E=u.y+v;t||(m=m*M[n.pattern_lev]+b[n.pattern_lev],E*=M[n.pattern_lev]),e.beginPath(),e.arc(m,E+w,3,0,2*Math.PI),e.fill(),e.beginPath(),e.moveTo(m,E+w),e.lineTo(p.x*l+d,p.y*l+f),e.stroke(),e.beginPath(),e.arc(p.x*l+d,p.y*l+f,3,0,2*Math.PI),e.fill()}},jsFeat2ImageData=function(t){for(var i=e.createImageData(t.cols,t.rows),n=t.data.length,r=4*n+3;n--;)i.data[r-=4]=255,i.data[r-1]=i.data[r-2]=i.data[r-3]=t.data[n];return i},displayColor=function(t,i){e.putImageData(y,t,i)},displayTrainingImages=function(t){T.Empty(),T.TrainFull(y);var i=T.getBluredImages(),n=0;b[0]=0,M[0]=1;for(var r=0;r<i.length;++r)originy=w,t||(originy=p-35-w-i[r].rows),e.putImageData(jsFeat2ImageData(i[r]),n,originy),n+=i[r].cols,b[r+1]=b[r]+i[r].cols,M[r+1]=M[r]/T.GetScaleIncrement()},drawTrainedCorners=function(t){"undefined"==typeof t&&(t=50);var i=T.getBluredImages(),n=new AM.TrainedImage(u);T.SetResultToTrainedImage(n);for(var r=0;r<n.GetLevelNbr();++r)for(var a=n.GetCorners(r),o=(n.GetDescriptors(r),p-35-w-i[r].rows),s=0;t>s;++s){var h=a[s];e.fillStyle=getGradientGreenRedColor(t-s,t);var c=h.x+g,l=h.y+v;c=c*M[r]+b[r],l*=M[r],e.beginPath(),e.arc(c,l+o,3,0,2*Math.PI),e.fill()}},this.UpdateSize=function(e,i){p=e.height,m=e.width;var n=p,r=t.videoWidth/t.videoHeight,a=m/n;if(a>r){var o=Math.round(n*r);l=o/i,d=Math.round(.5*(m-o)),f=0}else{var s=m/r;l=m/i,d=0,f=Math.round(.5*(n-s))}},this.SetData=function(i,n,r){e=i,t=n,R=r||!1},this.SetDebug=function(e){R=e||!1}};var AM=AM||{};AM.ImageLoader=function(){var e=document.createElement("canvas"),t=e.getContext("2d");this.GetImageData=function(i,n,r){var a=new Image;a.onload=function(i,n,r){return function(){if(r){var a=Math.max(i.width,i.height),o=(a-i.width)/2,s=(a-i.height)/2;e.width=a,e.height=a,t.drawImage(i,o,s)}else e.width=i.width,e.height=i.height,t.drawImage(i,0,0,e.width,e.height);var h=t.getImageData(0,0,e.width,e.height);n(h)}}(a,n,r),a.src=i}};var AM=AM||{};AM.JsonLoader=function(){function e(e,t){u=!1,o=void 0,a=void 0,r=void 0,h=void 0,s=void 0,c.progress=0,e&&e(t)}function t(){try{c.json=JSON.parse(h.responseText),e(r)}catch(t){c.json={},e(a,"failed to parse file: "+s)}}function i(t){var i="JsonLoader failed to open file: "+s;console.log(i),e(a,i)}function n(e){c.progress=e.loaded/e.total*100,o&&o()}var r,a,o,s,h,c=this,u=!1;this.json={},this.progress=0,this.IsLoading=function(){return u},this.Load=function(e,c,l,d){u||(u=!0,r=c,a=l,o=d,s=e,h=new XMLHttpRequest,h.onprogress=n,h.open("GET",e,!0),h.onload=t,h.onerror=i,h.send(null))}},AM.LoadJson=function(e){return new Promise(function(t,i){var n=new AM.JsonLoader;n.Load(e,function(){t(n.json)},i)})};var AM=AM||{};AM.LoadingManager=function(){function e(e){for(var t=0,i=e.length;i>t;++t)e[t]()}var t=[],i=[],n=0;this.Start=function(t){t=t||1,n+=t,e(i)},this.End=function(r){r=r||1,n>0&&(n-=r,e(i)),0>=n&&(n=0,e(t),t.length=0,i.length=0)},this.OnEnd=function(e){n>0?t.push(e):e()},this.OnProgress=function(e){n>0?i.push(e):e()},this.IsLoading=function(){return n>0},this.GetRemaining=function(){return n}};var AM=AM||{};!function(){var e=function(){function e(){this.start_time=0,this.stop_time=0,this.run_time=0,this.running=!1}return e.prototype.start=function(){this.start_time=(new Date).getTime(),this.running=!0},e.prototype.stop=function(){this.stop_time=(new Date).getTime(),this.run_time=this.stop_time-this.start_time,this.running=!1},e.prototype.get_runtime=function(){return this.run_time},e.prototype.reset=function(){this.run_time=0},e}(),t=function(){function e(e){this.arr=new Int32Array(e),this.begin=0,this.end=-1,this.num_el=0,this.arr_size=e}return e.prototype.push_back=function(e){this.num_el<this.arr_size?(this.end++,this.arr[this.end]=e,this.num_el++):(this.end=(this.end+1)%this.arr_size,this.begin=(this.begin+1)%this.arr_size,this.arr[this.end]=e)},e.prototype.get=function(e){return this.arr[(this.begin+e)%this.arr_size]},e.prototype.size=function(){return this.num_el},e}(),i=function(){function i(){this.fps=0,this.timers=[],this.frame_timer=new e}var n=0,r=new t(20);return i.prototype.add=function(t){this.timers.push([t,new e])},i.prototype.new_frame=function(){++n;var e=0,t=0|this.timers.length;for(e=0;t>e;++e){var i=this.timers[e][1];i.reset()}if(n>=1){this.frame_timer.stop(),r.push_back(this.frame_timer.get_runtime());var a=r.size(),o=0;for(e=0;a>e;++e)o+=r.get(e);this.fps=a/o*1e3,this.frame_timer.start()}},i.prototype.find_task=function(e){var t=0|this.timers.length,i=0;for(i=0;t>i;++i){var n=this.timers[i];if(n[0]===e)return n}return null},i.prototype.start=function(e){var t=this.find_task(e);t[1].start()},i.prototype.stop=function(e){var t=this.find_task(e);t[1].stop()},i.prototype.log=function(){var e=0|this.timers.length,t=0,i="<strong>FPS: "+this.fps.toFixed(2)+"</strong>";for(t=0;e>t;++t){var n=this.timers[t];i+="<br/>"+n[0]+": "+n[1].get_runtime()+"ms"}return i},i.prototype.log2=function(){var e=0|this.timers.length,t=0,i="FPS: "+this.fps.toFixed(2)+"  ";for(t=0;e>t;++t){var n=this.timers[t];i+=n[0]+": "+n[1].get_runtime()+"ms  "}return i},i.prototype.GetProfiler=function(){return{fps:this.fps,timers:this.timers}},i}();AM.Profiler=i}();var AM=AM||{};AM.DeviceLockScreenOrientation=function(){function e(){window.cordova?(t(),o=!0):s=!1}function t(){for(var e=0,t=h.length;t>e;++e)h[e]();h.length=0}function i(e){s&&(o?e():h.push(e))}function n(){screen.lockOrientation("landscape-primary")}function r(){screen.lockOrientation("portrait-primary")}function a(){screen.unlockOrientation()}var o=!1,s=!0,h=[];document.addEventListener("deviceready",e,!1),this.LockLandscape=function(){i(n)},this.LockPortrait=function(){i(r)},this.Unlock=function(){i(a)}};var AM=AM||{};AM.DeviceOrientationControl=function(e){var t=this;this.object=e,this.object.rotation.reorder("YXZ");var i=!1,n=!1,r=0,a=new this.CoefMethod,o=function(e){i?(a.OnOrientationChange(e),n=!0):i=!0},s=function(){r=window.orientation||0};this.Connect=function(){s(),window.addEventListener("orientationchange",s,!1),window.addEventListener("deviceorientation",o,!1)},this.Disconnect=function(){window.removeEventListener("orientationchange",s,!1),window.removeEventListener("deviceorientation",o,!1),n=!1,i=!1},this.Update=function(){var e=function(){var e=new THREE.Vector3(0,0,1),t=new THREE.Euler,i=new THREE.Quaternion,n=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));return function(r,a,o,s,h){t.set(o,a,-s,"YXZ"),r.setFromEuler(t),r.multiply(n),r.multiply(i.setFromAxisAngle(e,-h))}}();if(n){var i=r?THREE.Math.degToRad(r):0;a.Update(),e(t.object.quaternion,a.alpha,a.beta,a.gamma,i)}}},AM.DeviceOrientationControl.prototype.PowerMethod=function(){function e(e,t,i){var n=AM.DeviceOrientationControl.prototype.Mod2Pi(t-e),r=Math.sign(n),a=Math.abs(n/Math.PI);return a=Math.pow(a,i),AM.DeviceOrientationControl.prototype.Mod2Pi(e+a*Math.PI*r)}var t,i=this,n=2;this.alpha=0,this.beta=0,this.gamma=0,this.OnOrientationChange=function(e){t=e},this.Update=function(){i.alpha=e(i.alpha,THREE.Math.degToRad(t.alpha),n),i.beta=e(i.beta,THREE.Math.degToRad(t.beta),n),i.gamma=e(i.gamma,THREE.Math.degToRad(t.gamma),n)}},AM.DeviceOrientationControl.prototype.CoefMethod=function(){function e(e,t,i){return e+AM.DeviceOrientationControl.prototype.Mod2Pi(t-e)*i}var t=this;this.coef=.2,this.alpha=0,this.beta=0,this.gamma=0;var i=!1;this.OnOrientationChange=function(e){i=e},this.Update=function(){if(i){var n=e(t.alpha,THREE.Math.degToRad(i.alpha),t.coef),r=e(t.beta,THREE.Math.degToRad(i.beta),t.coef),a=e(t.gamma,THREE.Math.degToRad(i.gamma),t.coef);t.alpha=n,t.beta=r,t.gamma=a}}},AM.DeviceOrientationControl.prototype.AverageMethod=function(){var e=this;this.history=[],this.history_max=10,this.alpha=0,this.beta=0,this.gamma=0,this.OnOrientationChange=function(t){e.history.length>e.history_max&&e.history.shift(),e.history.push(t)},this.Update=function(t,i,n){if(0!==e.history.length){for(var r=0,a=e.history.length;a>r;r++)t+=AM.DeviceOrientationControl.prototype.Mod360(e.history[r].alpha),i+=AM.DeviceOrientationControl.prototype.Mod360(e.history[r].beta),n+=AM.DeviceOrientationControl.prototype.Mod360(e.history[r].gamma);t/=e.history.length,i/=e.history.length,n/=e.history.length,e.alpha=THREE.Math.degToRad(t),e.beta=THREE.Math.degToRad(i),e.gamma=THREE.Math.degToRad(n)}}},AM.DeviceOrientationControl.prototype.Mod2Pi=function(){var e=Math.PI,t=2*Math.PI;return function(i){if(i>e){do i-=t;while(i>e)}else if(-e>i)do i+=t;while(-e>i);return i}}(),AM.DeviceOrientationControl.prototype.Mod360=function(e){return e%=360,180>e?e:e-360};var AM=AM||{};AM.GeographicCoordinatesConverter=function(e,t){var i=this,n={latitude:0,longitude:0};this.GetLocalCoordinates=function(e,t){var r=(n.latitude+e)/2,a={x:0,y:0};return a.x=(t-n.longitude)*i.EARTH_RADIUS*Math.cos(r),a.y=(e-n.latitude)*-i.EARTH_RADIUS,a},this.GetLocalCoordinatesFromDegres=function(e,t){return i.GetLocalCoordinates(THREE.Math.degToRad(e),THREE.Math.degToRad(t))},this.SetOrigin=function(e,t){n.latitude=e,n.longitude=t},this.SetOriginFromDegres=function(e,t){n.latitude=THREE.Math.degToRad(e),n.longitude=THREE.Math.degToRad(t)},this.GetOrigin=function(){return n},this.SetOrigin(e||0,t||0)},AM.GeographicCoordinatesConverter.prototype.EARTH_RADIUS=6371e3;var AM=AM||{};AM.GeolocationControl=function(e,t){function i(e){o.copy(h.GetLocalCoordinatesFromDegres(e.coords.latitude,e.coords.longitude)),a=!0}function n(e){console.warn("geolocation failed: "+e.message),window.setTimeout(r.Connect,r.retry_connection_ms)}var r=this,a=!1,o=new THREE.Vector3,s=0,h=t,c=.1;this.object=e,this.interpolation_coefficient=.02,this.retry_connection_ms=1e3,this.Connect=function(){s=navigator.geolocation.watchPosition(i,n)},this.Disconnect=function(){navigator.geolocation.clearWatch(s),a=!1},this.Update=function(){if(a){var e=o.x-r.object.position.x,t=o.z-r.object.position.z,i=e*e+t*t;c*c>i?a=!1:(e*=r.interpolation_coefficient,t*=r.interpolation_coefficient,r.object.position.x+=e,r.object.position.z+=t)}}};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE&&!function(){function e(){this.id="",this.init_from=""}function t(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function n(){this.method=null,this.source=null,this.targets=null,this.weights=null}function r(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function a(){this.id="",this.name="",this.nodes=[],this.scene=new THREE.Group}function o(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE.Matrix4}function s(){this.sid="",this.type="",this.data=[],this.obj=null}function h(){this.url="",this.skeleton=[],this.instance_material=[]}function c(){this.symbol="",this.target=""}function u(){this.url="",this.instance_material=[]}function l(){this.id="",this.mesh=null}function d(e){this.geometry=e.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function f(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE.Geometry}function p(){f.call(this),this.vcount=[]}function m(){f.call(this),this.vcount=1}function g(){f.call(this),this.vcount=3}function v(){this.source="",this.count=0,this.stride=0,this.params=[]}function E(){this.input={}}function y(){this.semantic="",this.offset=0,this.source="",this.set=0}function T(e){this.id=e,this.type=null}function w(){this.id="",this.name="",this.instance_effect=null}function b(){this.color=new THREE.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function M(e,t){this.type=e,this.effect=t,this.material=null}function A(e){this.effect=e,this.init_from=null,this.format=null}function R(e){this.effect=e,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function x(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function H(){this.url=""}function _(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function k(e){this.animation=e,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function j(e){this.id="",this.animation=e,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function N(e){this.targets=[],this.time=e}function S(){this.id="",this.name="",this.technique=""}function C(){this.url=""}function O(){this.id="",this.name="",this.technique=""}function G(){this.url=""}function I(){this.id="",this.name="",this.joints=[],this.links=[]}function L(){this.sid="",this.name="",this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this["static"]=!1,this.zeroPosition=0,this.middlePosition=0}function P(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function D(){this.joint="",this.transforms=[],this.links=[]}function U(e){var t=e.getAttribute("id");return void 0!=_e[t]?_e[t]:(_e[t]=new T(t).parse(e),_e[t])}function F(e){for(var t=z(e),i=[],n=0,r=t.length;r>n;n++)i.push("true"===t[n]||"1"===t[n]);return i}function q(e){for(var t=z(e),i=[],n=0,r=t.length;r>n;n++)i.push(parseFloat(t[n]));return i}function V(e){for(var t=z(e),i=[],n=0,r=t.length;r>n;n++)i.push(parseInt(t[n],10));return i}function z(e){return e.length>0?B(e).split(/\s+/):[]}function B(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}function X(e,t,i){return e.hasAttribute(t)?parseInt(e.getAttribute(t),10):i}function Y(e,t){var i=new THREE.ImageLoader;i.load(t,function(t){e.image=t,e.needsUpdate=!0})}function J(e,t,i){var n=Ne[t.url];if(i=void 0!==i?i:40,!n||!n.skin)return void console.log("ColladaLoader: Could not find skin controller.");if(!t.skeleton||!t.skeleton.length)return void console.log("ColladaLoader: Could not find the skeleton for the skin. ");for(var r=Z(),a=ve.getChildById(t.skeleton[0],!0)||ve.getChildBySid(t.skeleton[0],!0),o=ie(a),s=n.skin.joints,h=[],c=0;c<s.length;c++)for(var u=0;u<o.length;u++)o[u].name===s[c]&&(h[c]=o[u]);for(var c=0;c<h.length;c++)for(var u=0;u<h.length;u++)h[c].parent===h[u].name&&(h[c].parent=u);var c,u,l;new THREE.Vector3;for(c=0;c<e.vertices.length;c++)e.vertices[c].applyMatrix4(n.skin.bindShapeMatrix);for(var d=[],f=[],p=n.skin.weights,c=0;c<p.length;c++){var m=new THREE.Vector4(p[c][0]?p[c][0].joint:0,p[c][1]?p[c][1].joint:0,p[c][2]?p[c][2].joint:0,p[c][3]?p[c][3].joint:0),l=new THREE.Vector4(p[c][0]?p[c][0].weight:0,p[c][1]?p[c][1].weight:0,p[c][2]?p[c][2].weight:0,p[c][3]?p[c][3].weight:0);d.push(m),f.push(l)}e.skinIndices=d,e.skinWeights=f,e.bones=h;for(var g={name:r.ID,fps:30,length:r.frames/30,hierarchy:[]},u=0;u<h.length;u++)g.hierarchy.push({parent:h[u].parent,name:h[u].name,keys:[]});for(console.log("ColladaLoader:",r.ID+" has "+h.length+" bones."),ge(e,a,n),i=0;i<r.frames;i++){var v=[];pe(a,v,i),me(v,n.skin);for(var c=0;c<v.length;c++)for(var u=0;u<g.hierarchy.length;u++)if(g.hierarchy[u].name===v[c].sid){var E={};E.time=i/30,E.matrix=v[c].animatrix,0===i&&(v[c].matrix=E.matrix);var y=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];E.matrix.decompose(y[0],y[1],y[2]),E.pos=[y[0].x,y[0].y,y[0].z],E.scl=[y[2].x,y[2].y,y[2].z],E.rot=y[1],g.hierarchy[u].keys.push(E)}e.animation=g}}function Z(){var e,t=1e6,i=-t,n=0;for(var r in je){var a=je[r];e=e||a.id;for(var o=0;o<a.sampler.length;o++){var s=a.sampler[o];s.create(),t=Math.min(t,s.startTime),i=Math.max(i,s.endTime),n=Math.max(n,s.input.length)}}return{start:t,end:i,frames:n,ID:e}}function W(e,t){var i,n,r,a,o=new THREE.Object3D,s=!1;for(r=0;r<e.controllers.length;r++){var h=Ne[e.controllers[r].url];switch(h.type){case"skin":if(Se[h.skin.source]){var c=new u;c.url=h.skin.source,c.instance_material=e.controllers[r].instance_material,e.geometries.push(c),s=!0,i=e.controllers[r]}else if(Ne[h.skin.source]){var l=Ne[h.skin.source];if(n=l,l.morph&&Se[l.morph.source]){var c=new u;c.url=l.morph.source,c.instance_material=e.controllers[r].instance_material,e.geometries.push(c)}}break;case"morph":if(Se[h.morph.source]){var c=new u;c.url=h.morph.source,c.instance_material=e.controllers[r].instance_material,e.geometries.push(c),n=e.controllers[r]}console.log("ColladaLoader: Morph-controller partially supported.")}}var d={};for(r=0;r<e.geometries.length;r++){var f,p=e.geometries[r],m=p.instance_material,g=Se[p.url],v={},E=[],y=0;if(g){if(!g.mesh||!g.mesh.primitives)continue;if(0===o.name.length&&(o.name=g.id),m)for(a=0;a<m.length;a++){var T=m[a],w=Ce[T.target],b=w.instance_effect.url,M=Oe[b].shader,A=M.material;if(g.doubleSided){if(!(T.symbol in d)){var R=A.clone();R.side=THREE.DoubleSide,d[T.symbol]=R}A=d[T.symbol]}A.opacity=A.opacity?A.opacity:1,v[T.symbol]=y,E.push(A),f=A,f.name=null===w.name||""===w.name?w.id:w.name,y++}var x,H=f||new THREE.MeshLambertMaterial({color:14540253,side:g.doubleSided?THREE.DoubleSide:THREE.FrontSide}),_=g.mesh.geometry3js;if(y>1)for(H=new THREE.MeshFaceMaterial(E),a=0;a<_.faces.length;a++){var k=_.faces[a];k.materialIndex=v[k.daeMaterial]}void 0!==i?(J(_,i),_.morphTargets.length>0?(H.morphTargets=!0,H.skinning=!1):(H.morphTargets=!1,H.skinning=!0),x=new THREE.SkinnedMesh(_,H,!1),x.name="skin_"+Re.length,Re.push(x)):void 0!==n?(createMorph(_,n),H.morphTargets=!0,x=new THREE.Mesh(_,H),x.name="morph_"+Ae.length,Ae.push(x)):x=_.isLineStrip===!0?new THREE.Line(_):new THREE.Mesh(_,H),o.add(x)}}for(r=0;r<e.cameras.length;r++){var j=e.cameras[r],N=Ge[j.url],S=new THREE.PerspectiveCamera(N.yfov,parseFloat(N.aspect_ratio),parseFloat(N.znear),parseFloat(N.zfar));o.add(S)}for(r=0;r<e.lights.length;r++){var C=null,O=e.lights[r],G=Ie[O.url];if(G&&G.technique){var I,L=G.color.getHex(),P=G.intensity,D=G.distance,U=G.falloff_angle;switch(G.technique){case"directional":C=new THREE.DirectionalLight(L,P,D),C.position.set(0,0,1);break;case"point":C=new THREE.PointLight(L,P,D);break;case"spot":C=new THREE.SpotLight(L,P,D,U,I),C.position.set(0,0,1);break;case"ambient":C=new THREE.AmbientLight(L)}}C&&o.add(C)}if(o.name=e.name||e.id||"",o.colladaId=e.id||"",o.layer=e.layer||"",o.matrix=e.matrix,o.matrix.decompose(o.position,o.quaternion,o.scale),Fe.centerGeometry&&o.geometry){var F=o.geometry.center();F.multiply(o.scale),F.applyQuaternion(o.quaternion),o.position.sub(F)}for(r=0;r<e.nodes.length;r++)o.add(W(e.nodes[r],e));return o}function K(e){if(e.channels&&e.channels.length){for(var t=[],i=[],n=0,r=e.channels.length;r>n;n++){var a,o=e.channels[n],s=o.fullSid,h=o.sampler,c=h.input,u=e.getTransformBySid(o.sid);if(o.arrIndices){a=[];for(var l=0,d=o.arrIndices.length;d>l;l++)a[l]=oe(o.arrIndices[l])}else a=he(o.member);if(u){-1===i.indexOf(s)&&i.push(s);for(var l=0,d=c.length;d>l;l++){var f=c[l],p=h.getData(u.type,l,a),m=$(t,f);if(!m){m=new N(f);var g=ee(t,f);t.splice(-1===g?t.length:g,0,m)}m.addTarget(s,u,a,p)}}else console.log('Could not find transform "'+o.sid+'" in node '+e.id)}for(var n=0;n<i.length;n++)for(var v=i[n],l=0;l<t.length;l++){var m=t[l];m.hasTarget(v)||de(t,m,l,v)}e.keys=t,e.sids=i}}function Q(e,t){e.doubleSided=!1;var i=t.querySelectorAll("extra double_sided")[0];i&&i&&1===parseInt(i.textContent,10)&&(e.doubleSided=!0)}function $(e,t){for(var i=null,n=0,r=e.length;r>n&&null===i;n++){var a=e[n];if(a.time===t)i=a;else if(a.time>t)break}return i}function ee(e,t){for(var i=-1,n=0,r=e.length;r>n&&-1===i;n++){var a=e[n];a.time>=t&&(i=n)}return i}function te(e,t){if(Fe.convertUpAxis===!0&&De!==Fe.upAxis)switch(Ue){case"XtoY":var i=e[0];e[0]=t*e[1],e[1]=i;break;case"XtoZ":var i=e[2];e[2]=e[1],e[1]=e[0],e[0]=i;break;case"YtoX":var i=e[0];e[0]=e[1],e[1]=t*i;break;case"YtoZ":var i=e[1];e[1]=t*e[2],e[2]=i;break;case"ZtoX":var i=e[0];e[0]=e[1],e[1]=e[2],e[2]=i;break;case"ZtoY":var i=e[1];e[1]=e[2],e[2]=t*i}}function ie(e){var t=[],i=function(e,t,n){var r={};r.name=t.sid,r.parent=e,r.matrix=t.matrix;var a=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];r.matrix.decompose(a[0],a[1],a[2]),r.pos=[a[0].x,a[0].y,a[0].z],r.scl=[a[2].x,a[2].y,a[2].z],r.rotq=[a[1].x,a[1].y,a[1].z,a[1].w],n.push(r);for(var o in t.nodes)i(t.sid,t.nodes[o],n)};return i(-1,e,t),t}function ne(e,t){if(Fe.convertUpAxis!==!0||De===Fe.upAxis)return t;switch(e){case"X":t="XtoY"===Ue?-1*t:t;break;case"Y":t="YtoZ"===Ue||"YtoX"===Ue?-1*t:t;break;case"Z":t="ZtoY"===Ue?-1*t:t}return t}function re(e,t){var i=[e[t],e[t+1],e[t+2]];return te(i,-1),new THREE.Vector3(i[0],i[1],i[2])}function ae(e){if(Fe.convertUpAxis){var t=[e[0],e[4],e[8]];te(t,-1),e[0]=t[0],e[4]=t[1],e[8]=t[2],t=[e[1],e[5],e[9]],te(t,-1),e[1]=t[0],e[5]=t[1],e[9]=t[2],t=[e[2],e[6],e[10]],te(t,-1),e[2]=t[0],e[6]=t[1],e[10]=t[2],t=[e[0],e[1],e[2]],te(t,-1),e[0]=t[0],e[1]=t[1],e[2]=t[2],t=[e[4],e[5],e[6]],te(t,-1),e[4]=t[0],e[5]=t[1],e[6]=t[2],t=[e[8],e[9],e[10]],te(t,-1),e[8]=t[0],e[9]=t[1],e[10]=t[2],t=[e[3],e[7],e[11]],te(t,-1),e[3]=t[0],e[7]=t[1],e[11]=t[2]}return(new THREE.Matrix4).set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function oe(e){if(e>-1&&3>e){var t=["X","Y","Z"],i={X:0,Y:1,Z:2};e=he(t[e]),e=i[e]}return e}function se(e){var t=[],i=1e6,n=-1e6;for(var r in je)for(var a=je[r],o=0;o<a.channel.length;o++){var s=a.channel[o],h=a.sampler[o],r=s.target.split("/")[0];r==e.id&&(h.create(),s.sampler=h,i=Math.min(i,h.startTime),n=Math.max(n,h.endTime),t.push(s))}return t.length&&(e.startTime=i,e.endTime=n),t}function he(e){if(Fe.convertUpAxis)switch(e){case"X":switch(Ue){case"XtoY":case"XtoZ":case"YtoX":e="Y";break;case"ZtoX":e="Z"}break;case"Y":switch(Ue){case"XtoY":case"YtoX":case"ZtoX":e="X";break;case"XtoZ":case"YtoZ":case"ZtoY":e="Z"}break;case"Z":switch(Ue){case"XtoZ":e="X";break;case"YtoZ":case"ZtoX":case"ZtoY":e="Y"}}return e}function ce(e){for(var t=xe.querySelectorAll("library_nodes node"),i=0;i<t.length;i++){var n=t[i].attributes.getNamedItem("id");if(n&&n.value===e)return t[i]}}function ue(e,t,i){for(;i<e.length;i++){var n=e[i];if(n.hasTarget(t))return n}return null}function le(e,t,i){for(i=i>=0?i:i+e.length;i>=0;i--){var n=e[i];if(n.hasTarget(t))return n}return null}function de(e,t,i,n){var r=le(e,n,i?i-1:0),a=ue(e,n,i+1);if(r&&a){var o,s=(t.time-r.time)/(a.time-r.time),h=r.getTarget(n),c=a.getTarget(n).data,u=h.data;if("matrix"===h.type)o=u;else if(u.length){o=[];for(var l=0;l<u.length;++l)o[l]=u[l]+(c[l]-u[l])*s}else o=u+(c-u)*s;t.addTarget(n,h.transform,h.member,o)}}function fe(e){var t=ve.getChildById(e.colladaId,!0),i=null;if(t&&t.keys){i={fps:60,hierarchy:[{node:t,keys:t.keys,sids:t.sids}],node:e,name:"animation_"+e.name,length:0},ye.push(i);for(var n=0,r=t.keys.length;r>n;n++)i.length=Math.max(i.length,t.keys[n].time)}else i={hierarchy:[{keys:[],sids:[]}]};for(var n=0,r=e.children.length;r>n;n++)for(var a=fe(e.children[n]),o=0,s=a.hierarchy.length;s>o;o++)i.hierarchy.push({keys:[],sids:[]});return i}function pe(e,t,i,n){if(e.world=e.world||new THREE.Matrix4,e.localworld=e.localworld||new THREE.Matrix4,e.world.copy(e.matrix),e.localworld.copy(e.matrix),e.channels&&e.channels.length){var r=e.channels[0],a=r.sampler.output[i];a instanceof THREE.Matrix4&&(e.world.copy(a),e.localworld.copy(a),0===i&&e.matrix.copy(a))}n&&e.world.multiplyMatrices(n,e.world),t.push(e);for(var o=0;o<e.nodes.length;o++)pe(e.nodes[o],t,i,e.world)}function me(e,t){for(var i=0;i<e.length;i++){var n=e[i],r=-1;if("JOINT"==n.type){for(var a=0;a<t.joints.length;a++)if(n.sid===t.joints[a]){r=a;break}if(r>=0){var o=t.invBindMatrices[r];n.invBindMatrix=o,n.skinningMatrix=new THREE.Matrix4,n.skinningMatrix.multiplyMatrices(n.world,o),n.animatrix=new THREE.Matrix4,n.animatrix.copy(n.localworld),n.weights=[];for(var a=0;a<t.weights.length;a++)for(var s=0;s<t.weights[a].length;s++){var h=t.weights[a][s];h.joint===r&&n.weights.push(h)}}else console.warn("ColladaLoader: Could not find joint '"+n.sid+"'."),n.skinningMatrix=new THREE.Matrix4,n.weights=[]}}}function ge(e,t,i){var n=[];pe(t,n,-1),me(n,i.skin);for(var r=new THREE.Vector3,a=[],o=0;o<e.vertices.length;o++)a.push(new THREE.Vector3);for(var o=0;o<n.length;o++)if("JOINT"==n[o].type)for(var s=0;s<n[o].weights.length;s++){var h=n[o].weights[s],c=h.index,u=h.weight,l=e.vertices[c],d=a[c];r.x=l.x,r.y=l.y,r.z=l.z,r.applyMatrix4(n[o].skinningMatrix),d.x+=r.x*u,d.y+=r.y*u,d.z+=r.z*u}for(var o=0;o<e.vertices.length;o++)e.vertices[o]=a[o]}var ve,Ee,ye,Te,we,be,Me,Ae,Re,xe=null,He=null,_e={},ke={},je={},Ne={},Se={},Ce={},Oe={},Ge={},Ie={},Le=THREE.SmoothShading,Pe=1,De="Y",Ue=null,Fe={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null};AMTHREE.ColladaLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},AMTHREE.ColladaLoader.prototype={constructor:AMTHREE.ColladaLoader,options:Fe,load:function(e,t,i,n){if(document.implementation&&document.implementation.createDocument){var r=this,a=new THREE.XHRLoader(this.manager);return a.setCrossOrigin(this.crossOrigin),new Promise(function(o,s){a.load(e,function(i){var n=e.split("/");n.pop(),Me=(n.length<1?".":n.join("/"))+"/",o(r.parse(i,e).then(function(e){return t(e),e}))},i,function(e){n(e),s(e)})})}alert("Don't know how to parse XML!")},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(i){return xe=(new DOMParser).parseFromString(i,"application/xml"),this.parseAsset(),this.setUpConversion(),Ce=this.parseLib("library_materials material",w,"material"),Oe=this.parseLib("library_effects effect",x,"effect"),Se=this.parseLib("library_geometries geometry",l,"geometry"),Ge=this.parseLib("library_cameras camera",S,"camera"),Ie=this.parseLib("library_lights light",O,"light"),Ne=this.parseLib("library_controllers controller",t,"controller"),je=this.parseLib("library_animations animation",_,"animation"),we=this.parseLib("library_visual_scenes visual_scene",a,"visual_scene"),be=this.parseLib("library_kinematics_models kinematics_model",I,"kinematics_model"),this.parseImages("library_images image",e,"image").then(function(e){ke=e,Ae=[],Re=[],ve=this.parseScene(),He=new THREE.Group;for(var t=0;t<ve.nodes.length;t++)He.add(W(ve.nodes[t]));He.scale.multiplyScalar(Pe),this.createAnimations(),Ee=this.parseKinematicsModel(),this.createKinematics();var i={scene:He,morphs:Ae,skins:Re,animations:ye,kinematics:Te,dae:{images:ke,materials:Ce,cameras:Ge,lights:Ie,effects:Oe,geometries:Se,controllers:Ne,animations:je,visualScenes:we,visualScene:ve,scene:ve,kinematicsModels:be,kinematicsModel:Ee}};return i})},setPreferredShading:function(e){Le=e},parseAsset:function(){var e=xe.querySelectorAll("asset"),t=e[0];if(t&&t.childNodes)for(var i=0;i<t.childNodes.length;i++){var n=t.childNodes[i];switch(n.nodeName){case"unit":var r=n.getAttribute("meter");
r&&(Pe=parseFloat(r));break;case"up_axis":De=n.textContent.charAt(0)}}},parseImages:function(e,t,n){var r=xe.querySelectorAll(e),a={};return Promise.all(r.map(function(e){return Promise.resolve(function(){return(new t).parse(e)}).then(function(e){e.id&&0!==e.id.length||(e.id=n+i++),a[e.id]=e})})).then(function(){return a})},parseLib:function(e,t,i){for(var n=xe.querySelectorAll(e),r={},a=0,o=n.length,s=0;o>s;s++){var h=n[s],c=(new t).parse(h);c.id&&0!==c.id.length||(c.id=i+a++),r[c.id]=c}return r},parseScene:function(){var e=xe.querySelectorAll("scene instance_visual_scene")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return we[t.length>0?t:"visual_scene0"]}return null},parseKinematicsModel:function(){var e=xe.querySelectorAll("instance_kinematics_model")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return be[t.length>0?t:"kinematics_model0"]}return null},createAnimations:function(){ye=[],fe(He)},recurseHierarchy:function(e){var t=ve.getChildById(e.colladaId,!0),i=null;if(t&&t.keys){i={fps:60,hierarchy:[{node:t,keys:t.keys,sids:t.sids}],node:e,name:"animation_"+e.name,length:0},ye.push(i);for(var n=0,r=t.keys.length;r>n;n++)i.length=Math.max(i.length,t.keys[n].time)}else i={hierarchy:[{keys:[],sids:[]}]};for(var n=0,r=e.children.length;r>n;n++)for(var a=fe(e.children[n]),o=0,s=a.hierarchy.length;s>o;o++)i.hierarchy.push({keys:[],sids:[]});return i},createMorph:function(e,t){var i=t instanceof h?Ne[t.url]:t;if(!i||!i.morph)return void console.log("could not find morph controller!");for(var n=i.morph,r=0;r<n.targets.length;r++){var a=n.targets[r],o=Se[a];if(o.mesh&&o.mesh.primitives&&o.mesh.primitives.length){var s=o.mesh.primitives[0].geometry;s.vertices.length===e.vertices.length&&e.morphTargets.push({name:"target_1",vertices:s.vertices})}}e.morphTargets.push({name:"target_Z",vertices:e.vertices})},createSkin:function(e,t,i){var n=Ne[t.url];if(!n||!n.skin)return void console.log("could not find skin controller!");if(!t.skeleton||!t.skeleton.length)return void console.log("could not find the skeleton for the skin!");var r=n.skin;ve.getChildById(t.skeleton[0]);i=void 0!==i?i:!0;if(e.skinWeights=[],e.skinIndices=[],i)for(var a=0;a<e.vertices.length;a++)e.vertices[a].applyMatrix4(r.bindShapeMatrix)},createKinematics:function(){if(Ee&&0===Ee.joints.length)return void(Te=void 0);var e={},t=function(t,i){var n=i.getAttribute("id"),r=ve.getChildById(n,!0),a=Ee.joints[t];He.traverse(function(i){i.colladaId==n&&(e[t]={node:i,transforms:r.transforms,joint:a,position:a.zeroPosition})})};Te={joints:Ee&&Ee.joints,getJointValue:function(t){var i=e[t];return i?i.position:void console.log("getJointValue: joint "+t+" doesn't exist")},setJointValue:function(t,i){var r=e[t];if(r){var a=r.joint;if(i>a.limits.max||i<a.limits.min)console.log("setJointValue: joint "+t+" value "+i+" outside of limits (min: "+a.limits.min+", max: "+a.limits.max+")");else if(a["static"])console.log("setJointValue: joint "+t+" is static");else{var o=r.node,s=a.axis,h=r.transforms,c=new THREE.Matrix4;for(n=0;n<h.length;n++){var u=h[n];if(u.sid&&-1!==u.sid.indexOf("joint"+t))switch(a.type){case"revolute":c.multiply(l.makeRotationAxis(s,THREE.Math.degToRad(i)));break;case"prismatic":c.multiply(l.makeTranslation(s.x*i,s.y*i,s.z*i));break;default:console.warn("setJointValue: unknown joint type: "+a.type)}else{var l=new THREE.Matrix4;switch(u.type){case"matrix":c.multiply(u.obj);break;case"translate":c.multiply(l.makeTranslation(u.obj.x,u.obj.y,u.obj.z));break;case"rotate":c.multiply(l.makeRotationAxis(u.obj,u.angle))}}}var d=c.elements,f=Array.prototype.slice.call(d),p=[f[0],f[4],f[8],f[12],f[1],f[5],f[9],f[13],f[2],f[6],f[10],f[14],f[3],f[7],f[11],f[15]];o.matrix.set.apply(o.matrix,p),o.matrix.decompose(o.position,o.quaternion,o.scale)}}else console.log("setJointValue: joint "+t+" doesn't exist")}};var i=xe.querySelector("scene instance_kinematics_scene");if(i)for(var n=0;n<i.childNodes.length;n++){var r=i.childNodes[n];if(1==r.nodeType)switch(r.nodeName){case"bind_joint_axis":var a=r.getAttribute("target").split("/").pop(),o=r.querySelector("axis param").textContent,s=parseInt(o.split("joint").pop().split(".")[0]),h=xe.querySelector('[sid="'+a+'"]');if(h){var c=h.parentElement;t(s,c)}}}},getJointId:function(e,t){for(var i=0;i<e.joints.length;i++)if(e.joints[i]===t)return i},calcFrameDuration:function(e){for(var t=1e7,i=0;i<e.channels.length;i++)for(var n=e.channels[i].sampler,r=0;r<n.input.length-1;r++){var a=n.input[r],o=n.input[r+1];t=Math.min(t,o-a)}return t},calcMatrixAt:function(e,t){var i,n,r={};for(i=0;i<e.channels.length;i++){var a=e.channels[i];r[a.sid]=a}var o=new THREE.Matrix4;for(i=0;i<e.transforms.length;i++){var s=e.transforms[i],a=r[s.sid];if(void 0!==a){var h,c=a.sampler;for(n=0;n<c.input.length-1;n++)if(c.input[n+1]>t){h=c.output[n];break}void 0!==h&&h instanceof THREE.Matrix4?o.multiplyMatrices(o,h):o.multiplyMatrices(o,s.matrix)}else o.multiplyMatrices(o,s.matrix)}return o},setUpConversion:function(){if(Fe.convertUpAxis!==!0||De===Fe.upAxis)Ue=null;else switch(De){case"X":Ue="Y"===Fe.upAxis?"XtoY":"XtoZ";break;case"Y":Ue="X"===Fe.upAxis?"YtoX":"YtoZ";break;case"Z":Ue="X"===Fe.upAxis?"ZtoX":"ZtoY"}}},e.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];"init_from"===i.nodeName&&(this.init_from=i.textContent)}return this},t.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.type="none";for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"skin":this.skin=(new r).parse(i),this.type=i.nodeName;break;case"morph":this.morph=(new n).parse(i),this.type=i.nodeName}}return this},n.prototype.parse=function(e){var t,i={},n=[];for(this.method=e.getAttribute("method"),this.source=e.getAttribute("source").replace(/^#/,""),t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"source":var a=(new T).parse(r);i[a.id]=a;break;case"targets":n=this.parseInputs(r);break;default:console.log(r.nodeName)}}for(t=0;t<n.length;t++){var o=n[t],a=i[o.source];switch(o.semantic){case"MORPH_TARGET":this.targets=a.read();break;case"MORPH_WEIGHT":this.weights=a.read()}}return this},n.prototype.parseInputs=function(e){for(var t=[],i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"input":t.push((new y).parse(n))}}return t},r.prototype.parse=function(e){var t,i,n={};this.source=e.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1==a.nodeType)switch(a.nodeName){case"bind_shape_matrix":var o=q(a.textContent);this.bindShapeMatrix=ae(o);break;case"source":var s=(new T).parse(a);n[s.id]=s;break;case"joints":t=a;break;case"vertex_weights":i=a;break;default:console.log(a.nodeName)}}return this.parseJoints(t,n),this.parseWeights(i,n),this},r.prototype.parseJoints=function(e,t){for(var i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"input":var r=(new y).parse(n),a=t[r.source];"JOINT"===r.semantic?this.joints=a.read():"INV_BIND_MATRIX"===r.semantic&&(this.invBindMatrices=a.read())}}},r.prototype.parseWeights=function(e,t){for(var i,n,r=[],a=0;a<e.childNodes.length;a++){var o=e.childNodes[a];if(1==o.nodeType)switch(o.nodeName){case"input":r.push((new y).parse(o));break;case"v":i=V(o.textContent);break;case"vcount":n=V(o.textContent)}}for(var s=0,a=0;a<n.length;a++){for(var h=n[a],c=[],u=0;h>u;u++){for(var l={},d=0;d<r.length;d++){var f=r[d],p=i[s+f.offset];switch(f.semantic){case"JOINT":l.joint=p;break;case"WEIGHT":l.weight=t[f.source].data[p]}}c.push(l),s+=r.length}for(var u=0;u<c.length;u++)c[u].index=a;this.weights.push(c)}},a.prototype.getChildById=function(e,t){for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildById(e,t);if(n)return n}return null},a.prototype.getChildBySid=function(e,t){for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildBySid(e,t);if(n)return n}return null},a.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.nodes=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"node":this.nodes.push((new o).parse(i))}}return this},o.prototype.getChannelForTransform=function(e){for(var t=0;t<this.channels.length;t++){var i,n,r=this.channels[t],a=r.target.split("/"),o=(a.shift(),a.shift()),s=o.indexOf(".")>=0,h=o.indexOf("(")>=0;if(s)a=o.split("."),o=a.shift(),n=a.shift();else if(h){i=o.split("("),o=i.shift();for(var c=0;c<i.length;c++)i[c]=parseInt(i[c].replace(/\)/,""))}if(o===e)return r.info={sid:o,dotSyntax:s,arrSyntax:h,arrIndices:i},r}return null},o.prototype.getChildById=function(e,t){if(this.id===e)return this;if(t)for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildById(e,t);if(n)return n}return null},o.prototype.getChildBySid=function(e,t){if(this.sid===e)return this;if(t)for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildBySid(e,t);if(n)return n}return null},o.prototype.getTransformBySid=function(e){for(var t=0;t<this.transforms.length;t++)if(this.transforms[t].sid===e)return this.transforms[t];return null},o.prototype.parse=function(e){var t;this.id=e.getAttribute("id"),this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.type=e.getAttribute("type"),this.layer=e.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE.Matrix4;for(var i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"node":this.nodes.push((new o).parse(n));break;case"instance_camera":this.cameras.push((new C).parse(n));break;case"instance_controller":this.controllers.push((new h).parse(n));break;case"instance_geometry":this.geometries.push((new u).parse(n));break;case"instance_light":this.lights.push((new G).parse(n));break;case"instance_node":t=n.getAttribute("url").replace(/^#/,"");var r=ce(t);r&&this.nodes.push((new o).parse(r));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new s).parse(n));break;case"extra":break;default:console.log(n.nodeName)}}return this.channels=se(this),K(this),this.updateMatrix(),this},o.prototype.updateMatrix=function(){this.matrix.identity();for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},s.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=q(e.textContent),this.convert(),this},s.prototype.convert=function(){switch(this.type){case"matrix":this.obj=ae(this.data);break;case"rotate":this.angle=THREE.Math.degToRad(this.data[3]);case"translate":te(this.data,-1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":te(this.data,1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},s.prototype.apply=function(){var e=new THREE.Matrix4;return function(t){switch(this.type){case"matrix":t.multiply(this.obj);break;case"translate":t.multiply(e.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":t.multiply(e.makeRotationAxis(this.obj,this.angle));break;case"scale":t.scale(this.obj)}}}(),s.prototype.update=function(e,t){var i=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(t)if(1===t.length)switch(t[0]){case 0:this.obj.n11=e[0],this.obj.n21=e[1],this.obj.n31=e[2],this.obj.n41=e[3];break;case 1:this.obj.n12=e[0],this.obj.n22=e[1],this.obj.n32=e[2],this.obj.n42=e[3];break;case 2:this.obj.n13=e[0],this.obj.n23=e[1],this.obj.n33=e[2],this.obj.n43=e[3];break;case 3:this.obj.n14=e[0],this.obj.n24=e[1],this.obj.n34=e[2],this.obj.n44=e[3]}else if(2===t.length){var n="n"+(t[0]+1)+(t[1]+1);this.obj[n]=e}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(e);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=i[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=i[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;case"ANGLE":this.angle=THREE.Math.degToRad(e);break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2],this.angle=THREE.Math.degToRad(e[3])}}},h.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1===i.nodeType)switch(i.nodeName){case"skeleton":this.skeleton.push(i.textContent.replace(/^#/,""));break;case"bind_material":for(var n=i.querySelectorAll("instance_material"),r=0;r<n.length;r++){var a=n[r];this.instance_material.push((new c).parse(a))}break;case"extra":}}return this},c.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},u.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType&&"bind_material"===i.nodeName){for(var n=i.querySelectorAll("instance_material"),r=0;r<n.length;r++){var a=n[r];this.instance_material.push((new c).parse(a))}break}}return this},l.prototype.parse=function(e){this.id=e.getAttribute("id"),Q(this,e);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"mesh":this.mesh=new d(this).parse(i);break;case"extra":}}return this},d.prototype.parse=function(e){this.primitives=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"source":U(i);break;case"vertices":this.vertices=(new E).parse(i);break;case"linestrips":this.primitives.push((new m).parse(i));break;case"triangles":this.primitives.push((new g).parse(i));break;case"polygons":this.primitives.push((new f).parse(i));break;case"polylist":this.primitives.push((new p).parse(i))}}if(this.geometry3js=new THREE.Geometry,null===this.vertices)return this;for(var n=_e[this.vertices.input.POSITION.source].data,t=0;t<n.length;t+=3)this.geometry3js.vertices.push(re(n,t).clone());for(var t=0;t<this.primitives.length;t++){var r=this.primitives[t];r.setVertices(this.vertices),this.handlePrimitive(r,this.geometry3js)}return this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this},d.prototype.handlePrimitive=function(e,t){if(e instanceof m)return void(t.isLineStrip=!0);var i,n,r,a,o,s,h,c=e.p,u=e.inputs,l=0,d=3,f=0,p=[];for(i=0;i<u.length;i++){r=u[i];var g=r.offset+1;switch(f=g>f?g:f,r.semantic){case"TEXCOORD":p.push(r.set)}}for(var v=0;v<c.length;++v)for(var E=c[v],y=0;y<E.length;){var T=[],w=[],b=null,M=[];for(d=e.vcount?e.vcount.length?e.vcount[l++]:e.vcount:E.length/f,i=0;d>i;i++)for(n=0;n<u.length;n++)switch(r=u[n],s=_e[r.source],a=E[y+i*f+r.offset],h=s.accessor.params.length,o=a*h,r.semantic){case"VERTEX":T.push(a);break;case"NORMAL":w.push(re(s.data,o));break;case"TEXCOORD":b=b||{},void 0===b[r.set]&&(b[r.set]=[]),b[r.set].push(new THREE.Vector2(s.data[o],s.data[o+1]));break;case"COLOR":M.push((new THREE.Color).setRGB(s.data[o],s.data[o+1],s.data[o+2]))}if(0===w.length)if(r=this.vertices.input.NORMAL){s=_e[r.source],h=s.accessor.params.length;for(var A=0,R=T.length;R>A;A++)w.push(re(s.data,T[A]*h))}else t.calcNormals=!0;if(!b&&(b={},r=this.vertices.input.TEXCOORD)){p.push(r.set),s=_e[r.source],h=s.accessor.params.length;for(var A=0,R=T.length;R>A;A++)o=T[A]*h,void 0===b[r.set]&&(b[r.set]=[]),b[r.set].push(new THREE.Vector2(s.data[o],1-s.data[o+1]))}if(0===M.length&&(r=this.vertices.input.COLOR)){s=_e[r.source],h=s.accessor.params.length;for(var A=0,R=T.length;R>A;A++)o=T[A]*h,M.push((new THREE.Color).setRGB(s.data[o],s.data[o+1],s.data[o+2]))}var x,H,_=null,k=[];if(3===d)k.push(new THREE.Face3(T[0],T[1],T[2],w,M.length?M:new THREE.Color));else if(4===d)k.push(new THREE.Face3(T[0],T[1],T[3],[w[0].clone(),w[1].clone(),w[3].clone()],M.length?[M[0],M[1],M[3]]:new THREE.Color)),k.push(new THREE.Face3(T[1],T[2],T[3],[w[1].clone(),w[2].clone(),w[3].clone()],M.length?[M[1],M[2],M[3]]:new THREE.Color));else if(d>4&&Fe.subdivideFaces){var j=M.length?M:new THREE.Color;for(n=1;d-1>n;)k.push(new THREE.Face3(T[0],T[n],T[n+1],[w[0].clone(),w[n++].clone(),w[n].clone()],j))}if(k.length)for(var A=0,R=k.length;R>A;A++)for(_=k[A],_.daeMaterial=e.material,t.faces.push(_),n=0;n<p.length;n++)x=b[p[n]],H=d>4?[x[0],x[A+1],x[A+2]]:4===d?0===A?[x[0],x[1],x[3]]:[x[1].clone(),x[2],x[3].clone()]:[x[0],x[1],x[2]],void 0===t.faceVertexUvs[n]&&(t.faceVertexUvs[n]=[]),t.faceVertexUvs[n].push(H);else console.log("dropped face with vcount "+d+" for geometry with id: "+t.id);y+=f*d}},f.prototype.setVertices=function(e){for(var t=0;t<this.inputs.length;t++)this.inputs[t].source===e.id&&(this.inputs[t].source=e.input.POSITION.source)},f.prototype.parse=function(e){this.material=e.getAttribute("material"),this.count=X(e,"count",0);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"input":this.inputs.push((new y).parse(e.childNodes[t]));break;case"vcount":this.vcount=V(i.textContent);break;case"p":this.p.push(V(i.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},p.prototype=Object.create(f.prototype),p.prototype.constructor=p,m.prototype=Object.create(f.prototype),m.prototype.constructor=m,g.prototype=Object.create(f.prototype),g.prototype.constructor=g,v.prototype.parse=function(e){this.params=[],this.source=e.getAttribute("source"),this.count=X(e,"count",0),this.stride=X(e,"stride",0);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if("param"===i.nodeName){var n={};n.name=i.getAttribute("name"),n.type=i.getAttribute("type"),this.params.push(n)}}return this},E.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++)if("input"===e.childNodes[t].nodeName){var i=(new y).parse(e.childNodes[t]);this.input[i.semantic]=i}return this},y.prototype.parse=function(e){return this.semantic=e.getAttribute("semantic"),this.source=e.getAttribute("source").replace(/^#/,""),this.set=X(e,"set",-1),this.offset=X(e,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},T.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"bool_array":this.data=F(i.textContent),this.type=i.nodeName;break;case"float_array":this.data=q(i.textContent),this.type=i.nodeName;break;case"int_array":this.data=V(i.textContent),this.type=i.nodeName;break;case"IDREF_array":case"Name_array":this.data=z(i.textContent),this.type=i.nodeName;break;case"technique_common":for(var n=0;n<i.childNodes.length;n++)if("accessor"===i.childNodes[n].nodeName){this.accessor=(new v).parse(i.childNodes[n]);break}}}return this},T.prototype.read=function(){var e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var i=0;i<this.data.length;i+=16){var n=this.data.slice(i,i+16),r=ae(n);e.push(r)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+t.type+".")}return e},w.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++)if("instance_effect"===e.childNodes[t].nodeName){this.instance_effect=(new H).parse(e.childNodes[t]);break}return this},b.prototype.isColor=function(){return null===this.texture},b.prototype.isTexture=function(){return null!=this.texture},b.prototype.parse=function(e){"transparent"===e.nodeName&&(this.opaque=e.getAttribute("opaque"));for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"color":var n=q(i.textContent);this.color=new THREE.Color,this.color.setRGB(n[0],n[1],n[2]),this.color.a=n[3];break;case"texture":this.texture=i.getAttribute("texture"),this.texcoord=i.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(i)}}return this},b.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&"extra"===e.childNodes[1].nodeName&&(e=e.childNodes[1],e.childNodes[1]&&"technique"===e.childNodes[1].nodeName&&(e=e.childNodes[1]));for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[i.nodeName]=parseFloat(i.textContent);break;case"wrapU":case"wrapV":"TRUE"===i.textContent.toUpperCase()?this.texOpts[i.nodeName]=1:this.texOpts[i.nodeName]=parseInt(i.textContent);break;default:this.texOpts[i.nodeName]=i.textContent}}return this},M.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"emission":case"diffuse":case"specular":case"transparent":this[i.nodeName]=(new b).parse(i);break;case"bump":var n=i.getAttribute("bumptype");n?"heightfield"===n.toLowerCase()?this.bump=(new b).parse(i):"normalmap"===n.toLowerCase()?this.normal=(new b).parse(i):(console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+n+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'"),this.bump=(new b).parse(i)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new b).parse(i));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var r=i.querySelectorAll("float");r.length>0&&(this[i.nodeName]=parseFloat(r[0].textContent))}}return this.create(),this},M.prototype.create=function(){var e={},t=!1;if(void 0!==this.transparency&&void 0!==this.transparent){var i=(this.transparent,(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency);i>0&&(t=!0,e.transparent=!0,e.opacity=1-i)}var n={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var r in this)switch(r){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var a=this[r];if(a instanceof b)if(a.isTexture()){var o=a.texture,s=this.effect.sampler[o];if(void 0!==s&&void 0!==s.source){var h=this.effect.surface[s.source];if(void 0!==h){var c=ke[h.init_from];if(c&&Me){var u,l=Me+c.init_from,d=THREE.Loader.Handlers.get(l);null!==d?u=d.load(l):(u=new THREE.Texture,Y(u,l)),u.wrapS=a.texOpts.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,u.wrapT=a.texOpts.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,u.offset.x=a.texOpts.offsetU,u.offset.y=a.texOpts.offsetV,u.repeat.x=a.texOpts.repeatU,u.repeat.y=a.texOpts.repeatV,e[n[r]]=u,"emission"===r&&(e.emissive=16777215)}}}}else"diffuse"!==r&&t||("emission"===r?e.emissive=a.color.getHex():e[r]=a.color.getHex());break;case"shininess":e[r]=this[r];break;case"reflectivity":e[r]=this[r],e[r]>0&&(e.envMap=Fe.defaultEnvMap),e.combine=THREE.MixOperation;break;case"index_of_refraction":e.refractionRatio=this[r],1!==this[r]&&(e.envMap=Fe.defaultEnvMap);break;case"transparency":}switch(e.shading=Le,e.side=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide,this.type){case"constant":void 0!=e.emissive&&(e.color=e.emissive),this.material=new THREE.MeshBasicMaterial(e);break;case"phong":case"blinn":void 0!=e.diffuse&&(e.color=e.diffuse),this.material=new THREE.MeshPhongMaterial(e);break;case"lambert":default:void 0!=e.diffuse&&(e.color=e.diffuse),this.material=new THREE.MeshLambertMaterial(e)}return this.material},A.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"init_from":this.init_from=i.textContent;break;case"format":this.format=i.textContent;break;default:console.log("unhandled Surface prop: "+i.nodeName)}}return this},R.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"source":this.source=i.textContent;break;case"minfilter":this.minfilter=i.textContent;break;case"magfilter":this.magfilter=i.textContent;break;case"mipfilter":this.mipfilter=i.textContent;break;case"wrap_s":this.wrap_s=i.textContent;break;case"wrap_t":this.wrap_t=i.textContent;break;default:console.log("unhandled Sampler2D prop: "+i.nodeName)}}return this},x.prototype.create=function(){return null===this.shader?null:void 0},x.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),Q(this,e),this.shader=null;for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(i))}}return this},x.prototype.parseNewparam=function(e){for(var t=e.getAttribute("sid"),i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"surface":this.surface[t]=new A(this).parse(n);break;case"sampler2D":this.sampler[t]=new R(this).parse(n);break;case"extra":break;default:console.log(n.nodeName)}}},x.prototype.parseProfileCOMMON=function(t){for(var i,n=0;n<t.childNodes.length;n++){var r=t.childNodes[n];if(1==r.nodeType)switch(r.nodeName){case"profile_COMMON":this.parseProfileCOMMON(r);break;case"technique":i=r;break;case"newparam":this.parseNewparam(r);break;case"image":var a=(new e).parse(r);ke[a.id]=a;break;case"extra":break;default:console.log(r.nodeName)}}return i},x.prototype.parseTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new M(i.nodeName,this).parse(i);break;case"extra":this.parseExtra(i)}}},x.prototype.parseExtra=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique":this.parseExtraTechnique(i)}}},x.prototype.parseExtraTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"bump":this.shader.parse(e)}}},H.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},_.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.source={};for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"animation":var n=(new _).parse(i);for(var r in n.source)this.source[r]=n.source[r];for(var a=0;a<n.channel.length;a++)this.channel.push(n.channel[a]),this.sampler.push(n.sampler[a]);break;case"source":var r=(new T).parse(i);this.source[r.id]=r;break;case"sampler":this.sampler.push(new j(this).parse(i));break;case"channel":this.channel.push(new k(this).parse(i))}}return this},k.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,""),this.target=e.getAttribute("target");var t=this.target.split("/"),i=(t.shift(),t.shift()),n=i.indexOf(".")>=0,r=i.indexOf("(")>=0;if(n)t=i.split("."),this.sid=t.shift(),this.member=t.shift();else if(r){var a=i.split("(");this.sid=a.shift();for(var o=0;o<a.length;o++)a[o]=parseInt(a[o].replace(/\)/,""));this.arrIndices=a}else this.sid=i;return this.fullSid=i,this.dotSyntax=n,this.arrSyntax=r,this},j.prototype.parse=function(e){this.id=e.getAttribute("id"),this.inputs=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"input":this.inputs.push((new y).parse(i))}}return this},j.prototype.create=function(){for(var e=0;e<this.inputs.length;e++){var t=this.inputs[e],i=this.animation.source[t.source];switch(t.semantic){case"INPUT":this.input=i.read();break;case"OUTPUT":this.output=i.read(),this.strideOut=i.accessor.stride;break;case"INTERPOLATION":this.interpolation=i.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(t.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(var e=0;e<this.input.length;e++)this.startTime=Math.min(this.startTime,this.input[e]),this.endTime=Math.max(this.endTime,this.input[e]);this.duration=this.endTime-this.startTime}},j.prototype.getData=function(e,t,i){var n;if("matrix"===e&&16===this.strideOut)n=this.output[t];else if(this.strideOut>1){n=[],t*=this.strideOut;for(var r=0;r<this.strideOut;++r)n[r]=this.output[t+r];if(3===this.strideOut)switch(e){case"rotate":case"translate":te(n,-1);break;case"scale":te(n,1)}else 4===this.strideOut&&"matrix"===e&&te(n,-1)}else n=this.output[t],i&&"translate"===e&&(n=ne(i,n));return n},N.prototype.addTarget=function(e,t,i,n){this.targets.push({sid:e,member:i,transform:t,data:n})},N.prototype.apply=function(e){for(var t=0;t<this.targets.length;++t){var i=this.targets[t];e&&i.sid!==e||i.transform.update(i.data,i.member)}},N.prototype.getTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return this.targets[t];return null},N.prototype.hasTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return!0;return!1},N.prototype.interpolate=function(e,t){for(var i=0,n=this.targets.length;n>i;i++){var r,a=this.targets[i],o=e.getTarget(a.sid);if("matrix"!==a.transform.type&&o){var s=(t-this.time)/(e.time-this.time),h=o.data,c=a.data;if(0>s&&(s=0),s>1&&(s=1),c.length){r=[];for(var u=0;u<c.length;++u)r[u]=c[u]+(h[u]-c[u])*s}else r=c+(h-c)*s}else r=a.data;a.transform.update(r,a.member)}},S.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"optics":this.parseOptics(i)}}return this},S.prototype.parseOptics=function(e){for(var t=0;t<e.childNodes.length;t++)if("technique_common"===e.childNodes[t].nodeName)for(var i=e.childNodes[t],n=0;n<i.childNodes.length;n++)if(this.technique=i.childNodes[n].nodeName,"perspective"===this.technique)for(var r=i.childNodes[n],a=0;a<r.childNodes.length;a++){var o=r.childNodes[a];switch(o.nodeName){case"yfov":this.yfov=o.textContent;break;case"xfov":this.xfov=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}}else if("orthographic"===this.technique)for(var s=i.childNodes[n],a=0;a<s.childNodes.length;a++){var o=s.childNodes[a];switch(o.nodeName){case"xmag":this.xmag=o.textContent;break;case"ymag":this.ymag=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}}return this},C.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},O.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique_common":this.parseCommon(i);break;case"technique":this.parseTechnique(i)}}return this},O.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++)switch(e.childNodes[t].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=e.childNodes[t].nodeName;for(var i=e.childNodes[t],n=0;n<i.childNodes.length;n++){var r=i.childNodes[n];switch(r.nodeName){case"color":var a=q(r.textContent);this.color=new THREE.Color(0),this.color.setRGB(a[0],a[1],a[2]),this.color.a=a[3];break;case"falloff_angle":this.falloff_angle=parseFloat(r.textContent);break;case"quadratic_attenuation":var o=parseFloat(r.textContent);this.distance=o?Math.sqrt(1/o):0}}}return this},O.prototype.parseTechnique=function(e){this.profile=e.getAttribute("profile");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){
case"intensity":this.intensity=parseFloat(i.textContent)}}return this},G.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},I.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.joints=[],this.links=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique_common":this.parseCommon(i)}}return this},I.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(e.childNodes[t].nodeName){case"joint":this.joints.push((new L).parse(i));break;case"link":this.links.push((new P).parse(i))}}return this},L.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this["static"]=!1,this.zeroPosition=0,this.middlePosition=0;var t=e.querySelector("axis"),i=q(t.textContent);this.axis=re(i,0);var n=e.querySelector("limits min")?parseFloat(e.querySelector("limits min").textContent):-360,r=e.querySelector("limits max")?parseFloat(e.querySelector("limits max").textContent):360;this.limits={min:n,max:r};for(var a=["prismatic","revolute"],o=0;o<a.length;o++){var s=a[o],h=e.querySelector(s);h&&(this.type=s)}return this.limits.min>=this.limits.max&&(this["static"]=!0),this.middlePosition=(this.limits.min+this.limits.max)/2,this},P.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.transforms=[],this.attachments=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"attachment_full":this.attachments.push((new D).parse(i));break;case"rotate":case"translate":case"matrix":this.transforms.push((new s).parse(i))}}return this},D.prototype.parse=function(e){this.joint=e.getAttribute("joint").split("/").pop(),this.links=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"link":this.links.push((new P).parse(i));break;case"rotate":case"translate":case"matrix":this.transforms.push((new s).parse(i))}}return this}}();var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.GifTexture=function(e){THREE.Texture.call(this),this.minFilter=THREE.NearestMipMapNearestFilter,this.imageElement=document.createElement("img");var t=document.getElementsByTagName("script");t=t[t.length-1],t.parentNode.appendChild(this.imageElement),this.imageElement.width=this.imageElement.naturalWidth,this.imageElement.height=this.imageElement.naturalHeight,e&&this.setGif(e)},AMTHREE.GifTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.GifTexture.prototype.constructor=AMTHREE.GifTexture,AMTHREE.GifTexture.prototype.play=function(){this.anim.play(),this.image=this.gifCanvas},AMTHREE.GifTexture.prototype.update=function(){this.needsUpdate=!0},AMTHREE.GifTexture.prototype.stop=function(){this.anim.move_to(0),this.image=void 0},AMTHREE.GifTexture.prototype.pause=function(){this.anim.pause()},AMTHREE.GifTexture.prototype.setGif=function(e){e.url&&(this.image_ref=e,this.imageElement.src=e.url,this.anim=new SuperGif({gif:this.imageElement,auto_play:!1}),this.anim.load(),this.gifCanvas=this.anim.get_canvas(),this.gifCanvas.style.display="none")},AMTHREE.GifTexture.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,this.image_ref&&(t.image=this.image_ref.uuid),t.animated=!0,this.image_ref.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.GifTexture=function(){console.warn("GifTexture.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Image=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url=t},AMTHREE.Image.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,t.url=AMTHREE.GetFilename(this.url),"object"==typeof e&&(e.images||(e.images={}),e.images[t.uuid]=t),t}):AMTHREE.Image=function(){console.warn("Image.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.ImageTexture=function(e){THREE.Texture.call(this),this.image=new Image,this.image.addEventListener("load",function(e){return function(){e.needsUpdate=!0}}(this)),this.set(e)},AMTHREE.ImageTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.ImageTexture.prototype.constructor=AMTHREE.ImageTexture,AMTHREE.ImageTexture.prototype.set=function(e){this.image_ref=e,this.image.src=e.url},AMTHREE.ImageTexture.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,t.image=this.image_ref.uuid,this.image_ref.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.ImageTexture=function(){console.warn("ImageTexture.js: THREE undefined")};var AMTHREE=AMTHREE||{};!function(){function e(e){return"undefined"!=typeof e&&null!=e}function t(t){t.traverse(function(t){e(t.material)&&e(t.material.map)&&(console.log(t,typeof t.material.map.image),window.setTimeout(function(t){return function(){if(console.log(t,typeof t.material.map.image),e(t.material.map.image)){var i=new AMTHREE.Image(void 0,t.material.map.image.src),n=new AMTHREE.ImageTexture(i);t.material.map=n,t.material.needsUpdate=!0}}}(t),100))})}AMTHREE.ObjectConvert=t}();var AMTHREE=AMTHREE||{};!function(){function e(e,t){e=e||{};var i={};return t?i.asset_path=t+"/":i.asset_path="",i.asset_path+=e.asset_path?e.asset_path+"/":"",i.image_path=i.asset_path+(e.image_path?e.image_path:""),i.video_path=i.asset_path+(e.video_path?e.video_path:""),i.model_path=i.asset_path+(e.model_path?e.model_path:""),i.sound_path=i.asset_path+(e.sound_path?e.sound_path:""),i}function t(e,t){var i={};if(e instanceof Array){var n=new THREE.MaterialLoader;n.setTextures(t);for(var r=0,a=e.length;a>r;r++){var o=n.parse(e[r]);i[o.uuid]=o}}else console.log("materials parsing failed: json not an array");return i}function n(e){var t=[];if(e instanceof Array)for(var i=0;i<e.length;i++){var n=THREE.AnimationClip.parse(e[i]);t.push(n)}else console.log("animations parsing failed: json not an array");return t}function r(e,t){var i={};if(e instanceof Array)for(var n=0,r=e.length;r>n;++n){var a=e[n];if(void 0===a.uuid)console.warn('failed to parse sound: no "uuid" specified for sound '+n);else if(void 0===a.url)console.warn('failed to parse sound: no "url" specified for sound '+n);else{var o=new AMTHREE.Sound(a.uuid,t+"/"+a.url);i[a.uuid]=o}}return i}function a(e,t){return new Promise(function(n,r){var a={};return e instanceof Array?Promise.all(e.map(function(e){return new Promise(function(n,r){if(void 0===e.url)r('failed to parse image: no "url" specified for image '+i);else if(void 0===e.uuid)r('failed to parse image: no "uuid" specified for image '+i);else{var o=new AMTHREE.Image(e.uuid,t+"/"+e.url);a[o.uuid]=o,n()}})})).then(n(a),r):void r("images parsing failed: json not an array")})}function o(e,t){var i={};if(e instanceof Array)for(var n=0,r=e.length;r>n;n++){var a=e[n];if(void 0===a.uuid)console.warn('failed to parse video: no "uuid" specified for video '+n);else if(void 0===a.url)console.warn('failed to parse video: no "url" specified for video '+n);else{var o=new AMTHREE.Video(a.uuid,t+"/"+a.url);i[a.uuid]=o}}return i}function s(e){return"number"==typeof e?e:(console.warn("AMTHREE.ObjectLoading: Constant should be in numeric form.",e),THREE[e])}function h(e,t,i){var n={};if("undefined"==typeof SuperGif&&console.warn("AMTHREE.ObjectLoading: SuperGif is undefined"),"undefined"!=typeof e)for(var r=0,a=e.length;a>r;r++){var o=e[r],h=void 0;if(o.uuid||console.warn("failed to parse texture "+r+": no uuid provided"),void 0!==o.image||void 0!==o.video){if(void 0!==o.image){if(void 0===t[o.image]){console.warn("failed to parse texture "+o.uuid+": undefined image",o.image);continue}var c=t[o.image];if(void 0!==o.animated&&o.animated){if("undefined"==typeof SuperGif)continue;h=new AMTHREE.GifTexture(c)}else h=new AMTHREE.ImageTexture(c),h.needsUpdate=!0}else{if(void 0===i[o.video]){console.warn("failed to parse texture "+o.uuid+": undefined video",o.video);continue}var u=i[o.video];h=new AMTHREE.VideoTexture(u,o.width,o.height,o.loop,o.autoplay)}h.uuid=o.uuid,void 0!==o.name&&(h.name=o.name),void 0!==o.mapping&&(h.mapping=s(o.mapping)),void 0!==o.offset&&(h.offset=new THREE.Vector2(o.offset[0],o.offset[1])),void 0!==o.repeat&&(h.repeat=new THREE.Vector2(o.repeat[0],o.repeat[1])),void 0!==o.minFilter?h.minFilter=s(o.minFilter):h.minFilter=THREE.LinearFilter,void 0!==o.magFilter&&(h.magFilter=s(o.magFilter)),void 0!==o.anisotropy&&(h.anisotropy=o.anisotropy),Array.isArray(o.wrap)&&(h.wrapS=s(o.wrap[0]),h.wrapT=s(o.wrap[1])),n[o.uuid]=h}else console.warn('failed to parse texture: no "image" nor "video" specified for '+o.uuid)}return n}function c(e){var t={};if("undefined"!=typeof e)for(var i=new THREE.JSONLoader,n=new THREE.BufferGeometryLoader,r=0,a=e.length;a>r;r++){var o,s=e[r];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":o=new THREE[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"CubeGeometry":o=new THREE.BoxGeometry(s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleBufferGeometry":o=new THREE.CircleBufferGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CircleGeometry":o=new THREE.CircleGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":o=new THREE.CylinderGeometry(s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"SphereGeometry":o=new THREE.SphereGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"SphereBufferGeometry":o=new THREE.SphereBufferGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":o=new THREE.DodecahedronGeometry(s.radius,s.detail);break;case"IcosahedronGeometry":o=new THREE.IcosahedronGeometry(s.radius,s.detail);break;case"OctahedronGeometry":o=new THREE.OctahedronGeometry(s.radius,s.detail);break;case"TetrahedronGeometry":o=new THREE.TetrahedronGeometry(s.radius,s.detail);break;case"RingGeometry":o=new THREE.RingGeometry(s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":o=new THREE.TorusGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":o=new THREE.TorusKnotGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.p,s.q,s.heightScale);break;case"BufferGeometry":o=n.parse(s);break;case"Geometry":o=i.parse(s.data,this.texturePath).geometry;break;default:console.warn('AMTHREE.ObjectLoading: Unsupported geometry type "'+s.type+'"');continue}o.uuid=s.uuid,void 0!==s.name&&(o.name=s.name),t[s.uuid]=o}return t}function u(e,t,i){return new Promise(function(n,r){var a=new AM.JsonLoader;a.Load(e,function(){t(a.json,i).then(n,r)},function(){r("failed to load object: "+e)})})}function l(e,t){return u(e,p,t)}function d(e,t){return u(e,m,t)}function f(i,s){var u=e(i.constants,s);return a(i.images||[],u.image_path).then(function(e){var a=r(i.sounds||[],u.sound_path),s=o(i.videos||[],u.video_path),l=h(i.textures||[],e,s),d=n(i.animations||[]),f=t(i.materials||[],l),p=c(i.geometries||[]),m={constants:u,videos:s,images:e,sounds:a,textures:l,animations:d,materials:f,geometries:p};return m})}function p(e,t){return f(e,t).then(function(t){return T(e.object,t.materials,t.geometries,t.sounds,t.constants.model_path).then(function(e){return e.animations=t.animations,e})})}function m(e,t){return f(e,t).then(function(t){return w(e.objects,t.materials,t.geometries,t.sounds,t.constants.model_path)})}function g(e,t,i,n,r,a){var o=new THREE.Matrix4;if(e.uuid=t.uuid,void 0!==t.name&&(e.name=t.name),void 0!==t.matrix?(o.fromArray(t.matrix),o.decompose(e.position,e.quaternion,e.scale)):(void 0!==t.position&&e.position.fromArray(t.position),void 0!==t.rotation&&e.rotation.fromArray(t.rotation),void 0!==t.scale&&e.scale.fromArray(t.scale),void 0!==t.scaleXYZ&&(e.scale.x*=t.scaleXYZ,e.scale.y*=t.scaleXYZ,e.scale.z*=t.scaleXYZ)),void 0!==t.castShadow&&(e.castShadow=t.castShadow),void 0!==t.receiveShadow&&(e.receiveShadow=t.receiveShadow),void 0!==t.visible&&(e.visible=t.visible),void 0!==t.userData&&(e.userData=t.userData),"LOD"===t.type)for(var s=t.levels,h=0;h<s.length;h++){var c=s[h],u=e.getObjectByProperty("uuid",c.object);void 0!==u&&e.addLevel(u,c.distance)}return void 0!==t.children?w(t.children,i,n,r,a).then(function(t){for(var i=0,n=t.length;n>i;++i)e.add(t[i]);return e}):Promise.resolve(e)}function v(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get geometry: no id provided"):console.warn("failed to get geometry: no such geometry: "+e))}function E(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get material: no id provided"):console.warn("failed to get material: no such material: "+e))}function y(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get sound: no id provided"):console.warn("failed to get sound: no such sound: "+e))}function T(e,t,i,n,r){var a,o;switch(e.type){case"OBJ":if(THREE.OBJLoader){var s=new THREE.OBJLoader;o=r+"/"+e.url,s.load(o,function(a){a.traverse(function(e){e.geometry&&e.geometry.computeBoundingSphere()}),g(a,e,t,i,n,r).then(resolve,reject)})}else reject("failed to load "+e.uuid+": THREE.OBJLoader is undefined");return;case"OBJMTL":if(THREE.OBJMTLLoader){var h=new THREE.OBJMTLLoader,c=r+"/"+e.objUrl,u=r+"/"+e.mtlUrl;h.load(c,u,function(a){a.traverse(function(e){e.geometry&&e.geometry.computeBoundingSphere()}),g(a,e,t,i,n,r).then(resolve,reject)})}else reject("failed to load "+e.uuid+": THREE.OBJMTLLoader is undefined");return;case"Collada":if(THREE.ColladaLoader){var l=new THREE.ColladaLoader;l.options.convertUpAxis=!0,o=r+"/"+e.url,l.load(o,function(a){var o=a.scene;g(o,e,t,i,n,r).then(resolve,reject)})}else reject("failed to load "+e.uuid+": THREE.ColladaLoader is undefined");return;case"SoundObject":a=new AMTHREE.SoundObject(y(e.sound,n));break;case"Scene":a=new THREE.Scene;break;case"PerspectiveCamera":a=new THREE.PerspectiveCamera(e.fov,e.aspect,e.near,e.far);break;case"OrthographicCamera":a=new THREE.OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far);break;case"AmbientLight":a=new THREE.AmbientLight(e.color);break;case"DirectionalLight":a=new THREE.DirectionalLight(e.color,e.intensity);break;case"PointLight":a=new THREE.PointLight(e.color,e.intensity,e.distance,e.decay);break;case"SpotLight":a=new THREE.SpotLight(e.color,e.intensity,e.distance,e.angle,e.exponent,e.decay);break;case"HemisphereLight":a=new THREE.HemisphereLight(e.color,e.groundColor,e.intensity);break;case"Mesh":a=new THREE.Mesh(v(e.geometry,i),E(e.material,t));break;case"LOD":a=new THREE.LOD;break;case"Line":a=new THREE.Line(v(e.geometry,i),E(e.material,t),e.mode);break;case"PointCloud":case"Points":a=new THREE.Points(v(e.geometry,i),E(e.material,t));break;case"Sprite":a=new THREE.Sprite(E(e.material,t));break;case"Group":a=new THREE.Group;break;default:a=new THREE.Object3D}return g(a,e,t,i,n,r)}function w(e,t,i,n,r){return e instanceof Array?Promise.all(e.map(function(e){return T(e,t,i,n,r)})):Promise.reject("failed to parse object array: json not an array")}function b(e){var t=new THREE.Box3,i=new THREE.Sphere,n=new THREE.Object3D;n.add(e),t.setFromObject(e),t.getBoundingSphere(i),n.scale.multiplyScalar(1/i.radius),i.center.divideScalar(i.radius),n.position.sub(i.center);var r=new THREE.Object3D;return r.add(n),r}function M(e){e.traverse(function(e){e instanceof THREE.Mesh&&e.geometry&&e.geometry.computeBoundingBox()})}function A(e){e.traverse(function(e){e instanceof THREE.Mesh&&e.geometry&&e.geometry.computeBoundingSphere()})}"undefined"!=typeof THREE&&(AMTHREE.ParseObject=p,AMTHREE.ParseObjectArray=m,AMTHREE.LoadObject=l,AMTHREE.LoadObjectArray=d,AMTHREE.NormalizeObject=b,AMTHREE.ComputeBoundingBox=M,AMTHREE.ComputeBoundingSphere=A)}();var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Sound=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url=t},AMTHREE.Sound.prototype.toJSON=function(e){var t={uuid:this.uuid,url:AMTHREE.GetFilename(this.url)};return e.sounds||(e.sounds={}),e.sounds[this.uuid]||(e.sounds[this.uuid]=t),t}):AMTHREE.Sound=function(){console.warn("Sound.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.SoundObject=function(e){THREE.Object3D.call(this),this.sound=e,this.audio=new Audio,this.audio.loop=!0,this.playing=!1},AMTHREE.SoundObject.prototype=Object.create(THREE.Object3D.prototype),AMTHREE.SoundObject.prototype.constructor=AMTHREE.SoundObject,AMTHREE.SoundObject.prototype.play=function(){this.playing=!0,this.audio.src=this.sound.url,this.audio.play()},AMTHREE.SoundObject.prototype.stop=function(){this.audio.src="",this.playing=!1},AMTHREE.SoundObject.prototype.pause=function(){this.audio.pause(),this.playing=!1},AMTHREE.SoundObject.prototype.setSound=function(e){this.sound=e,this.isPlaying()&&this.play()},AMTHREE.SoundObject.prototype.isPlaying=function(){return this.playing},AMTHREE.SoundObject.prototype.clone=function(){return(new AMTHREE.SoundObject).copy(this)},AMTHREE.SoundObject.prototype.copy=function(e){return this.setSound(e.sound),this},AMTHREE.SoundsCall=function(e,t){e.traverse(function(e){e instanceof AMTHREE.SoundObject&&e[t]&&e[t]()})},AMTHREE.PlaySounds=function(e){AMTHREE.SoundsCall(e,"play")},AMTHREE.PauseSounds=function(e){AMTHREE.SoundsCall(e,"pause")},AMTHREE.StopSounds=function(e){AMTHREE.SoundsCall(e,"stop")},AMTHREE.SoundObject.prototype.toJSON=function(e){var t=THREE.Object3D.prototype.toJSON.call(this,e);return this.sound.toJSON(e),t.object.type="SoundObject",t.object.sound=this.sound.uuid,t}):AMTHREE.SoundObject=function(){console.warn("SoundObject.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.TrackedObjManager=function(e){function t(e,t,i){e.position.lerp(t.position,i),e.quaternion.slerp(t.quaternion,i),e.scale.lerp(t.scale,i)}function i(){a.ForEach(function(e){e.enabled&&t(e.object,e.target,n.lerp_factor)})}e=e||{};var n=this,r=new THREE.Clock(!0),a=new AMTHREE.TrackedObjManager.prototype.Holder,o=i;this.camera=e.camera,this.lerp_factor=e.lerp_factor||.8,this.timeout=e.timeout||6,this.Add=function(e,t,i,n){a.Add(e,t,i,n)},this.Remove=function(e){a.Remove(e)},this.Clear=function(){a.Clear()},this.Update=function(){a.UpdateElapsed(r.getDelta()),a.CheckTimeout(n.timeout),o()},this.Track=function(){var e=new THREE.Matrix4,i=new THREE.Object3D;return function(r,o){if(n.camera){var s=a.Get(r);if(s){var h=s.target;return e.copy(n.camera.matrixWorld),e.multiply(o),s.enabled?(e.decompose(i.position,i.quaternion,i.scale),t(h,i,n.lerp_factor)):(e.decompose(h.position,h.quaternion,h.scale),e.decompose(s.object.position,s.object.quaternion,s.object.scale)),a.Track(r),!0}console.warn("TrackedObjManager: object "+r+" not found")}else console.warn("TrackedObjManager: camera is undefined");return!1}}(),this.TrackCompose=function(){var e=new THREE.Matrix4;return function(t,i,r,a){return e.compose(i,r,a),n.Track(t,e)}}(),this.TrackComposePosit=function(){var e=new THREE.Vector3,t=new THREE.Euler,i=new THREE.Quaternion,r=new THREE.Vector3;return function(a,o,s,h){return e.x=o[0],e.y=o[1],e.z=-o[2],t.x=-Math.asin(-s[1][2]),t.y=-Math.atan2(s[0][2],s[2][2]),t.z=Math.atan2(s[1][0],s[1][1]),r.x=h,r.y=h,r.z=h,i.setFromEuler(t),n.TrackCompose(a,e,i,r)}}(),this.GetObject=function(e){var t=a.get(e);return t?t.object:void 0}},AMTHREE.TrackedObjManager.prototype.Holder=function(){var e=this,t={};this.Add=function(e,i,n,r){t[i]={object:e,target:{position:e.position.clone(),quaternion:e.quaternion.clone(),scale:e.scale.clone()},elapsed:0,on_enable:n,on_disable:r,enabled:!1}},this.Remove=function(e){var i=t[e];i.enabled&&i.on_disable&&i.on_disable(i.object),delete t[e]},this.Clear=function(){for(var i in t)e.Remove(i)},this.Track=function(e){var i=t[e];i.elapsed=0,i.enabled||(i.enabled=!0,i.on_enable&&i.on_enable(i.object))},this.UpdateElapsed=function(e){for(var i in t)t[i].elapsed+=e},this.CheckTimeout=function(e){for(var i in t){var n=t[i];n.enabled&&n.elapsed>e&&(n.on_disable&&n.on_disable(n.object),n.enabled=!1)}},this.ForEach=function(e){for(var i in t)e(t[i])},this.Get=function(e){return t[e]}}):AMTHREE.TrackedObjManager=function(){console.warn("TrackedObjManager.js: THREE undefined")};var AMTHREE=AMTHREE||{};AMTHREE.AnimatedTextureCall=function(e,t){e.traverse(function(e){e.material&&e.material.map&&e.material.map[t]&&e.material.map[t]()})},AMTHREE.PlayAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"play")},AMTHREE.StopAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"stop")},AMTHREE.PauseAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"pause")},AMTHREE.UpdateAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"update")},AMTHREE.WorldToCanvasPosition=function(e,t,i){var n=new THREE.Vector3;n.copy(e),n.project(t);var r=Math.round((n.x+1)*i.width/2),a=Math.round((-n.y+1)*i.height/2);return{x:r,y:a,z:n.z}},AMTHREE.PlayAnimations=function(e){e.traverse(function(e){if(e instanceof THREE.SkinnedMesh){var t=new THREE.Animation(e,e.geometry.animation);t.play()}})},AMTHREE.GetFilename=function(e){return e.split("/").pop().split("\\").pop()},AMTHREE.IMAGE_PATH="images/",AMTHREE.MODEL_PATH="models/",AMTHREE.VIDEO_PATH="videos/",AMTHREE.SOUND_PATH="sounds/",AMTHREE.ASSET_PATH="assets/";var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Video=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url="string"==typeof t?t:void 0},AMTHREE.Video.prototype.toJSON=function(e){var t={uuid:this.uuid,url:AMTHREE.GetFilename(this.url)};return"object"==typeof e&&(e.videos||(e.videos={}),e.videos[t.uuid]=t),t}):AMTHREE.Video=function(){console.warn("Video.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.VideoTexture=function(e,t,i,n,r,a){THREE.Texture.call(this),this.uuid="string"==typeof t?t:THREE.Math.generateUUID(),this.minFilter=THREE.NearestMipMapNearestFilter,this.videoElement=document.createElement("video"),this.needsUpdate=!1,this.set(e,i,n,r,a)},AMTHREE.VideoTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.VideoTexture.prototype.constructor=AMTHREE.VideoTexture,AMTHREE.VideoTexture.prototype.play=function(){this.videoElement&&!this.playing&&this.video&&(this.paused||(this.videoElement.src=this.video.url),this.videoElement.setAttribute("crossorigin","anonymous"),this.videoElement.play(),this.image=this.videoElement,this.playing=!0)},AMTHREE.VideoTexture.prototype.update=function(){this.videoElement&&this.videoElement.readyState==this.videoElement.HAVE_ENOUGH_DATA&&(this.needsUpdate=!0)},AMTHREE.VideoTexture.prototype.pause=function(){this.videoElement&&!this.videoElement.paused&&(this.videoElement.pause(),this.playing=!1)},AMTHREE.VideoTexture.prototype.stop=function(){this.videoElement&&(this.pause(),this.videoElement.src="",this.image=void 0,this.needsUpdate=!0)},AMTHREE.VideoTexture.prototype.set=function(e,t,i,n,r){this.stop(),this.video=e,this.videoElement.width="number"==typeof t?t:void 0,this.videoElement.height="number"==typeof i?i:void 0,this.videoElement.autoplay="boolean"==typeof r?r:!1,this.videoElement.loop="boolean"==typeof n?n:!0,this.playing=!1,this.videoElement.autoplay&&this.play()},AMTHREE.VideoTexture.prototype.toJSON=function(e){var t={uuid:this.uuid,video:this.video.uuid,width:this.videoElement.width,height:this.videoElement.height,loop:this.videoElement.loop,autoplay:this.videoElement.autoplay};return this.video.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.VideoTexture=function(){console.warn("VideoTexture.js: THREE undefined")};var AM=AM||{};AM.Detection=function(){function e(e,t){var i=e*t;if(i>n.length)for(;--i>=0;)n[i]=new jsfeat.keypoint_t}var t={laplacian_threshold:30,eigen_threshold:25,detection_corners_max:500,border_size:15,fast_threshold:20},i=!1,n=[],r=0,a=new jsfeat.matrix_t(32,t.detection_corners_max,jsfeat.U8_t|jsfeat.C1_t);this.Detect=function(o){e(o.cols,o.rows),r=AM.DetectKeypointsYape06(o,n,t.detection_corners_max,t.laplacian_threshold,t.eigen_threshold,t.border_size),jsfeat.orb.describe(o,n,r,a),i&&console.log("Learn : "+r+" corners")},this.SetParameters=function(e){for(var i in e)"undefined"!=typeof t[i]&&(t[i]=e[i])},this.GetDescriptors=function(){return a},this.GetNumCorners=function(){return r},this.GetCorners=function(){return n}},AM.IcAngle=function(){var e=new Int32Array([15,15,15,15,14,14,14,13,13,12,11,10,9,8,6,3,0]),t=Math.PI/2;return function(i,n,r){var a=15,o=0,s=0,h=i.data,c=i.cols,u=0,l=0,d=r*c+n|0,f=0,p=0,m=0,g=0;for(u=-a;a>=u;++u)s+=u*h[d+u];for(l=1;a>=l;++l){for(f=0,p=e[l],u=-p;p>=u;++u)m=h[d+u+l*c],g=h[d+u-l*c],f+=m-g,s+=u*(m+g);o+=l*f}return AM.DiamondAngle(o,s)*t}}(),AM.DiamondAngle=function(e,t){return e>=0?t>=0?e/(t+e):1-t/(-t+e):0>t?2-e/(-t-e):3+t/(t-e)},AM.DetectKeypointsPostProc=function(e,t,i,n){i>n&&(jsfeat.math.qsort(t,0,i-1,function(e,t){return t.score<e.score}),i=n);for(var r=0;i>r;++r)t[r].angle=AM.IcAngle(e,t[r].x,t[r].y);return i},AM.DetectKeypointsYape06=function(e,t,i,n,r,a){jsfeat.yape06.laplacian_threshold=n,jsfeat.yape06.min_eigen_value_threshold=r;var o=jsfeat.yape06.detect(e,t,a);return o=AM.DetectKeypointsPostProc(e,t,o,i)},AM.DetectKeypointsFast=function(e,t,i,n,r){jsfeat.fast_corners.set_threshold(n);var a=jsfeat.fast_corners.detect(e,t,r||3);return a=AM.DetectKeypointsPostProc(e,t,a,i)};var AM=AM||{};AM.ImageFilter=function(){var e,t={blur_size:3,blur:!0};this.Filter=function(i){var n=i.width,r=i.height;e?e.resize(n,r,jsfeat.U8_t|jsfeat.C1_t):e=new jsfeat.matrix_t(n,r,jsfeat.U8_t|jsfeat.C1_t),jsfeat.imgproc.grayscale(i.data,n,r,e),t.blur&&jsfeat.imgproc.gaussian_blur(e,e,t.blur_size)},this.GetFilteredImage=function(){return e},this.SetParameters=function(e){for(var i in e)"undefined"!=typeof t[i]&&(t[i]=e[i])}};var AM=AM||{};AM.MarkerTracker=function(){var e,t=new AM.Training,i={},n=new AM.ImageFilter,r=new AM.Detection,a=new AM.Matching,o=new AM.Pose,s=!1,h={match_min:8},c=!1,u=new AM.Profiler;u.add("filter"),u.add("detection"),u.add("matching"),u.add("pose"),this.ComputeImage=function(e){u.new_frame(),u.start("filter"),n.Filter(e),u.stop("filter"),u.start("detection"),r.Detect(n.GetFilteredImage()),u.stop("detection")},this.Match=function(){u.start("matching"),s=!1,e=void 0,a.SetScreenDescriptors(r.GetDescriptors());for(var t in i){var n=i[t];if(n.IsActive()){a.Match(n.GetDescriptorsLevels());var l=a.GetNumMatches();if(s=l>=h.match_min,c&&console.log("nbMatches : "+l),s){var d=o.Pose(a.GetMatches(),l,r.GetCorners(),n.GetCornersLevels());if(s=d>=h.match_min,c&&console.log(" goodMatches : "+d),s){e=n;break}}}}return u.stop("matching"),s},this.GetMatchUuid=function(){return e.GetUuid()},this.GetPose=function(){if(s){u.start("pose");var t=o.GetPoseCorners(e.GetWidth(),e.GetHeight());return u.stop("pose"),t}},this.AddMarker=function(e,n){t.Train(e);var r=new AM.TrainedImage(n);t.SetResultToTrainedImage(r),t.Empty(),i[n]=r},this.RemoveMarker=function(e){i[e]&&delete i[e]},this.ActiveMarker=function(e,t){i[e]&&i[e].Active(t)},this.ActiveAllMarkers=function(e){for(var t in i)i[t].Active(e)},this.ClearMarkers=function(){i={}},this.GetScreenCorners=function(){return r.GetCorners()},this.GetNumScreenCorners=function(){return r.GetNumCorners()},this.GetMatches=function(){return a.GetMatches()},this.GetMatchesMask=function(){return o.GetMatchesMask()},this.GetProfiler=function(){return u.GetProfiler()},this.GetTrainedCorners=function(){var t=i[e.GetUuid()];return t.GetCornersLevels()},this.Log=function(){console.log(u.log()+(s?"<br/>match found":""))},this.SetParameters=function(e){for(var i in e)"undefined"!=typeof h[i]&&(h[i]=e[i]);t.SetParameters(e),n.SetParameters(e),r.SetParameters(e),a.SetParameters(e)}};var AM=AM||{};AM.Matching=function(){function e(e){return e-=e>>1&1431655765,e=(858993459&e)+(e>>2&858993459),16843009*(e+(e>>4)&252645135)>>24}function t(e,t){var i=e.rows,n=e.buffer.i32,r=0,h=0;a=[];for(var c=0;i>c;++c){for(var u=256,l=256,d=-1,f=-1,p=0,m=t.length;m>p;++p)for(var g=t[p],v=g.rows,E=g.buffer.i32,y=0,T=0;v>T;++T){for(var w=0,b=0;8>b;++b)w+=s(n[r+b]^E[y+b]);u>w?(l=u,u=w,f=p,d=T):l>w&&(l=w),y+=8}if(u<o.match_threshold){for(;a.length<=h;)a.push(new AM.match_t);a[h].screen_idx=c,a[h].pattern_lev=f,a[h].pattern_idx=d,h++}r+=8}return a.length=h,h}var n,r,a=[],o={match_threshold:48};this.SetScreenDescriptors=function(e){n=e},this.Match=function(e){return r=t(n,e)};var s=(function(){var e=[0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8],t=255;return function(i){var n=e[i&t];return i>>=8,n+=e[i&t],i>>=8,n+=e[i&t],i>>=8,n+=e[i&t]}}(),function(){var t=[];for(i=0;i<65536;++i)t.push(e(i));var n=65535;return function(e){var i=t[e&n];return e>>=16,i+=t[e&n]}}());this.GetMatches=function(){return a},this.GetNumMatches=function(){return r},this.SetParameters=function(e){for(var t in e)"undefined"!=typeof o[t]&&(o[t]=e[t])}},AM.match_t=function(e,t,i,n){this.screen_idx=e||0,this.pattern_lev=t||0,this.pattern_idx=i||0,this.distance=n||0};var AM=AM||{};AM.Pose=function(){function e(e,t,i,n,r,a){var o,s=new jsfeat.motion_model.homography2d,h=4,c=3,u=new jsfeat.ransac_params_t(h,c,.5,.99),l=[],d=[];for(o=0;t>o;++o){var f=e[o],p=r[f.screen_idx],m=a[f.pattern_lev][f.pattern_idx];l[o]={x:m.x,y:m.y},d[o]={x:p.x,y:p.y}}var g=!1;g=jsfeat.motion_estimator.ransac(u,s,l,d,t,i,n,1e3);var v=0;if(g){for(o=0;t>o;++o)n.data[o]&&(l[v].x=l[o].x,l[v].y=l[o].y,d[v].x=d[o].x,d[v].y=d[o].y,v++);s.run(l,d,i,v)}else jsfeat.matmath.identity_3x3(i,1);return v}function t(e,t,i){for(var n=[{x:0,y:0},{x:t,y:0},{x:t,y:i},{x:0,y:i}],r=0,a=0,o=0,s=0;4>s;++s)a=e[0]*n[s].x+e[1]*n[s].y+e[2],o=e[3]*n[s].x+e[4]*n[s].y+e[5],r=e[6]*n[s].x+e[7]*n[s].y+e[8],n[s].x=a/r,n[s].y=o/r;return n}var i=0,n=new jsfeat.matrix_t(3,3,jsfeat.F32C1_t),r=new jsfeat.matrix_t(500,1,jsfeat.U8C1_t);this.Pose=function(t,a,o,s){return i=e(t,a,n,r,o,s)},this.GetGoodCount=function(){return i},this.GetPoseCorners=function(e,i){return t(n.data,e,i)},this.GetMatchesMask=function(){return r}},AM.PosePosit=function(){this.posit=new POS.Posit(10,1),this.pose=void 0},AM.PosePosit.prototype.Set=function(e,t,i,n){t=t||35;for(var r=[],a=0;a<e.length;++a){var o=e[a].x-i/2,s=n/2-e[a].y;r.push({x:o,y:s})}this.pose=this.posit.pose(r)},AM.PosePosit.prototype.SetFocalLength=function(e){this.posit.focalLength=e},AM.PoseThree=function(){this.position=new THREE.Vector3,this.rotation=new THREE.Euler,this.quaternion=new THREE.Quaternion,this.scale=new THREE.Vector3},AM.PoseThree.prototype.Set=function(e,t){t=t||35;var i=e.bestRotation,n=e.bestTranslation;this.scale.x=t,this.scale.y=t,this.scale.z=t,this.rotation.x=-Math.asin(-i[1][2]),this.rotation.y=-Math.atan2(i[0][2],i[2][2]),this.rotation.z=Math.atan2(i[1][0],i[1][1]),this.position.x=n[0],this.position.y=n[1],this.position.z=-n[2],this.quaternion.setFromEuler(this.rotation)};var AM=AM||{};AM.TrainedImage=function(e){var t=!0,i=[],n=[],r=0,a=0,o=e,s=!0;this.GetCorners=function(e){return i[e]},this.GetDescriptors=function(e){return n[e]},this.GetLevelNbr=function(){return Math.min(n.length,i.length)},this.GetCornersLevels=function(){return i},this.GetDescriptorsLevels=function(){return n},this.GetWidth=function(){return r},this.GetHeight=function(){return a},this.Set=function(e,o,s,h){t=!1,i=e,n=o,r=s,a=h},this.IsEmpty=function(){return t},this.Empty=function(){t=!0,i=[],n=[]},this.SetUuid=function(e){
o=e},this.GetUuid=function(){return o},this.Active=function(e){s=e===!0},this.IsActive=function(){return s}};var AM=AM||{};AM.Training=function(){function e(e,n,o,s){var h=a[o],u=r[o];0!==o?(t(e,n,s),jsfeat.imgproc.gaussian_blur(n,n,c.blur_size)):jsfeat.imgproc.gaussian_blur(e,n,c.blur_size);var l=AM.DetectKeypointsYape06(n,h,c.training_corners_max,c.laplacian_threshold,c.eigen_threshold);if(h.length=l,jsfeat.orb.describe(n,h,l,u),0!==o)for(i=0;i<l;++i)h[i].x*=1/s,h[i].y*=1/s;console.log("train "+n.cols+"x"+n.rows+" points: "+l)}function t(e,t,i){if(1>i){var n=Math.round(e.cols*i),r=Math.round(e.rows*i);jsfeat.imgproc.resample(e,t,n,r)}else t.resize(e.cols,e.rows),e.copy_to(t)}function n(e,t){for(var i=0;i<c.num_train_levels;++i){a[i]=[];for(var n=a[i],o=e*t>>i;--o>=0;)n[o]=new jsfeat.keypoint_t(0,0,0,0,-1);r[i]=new jsfeat.matrix_t(32,c.training_corners_max,jsfeat.U8_t|jsfeat.C1_t)}}var r,a,o,s=0,h=0,c={num_train_levels:3,blur_size:3,image_size_max:512,training_corners_max:200,laplacian_threshold:30,eigen_threshold:25},u=Math.sqrt(2),l=[];this.Train=function(i){var o=0,l=1;r=[],a=[];var d=new jsfeat.matrix_t(i.width,i.height,jsfeat.U8_t|jsfeat.C1_t);jsfeat.imgproc.grayscale(i.data,i.width,i.height,d,jsfeat.COLOR_RGBA2GRAY);var f=Math.min(c.image_size_max/i.width,c.image_size_max/i.height),p=new jsfeat.matrix_t(i.width*f,i.height*f,jsfeat.U8_t|jsfeat.C1_t);s=p.cols,h=p.rows,t(d,p,f),n(p.cols,p.rows);var m=new jsfeat.matrix_t(p.cols,p.rows,jsfeat.U8_t|jsfeat.C1_t);for(e(p,m,0,l),o=1;o<c.num_train_levels;++o)l/=u,e(p,m,o,l)},cloneImage=function(e){var t=new jsfeat.matrix_t(e.cols,e.rows,jsfeat.U8_t|jsfeat.C1_t);return e.copy_to(t),t},this.TrainFull=function(i){var d=0,f=1;r=[],a=[],l=[];var p=new jsfeat.matrix_t(i.width,i.height,jsfeat.U8_t|jsfeat.C1_t);jsfeat.imgproc.grayscale(i.data,i.width,i.height,p,jsfeat.COLOR_RGBA2GRAY);var m=Math.min(c.image_size_max/i.width,c.image_size_max/i.height),g=new jsfeat.matrix_t(i.width*m,i.height*m,jsfeat.U8_t|jsfeat.C1_t);s=g.cols,h=g.rows,t(p,g,m),n(g.cols,g.rows);var v=new jsfeat.matrix_t(g.cols,g.rows,jsfeat.U8_t|jsfeat.C1_t);for(e(g,v,0,f),o=g,l[0]=cloneImage(v),d=1;d<c.num_train_levels;++d)f/=u,e(g,v,d,f),l[d]=cloneImage(v)},this.getGrayData=function(){return o},this.getBluredImages=function(){return l},this.SetResultToTrainedImage=function(e){e.Set(a,r,s,h)},this.IsEmpty=function(){return!r||!a},this.Empty=function(){r=void 0,a=void 0,l=void 0},this.SetParameters=function(e){for(var t in e)"undefined"!=typeof c[t]&&(c[t]=e[t])},this.GetScaleIncrement=function(){return u}};