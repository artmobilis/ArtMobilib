var compatibility=function(){var e=0,t=!0,n=window.URL||window.webkitURL||window.mozURL||window.msURL,i=function(t,n){var i=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,n){var i=(new Date).getTime(),r=Math.max(0,16-(i-e)),o=window.setTimeout(function(){t(i+r)},r);return e=i+r,o};return i.call(window,t,n)},r=function(e){var t=window.cancelAnimationFrame||function(e){clearTimeout(e)};return t.call(window,e)},o=function(e,t,n){var i=window.navigator.getUserMedia||window.navigator.mozGetUserMedia||window.navigator.webkitGetUserMedia||window.navigator.msGetUserMedia||function(e,t,n){n()};return i.call(window.navigator,e,t,n)},a=function(){var e=new ArrayBuffer(8),n=new Uint32Array(e);return n[0]=4278190080,t=!0,255===e[0]&&(t=!1),t};return{URL:n,requestAnimationFrame:i,cancelAnimationFrame:r,getUserMedia:o,detectEndian:a,isLittleEndian:t}}();!function(){AM=AM||{};var e=function(){this._listeners={}};e.prototype.AddListener=function(e,t){return"string"==typeof e&&("undefined"==typeof this._listeners[e]&&(this._listeners[e]=[]),-1==this._listeners[e].indexOf(t))?(this._listeners[e].push(t),!0):!1},e.prototype.RemoveListener=function(e,t){if("string"==typeof e){var n=this._listeners[e];if("undefined"!=typeof n){var i=n.indexOf(t);if(-1!=i)return 1!=n.length?n.splice(i,1):delete this._listeners[e],!0}}return!1},e.prototype.Fire=function(e,t){if("string"==typeof e){var n=this._listeners[e];if("undefined"!=typeof n){for(var i=0,r=n.length;r>i;++i)n[i].apply(this,t);return!0}}return!1},AM.EventManager=e}(),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL;var AM=AM||{};!function(){function e(){function e(){return u||(o&&o.Dispose(),u=!0,o=new t(s),a=o.Load().then(function(e){r=e})),a}function n(){r&&(r.getTracks()[0].stop(),r=void 0),o&&(o.Dispose(),o=void 0),a=Promise.resolve(),u=!1}function i(){return u}var r,o,a,s=document.createElement("video"),u=!1;s.setAttribute("autoplay",!0),s.style.position="absolute",s.style.top="0px",s.style.left="0px",s.style.width="100%",s.style.height="auto",this.domElement=s,n(),this.Start=e,this.Stop=n,this.IsActive=i}function t(e){function t(e){return new Promise(function(t,n){!function i(){u&&n("loader interrupted"),e.readyState===e.HAVE_ENOUGH_DATA?t():window.requestAnimationFrame(i)}()})}function n(n){var i=new Promise(function(e,t){u&&t("loader interrupted");for(var i={video:!0,audio:!1},r=0;r!=n.length;++r){var o=n[r];"video"==o.kind&&"environment"==o.facing&&(i.video={optional:[{sourceId:o.id}]})}navigator.getUserMedia(i,e,t)});return i=i.then(function(n){return e.src=window.URL.createObjectURL(n),t(e).then(function(){return n})})}function i(e){return new Promise(function(e,t){return u&&t("loader interrupted"),MediaStreamTrack.getSources(e)})}function r(e){return Promise.resolve(function(){return u&&reject("loader interrupted"),navigator.mediaDevices.enumerateDevices()})}function o(){return s=!0,new Promise(function(e,t){u&&t("loader interrupted");var o=i();o=o.then(function(t){n(t).then(e)}),o["catch"](function(){r().then(function(t){n(t).then(e)})["catch"](t)})})}function a(){u=!0}var s=!1,u=!1;this.Load=o,this.Dispose=a}AM.FrontCamGrabbing=e}();var AM=AM||{};getGradientGreenRedColor=function(e,t){function n(e){var t=parseInt(e).toString(16);return t.length<2?"0"+t:t}var i=255*e/t,r=255*(t-e)/t;return"#"+n(i)+n(r)+"00"},AM.ImageDebugger=function(){var e,t,n,i,r,o,a,s,u,c,d,h,f,l,p,m,E,g,v,T,y=new AM.Training,M=44,A=[],w=[],R=new AM.ImageLoader,H=!1,_=!0;this.DrawCorners=function(t){var n,i;if(H&&t&&(o=t.screen_corners,u=t.profiles,c=t.image_data,o.length)){for(e.fillStyle="red",n=0;n<o.length;++n)i=o[n],e.beginPath(),e.arc(i.x*h+f,i.y*h+l,3,0,2*Math.PI),e.fill();for(e.putImageData(c,m-c.width,M),n=0;n<o.length;++n)i=o[n],e.beginPath(),e.arc(i.x+m-c.width,i.y+M,3,0,2*Math.PI),e.fill();e.font="30px Arial",e.fillStyle="red",e.textAlign="left";var r="FPS: "+u.fps.toFixed(2)+"  ";for(n=0;n<u.timers.length;++n){var a=u.timers[n];r+=a[0]+": "+a[1].run_time+"ms  "}e.fillText(r,10,p-5-M)}},this.DebugMatching=function(e,t){H&&e&&t&&(i=e.corners,r=e.trained_corners,a=e.matches,s=e.matches_mask,n=t,e.uuid!=v&&(v=e.uuid,R.GetImageData(t,function(e){T=e,correctTrainingImageOffsets(),displayTrainingImages(!0),drawContour(),drawMatches(),_&&(displayTrainingImages(!1),drawTrainedCorners())},!1)),T&&(correctTrainingImageOffsets(),displayTrainingImages(!0),drawContour(),drawMatches(),_&&(displayTrainingImages(!1),drawTrainedCorners())))},correctTrainingImageOffsets=function(){var e;T.width>T.height?(e=T.width-T.height,E=0,g=-Math.round(e/2)):(e=T.height-T.width,E=-Math.round(e/2),g=0)},drawContour=function(){e.strokeStyle="green",e.lineWidth=5,e.beginPath(),e.moveTo(i[0].x*h+f,i[0].y*h+l),e.lineTo(i[1].x*h+f,i[1].y*h+l),e.lineTo(i[2].x*h+f,i[2].y*h+l),e.lineTo(i[3].x*h+f,i[3].y*h+l),e.lineTo(i[0].x*h+f,i[0].y*h+l),e.stroke()},drawMatches=function(t){"undefined"==typeof t&&(t=!1),e.lineWidth=2;for(var n=0;n<a.length;++n){var i=a[n],u=s.data[n],c=r[i.pattern_lev],d=c[i.pattern_idx],p=o[i.screen_idx];u?(e.fillStyle="blue",e.strokeStyle="blue"):(e.fillStyle="red",e.strokeStyle="red");var m=d.x+E,v=d.y+g;t||(m=m*w[i.pattern_lev]+A[i.pattern_lev],v*=w[i.pattern_lev]),e.beginPath(),e.arc(m,v+M,3,0,2*Math.PI),e.fill(),e.beginPath(),e.moveTo(m,v+M),e.lineTo(p.x*h+f,p.y*h+l),e.stroke(),e.beginPath(),e.arc(p.x*h+f,p.y*h+l,3,0,2*Math.PI),e.fill()}},jsFeat2ImageData=function(t){for(var n=e.createImageData(t.cols,t.rows),i=t.data.length,r=4*i+3;i--;)n.data[r-=4]=255,n.data[r-1]=n.data[r-2]=n.data[r-3]=t.data[i];return n},displayColor=function(t,n){e.putImageData(T,t,n)},displayTrainingImages=function(t){y.Empty(),y.TrainFull(T);var n=y.getBluredImages(),i=0;A[0]=0,w[0]=1;for(var r=0;r<n.length;++r)originy=M,t||(originy=p-35-M-n[r].rows),e.putImageData(jsFeat2ImageData(n[r]),i,originy),i+=n[r].cols,A[r+1]=A[r]+n[r].cols,w[r+1]=w[r]/y.GetScaleIncrement()},drawTrainedCorners=function(t){"undefined"==typeof t&&(t=50);var n=y.getBluredImages(),i=new AM.TrainedImage(d);y.SetResultToTrainedImage(i);for(var r=0;r<i.GetLevelNbr();++r)for(var o=i.GetCorners(r),a=(i.GetDescriptors(r),p-35-M-n[r].rows),s=0;t>s;++s){var u=o[s];e.fillStyle=getGradientGreenRedColor(t-s,t);var c=u.x+E,h=u.y+g;c=c*w[r]+A[r],h*=w[r],e.beginPath(),e.arc(c,h+a,3,0,2*Math.PI),e.fill()}},this.UpdateSize=function(e,n){p=e.height,m=e.width;var i=p,r=t.videoWidth/t.videoHeight,o=m/i;if(o>r){var a=Math.round(i*r);h=a/n,f=Math.round(.5*(m-a)),l=0}else{var s=m/r;h=m/n,f=0,l=Math.round(.5*(i-s))}},this.SetData=function(n,i,r){e=n,t=i,H=r||!1},this.SetDebug=function(e){H=e||!1}};var AM=AM||{};AM.ImageLoader=function(){var e=document.createElement("canvas"),t=e.getContext("2d");this.GetImageData=function(n,i,r){var o=new Image;o.onload=function(n,i,r){return function(){if(r){var o=Math.max(n.width,n.height),a=(o-n.width)/2,s=(o-n.height)/2;e.width=o,e.height=o,t.drawImage(n,a,s)}else e.width=n.width,e.height=n.height,t.drawImage(n,0,0,e.width,e.height);var u=t.getImageData(0,0,e.width,e.height);i(u)}}(o,i,r),o.src=n}};var AM=AM||{};AM.JsonLoader=function(){function e(e,t){d=!1,a=void 0,o=void 0,r=void 0,u=void 0,s=void 0,c.progress=0,e&&e(t)}function t(){try{c.json=JSON.parse(u.responseText),e(r)}catch(t){c.json={},e(o,"failed to parse file: "+s)}}function n(t){var n="JsonLoader failed to open file: "+s;console.log(n),e(o,n)}function i(e){c.progress=e.loaded/e.total*100,a&&a()}var r,o,a,s,u,c=this,d=!1;this.json={},this.progress=0,this.IsLoading=function(){return d},this.Load=function(e,c,h,f){d||(d=!0,r=c,o=h,a=f,s=e,u=new XMLHttpRequest,u.onprogress=i,u.open("GET",e,!0),u.onload=t,u.onerror=n,u.send(null))}},AM.LoadJson=function(e){return new Promise(function(t,n){var i=new AM.JsonLoader;i.Load(e,function(){t(i.json)},n)})};var AM=AM||{};AM.LoadingManager=function(){function e(e){for(var t=0,n=e.length;n>t;++t)e[t]()}var t=[],n=[],i=0;this.Start=function(t){t=t||1,i+=t,e(n)},this.End=function(r){r=r||1,i>0&&(i-=r,e(n)),0>=i&&(i=0,e(t),t.length=0,n.length=0)},this.OnEnd=function(e){i>0?t.push(e):e()},this.OnProgress=function(e){i>0?n.push(e):e()},this.IsLoading=function(){return i>0},this.GetRemaining=function(){return i}};var AM=AM||{};!function(){var e=function(){function e(){this.start_time=0,this.stop_time=0,this.run_time=0,this.running=!1}return e.prototype.start=function(){this.start_time=(new Date).getTime(),this.running=!0},e.prototype.stop=function(){this.stop_time=(new Date).getTime(),this.run_time=this.stop_time-this.start_time,this.running=!1},e.prototype.get_runtime=function(){return this.run_time},e.prototype.reset=function(){this.run_time=0},e}(),t=function(){function e(e){this.arr=new Int32Array(e),this.begin=0,this.end=-1,this.num_el=0,this.arr_size=e}return e.prototype.push_back=function(e){this.num_el<this.arr_size?(this.end++,this.arr[this.end]=e,this.num_el++):(this.end=(this.end+1)%this.arr_size,this.begin=(this.begin+1)%this.arr_size,this.arr[this.end]=e)},e.prototype.get=function(e){return this.arr[(this.begin+e)%this.arr_size]},e.prototype.size=function(){return this.num_el},e}(),n=function(){function n(){this.fps=0,this.timers=[],this.frame_timer=new e}var i=0,r=new t(20);return n.prototype.add=function(t){this.timers.push([t,new e])},n.prototype.new_frame=function(){++i;var e=0,t=0|this.timers.length;for(e=0;t>e;++e){var n=this.timers[e][1];n.reset()}if(i>=1){this.frame_timer.stop(),r.push_back(this.frame_timer.get_runtime());var o=r.size(),a=0;for(e=0;o>e;++e)a+=r.get(e);this.fps=o/a*1e3,this.frame_timer.start()}},n.prototype.find_task=function(e){var t=0|this.timers.length,n=0;for(n=0;t>n;++n){var i=this.timers[n];if(i[0]===e)return i}return null},n.prototype.start=function(e){var t=this.find_task(e);t[1].start()},n.prototype.stop=function(e){var t=this.find_task(e);t[1].stop()},n.prototype.log=function(){var e=0|this.timers.length,t=0,n="<strong>FPS: "+this.fps.toFixed(2)+"</strong>";for(t=0;e>t;++t){var i=this.timers[t];n+="<br/>"+i[0]+": "+i[1].get_runtime()+"ms"}return n},n.prototype.log2=function(){var e=0|this.timers.length,t=0,n="FPS: "+this.fps.toFixed(2)+"  ";for(t=0;e>t;++t){var i=this.timers[t];n+=i[0]+": "+i[1].get_runtime()+"ms  "}return n},n.prototype.GetProfiler=function(){return{fps:this.fps,timers:this.timers}},n}();AM.Profiler=n}();var AM=AM||{};AM.DeviceLockScreenOrientation=function(){function e(){window.cordova?(t(),a=!0):s=!1}function t(){for(var e=0,t=u.length;t>e;++e)u[e]();u.length=0}function n(e){s&&(a?e():u.push(e))}function i(){screen.lockOrientation("landscape-primary")}function r(){screen.lockOrientation("portrait-primary")}function o(){screen.unlockOrientation()}var a=!1,s=!0,u=[];document.addEventListener("deviceready",e,!1),this.LockLandscape=function(){n(i)},this.LockPortrait=function(){n(r)},this.Unlock=function(){n(o)}};var AM=AM||{};AM.DeviceOrientationControl=function(e){var t=this;this.object=e,this.object.rotation.reorder("YXZ");var n=!1,i=!1,r=0,o=new this.CoefMethod,a=function(e){n?(o.OnOrientationChange(e),i=!0):n=!0},s=function(){r=window.orientation||0};this.Connect=function(){s(),window.addEventListener("orientationchange",s,!1),window.addEventListener("deviceorientation",a,!1)},this.Disconnect=function(){window.removeEventListener("orientationchange",s,!1),window.removeEventListener("deviceorientation",a,!1),i=!1,n=!1},this.Update=function(){var e=function(){var e=new THREE.Vector3(0,0,1),t=new THREE.Euler,n=new THREE.Quaternion,i=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));return function(r,o,a,s,u){t.set(a,o,-s,"YXZ"),r.setFromEuler(t),r.multiply(i),r.multiply(n.setFromAxisAngle(e,-u))}}();if(i){var n=r?THREE.Math.degToRad(r):0;o.Update(),e(t.object.quaternion,o.alpha,o.beta,o.gamma,n)}}},AM.DeviceOrientationControl.prototype.PowerMethod=function(){function e(e,t,n){var i=AM.DeviceOrientationControl.prototype.Mod2Pi(t-e),r=Math.sign(i),o=Math.abs(i/Math.PI);return o=Math.pow(o,n),AM.DeviceOrientationControl.prototype.Mod2Pi(e+o*Math.PI*r)}var t,n=this,i=2;this.alpha=0,this.beta=0,this.gamma=0,this.OnOrientationChange=function(e){t=e},this.Update=function(){n.alpha=e(n.alpha,THREE.Math.degToRad(t.alpha),i),n.beta=e(n.beta,THREE.Math.degToRad(t.beta),i),n.gamma=e(n.gamma,THREE.Math.degToRad(t.gamma),i)}},AM.DeviceOrientationControl.prototype.CoefMethod=function(){function e(e,t,n){return e+AM.DeviceOrientationControl.prototype.Mod2Pi(t-e)*n}var t=this;this.coef=.2,this.alpha=0,this.beta=0,this.gamma=0;var n=!1;this.OnOrientationChange=function(e){n=e},this.Update=function(){if(n){var i=e(t.alpha,THREE.Math.degToRad(n.alpha),t.coef),r=e(t.beta,THREE.Math.degToRad(n.beta),t.coef),o=e(t.gamma,THREE.Math.degToRad(n.gamma),t.coef);t.alpha=i,t.beta=r,t.gamma=o}}},AM.DeviceOrientationControl.prototype.AverageMethod=function(){var e=this;this.history=[],this.history_max=10,this.alpha=0,this.beta=0,this.gamma=0,this.OnOrientationChange=function(t){e.history.length>e.history_max&&e.history.shift(),e.history.push(t)},this.Update=function(t,n,i){if(0!==e.history.length){for(var r=0,o=e.history.length;o>r;r++)t+=AM.DeviceOrientationControl.prototype.Mod360(e.history[r].alpha),n+=AM.DeviceOrientationControl.prototype.Mod360(e.history[r].beta),i+=AM.DeviceOrientationControl.prototype.Mod360(e.history[r].gamma);t/=e.history.length,n/=e.history.length,i/=e.history.length,e.alpha=THREE.Math.degToRad(t),e.beta=THREE.Math.degToRad(n),e.gamma=THREE.Math.degToRad(i)}}},AM.DeviceOrientationControl.prototype.Mod2Pi=function(){var e=Math.PI,t=2*Math.PI;return function(n){if(n>e){do n-=t;while(n>e)}else if(-e>n)do n+=t;while(-e>n);return n}}(),AM.DeviceOrientationControl.prototype.Mod360=function(e){return e%=360,180>e?e:e-360};var AM=AM||{};AM.GeographicCoordinatesConverter=function(e,t){var n=this,i={latitude:0,longitude:0};this.GetLocalCoordinates=function(e,t){var r=(i.latitude+e)/2,o={x:0,y:0};return o.x=(t-i.longitude)*n.EARTH_RADIUS*Math.cos(r),o.y=(e-i.latitude)*-n.EARTH_RADIUS,o},this.GetLocalCoordinatesFromDegres=function(e,t){return n.GetLocalCoordinates(THREE.Math.degToRad(e),THREE.Math.degToRad(t))},this.SetOrigin=function(e,t){i.latitude=e,i.longitude=t},this.SetOriginFromDegres=function(e,t){i.latitude=THREE.Math.degToRad(e),i.longitude=THREE.Math.degToRad(t)},this.GetOrigin=function(){return i},this.SetOrigin(e||0,t||0)},AM.GeographicCoordinatesConverter.prototype.EARTH_RADIUS=6371e3;var AM=AM||{};AM.GeolocationControl=function(e,t){function n(e){a.copy(u.GetLocalCoordinatesFromDegres(e.coords.latitude,e.coords.longitude)),o=!0}function i(e){console.warn("geolocation failed: "+e.message),window.setTimeout(r.Connect,r.retry_connection_ms)}var r=this,o=!1,a=new THREE.Vector3,s=0,u=t,c=.1;this.object=e,this.interpolation_coefficient=.02,this.retry_connection_ms=1e3,this.Connect=function(){s=navigator.geolocation.watchPosition(n,i)},this.Disconnect=function(){navigator.geolocation.clearWatch(s),o=!1},this.Update=function(){if(o){var e=a.x-r.object.position.x,t=a.z-r.object.position.z,n=e*e+t*t;c*c>n?o=!1:(e*=r.interpolation_coefficient,t*=r.interpolation_coefficient,r.object.position.x+=e,r.object.position.z+=t)}}};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.GifTexture=function(e){THREE.Texture.call(this),this.minFilter=THREE.NearestMipMapNearestFilter,this.imageElement=document.createElement("img");var t=document.getElementsByTagName("script");t=t[t.length-1],t.parentNode.appendChild(this.imageElement),this.imageElement.width=this.imageElement.naturalWidth,this.imageElement.height=this.imageElement.naturalHeight,e&&this.setGif(e)},AMTHREE.GifTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.GifTexture.prototype.constructor=AMTHREE.GifTexture,AMTHREE.GifTexture.prototype.play=function(){this.anim.play(),this.image=this.gifCanvas},AMTHREE.GifTexture.prototype.update=function(){this.needsUpdate=!0},AMTHREE.GifTexture.prototype.stop=function(){this.anim.move_to(0),this.image=void 0},AMTHREE.GifTexture.prototype.pause=function(){this.anim.pause()},AMTHREE.GifTexture.prototype.setGif=function(e){e.url&&(this.image_ref=e,this.imageElement.src=e.url,this.anim=new SuperGif({gif:this.imageElement,auto_play:!1}),this.anim.load(),this.gifCanvas=this.anim.get_canvas(),this.gifCanvas.style.display="none")},AMTHREE.GifTexture.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,this.image_ref&&(t.image=this.image_ref.uuid),t.animated=!0,this.image_ref.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.GifTexture=function(){console.warn("GifTexture.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Image=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url=t},AMTHREE.Image.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,t.url=AMTHREE.GetFilename(this.url),"object"==typeof e&&(e.images||(e.images={}),e.images[t.uuid]=t),t}):AMTHREE.Image=function(){console.warn("Image.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.ImageTexture=function(e){THREE.Texture.call(this),this.image=new Image,this.image.addEventListener("load",function(e){return function(){e.needsUpdate=!0}}(this)),this.set(e)},AMTHREE.ImageTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.ImageTexture.prototype.constructor=AMTHREE.ImageTexture,AMTHREE.ImageTexture.prototype.set=function(e){this.image_ref=e,this.image.src=e.url},AMTHREE.ImageTexture.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,t.image=this.image_ref.uuid,this.image_ref.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.ImageTexture=function(){console.warn("ImageTexture.js: THREE undefined")};var AMTHREE=AMTHREE||{};!function(){function e(e){e.traverse(function(e){if(e.material&&e.material.map&&e.material.map.image){var t=new AMTHREE.Image(void 0,e.material.map.image.src),n=new AMTHREE.ImageTexture(t);e.material.map=n,e.material.needsUpdate=!0}})}AMTHREE.ObjectConvert=e}();var AMTHREE=AMTHREE||{};!function(){function e(e,t){e=e||{};var n={};return t?n.asset_path=t+"/":n.asset_path="",n.asset_path+=e.asset_path?e.asset_path+"/":"",n.image_path=n.asset_path+(e.image_path?e.image_path:""),n.video_path=n.asset_path+(e.video_path?e.video_path:""),n.model_path=n.asset_path+(e.model_path?e.model_path:""),n.sound_path=n.asset_path+(e.sound_path?e.sound_path:""),n}function t(e,t){var n={};if(e instanceof Array){var i=new THREE.MaterialLoader;i.setTextures(t);for(var r=0,o=e.length;o>r;r++){var a=i.parse(e[r]);n[a.uuid]=a}}else console.log("materials parsing failed: json not an array");return n}function n(e){var t=[];if(e instanceof Array)for(var n=0;n<e.length;n++){var i=THREE.AnimationClip.parse(e[n]);t.push(i)}else console.log("animations parsing failed: json not an array");return t}function r(e,t){var n={};if(e instanceof Array)for(var i=0,r=e.length;r>i;++i){var o=e[i];if(void 0===o.uuid)console.warn('failed to parse sound: no "uuid" specified for sound '+i);else if(void 0===o.url)console.warn('failed to parse sound: no "url" specified for sound '+i);else{var a=new AMTHREE.Sound(o.uuid,t+"/"+o.url);n[o.uuid]=a}}return n}function o(e,t){return new Promise(function(n,r){var o={};return e instanceof Array?Promise.all(e.map(function(e){return new Promise(function(n,r){if(void 0===e.url)r('failed to parse image: no "url" specified for image '+i);else if(void 0===e.uuid)r('failed to parse image: no "uuid" specified for image '+i);else{var a=new AMTHREE.Image(e.uuid,t+"/"+e.url);o[a.uuid]=a,n()}})})).then(n(o),r):void r("images parsing failed: json not an array")})}function a(e,t){var n={};if(e instanceof Array)for(var i=0,r=e.length;r>i;i++){var o=e[i];if(void 0===o.uuid)console.warn('failed to parse video: no "uuid" specified for video '+i);else if(void 0===o.url)console.warn('failed to parse video: no "url" specified for video '+i);else{var a=new AMTHREE.Video(o.uuid,t+"/"+o.url);n[o.uuid]=a}}return n}function s(e){return"number"==typeof e?e:(console.warn("AMTHREE.ObjectLoading: Constant should be in numeric form.",e),THREE[e])}function u(e,t,n){var i={};if("undefined"==typeof SuperGif&&console.warn("AMTHREE.ObjectLoading: SuperGif is undefined"),"undefined"!=typeof e)for(var r=0,o=e.length;o>r;r++){var a=e[r],u=void 0;if(a.uuid||console.warn("failed to parse texture "+r+": no uuid provided"),void 0!==a.image||void 0!==a.video){if(void 0!==a.image){if(void 0===t[a.image]){console.warn("failed to parse texture "+a.uuid+": undefined image",a.image);continue}var c=t[a.image];if(void 0!==a.animated&&a.animated){if("undefined"==typeof SuperGif)continue;u=new AMTHREE.GifTexture(c)}else u=new AMTHREE.ImageTexture(c),u.needsUpdate=!0}else{if(void 0===n[a.video]){console.warn("failed to parse texture "+a.uuid+": undefined video",a.video);continue}var d=n[a.video];u=new AMTHREE.VideoTexture(d,a.width,a.height,a.loop,a.autoplay)}u.uuid=a.uuid,void 0!==a.name&&(u.name=a.name),void 0!==a.mapping&&(u.mapping=s(a.mapping)),void 0!==a.offset&&(u.offset=new THREE.Vector2(a.offset[0],a.offset[1])),void 0!==a.repeat&&(u.repeat=new THREE.Vector2(a.repeat[0],a.repeat[1])),void 0!==a.minFilter?u.minFilter=s(a.minFilter):u.minFilter=THREE.LinearFilter,void 0!==a.magFilter&&(u.magFilter=s(a.magFilter)),void 0!==a.anisotropy&&(u.anisotropy=a.anisotropy),Array.isArray(a.wrap)&&(u.wrapS=s(a.wrap[0]),u.wrapT=s(a.wrap[1])),i[a.uuid]=u}else console.warn('failed to parse texture: no "image" nor "video" specified for '+a.uuid)}return i}function c(e){var t={};if("undefined"!=typeof e)for(var n=new THREE.JSONLoader,i=new THREE.BufferGeometryLoader,r=0,o=e.length;o>r;r++){var a,s=e[r];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":a=new THREE[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"CubeGeometry":a=new THREE.BoxGeometry(s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleBufferGeometry":a=new THREE.CircleBufferGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CircleGeometry":a=new THREE.CircleGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":a=new THREE.CylinderGeometry(s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"SphereGeometry":a=new THREE.SphereGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"SphereBufferGeometry":a=new THREE.SphereBufferGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":a=new THREE.DodecahedronGeometry(s.radius,s.detail);break;case"IcosahedronGeometry":a=new THREE.IcosahedronGeometry(s.radius,s.detail);break;case"OctahedronGeometry":a=new THREE.OctahedronGeometry(s.radius,s.detail);break;case"TetrahedronGeometry":a=new THREE.TetrahedronGeometry(s.radius,s.detail);break;case"RingGeometry":a=new THREE.RingGeometry(s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":a=new THREE.TorusGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":a=new THREE.TorusKnotGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.p,s.q,s.heightScale);break;case"BufferGeometry":a=i.parse(s);break;case"Geometry":a=n.parse(s.data,this.texturePath).geometry;break;default:console.warn('AMTHREE.ObjectLoading: Unsupported geometry type "'+s.type+'"');continue}a.uuid=s.uuid,void 0!==s.name&&(a.name=s.name),t[s.uuid]=a}return t}function d(e,t,n){return new Promise(function(i,r){var o=new AM.JsonLoader;o.Load(e,function(){t(o.json,n).then(i,r)},function(){r("failed to load object: "+e)})})}function h(e,t){return d(e,p,t)}function f(e,t){return d(e,m,t)}function l(i,s){var d=e(i.constants,s);return o(i.images||[],d.image_path).then(function(e){var o=r(i.sounds||[],d.sound_path),s=a(i.videos||[],d.video_path),h=u(i.textures||[],e,s),f=n(i.animations||[]),l=t(i.materials||[],h),p=c(i.geometries||[]),m={constants:d,videos:s,images:e,sounds:o,textures:h,animations:f,materials:l,geometries:p};return m})}function p(e,t){return l(e,t).then(function(t){return y(e.object,t.materials,t.geometries,t.sounds,t.constants.model_path).then(function(e){return e.animations=t.animations,e})})}function m(e,t){return l(e,t).then(function(t){return M(e.objects,t.materials,t.geometries,t.sounds,t.constants.model_path)})}function E(e,t,n,i,r,o){var a=new THREE.Matrix4;if(e.uuid=t.uuid,void 0!==t.name&&(e.name=t.name),void 0!==t.matrix?(a.fromArray(t.matrix),a.decompose(e.position,e.quaternion,e.scale)):(void 0!==t.position&&e.position.fromArray(t.position),void 0!==t.rotation&&e.rotation.fromArray(t.rotation),void 0!==t.scale&&e.scale.fromArray(t.scale),void 0!==t.scaleXYZ&&(e.scale.x*=t.scaleXYZ,e.scale.y*=t.scaleXYZ,e.scale.z*=t.scaleXYZ)),void 0!==t.castShadow&&(e.castShadow=t.castShadow),void 0!==t.receiveShadow&&(e.receiveShadow=t.receiveShadow),void 0!==t.visible&&(e.visible=t.visible),void 0!==t.userData&&(e.userData=t.userData),"LOD"===t.type)for(var s=t.levels,u=0;u<s.length;u++){var c=s[u],d=e.getObjectByProperty("uuid",c.object);void 0!==d&&e.addLevel(d,c.distance)}return void 0!==t.children?M(t.children,n,i,r,o).then(function(t){for(var n=0,i=t.length;i>n;++n)e.add(t[n]);return e}):Promise.resolve(e)}function g(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get geometry: no id provided"):console.warn("failed to get geometry: no such geometry: "+e))}function v(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get material: no id provided"):console.warn("failed to get material: no such material: "+e))}function T(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get sound: no id provided"):console.warn("failed to get sound: no such sound: "+e))}function y(e,t,n,i,r){var o,a;switch(e.type){case"OBJ":if(THREE.OBJLoader){var s=new THREE.OBJLoader;a=r+"/"+e.url,s.load(a,function(o){o.traverse(function(e){e.geometry&&e.geometry.computeBoundingSphere()}),E(o,e,t,n,i,r).then(resolve,reject)})}else reject("failed to load "+e.uuid+": THREE.OBJLoader is undefined");return;case"OBJMTL":if(THREE.OBJMTLLoader){var u=new THREE.OBJMTLLoader,c=r+"/"+e.objUrl,d=r+"/"+e.mtlUrl;u.load(c,d,function(o){o.traverse(function(e){e.geometry&&e.geometry.computeBoundingSphere()}),E(o,e,t,n,i,r).then(resolve,reject)})}else reject("failed to load "+e.uuid+": THREE.OBJMTLLoader is undefined");return;case"Collada":if(THREE.ColladaLoader){var h=new THREE.ColladaLoader;h.options.convertUpAxis=!0,a=r+"/"+e.url,h.load(a,function(o){var a=o.scene;E(a,e,t,n,i,r).then(resolve,reject)})}else reject("failed to load "+e.uuid+": THREE.ColladaLoader is undefined");return;case"SoundObject":o=new AMTHREE.SoundObject(T(e.sound,i));break;case"Scene":o=new THREE.Scene;break;case"PerspectiveCamera":o=new THREE.PerspectiveCamera(e.fov,e.aspect,e.near,e.far);break;case"OrthographicCamera":o=new THREE.OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far);break;case"AmbientLight":o=new THREE.AmbientLight(e.color);break;case"DirectionalLight":o=new THREE.DirectionalLight(e.color,e.intensity);break;case"PointLight":o=new THREE.PointLight(e.color,e.intensity,e.distance,e.decay);break;case"SpotLight":o=new THREE.SpotLight(e.color,e.intensity,e.distance,e.angle,e.exponent,e.decay);break;case"HemisphereLight":o=new THREE.HemisphereLight(e.color,e.groundColor,e.intensity);break;case"Mesh":o=new THREE.Mesh(g(e.geometry,n),v(e.material,t));break;case"LOD":o=new THREE.LOD;break;case"Line":o=new THREE.Line(g(e.geometry,n),v(e.material,t),e.mode);break;case"PointCloud":case"Points":o=new THREE.Points(g(e.geometry,n),v(e.material,t));break;case"Sprite":o=new THREE.Sprite(v(e.material,t));break;case"Group":o=new THREE.Group;break;default:o=new THREE.Object3D}return E(o,e,t,n,i,r)}function M(e,t,n,i,r){return e instanceof Array?Promise.all(e.map(function(e){return y(e,t,n,i,r)})):Promise.reject("failed to parse object array: json not an array")}function A(e){var t=new THREE.Box3,n=new THREE.Sphere,i=new THREE.Object3D;i.add(elem),t.setFromObject(elem),t.getBoundingSphere(n),i.scale.multiplyScalar(1/n.radius),n.center.divideScalar(n.radius),i.position.sub(n.center);var r=new THREE.Object3D;return r.add(i),r}"undefined"!=typeof THREE&&(AMTHREE.ParseObject=p,AMTHREE.ParseObjectArray=m,AMTHREE.LoadObject=h,AMTHREE.LoadObjectArray=f,AMTHREE.NormalizeObject=A)}();var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Sound=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url=t},AMTHREE.Sound.prototype.toJSON=function(e){var t={uuid:this.uuid,url:AMTHREE.GetFilename(this.url)};return e.sounds||(e.sounds={}),e.sounds[this.uuid]||(e.sounds[this.uuid]=t),t}):AMTHREE.Sound=function(){console.warn("Sound.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.SoundObject=function(e){THREE.Object3D.call(this),this.sound=e,this.audio=new Audio,this.audio.loop=!0,this.playing=!1},AMTHREE.SoundObject.prototype=Object.create(THREE.Object3D.prototype),AMTHREE.SoundObject.prototype.constructor=AMTHREE.SoundObject,AMTHREE.SoundObject.prototype.play=function(){this.playing=!0,this.audio.src=this.sound.url,this.audio.play()},AMTHREE.SoundObject.prototype.stop=function(){this.audio.src="",this.playing=!1},AMTHREE.SoundObject.prototype.pause=function(){this.audio.pause(),this.playing=!1},AMTHREE.SoundObject.prototype.setSound=function(e){this.sound=e,this.isPlaying()&&this.play()},AMTHREE.SoundObject.prototype.isPlaying=function(){return this.playing},AMTHREE.SoundObject.prototype.clone=function(){return(new AMTHREE.SoundObject).copy(this)},AMTHREE.SoundObject.prototype.copy=function(e){return this.setSound(e.sound),this},AMTHREE.SoundsCall=function(e,t){e.traverse(function(e){e instanceof AMTHREE.SoundObject&&e[t]&&e[t]()})},AMTHREE.PlaySounds=function(e){AMTHREE.SoundsCall(e,"play")},AMTHREE.PauseSounds=function(e){AMTHREE.SoundsCall(e,"pause")},AMTHREE.StopSounds=function(e){AMTHREE.SoundsCall(e,"stop")},AMTHREE.SoundObject.prototype.toJSON=function(e){var t=THREE.Object3D.prototype.toJSON.call(this,e);return this.sound.toJSON(e),t.object.type="SoundObject",t.object.sound=this.sound.uuid,t}):AMTHREE.SoundObject=function(){console.warn("SoundObject.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.TrackedObjManager=function(e){function t(e,t,n){e.position.lerp(t.position,n),e.quaternion.slerp(t.quaternion,n),e.scale.lerp(t.scale,n)}function n(){o.ForEach(function(e){e.enabled&&t(e.object,e.target,i.lerp_factor)})}e=e||{};var i=this,r=new THREE.Clock(!0),o=new AMTHREE.TrackedObjManager.prototype.Holder,a=n;this.camera=e.camera,this.lerp_factor=e.lerp_factor||.8,this.timeout=e.timeout||6,this.Add=function(e,t,n,i){o.Add(e,t,n,i)},this.Remove=function(e){o.Remove(e)},this.Clear=function(){o.Clear()},this.Update=function(){o.UpdateElapsed(r.getDelta()),o.CheckTimeout(i.timeout),a()},this.Track=function(){var e=new THREE.Matrix4,n=new THREE.Object3D;return function(r,a){if(i.camera){var s=o.Get(r);if(s){var u=s.target;return e.copy(i.camera.matrixWorld),e.multiply(a),s.enabled?(e.decompose(n.position,n.quaternion,n.scale),t(u,n,i.lerp_factor)):(e.decompose(u.position,u.quaternion,u.scale),e.decompose(s.object.position,s.object.quaternion,s.object.scale)),o.Track(r),!0}console.warn("TrackedObjManager: object "+r+" not found")}else console.warn("TrackedObjManager: camera is undefined");return!1}}(),this.TrackCompose=function(){var e=new THREE.Matrix4;return function(t,n,r,o){return e.compose(n,r,o),i.Track(t,e)}}(),this.TrackComposePosit=function(){var e=new THREE.Vector3,t=new THREE.Euler,n=new THREE.Quaternion,r=new THREE.Vector3;return function(o,a,s,u){return e.x=a[0],e.y=a[1],e.z=-a[2],t.x=-Math.asin(-s[1][2]),
t.y=-Math.atan2(s[0][2],s[2][2]),t.z=Math.atan2(s[1][0],s[1][1]),r.x=u,r.y=u,r.z=u,n.setFromEuler(t),i.TrackCompose(o,e,n,r)}}(),this.GetObject=function(e){var t=o.get(e);return t?t.object:void 0}},AMTHREE.TrackedObjManager.prototype.Holder=function(){var e=this,t={};this.Add=function(e,n,i,r){t[n]={object:e,target:{position:e.position.clone(),quaternion:e.quaternion.clone(),scale:e.scale.clone()},elapsed:0,on_enable:i,on_disable:r,enabled:!1}},this.Remove=function(e){var n=t[e];n.enabled&&n.on_disable&&n.on_disable(n.object),delete t[e]},this.Clear=function(){for(var n in t)e.Remove(n)},this.Track=function(e){var n=t[e];n.elapsed=0,n.enabled||(n.enabled=!0,n.on_enable&&n.on_enable(n.object))},this.UpdateElapsed=function(e){for(var n in t)t[n].elapsed+=e},this.CheckTimeout=function(e){for(var n in t){var i=t[n];i.enabled&&i.elapsed>e&&(i.on_disable&&i.on_disable(i.object),i.enabled=!1)}},this.ForEach=function(e){for(var n in t)e(t[n])},this.Get=function(e){return t[e]}}):AMTHREE.TrackedObjManager=function(){console.warn("TrackedObjManager.js: THREE undefined")};var AMTHREE=AMTHREE||{};AMTHREE.AnimatedTextureCall=function(e,t){e.traverse(function(e){e.material&&e.material.map&&e.material.map[t]&&e.material.map[t]()})},AMTHREE.PlayAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"play")},AMTHREE.StopAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"stop")},AMTHREE.PauseAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"pause")},AMTHREE.UpdateAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"update")},AMTHREE.WorldToCanvasPosition=function(e,t,n){var i=new THREE.Vector3;i.copy(e),i.project(t);var r=Math.round((i.x+1)*n.width/2),o=Math.round((-i.y+1)*n.height/2);return{x:r,y:o,z:i.z}},AMTHREE.PlayAnimations=function(e){e.traverse(function(e){if(e instanceof THREE.SkinnedMesh){var t=new THREE.Animation(e,e.geometry.animation);t.play()}})},AMTHREE.GetFilename=function(e){return e.split("/").pop().split("\\").pop()},AMTHREE.IMAGE_PATH="images/",AMTHREE.MODEL_PATH="models/",AMTHREE.VIDEO_PATH="videos/",AMTHREE.SOUND_PATH="sounds/",AMTHREE.ASSET_PATH="assets/";var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Video=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url="string"==typeof t?t:void 0},AMTHREE.Video.prototype.toJSON=function(e){var t={uuid:this.uuid,url:AMTHREE.GetFilename(this.url)};return"object"==typeof e&&(e.videos||(e.videos={}),e.videos[t.uuid]=t),t}):AMTHREE.Video=function(){console.warn("Video.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.VideoTexture=function(e,t,n,i,r,o){THREE.Texture.call(this),this.uuid="string"==typeof t?t:THREE.Math.generateUUID(),this.minFilter=THREE.NearestMipMapNearestFilter,this.videoElement=document.createElement("video"),this.needsUpdate=!1,this.set(e,n,i,r,o)},AMTHREE.VideoTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.VideoTexture.prototype.constructor=AMTHREE.VideoTexture,AMTHREE.VideoTexture.prototype.play=function(){this.videoElement&&!this.playing&&this.video&&(this.paused||(this.videoElement.src=this.video.url),this.videoElement.setAttribute("crossorigin","anonymous"),this.videoElement.play(),this.image=this.videoElement,this.playing=!0)},AMTHREE.VideoTexture.prototype.update=function(){this.videoElement&&this.videoElement.readyState==this.videoElement.HAVE_ENOUGH_DATA&&(this.needsUpdate=!0)},AMTHREE.VideoTexture.prototype.pause=function(){this.videoElement&&!this.videoElement.paused&&(this.videoElement.pause(),this.playing=!1)},AMTHREE.VideoTexture.prototype.stop=function(){this.videoElement&&(this.pause(),this.videoElement.src="",this.image=void 0,this.needsUpdate=!0)},AMTHREE.VideoTexture.prototype.set=function(e,t,n,i,r){this.stop(),this.video=e,this.videoElement.width="number"==typeof t?t:void 0,this.videoElement.height="number"==typeof n?n:void 0,this.videoElement.autoplay="boolean"==typeof r?r:!1,this.videoElement.loop="boolean"==typeof i?i:!0,this.playing=!1,this.videoElement.autoplay&&this.play()},AMTHREE.VideoTexture.prototype.toJSON=function(e){var t={uuid:this.uuid,video:this.video.uuid,width:this.videoElement.width,height:this.videoElement.height,loop:this.videoElement.loop,autoplay:this.videoElement.autoplay};return this.video.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.VideoTexture=function(){console.warn("VideoTexture.js: THREE undefined")};var AM=AM||{};AM.Detection=function(){function e(e,t){var n=e*t;if(n>i.length)for(;--n>=0;)i[n]=new jsfeat.keypoint_t}var t={laplacian_threshold:30,eigen_threshold:25,detection_corners_max:500,border_size:15,fast_threshold:20},n=!1,i=[],r=0,o=new jsfeat.matrix_t(32,t.detection_corners_max,jsfeat.U8_t|jsfeat.C1_t);this.Detect=function(a){e(a.cols,a.rows),r=AM.DetectKeypointsYape06(a,i,t.detection_corners_max,t.laplacian_threshold,t.eigen_threshold,t.border_size),jsfeat.orb.describe(a,i,r,o),n&&console.log("Learn : "+r+" corners")},this.SetParameters=function(e){for(var n in e)"undefined"!=typeof t[n]&&(t[n]=e[n])},this.GetDescriptors=function(){return o},this.GetNumCorners=function(){return r},this.GetCorners=function(){return i}},AM.IcAngle=function(){var e=new Int32Array([15,15,15,15,14,14,14,13,13,12,11,10,9,8,6,3,0]),t=Math.PI/2;return function(n,i,r){var o=15,a=0,s=0,u=n.data,c=n.cols,d=0,h=0,f=r*c+i|0,l=0,p=0,m=0,E=0;for(d=-o;o>=d;++d)s+=d*u[f+d];for(h=1;o>=h;++h){for(l=0,p=e[h],d=-p;p>=d;++d)m=u[f+d+h*c],E=u[f+d-h*c],l+=m-E,s+=d*(m+E);a+=h*l}return AM.DiamondAngle(a,s)*t}}(),AM.DiamondAngle=function(e,t){return e>=0?t>=0?e/(t+e):1-t/(-t+e):0>t?2-e/(-t-e):3+t/(t-e)},AM.DetectKeypointsPostProc=function(e,t,n,i){n>i&&(jsfeat.math.qsort(t,0,n-1,function(e,t){return t.score<e.score}),n=i);for(var r=0;n>r;++r)t[r].angle=AM.IcAngle(e,t[r].x,t[r].y);return n},AM.DetectKeypointsYape06=function(e,t,n,i,r,o){jsfeat.yape06.laplacian_threshold=i,jsfeat.yape06.min_eigen_value_threshold=r;var a=jsfeat.yape06.detect(e,t,o);return a=AM.DetectKeypointsPostProc(e,t,a,n)},AM.DetectKeypointsFast=function(e,t,n,i,r){jsfeat.fast_corners.set_threshold(i);var o=jsfeat.fast_corners.detect(e,t,r||3);return o=AM.DetectKeypointsPostProc(e,t,o,n)};var AM=AM||{};AM.ImageFilter=function(){var e,t={blur_size:3,blur:!0};this.Filter=function(n){var i=n.width,r=n.height;e?e.resize(i,r,jsfeat.U8_t|jsfeat.C1_t):e=new jsfeat.matrix_t(i,r,jsfeat.U8_t|jsfeat.C1_t),jsfeat.imgproc.grayscale(n.data,i,r,e),t.blur&&jsfeat.imgproc.gaussian_blur(e,e,t.blur_size)},this.GetFilteredImage=function(){return e},this.SetParameters=function(e){for(var n in e)"undefined"!=typeof t[n]&&(t[n]=e[n])}};var AM=AM||{};AM.MarkerTracker=function(){var e,t=new AM.Training,n={},i=new AM.ImageFilter,r=new AM.Detection,o=new AM.Matching,a=new AM.Pose,s=!1,u={match_min:8},c=!1,d=new AM.Profiler;d.add("filter"),d.add("detection"),d.add("matching"),d.add("pose"),this.ComputeImage=function(e){d.new_frame(),d.start("filter"),i.Filter(e),d.stop("filter"),d.start("detection"),r.Detect(i.GetFilteredImage()),d.stop("detection")},this.Match=function(){d.start("matching"),s=!1,e=void 0,o.SetScreenDescriptors(r.GetDescriptors());for(var t in n){var i=n[t];if(i.IsActive()){o.Match(i.GetDescriptorsLevels());var h=o.GetNumMatches();if(s=h>=u.match_min,c&&console.log("nbMatches : "+h),s){var f=a.Pose(o.GetMatches(),h,r.GetCorners(),i.GetCornersLevels());if(s=f>=u.match_min,c&&console.log(" goodMatches : "+f),s){e=i;break}}}}return d.stop("matching"),s},this.GetMatchUuid=function(){return e.GetUuid()},this.GetPose=function(){if(s){d.start("pose");var t=a.GetPoseCorners(e.GetWidth(),e.GetHeight());return d.stop("pose"),t}},this.AddMarker=function(e,i){t.Train(e);var r=new AM.TrainedImage(i);t.SetResultToTrainedImage(r),t.Empty(),n[i]=r},this.RemoveMarker=function(e){n[e]&&delete n[e]},this.ActiveMarker=function(e,t){n[e]&&n[e].Active(t)},this.ActiveAllMarkers=function(e){for(var t in n)n[t].Active(e)},this.ClearMarkers=function(){n={}},this.GetScreenCorners=function(){return r.GetCorners()},this.GetNumScreenCorners=function(){return r.GetNumCorners()},this.GetMatches=function(){return o.GetMatches()},this.GetMatchesMask=function(){return a.GetMatchesMask()},this.GetProfiler=function(){return d.GetProfiler()},this.GetTrainedCorners=function(){var e=n[uuid];return e.GetCornersLevels()},this.Log=function(){console.log(d.log()+(s?"<br/>match found":""))},this.SetParameters=function(e){for(var n in e)"undefined"!=typeof u[n]&&(u[n]=e[n]);t.SetParameters(e),i.SetParameters(e),r.SetParameters(e),o.SetParameters(e)}};var AM=AM||{};AM.Matching=function(){function e(e){return e-=e>>1&1431655765,e=(858993459&e)+(e>>2&858993459),16843009*(e+(e>>4)&252645135)>>24}function t(e,t){var n=e.rows,i=e.buffer.i32,r=0,u=0;o=[];for(var c=0;n>c;++c){for(var d=256,h=256,f=-1,l=-1,p=0,m=t.length;m>p;++p)for(var E=t[p],g=E.rows,v=E.buffer.i32,T=0,y=0;g>y;++y){for(var M=0,A=0;8>A;++A)M+=s(i[r+A]^v[T+A]);d>M?(h=d,d=M,l=p,f=y):h>M&&(h=M),T+=8}if(d<a.match_threshold){for(;o.length<=u;)o.push(new AM.match_t);o[u].screen_idx=c,o[u].pattern_lev=l,o[u].pattern_idx=f,u++}r+=8}return o.length=u,u}var n,r,o=[],a={match_threshold:48};this.SetScreenDescriptors=function(e){n=e},this.Match=function(e){return r=t(n,e)};var s=(function(){var e=[0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8],t=255;return function(n){var i=e[n&t];return n>>=8,i+=e[n&t],n>>=8,i+=e[n&t],n>>=8,i+=e[n&t]}}(),function(){var t=[];for(i=0;i<65536;++i)t.push(e(i));var n=65535;return function(e){var i=t[e&n];return e>>=16,i+=t[e&n]}}());this.GetMatches=function(){return o},this.GetNumMatches=function(){return r},this.SetParameters=function(e){for(var t in e)"undefined"!=typeof a[t]&&(a[t]=e[t])}},AM.match_t=function(e,t,n,i){this.screen_idx=e||0,this.pattern_lev=t||0,this.pattern_idx=n||0,this.distance=i||0};var AM=AM||{};AM.Pose=function(){function e(e,t,n,i,r,o){var a,s=new jsfeat.motion_model.homography2d,u=4,c=3,d=new jsfeat.ransac_params_t(u,c,.5,.99),h=[],f=[];for(a=0;t>a;++a){var l=e[a],p=r[l.screen_idx],m=o[l.pattern_lev][l.pattern_idx];h[a]={x:m.x,y:m.y},f[a]={x:p.x,y:p.y}}var E=!1;E=jsfeat.motion_estimator.ransac(d,s,h,f,t,n,i,1e3);var g=0;if(E){for(a=0;t>a;++a)i.data[a]&&(h[g].x=h[a].x,h[g].y=h[a].y,f[g].x=f[a].x,f[g].y=f[a].y,g++);s.run(h,f,n,g)}else jsfeat.matmath.identity_3x3(n,1);return g}function t(e,t,n){for(var i=[{x:0,y:0},{x:t,y:0},{x:t,y:n},{x:0,y:n}],r=0,o=0,a=0,s=0;4>s;++s)o=e[0]*i[s].x+e[1]*i[s].y+e[2],a=e[3]*i[s].x+e[4]*i[s].y+e[5],r=e[6]*i[s].x+e[7]*i[s].y+e[8],i[s].x=o/r,i[s].y=a/r;return i}var n=0,i=new jsfeat.matrix_t(3,3,jsfeat.F32C1_t),r=new jsfeat.matrix_t(500,1,jsfeat.U8C1_t);this.Pose=function(t,o,a,s){return n=e(t,o,i,r,a,s)},this.GetGoodCount=function(){return n},this.GetPoseCorners=function(e,n){return t(i.data,e,n)},this.GetMatchesMask=function(){return r}},AM.PosePosit=function(){this.posit=new POS.Posit(10,1),this.pose=void 0},AM.PosePosit.prototype.Set=function(e,t,n,i){t=t||35;for(var r=[],o=0;o<e.length;++o){var a=e[o].x-n/2,s=i/2-e[o].y;r.push({x:a,y:s})}this.pose=this.posit.pose(r)},AM.PosePosit.prototype.SetFocalLength=function(e){this.posit.focalLength=e},AM.PoseThree=function(){this.position=new THREE.Vector3,this.rotation=new THREE.Euler,this.quaternion=new THREE.Quaternion,this.scale=new THREE.Vector3},AM.PoseThree.prototype.Set=function(e,t){t=t||35;var n=e.bestRotation,i=e.bestTranslation;this.scale.x=t,this.scale.y=t,this.scale.z=t,this.rotation.x=-Math.asin(-n[1][2]),this.rotation.y=-Math.atan2(n[0][2],n[2][2]),this.rotation.z=Math.atan2(n[1][0],n[1][1]),this.position.x=i[0],this.position.y=i[1],this.position.z=-i[2],this.quaternion.setFromEuler(this.rotation)};var AM=AM||{};AM.TrainedImage=function(e){var t=!0,n=[],i=[],r=0,o=0,a=e,s=!0;this.GetCorners=function(e){return n[e]},this.GetDescriptors=function(e){return i[e]},this.GetLevelNbr=function(){return Math.min(i.length,n.length)},this.GetCornersLevels=function(){return n},this.GetDescriptorsLevels=function(){return i},this.GetWidth=function(){return r},this.GetHeight=function(){return o},this.Set=function(e,a,s,u){t=!1,n=e,i=a,r=s,o=u},this.IsEmpty=function(){return t},this.Empty=function(){t=!0,n=[],i=[]},this.SetUuid=function(e){a=e},this.GetUuid=function(){return a},this.Active=function(e){s=e===!0},this.IsActive=function(){return s}};var AM=AM||{};AM.Training=function(){function e(e,n,a,s){var u=o[a],d=r[a];0!==a?(t(e,n,s),jsfeat.imgproc.gaussian_blur(n,n,c.blur_size)):jsfeat.imgproc.gaussian_blur(e,n,c.blur_size);var h=AM.DetectKeypointsYape06(n,u,c.training_corners_max,c.laplacian_threshold,c.eigen_threshold);if(u.length=h,jsfeat.orb.describe(n,u,h,d),0!==a)for(i=0;i<h;++i)u[i].x*=1/s,u[i].y*=1/s;console.log("train "+n.cols+"x"+n.rows+" points: "+h)}function t(e,t,n){if(1>n){var i=Math.round(e.cols*n),r=Math.round(e.rows*n);jsfeat.imgproc.resample(e,t,i,r)}else t.resize(e.cols,e.rows),e.copy_to(t)}function n(e,t){for(var n=0;n<c.num_train_levels;++n){o[n]=[];for(var i=o[n],a=e*t>>n;--a>=0;)i[a]=new jsfeat.keypoint_t(0,0,0,0,-1);r[n]=new jsfeat.matrix_t(32,c.training_corners_max,jsfeat.U8_t|jsfeat.C1_t)}}var r,o,a,s=0,u=0,c={num_train_levels:3,blur_size:3,image_size_max:512,training_corners_max:200,laplacian_threshold:30,eigen_threshold:25},d=Math.sqrt(2),h=[];this.Train=function(i){var a=0,h=1;r=[],o=[];var f=new jsfeat.matrix_t(i.width,i.height,jsfeat.U8_t|jsfeat.C1_t);jsfeat.imgproc.grayscale(i.data,i.width,i.height,f,jsfeat.COLOR_RGBA2GRAY);var l=Math.min(c.image_size_max/i.width,c.image_size_max/i.height),p=new jsfeat.matrix_t(i.width*l,i.height*l,jsfeat.U8_t|jsfeat.C1_t);s=p.cols,u=p.rows,t(f,p,l),n(p.cols,p.rows);var m=new jsfeat.matrix_t(p.cols,p.rows,jsfeat.U8_t|jsfeat.C1_t);for(e(p,m,0,h),a=1;a<c.num_train_levels;++a)h/=d,e(p,m,a,h)},cloneImage=function(e){var t=new jsfeat.matrix_t(e.cols,e.rows,jsfeat.U8_t|jsfeat.C1_t);return e.copy_to(t),t},this.TrainFull=function(i){var f=0,l=1;r=[],o=[],h=[];var p=new jsfeat.matrix_t(i.width,i.height,jsfeat.U8_t|jsfeat.C1_t);jsfeat.imgproc.grayscale(i.data,i.width,i.height,p,jsfeat.COLOR_RGBA2GRAY);var m=Math.min(c.image_size_max/i.width,c.image_size_max/i.height),E=new jsfeat.matrix_t(i.width*m,i.height*m,jsfeat.U8_t|jsfeat.C1_t);s=E.cols,u=E.rows,t(p,E,m),n(E.cols,E.rows);var g=new jsfeat.matrix_t(E.cols,E.rows,jsfeat.U8_t|jsfeat.C1_t);for(e(E,g,0,l),a=E,h[0]=cloneImage(g),f=1;f<c.num_train_levels;++f)l/=d,e(E,g,f,l),h[f]=cloneImage(g)},this.getGrayData=function(){return a},this.getBluredImages=function(){return h},this.SetResultToTrainedImage=function(e){e.Set(o,r,s,u)},this.IsEmpty=function(){return!r||!o},this.Empty=function(){r=void 0,o=void 0,h=void 0},this.SetParameters=function(e){for(var t in e)"undefined"!=typeof c[t]&&(c[t]=e[t])},this.GetScaleIncrement=function(){return d}};