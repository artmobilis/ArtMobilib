var compatibility=function(){var e=0,t=!0,n=window.URL||window.webkitURL||window.mozURL||window.msURL,i=function(t,n){var i=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,n){var i=(new Date).getTime(),o=Math.max(0,16-(i-e)),r=window.setTimeout(function(){t(i+o)},o);return e=i+o,r};return i.call(window,t,n)},o=function(e){var t=window.cancelAnimationFrame||function(e){clearTimeout(e)};return t.call(window,e)},r=function(e,t,n){var i=window.navigator.getUserMedia||window.navigator.mozGetUserMedia||window.navigator.webkitGetUserMedia||window.navigator.msGetUserMedia||function(e,t,n){n()};return i.call(window.navigator,e,t,n)},a=function(){var e=new ArrayBuffer(8),n=new Uint32Array(e);return n[0]=4278190080,t=!0,255===e[0]&&(t=!1),t};return{URL:n,requestAnimationFrame:i,cancelAnimationFrame:o,getUserMedia:r,detectEndian:a,isLittleEndian:t}}();!function(){AM=AM||{};var e=function(){this._listeners={}};e.prototype.AddListener=function(e,t){return"string"==typeof e&&("undefined"==typeof this._listeners[e]&&(this._listeners[e]=[]),-1==this._listeners[e].indexOf(t))?(this._listeners[e].push(t),!0):!1},e.prototype.RemoveListener=function(e,t){if("string"==typeof e){var n=this._listeners[e];if("undefined"!=typeof n){var i=n.indexOf(t);if(-1!=i)return 1!=n.length?n.splice(i,1):delete this._listeners[e],!0}}return!1},e.prototype.Fire=function(e,t){if("string"==typeof e){var n=this._listeners[e];if("undefined"!=typeof n){for(var i=0,o=n.length;o>i;++i)n[i].apply(this,t);return!0}}return!1},AM.EventManager=e}(),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL;var AM=AM||{};AM.FrontCamGrabbing=function(){function e(){u.readyState===u.HAVE_ENOUGH_DATA?(d=!1,r&&r()):window.requestAnimationFrame(e)}function t(t){return function(n){for(var i={video:!0,audio:!1},r=0;r!=n.length;++r){var a=n[r];"video"==a.kind&&"environment"==a.facing&&(i.video={optional:[{sourceId:a.id}]})}navigator.getUserMedia(i,function(t){o=t,u.src=window.URL.createObjectURL(t),e()},function(e){console.error("Cant getUserMedia()! due to ",e),t&&t()})}}function n(e){"undefined"!=typeof MediaStreamTrack&&"undefined"!=typeof MediaStreamTrack.getSources?MediaStreamTrack.getSources(t(e)):e&&e()}function i(e){"undefined"!=typeof navigator.mediaDevices&&"undefined"!=typeof navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(t(e)):e&&e()}var o,r,a,s=this,u=document.createElement("video"),d=!1;u.setAttribute("autoplay",!0),u.style.zIndex=-1,u.style.position="absolute",u.style.top="0px",u.style.left="0px",u.style.width="100%",u.style.height="100%",this.domElement=u,this.Start=function(e,t){s.IsActive()||d?e():(d=!0,r=e,a=t,n(function(){i(function(){a&&a(),r&&r()})}))},this.Stop=function(){o&&(o.getTracks()[0].stop(),o=void 0)},this.IsActive=function(){return void 0!==o}};var AM=AM||{};getGradientGreenRedColor=function(e,t){function n(e){var t=parseInt(e).toString(16);return t.length<2?"0"+t:t}var i=255*e/t,o=255*(t-e)/t;return"#"+n(i)+n(o)+"00"},AM.ImageDebugger=function(){var e,t,n,i,o,r,a,s,u,d,c,h,f,l,m,E,p,g,v,T,y=new AM.Training,w=44,R=[],M=[],H=new AM.ImageLoader,A=!1,b=!0;this.DrawCorners=function(t){if(A&&t&&(r=t.screen_corners,u=t.profiles,d=t.image_data,r.length)){e.fillStyle="red";for(var n=0;n<r.length;++n){var i=r[n];e.beginPath(),e.arc(i.x*h+f,i.y*h+l,3,0,2*Math.PI),e.fill()}e.putImageData(d,E-d.width,w);for(var n=0;n<r.length;++n){var i=r[n];e.beginPath(),e.arc(i.x+E-d.width,i.y+w,3,0,2*Math.PI),e.fill()}e.font="30px Arial",e.fillStyle="red",e.textAlign="left";var o="FPS: "+u.fps.toFixed(2)+"  ";for(n=0;n<u.timers.length;++n){var a=u.timers[n];o+=a[0]+": "+a[1].run_time+"ms  "}e.fillText(o,10,m-5-w)}},this.DebugMatching=function(e,t){A&&e&&t&&(i=e.corners,o=e.trained_corners,a=e.matches,s=e.matches_mask,n=t,e.uuid!=v&&(v=e.uuid,H.GetImageData(t,function(e){T=e,correctTrainingImageOffsets(),displayTrainingImages(!0),drawContour(),drawMatches(),b&&(displayTrainingImages(!1),drawTrainedCorners())},!1)),T&&(correctTrainingImageOffsets(),displayTrainingImages(!0),drawContour(),drawMatches(),b&&(displayTrainingImages(!1),drawTrainedCorners())))},correctTrainingImageOffsets=function(){if(T.width>T.height){var e=T.width-T.height;p=0,g=-Math.round(e/2)}else{var e=T.height-T.width;p=-Math.round(e/2),g=0}},drawContour=function(){e.strokeStyle="green",e.lineWidth=5,e.beginPath(),e.moveTo(i[0].x*h+f,i[0].y*h+l),e.lineTo(i[1].x*h+f,i[1].y*h+l),e.lineTo(i[2].x*h+f,i[2].y*h+l),e.lineTo(i[3].x*h+f,i[3].y*h+l),e.lineTo(i[0].x*h+f,i[0].y*h+l),e.stroke()},drawMatches=function(t){"undefined"==typeof t&&(t=!1),e.lineWidth=2;for(var n=0;n<a.length;++n){var i=a[n],u=s.data[n],d=o[i.pattern_lev],c=d[i.pattern_idx],m=r[i.screen_idx];u?(e.fillStyle="blue",e.strokeStyle="blue"):(e.fillStyle="red",e.strokeStyle="red");var E=c.x+p,v=c.y+g;t||(E=E*M[i.pattern_lev]+R[i.pattern_lev],v*=M[i.pattern_lev]),e.beginPath(),e.arc(E,v+w,3,0,2*Math.PI),e.fill(),e.beginPath(),e.moveTo(E,v+w),e.lineTo(m.x*h+f,m.y*h+l),e.stroke(),e.beginPath(),e.arc(m.x*h+f,m.y*h+l,3,0,2*Math.PI),e.fill()}},jsFeat2ImageData=function(t){for(var n=e.createImageData(t.cols,t.rows),i=t.data.length,o=4*i+3;i--;)n.data[o-=4]=255,n.data[o-1]=n.data[o-2]=n.data[o-3]=t.data[i];return n},displayColor=function(t,n){e.putImageData(T,t,n)},displayTrainingImages=function(t){y.Empty(),y.TrainFull(T);var n=y.getBluredImages(),i=0;R[0]=0,M[0]=1;for(var o=0;o<n.length;++o)originy=w,t||(originy=m-35-w-n[o].rows),e.putImageData(jsFeat2ImageData(n[o]),i,originy),i+=n[o].cols,R[o+1]=R[o]+n[o].cols,M[o+1]=M[o]/y.GetScaleIncrement()},drawTrainedCorners=function(t){"undefined"==typeof t&&(t=50);var n=y.getBluredImages(),i=new AM.TrainedImage(c);y.SetResultToTrainedImage(i);for(var o=0;o<i.GetLevelNbr();++o)for(var r=i.GetCorners(o),a=(i.GetDescriptors(o),m-35-w-n[o].rows),s=0;t>s;++s){var u=r[s];e.fillStyle=getGradientGreenRedColor(t-s,t);var d=u.x+p,h=u.y+g;d=d*M[o]+R[o],h*=M[o],e.beginPath(),e.arc(d,h+a,3,0,2*Math.PI),e.fill()}},this.UpdateSize=function(e,n){m=e.height,E=e.width;var i=m,o=t.videoWidth/t.videoHeight,r=E/i;if(r>o){var a=Math.round(i*o);h=a/n,f=Math.round(.5*(E-a)),l=0}else{var s=E/o;h=E/n,f=0,l=Math.round(.5*(i-s))}},this.SetData=function(n,i,o){e=n,t=i,A=o||!1},this.SetDebug=function(e){A=e||!1}};var AM=AM||{};AM.ImageLoader=function(){var e=document.createElement("canvas"),t=e.getContext("2d");this.GetImageData=function(n,i,o){var r=new Image;r.onload=function(n,i,o){return function(){if(o){var r=Math.max(n.width,n.height),a=(r-n.width)/2,s=(r-n.height)/2;e.width=r,e.height=r,t.drawImage(n,a,s)}else e.width=n.width,e.height=n.height,t.drawImage(n,0,0,e.width,e.height);var u=t.getImageData(0,0,e.width,e.height);i(u)}}(r,i,o),r.src=n}};var AM=AM||{};AM.JsonLoader=function(){function e(e,t){c=!1,a=void 0,r=void 0,o=void 0,u=void 0,s=void 0,d.progress=0,e&&e(t)}function t(){try{d.json=JSON.parse(u.responseText),e(o)}catch(t){d.json={},e(r,"failed to parse file: "+s)}}function n(t){var n="JsonLoader failed to open file: "+s;console.log(n),e(r,n)}function i(e){d.progress=e.loaded/e.total*100,a&&a()}var o,r,a,s,u,d=this,c=!1;this.json={},this.progress=0,this.IsLoading=function(){return c},this.Load=function(e,d,h,f){c||(c=!0,o=d,r=h,a=f,s=e,u=new XMLHttpRequest,u.onprogress=i,u.open("GET",e,!0),u.onload=t,u.onerror=n,u.send(null))}},AM.LoadJson=function(e){return new Promise(function(t,n){var i=new AM.JsonLoader;i.Load(e,function(){t(i.json)},n)})};var AM=AM||{};AM.LoadingManager=function(){function e(e){for(var t=0,n=e.length;n>t;++t)e[t]()}var t=[],n=[],i=0;this.Start=function(t){t=t||1,i+=t,e(n)},this.End=function(o){o=o||1,i>0&&(i-=o,e(n)),0>=i&&(i=0,e(t),t.length=0,n.length=0)},this.OnEnd=function(e){i>0?t.push(e):e()},this.OnProgress=function(e){i>0?n.push(e):e()},this.IsLoading=function(){return i>0},this.GetRemaining=function(){return i}};var AM=AM||{};!function(){var e=function(){"use strict";function e(){this.start_time=0,this.stop_time=0,this.run_time=0,this.running=!1}return e.prototype.start=function(){this.start_time=(new Date).getTime(),this.running=!0},e.prototype.stop=function(){this.stop_time=(new Date).getTime(),this.run_time=this.stop_time-this.start_time,this.running=!1},e.prototype.get_runtime=function(){return this.run_time},e.prototype.reset=function(){this.run_time=0},e}(),t=function(){"use strict";function e(e){this.arr=new Int32Array(e),this.begin=0,this.end=-1,this.num_el=0,this.arr_size=e}return e.prototype.push_back=function(e){this.num_el<this.arr_size?(this.end++,this.arr[this.end]=e,this.num_el++):(this.end=(this.end+1)%this.arr_size,this.begin=(this.begin+1)%this.arr_size,this.arr[this.end]=e)},e.prototype.get=function(e){return this.arr[(this.begin+e)%this.arr_size]},e.prototype.size=function(){return this.num_el},e}(),n=function(){"use strict";function n(){this.fps=0,this.timers=[],this.frame_timer=new e}var i=0,o=new t(20);return n.prototype.add=function(t){this.timers.push([t,new e])},n.prototype.new_frame=function(){++i;var e=0,t=0|this.timers.length;for(e=0;t>e;++e){var n=this.timers[e][1];n.reset()}if(i>=1){this.frame_timer.stop(),o.push_back(this.frame_timer.get_runtime());var r=o.size(),a=0;for(e=0;r>e;++e)a+=o.get(e);this.fps=r/a*1e3,this.frame_timer.start()}},n.prototype.find_task=function(e){var t=0|this.timers.length,n=0;for(n=0;t>n;++n){var i=this.timers[n];if(i[0]===e)return i}return null},n.prototype.start=function(e){var t=this.find_task(e);t[1].start()},n.prototype.stop=function(e){var t=this.find_task(e);t[1].stop()},n.prototype.log=function(){var e=0|this.timers.length,t=0,n="<strong>FPS: "+this.fps.toFixed(2)+"</strong>";for(t=0;e>t;++t){var i=this.timers[t];n+="<br/>"+i[0]+": "+i[1].get_runtime()+"ms"}return n},n.prototype.log2=function(){var e=0|this.timers.length,t=0,n="FPS: "+this.fps.toFixed(2)+"  ";for(t=0;e>t;++t){var i=this.timers[t];n+=i[0]+": "+i[1].get_runtime()+"ms  "}return n},n.prototype.GetProfiler=function(){return{fps:this.fps,timers:this.timers}},n}();AM.Profiler=n}();var AM=AM||{};AM.DeviceLockScreenOrientation=function(){function e(){window.cordova?(t(),a=!0):s=!1}function t(){for(var e=0,t=u.length;t>e;++e)u[e]();u.length=0}function n(e){s&&(a?e():u.push(e))}function i(){screen.lockOrientation("landscape-primary")}function o(){screen.lockOrientation("portrait-primary")}function r(){screen.unlockOrientation()}var a=!1,s=!0,u=[];document.addEventListener("deviceready",e,!1),this.LockLandscape=function(){n(i)},this.LockPortrait=function(){n(o)},this.Unlock=function(){n(r)}};var AM=AM||{};AM.DeviceOrientationControl=function(e){var t=this;this.object=e,this.object.rotation.reorder("YXZ");var n=!1,i=!1,o=0,r=new this.CoefMethod,a=function(e){n?(r.OnOrientationChange(e),i=!0):n=!0},s=function(){o=window.orientation||0};this.Connect=function(){s(),window.addEventListener("orientationchange",s,!1),window.addEventListener("deviceorientation",a,!1)},this.Disconnect=function(){window.removeEventListener("orientationchange",s,!1),window.removeEventListener("deviceorientation",a,!1),i=!1},this.Update=function(){var e=function(){var e=new THREE.Vector3(0,0,1),t=new THREE.Euler,n=new THREE.Quaternion,i=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));return function(o,r,a,s,u){t.set(a,r,-s,"YXZ"),o.setFromEuler(t),o.multiply(i),o.multiply(n.setFromAxisAngle(e,-u))}}();if(i){var n=o?THREE.Math.degToRad(o):0;r.Update(),e(t.object.quaternion,r.alpha,r.beta,r.gamma,n)}}},AM.DeviceOrientationControl.prototype.PowerMethod=function(){function e(e,t,n){var i=AM.DeviceOrientationControl.prototype.Mod2Pi(t-e),o=Math.sign(i),r=Math.abs(i/Math.PI);return r=Math.pow(r,n),AM.DeviceOrientationControl.prototype.Mod2Pi(e+r*Math.PI*o)}var t,n=this,i=2;this.alpha=0,this.beta=0,this.gamma=0,this.OnOrientationChange=function(e){t=e},this.Update=function(){n.alpha=e(n.alpha,THREE.Math.degToRad(t.alpha),i),n.beta=e(n.beta,THREE.Math.degToRad(t.beta),i),n.gamma=e(n.gamma,THREE.Math.degToRad(t.gamma),i)}},AM.DeviceOrientationControl.prototype.CoefMethod=function(){function e(e,t,n){return e+AM.DeviceOrientationControl.prototype.Mod2Pi(t-e)*n}var t=this;this.coef=.2,this.alpha=0,this.beta=0,this.gamma=0;var n=!1;this.OnOrientationChange=function(e){n=e},this.Update=function(){if(n){var i=e(t.alpha,THREE.Math.degToRad(n.alpha),t.coef),o=e(t.beta,THREE.Math.degToRad(n.beta),t.coef),r=e(t.gamma,THREE.Math.degToRad(n.gamma),t.coef);t.alpha=i,t.beta=o,t.gamma=r}}},AM.DeviceOrientationControl.prototype.AverageMethod=function(){var e=this;this.history=[],this.history_max=10,this.alpha=0,this.beta=0,this.gamma=0,this.OnOrientationChange=function(t){e.history.length>e.history_max&&e.history.shift(),e.history.push(t)},this.Update=function(t,n,i){var t=0,n=0,i=0;if(0!=e.history.length){for(var o=0,r=e.history.length;r>o;o++)t+=AM.DeviceOrientationControl.prototype.Mod360(e.history[o].alpha),n+=AM.DeviceOrientationControl.prototype.Mod360(e.history[o].beta),i+=AM.DeviceOrientationControl.prototype.Mod360(e.history[o].gamma);t/=e.history.length,n/=e.history.length,i/=e.history.length,e.alpha=THREE.Math.degToRad(t),e.beta=THREE.Math.degToRad(n),e.gamma=THREE.Math.degToRad(i)}}},AM.DeviceOrientationControl.prototype.Mod2Pi=function(){var e=Math.PI,t=2*Math.PI;return function(n){if(n>e){do n-=t;while(n>e)}else if(-e>n)do n+=t;while(-e>n);return n}}(),AM.DeviceOrientationControl.prototype.Mod360=function(e){return e%=360,180>e?e:e-360};var AM=AM||{};AM.GeographicCoordinatesConverter=function(e,t){var n=this,i={latitude:0,longitude:0};this.GetLocalCoordinates=function(e,t){var o=(i.latitude+e)/2,r={x:0,y:0};return r.x=(t-i.longitude)*n.EARTH_RADIUS*Math.cos(o),r.y=(e-i.latitude)*-n.EARTH_RADIUS,r},this.GetLocalCoordinatesFromDegres=function(e,t){return n.GetLocalCoordinates(THREE.Math.degToRad(e),THREE.Math.degToRad(t))},this.SetOrigin=function(e,t){i.latitude=e,i.longitude=t},this.SetOriginFromDegres=function(e,t){i.latitude=THREE.Math.degToRad(e),i.longitude=THREE.Math.degToRad(t)},this.GetOrigin=function(){return i},this.SetOrigin(e||0,t||0)},AM.GeographicCoordinatesConverter.prototype.EARTH_RADIUS=6371e3;var AM=AM||{};AM.GeolocationControl=function(e,t){function n(e){a.copy(u.GetLocalCoordinatesFromDegres(e.coords.latitude,e.coords.longitude)),r=!0}function i(e){console.warn("geolocation failed: "+e.message),window.setTimeout(o.Connect,o.retry_connection_ms)}var o=this,r=!1,a=new THREE.Vector3,s=0,u=t,d=.1;this.object=e,this.interpolation_coefficient=.02,this.retry_connection_ms=1e3,this.Connect=function(){s=navigator.geolocation.watchPosition(n,i)},this.Disconnect=function(){navigator.geolocation.clearWatch(s),r=!1},this.Update=function(){if(r){var e=a.x-o.object.position.x,t=a.z-o.object.position.z,n=e*e+t*t;d*d>n?r=!1:(e*=o.interpolation_coefficient,t*=o.interpolation_coefficient,o.object.position.x+=e,o.object.position.z+=t)}}};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.GifTexture=function(e){THREE.Texture.call(this),this.minFilter=THREE.NearestMipMapNearestFilter,this.imageElement=document.createElement("img");var t=document.getElementsByTagName("script");t=t[t.length-1],t.parentNode.appendChild(this.imageElement),this.imageElement.width=this.imageElement.naturalWidth,this.imageElement.height=this.imageElement.naturalHeight,e&&this.setGif(e)},AMTHREE.GifTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.GifTexture.prototype.constructor=AMTHREE.GifTexture,AMTHREE.GifTexture.prototype.play=function(){this.anim.play(),this.image=this.gifCanvas},AMTHREE.GifTexture.prototype.update=function(){this.needsUpdate=!0},AMTHREE.GifTexture.prototype.stop=function(){this.anim.move_to(0),this.image=void 0},AMTHREE.GifTexture.prototype.pause=function(){this.anim.pause()},AMTHREE.GifTexture.prototype.setGif=function(e){e.url&&(this.image_ref=e,this.imageElement.src=e.url,this.anim=new SuperGif({gif:this.imageElement,auto_play:!1}),this.anim.load(),this.gifCanvas=this.anim.get_canvas(),this.gifCanvas.style.display="none")},AMTHREE.GifTexture.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,this.image_ref&&(t.image=this.image_ref.uuid),t.animated=!0,this.image_ref.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.GifTexture=function(){console.warn("GifTexture.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Image=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url=t},AMTHREE.Image.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,t.url=AMTHREE.GetFilename(this.url),"object"==typeof e&&(e.images||(e.images={}),e.images[t.uuid]=t),t}):AMTHREE.Image=function(){console.warn("Image.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.ImageTexture=function(e){THREE.Texture.call(this),this.image=new Image,this.image.addEventListener("load",function(e){return function(){e.needsUpdate=!0}}(this)),this.set(e)},AMTHREE.ImageTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.ImageTexture.prototype.constructor=AMTHREE.ImageTexture,AMTHREE.ImageTexture.prototype.set=function(e){this.image_ref=e,this.image.src=e.url},AMTHREE.ImageTexture.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,t.image=this.image_ref.uuid,this.image_ref.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.ImageTexture=function(){console.warn("ImageTexture.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?AMTHREE.ObjectLoader=function(e){var t=this;this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.constants={},this.geometries={},this.materials={},this.animations=[],this.images={},this.videos={},this.textures={},this.json={},this.root,this.Load=function(e,n){var i=new THREE.XHRLoader(t.manager);i.load(e,function(e){return function(n){t.json=JSON.parse(n),e(t.Parse(t.json))}}(n))},this.Parse=function(e){t.json=e,t.ParseConstants(e.constants),t.ParseGeometries(e.geometries),t.ParseImages(e.images),t.ParseVideos(e.videos),t.ParseTextures(e.textures),t.ParseMaterials(e.materials),t.ParseAnimations(e.animations);var n=t.ParseObject(e.object);return n.animations=t.animations,n},this.ParseConstants=function(e){data=void 0!==e?e:{},t.constants.asset_path=t.root?t.root+"/":"",data.asset_path&&(t.constants.asset_path=t.constants.asset_path+data.asset_path+"/"),t.constants.image_path=t.constants.asset_path+(void 0!==data.image_path?data.image_path:""),t.constants.video_path=t.constants.asset_path+(void 0!==data.video_path?data.video_path:""),t.constants.model_path=t.constants.asset_path+(void 0!==data.model_path?data.model_path:"")},this.ParseMaterials=function(e){if(void 0!==e){var n=new THREE.MaterialLoader;n.setTextures(t.textures);for(var i=0,o=e.length;o>i;i++){var r=n.parse(e[i]);t.materials[r.uuid]=r}}},this.ParseAnimations=function(e){if(void 0!==e){t.animations=[];for(var n=0;n<e.length;n++){var i=THREE.AnimationClip.parse(e[n]);t.animations.push(i)}}},this.ParseImages=function(e){function n(e){return t.manager.itemStart(e),o.load(e,function(){t.manager.itemEnd(e)})}if(void 0!==e&&e.length>0)for(var i=new THREE.LoadingManager,o=new THREE.ImageLoader(i),r=0,a=e.length;a>r;r++){var s=e[r];if(void 0===s.url)console.warn('AMTHREE.ObjectLoader: no "url" specified for image '+r);else if(void 0===s.uuid)console.warn('AMTHREE.ObjectLoader: no "uuid" specified for image '+r);else{var u=t.constants.image_path+"/"+s.url;t.images[s.uuid]=n(u)}}},this.ParseVideos=function(e){if(void 0!==e)for(var n=0,i=e.length;i>n;n++){var o=e[n];if(void 0===o.url)console.warn('AMTHREE.ObjectLoader: no "url" specified for video '+n);else if(void 0===o.uuid)console.warn('AMTHREE.ObjectLoader: no "uuid" specified for video '+n);else{var r={url:t.constants.video_path+"/"+o.url,uuid:o.uuid,width:o.width||640,height:o.height||480};t.videos[o.uuid]=r}}},this.ParseTextures=function(e){function n(e){return"number"==typeof e?e:(console.warn("AMTHREE.ObjectLoader.parseTexture: Constant should be in numeric form.",e),THREE[e])}if("undefined"==typeof SuperGif&&console.warn("AMTHREE.ObjectLoader: SuperGif is undefined"),void 0!==e)for(var i=0,o=e.length;o>i;i++){var r=e[i];if(void 0!==r.image||void 0!==r.video){if(void 0!==r.image){if(void 0===t.images[r.image]){console.warn("AMTHREE.ObjectLoader: Undefined image",r.image);continue}var a=t.images[r.image];if(void 0!==r.animated&&r.animated){if("undefined"==typeof SuperGif)continue;var s=new AMTHREE.GifTexture(a.src)}else{var s=new THREE.Texture(a);s.needsUpdate=!0}}else{if(void 0===t.videos[r.video]){console.warn("AMTHREE.ObjectLoader: Undefined video",r.video);continue}var u=t.videos[r.video],s=new AMTHREE.VideoTexture({src:u.url,width:u.width,height:u.height,loop:r.loop,autoplay:r.autoplay})}s.uuid=r.uuid,void 0!==r.name&&(s.name=r.name),void 0!==r.mapping&&(s.mapping=n(r.mapping)),void 0!==r.offset&&(s.offset=new THREE.Vector2(r.offset[0],r.offset[1])),void 0!==r.repeat&&(s.repeat=new THREE.Vector2(r.repeat[0],r.repeat[1])),void 0!==r.minFilter?s.minFilter=n(r.minFilter):s.minFilter=THREE.LinearFilter,void 0!==r.magFilter&&(s.magFilter=n(r.magFilter)),void 0!==r.anisotropy&&(s.anisotropy=r.anisotropy),Array.isArray(r.wrap)&&(s.wrapS=n(r.wrap[0]),s.wrapT=n(r.wrap[1])),t.textures[r.uuid]=s}else console.warn('AMTHREE.ObjectLoader: No "image" nor "video" specified for',r.uuid)}},this.ParseGeometries=function(e){if(void 0!==e)for(var n=new THREE.JSONLoader,i=new THREE.BufferGeometryLoader,o=0,r=e.length;r>o;o++){var a,s=e[o];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":a=new THREE[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"CubeGeometry":a=new THREE.BoxGeometry(s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleBufferGeometry":a=new THREE.CircleBufferGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CircleGeometry":a=new THREE.CircleGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":a=new THREE.CylinderGeometry(s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"SphereGeometry":a=new THREE.SphereGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"SphereBufferGeometry":a=new THREE.SphereBufferGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":a=new THREE.DodecahedronGeometry(s.radius,s.detail);break;case"IcosahedronGeometry":a=new THREE.IcosahedronGeometry(s.radius,s.detail);break;case"OctahedronGeometry":a=new THREE.OctahedronGeometry(s.radius,s.detail);break;case"TetrahedronGeometry":a=new THREE.TetrahedronGeometry(s.radius,s.detail);break;case"RingGeometry":a=new THREE.RingGeometry(s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":a=new THREE.TorusGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":a=new THREE.TorusKnotGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.p,s.q,s.heightScale);break;case"BufferGeometry":a=i.parse(s);break;case"Geometry":a=n.parse(s.data,this.texturePath).geometry;break;default:console.warn('AMTHREE.ObjectLoader: Unsupported geometry type "'+s.type+'"');continue}a.uuid=s.uuid,void 0!==s.name&&(a.name=s.name),t.geometries[s.uuid]=a}},this.ParseObject=function(){function n(e,t){var n=new THREE.Matrix4;e.uuid=t.uuid,void 0!==t.name&&(e.name=t.name),void 0!==t.matrix?(n.fromArray(t.matrix),n.decompose(e.position,e.quaternion,e.scale)):(void 0!==t.position&&e.position.fromArray(t.position),void 0!==t.rotation&&e.rotation.fromArray(t.rotation),void 0!==t.scale&&e.scale.fromArray(t.scale),void 0!==t.scaleXYZ&&(e.scale.x*=t.scaleXYZ,e.scale.y*=t.scaleXYZ,e.scale.z*=t.scaleXYZ)),void 0!==t.castShadow&&(e.castShadow=t.castShadow),void 0!==t.receiveShadow&&(e.receiveShadow=t.receiveShadow),void 0!==t.visible&&(e.visible=t.visible),void 0!==t.userData&&(e.userData=t.userData)}if(THREE.ColladaLoader){var i=new THREE.ColladaLoader;i.options.convertUpAxis=!0}else console.warn("AMTHREE.ObjectLoader: THREE.ColladaLoader undefined");if(THREE.OBJLoader)var o=new THREE.OBJLoader;else console.warn("AMTHREE.ObjectLoader: THREE.OBJLoader undefined");if(THREE.OBJMTLLoader)var r=new THREE.OBJMTLLoader;else console.warn("AMTHREE.ObjectLoader: THREE.OBJMTLLoader undefined");return function(a,s){function u(e){return void 0!==e?(void 0===t.geometries[e]&&console.warn("AMTHREE.ObjectLoader: Undefined geometry",e),t.geometries[e]):void 0}function d(e){return void 0!==e?(void 0===t.materials[e]&&console.warn("AMTHREE.ObjectLoader: Undefined material",e),t.materials[e]):void 0}var c;switch(a.type){case"Scene":c=new THREE.Scene;break;case"PerspectiveCamera":c=new THREE.PerspectiveCamera(a.fov,a.aspect,a.near,a.far);break;case"OrthographicCamera":c=new THREE.OrthographicCamera(a.left,a.right,a.top,a.bottom,a.near,a.far);break;case"AmbientLight":c=new THREE.AmbientLight(a.color);break;case"DirectionalLight":c=new THREE.DirectionalLight(a.color,a.intensity);break;case"PointLight":c=new THREE.PointLight(a.color,a.intensity,a.distance,a.decay);break;case"SpotLight":c=new THREE.SpotLight(a.color,a.intensity,a.distance,a.angle,a.exponent,a.decay);break;case"HemisphereLight":c=new THREE.HemisphereLight(a.color,a.groundColor,a.intensity);break;case"Mesh":c=new THREE.Mesh(u(a.geometry),d(a.material));break;case"LOD":c=new THREE.LOD;break;case"Line":c=new THREE.Line(u(a.geometry),d(a.material),a.mode);break;case"PointCloud":case"Points":c=new THREE.Points(u(a.geometry),d(a.material));break;case"Sprite":c=new THREE.Sprite(d(a.material));break;case"Group":c=new THREE.Group;break;case"OBJ":if("undefined"==typeof o)return void console.warn("AMTHREE.ObjectLoader: failed to load "+a.uuid+": THREE.OBJLoader is undefined");c=new THREE.Object3D;var h=t.constants.model_path+"/"+a.url;t.manager.itemStart(h),o.load(h,function(e,t,i,o){return function(r){e.copy(r),e.traverse(function(e){e.geometry&&e.geometry.computeBoundingSphere()}),n(e,t),i.itemEnd(o)}}(c,a,t.manager,h));break;case"OBJMTL":if("undefined"==typeof r)return void console.warn("AMTHREE.ObjectLoader: failed to load "+a.uuid+": THREE.OBJMTLLoader is undefined");c=new THREE.Group;var f=t.constants.model_path+"/"+a.objUrl,l=t.constants.model_path+"/"+a.mtlUrl;t.manager.itemStart(f),t.manager.itemStart(l),r.load(f,l,function(e,t,i,o,r){return function(a){e.copy(a),e.traverse(function(e){e.geometry&&e.geometry.computeBoundingSphere()}),n(e,t),i.itemEnd(o),i.itemEnd(r)}}(c,a,t.manager,f,l));break;case"Collada":if("undefined"==typeof i)return void console.warn("ObjectLoader: failed to load "+a.uuid+": THREE.ColladaLoader is undefined");c=new THREE.Group;var h=t.constants.model_path+"/"+a.url;t.manager.itemStart(h),i.load(h,function(e,t,i,o){return function(r){var a=r.scene;e.copy(a),"undefined"!=typeof THREE.Animation&&e.traverse(function(e){if(e instanceof THREE.SkinnedMesh){var t=new THREE.Animation(e,e.geometry.animation);t.play()}}),n(e,t),i.itemEnd(o)}}(c,a,e,h));case"Sound":c=new AMTHREE.Sound(a.url);break;case"ImagePlane":var h;h=t.constants.image_path?t.constants.image_path+"/"+a.url:a.url,c=new AMTHREE.ImagePlane(h);break;default:c=new THREE.Object3D}if(n(c,a),void 0!==a.children)for(var m in a.children){var E=t.ParseObject(a.children[m],c);void 0!==E&&c.add(E)}if("LOD"===a.type)for(var p=a.levels,g=0;g<p.length;g++){var v=p[g],m=c.getObjectByProperty("uuid",v.object);void 0!==m&&c.addLevel(m,v.distance)}return void 0!==s&&s.add(c),c}}()}:AMTHREE.ObjectLoader=function(){console.warn("ObjectLoader.js: THREE undefined")};var AMTHREE=AMTHREE||{};!function(){function e(e,t){e=e||{};var n={};return t?n.asset_path=t+"/":n.asset_path="",n.asset_path+=e.asset_path?e.asset_path+"/":"",n.image_path=n.asset_path+(e.image_path?e.image_path:""),n.video_path=n.asset_path+(e.video_path?e.video_path:""),n.model_path=n.asset_path+(e.model_path?e.model_path:""),n}function t(e,t){var n={};if(e instanceof Array){var i=new THREE.MaterialLoader;i.setTextures(t);for(var o=0,r=e.length;r>o;o++){var a=i.parse(e[o]);n[a.uuid]=a}}else console.log("materials parsing failed: json not an array");return n}function n(e){var t=[];if(e instanceof Array)for(var n=0;n<e.length;n++){var i=THREE.AnimationClip.parse(e[n]);t.push(i)}else console.log("animations parsing failed: json not an array");return t}function o(e,t){var n={};if(e instanceof Array)for(var i=0,o=e.length;o>i;++i){var r=e[i];if(void 0===r.uuid)console.warn('failed to parse sound: no "uuid" specified for sound '+i);else if(void 0===r.url)console.warn('failed to parse sound: no "url" specified for sound '+i);else{var a=new AMTHREE.Sound(r.uuid,t+"/"+r.url);n[r.uuid]=a}}return n}function r(e,t){return new Promise(function(n,o){var r={};return e instanceof Array?Promise.all(e.map(function(e){return new Promise(function(n,o){if(void 0===e.url)o('failed to parse image: no "url" specified for image '+i);else if(void 0===e.uuid)o('failed to parse image: no "uuid" specified for image '+i);else{var a=new AMTHREE.Image(e.uuid,t+"/"+e.url);r[a.uuid]=a,n()}})})).then(n(r),o):void o("images parsing failed: json not an array")})}function a(e,t){var n={};if(e instanceof Array)for(var i=0,o=e.length;o>i;i++){var r=e[i];if(void 0===r.uuid)console.warn('failed to parse video: no "uuid" specified for video '+i);else if(void 0===r.url)console.warn('failed to parse video: no "url" specified for video '+i);else{var a=new AMTHREE.Video(r.uuid,t+"/"+r.url);n[r.uuid]=a}}return n}function s(e){return"number"==typeof e?e:(console.warn("AMTHREE.ObjectLoader.parseTexture: Constant should be in numeric form.",e),THREE[e])}function u(e,t,n){var i={};if("undefined"==typeof SuperGif&&console.warn("AMTHREE.ObjectLoading: SuperGif is undefined"),"undefined"!=typeof e)for(var o=0,r=e.length;r>o;o++){var a=e[o];if(a.uuid||console.warn("failed to parse texture "+o+": no uuid provided"),void 0!==a.image||void 0!==a.video){if(void 0!==a.image){if(void 0===t[a.image]){console.warn("failed to parse texture "+a.uuid+": undefined image",a.image);continue}var u=t[a.image];if(void 0!==a.animated&&a.animated){if("undefined"==typeof SuperGif)continue;var d=new AMTHREE.GifTexture(u)}else{var d=new AMTHREE.ImageTexture(u);d.needsUpdate=!0}}else{if(void 0===n[a.video]){console.warn("failed to parse texture "+a.uuid+": undefined video",a.video);continue}var c=n[a.video],d=new AMTHREE.VideoTexture(c,a.width,a.height,a.loop,a.autoplay)}d.uuid=a.uuid,void 0!==a.name&&(d.name=a.name),void 0!==a.mapping&&(d.mapping=s(a.mapping)),void 0!==a.offset&&(d.offset=new THREE.Vector2(a.offset[0],a.offset[1])),void 0!==a.repeat&&(d.repeat=new THREE.Vector2(a.repeat[0],a.repeat[1])),void 0!==a.minFilter?d.minFilter=s(a.minFilter):d.minFilter=THREE.LinearFilter,void 0!==a.magFilter&&(d.magFilter=s(a.magFilter)),void 0!==a.anisotropy&&(d.anisotropy=a.anisotropy),Array.isArray(a.wrap)&&(d.wrapS=s(a.wrap[0]),d.wrapT=s(a.wrap[1])),i[a.uuid]=d}else console.warn('failed to parse texture: no "image" nor "video" specified for '+a.uuid)}return i}function d(e){var t={};if("undefined"!=typeof e)for(var n=new THREE.JSONLoader,i=new THREE.BufferGeometryLoader,o=0,r=e.length;r>o;o++){var a,s=e[o];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":a=new THREE[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"CubeGeometry":a=new THREE.BoxGeometry(s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleBufferGeometry":a=new THREE.CircleBufferGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CircleGeometry":a=new THREE.CircleGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":a=new THREE.CylinderGeometry(s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);
break;case"SphereGeometry":a=new THREE.SphereGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"SphereBufferGeometry":a=new THREE.SphereBufferGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":a=new THREE.DodecahedronGeometry(s.radius,s.detail);break;case"IcosahedronGeometry":a=new THREE.IcosahedronGeometry(s.radius,s.detail);break;case"OctahedronGeometry":a=new THREE.OctahedronGeometry(s.radius,s.detail);break;case"TetrahedronGeometry":a=new THREE.TetrahedronGeometry(s.radius,s.detail);break;case"RingGeometry":a=new THREE.RingGeometry(s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":a=new THREE.TorusGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":a=new THREE.TorusKnotGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.p,s.q,s.heightScale);break;case"BufferGeometry":a=i.parse(s);break;case"Geometry":a=n.parse(s.data,this.texturePath).geometry;break;default:console.warn('AMTHREE.ObjectLoader: Unsupported geometry type "'+s.type+'"');continue}a.uuid=s.uuid,void 0!==s.name&&(a.name=s.name),t[s.uuid]=a}return t}function c(e,t,n){return new Promise(function(i,o){var r=new AM.JsonLoader;r.Load(e,function(){t(r.json,n).then(i,o)},function(){o("failed to load object: "+e)})})}function h(e,t){return c(e,m,t)}function f(e,t){return c(e,E,t)}function l(i,s){var c=e(i.constants,s);return r(i.images||[],c.image_path).then(function(e){var r=o(i.sounds||[],c.sound_path),s=a(i.videos||[],c.video_path),h=u(i.textures||[],e,s),f=n(i.animations||[]),l=t(i.materials||[],h),m=d(i.geometries||[]),E={constants:c,videos:s,images:e,sounds:r,textures:h,animations:f,materials:l,geometries:m};return E})}function m(e,t){return l(e,t).then(function(t){return y(e.object,t.materials,t.geometries,t.sounds,t.constants.model_path).then(function(e){return e.animations=t.animations,e})})}function E(e,t){return l(e,t).then(function(t){return w(e.objects,t.materials,t.geometries,t.constants.model_path)})}function p(e,t,n,i,o){var r=new THREE.Matrix4;if(e.uuid=t.uuid,void 0!==t.name&&(e.name=t.name),void 0!==t.matrix?(r.fromArray(t.matrix),r.decompose(e.position,e.quaternion,e.scale)):(void 0!==t.position&&e.position.fromArray(t.position),void 0!==t.rotation&&e.rotation.fromArray(t.rotation),void 0!==t.scale&&e.scale.fromArray(t.scale),void 0!==t.scaleXYZ&&(e.scale.x*=t.scaleXYZ,e.scale.y*=t.scaleXYZ,e.scale.z*=t.scaleXYZ)),void 0!==t.castShadow&&(e.castShadow=t.castShadow),void 0!==t.receiveShadow&&(e.receiveShadow=t.receiveShadow),void 0!==t.visible&&(e.visible=t.visible),void 0!==t.userData&&(e.userData=t.userData),"LOD"===t.type)for(var a=t.levels,s=0;s<a.length;s++){var u=a[s],d=e.getObjectByProperty("uuid",u.object);void 0!==d&&e.addLevel(d,u.distance)}return void 0!==t.children?w(t.children,n,i,o).then(function(t){for(var n=0,i=t.length;i>n;++n)e.add(t[n]);return e}):Promise.resolve(e)}function g(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get geometry: no id provided"):console.warn("failed to get geometry: no such geometry: "+e))}function v(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get material: no id provided"):console.warn("failed to get material: no such material: "+e))}function T(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get sound: no id provided"):console.warn("failed to get sound: no such sound: "+e))}function y(e,t,n,i,o){var r;switch(e.type){case"OBJ":if(THREE.OBJLoader){var a=new THREE.OBJLoader,s=o+"/"+e.url;a.load(s,function(i){i.traverse(function(e){e.geometry&&e.geometry.computeBoundingSphere()}),p(i,e,t,n,o).then(resolve,reject)})}else reject("failed to load "+e.uuid+": THREE.OBJLoader is undefined");return;case"OBJMTL":if(THREE.OBJMTLLoader){var u=new THREE.OBJMTLLoader,d=o+"/"+e.objUrl,c=o+"/"+e.mtlUrl;u.load(d,c,function(i){i.traverse(function(e){e.geometry&&e.geometry.computeBoundingSphere()}),p(i,e,t,n,o).then(resolve,reject)})}else reject("failed to load "+e.uuid+": THREE.OBJMTLLoader is undefined");return;case"Collada":if(THREE.ColladaLoader){var h=new THREE.ColladaLoader;h.options.convertUpAxis=!0;var s=o+"/"+e.url;h.load(s,function(i){var r=i.scene;p(r,e,t,n,o).then(resolve,reject)})}else reject("failed to load "+e.uuid+": THREE.ColladaLoader is undefined");return;case"SoundObject":r=new AMTHREE.SoundObject(T(e.sound,i));break;case"Scene":r=new THREE.Scene;break;case"PerspectiveCamera":r=new THREE.PerspectiveCamera(e.fov,e.aspect,e.near,e.far);break;case"OrthographicCamera":r=new THREE.OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far);break;case"AmbientLight":r=new THREE.AmbientLight(e.color);break;case"DirectionalLight":r=new THREE.DirectionalLight(e.color,e.intensity);break;case"PointLight":r=new THREE.PointLight(e.color,e.intensity,e.distance,e.decay);break;case"SpotLight":r=new THREE.SpotLight(e.color,e.intensity,e.distance,e.angle,e.exponent,e.decay);break;case"HemisphereLight":r=new THREE.HemisphereLight(e.color,e.groundColor,e.intensity);break;case"Mesh":r=new THREE.Mesh(g(e.geometry,n),v(e.material,t));break;case"LOD":r=new THREE.LOD;break;case"Line":r=new THREE.Line(g(e.geometry,n),v(e.material,t),e.mode);break;case"PointCloud":case"Points":r=new THREE.Points(g(e.geometry,n),v(e.material,t));break;case"Sprite":r=new THREE.Sprite(v(e.material,t));break;case"Group":r=new THREE.Group;break;default:r=new THREE.Object3D}return p(r,e,t,n,o)}function w(e,t,n,i,o){return e instanceof Array?Promise.all(e.map(function(e){return y(e,t,n,i,o)})):Promise.reject("failed to parse object array: json not an array")}function R(e){var t=new THREE.Box3,n=new THREE.Sphere,i=new THREE.Object3D;i.add(elem),t.setFromObject(elem),t.getBoundingSphere(n),i.scale.multiplyScalar(1/n.radius),n.center.divideScalar(n.radius),i.position.sub(n.center);var o=new THREE.Object3D;return o.add(i),o}"undefined"!=typeof THREE&&(AMTHREE.ParseObject=m,AMTHREE.ParseObjectArray=E,AMTHREE.LoadObject=h,AMTHREE.LoadObjectArray=f,AMTHREE.NormalizeObject=R)}();var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?AMTHREE.Scene=function(e){function t(){s.aspect=window.innerWidth/window.innerHeight,s.updateProjectionMatrix(),r.setSize(window.innerWidth,window.innerHeight)}function n(e){if(o.gps_converter&&void 0!==e.userData&&void 0!==e.position){var t=e.userData;if(void 0!==t.latitude&&void 0!==t.longitude){var n=o.gps_converter(t.latitude,t.longitude);e.position.z=n.y,e.position.x=n.x}void 0!==t.altitude&&(e.position.y=t.altitude)}}"undefined"==typeof AMTHREE.ObjectLoader&&console.warn("AMTHREE.Scene: AMTHREE.ObjectLoader undefined"),e=e||{};var i,o=this,r=new THREE.WebGLRenderer({alpha:!0,canvas:e.canvas}),a=new THREE.Scene,s=new THREE.PerspectiveCamera(e.fov||80,r.domElement.width/r.domElement.height,1e-4,1e4),u=new THREE.Object3D,d=new THREE.LoadingManager;u.add(s),a.add(u),e.canvas||(r.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(r.domElement)),r.setClearColor(10066383,0),"undefined"!=typeof AMTHREE.ObjectLoader&&(i=new AMTHREE.ObjectLoader(d)),this.gps_converter=e.gps_converter,this.Clear=function(){a.children=[],a.copy(new THREE.Scene,!1)},this.SetFullWindow=function(){window.addEventListener("resize",t,!1),t()},this.StopFullWindow=function(){window.removeEventListener("resize",t,!1)},this.Render=function(){r.render(a,s)},this.Update=function(){var e=new THREE.Clock;return function(){THREE.AnimationHandler&&THREE.AnimationHandler.update(e.getDelta()),AMTHREE.UpdateAnimatedTextures(a)}}(),this.AddObject=function(e){n(e),a.add(e)},this.RemoveObject=function(e){a.remove(e)};var c=function(e){return function(t){var n=function(t){return function(){for(;t.children.length;){var n=t.children[0];t.remove(n),o.AddObject(n)}a.copy(t,!1),AMTHREE.PlayAnimations(a),e&&e()}}(t);d.onLoad=n}};this.Parse=function(e,t){if(i){var n=new c(t),o=i.parse(e);n(o)}else console.warn("AMTHREE.Scene: Parse failed: AMTHREE.ObjectLoader undefined")},this.Load=function(e,t){i?i.Load(e,new c(t)):console.warn("AMTHREE.Scene: Load failed: AMTHREE.ObjectLoader undefined")},this.GetCamera=function(){return s},this.GetCameraBody=function(){return u},this.GetScene=function(){return a},this.GetRenderer=function(){return r},this.ResizeRenderer=function(e,t){r.setSize(e,t),s.aspect=r.domElement.width/r.domElement.height,s.updateProjectionMatrix()}}:AMTHREE.Scene=function(){console.warn("Scene.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Sound=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url=t},AMTHREE.Sound.prototype.toJSON=function(e){var t={uuid:this.uuid,url:AMTHREE.GetFilename(this.url)};return e.sounds||(e.sounds={}),e.sounds[this.uuid]||(e.sounds[this.uuid]=t),t}):AMTHREE.Sound=function(){console.warn("Sound.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.SoundObject=function(e){THREE.Object3D.call(this),this.sound=e,this.audio=new Audio,this.audio.loop=!0,this.playing=!1},AMTHREE.SoundObject.prototype=Object.create(THREE.Object3D.prototype),AMTHREE.SoundObject.prototype.constructor=AMTHREE.SoundObject,AMTHREE.SoundObject.prototype.play=function(){this.playing=!0,this.audio.src=this.sound.url,this.audio.play()},AMTHREE.SoundObject.prototype.stop=function(){this.audio.src="",this.playing=!1},AMTHREE.SoundObject.prototype.pause=function(){this.audio.pause(),this.playing=!1},AMTHREE.SoundObject.prototype.setSound=function(e){this.sound=e,this.isPlaying()&&this.play()},AMTHREE.SoundObject.prototype.isPlaying=function(){return this.playing},AMTHREE.SoundObject.prototype.clone=function(){return(new AMTHREE.SoundObject).copy(this)},AMTHREE.SoundObject.prototype.copy=function(e){return this.setSound(e.sound),this},AMTHREE.SoundsCall=function(e,t){e.traverse(function(e){e instanceof AMTHREE.SoundObject&&e[t]&&e[t]()})},AMTHREE.PlaySounds=function(e){AMTHREE.SoundsCall(e,"play")},AMTHREE.PauseSounds=function(e){AMTHREE.SoundsCall(e,"pause")},AMTHREE.StopSounds=function(e){AMTHREE.SoundsCall(e,"stop")},AMTHREE.SoundObject.prototype.toJSON=function(e){var t=THREE.Object3D.prototype.toJSON.call(this,e);return t.object.type="SoundObject",t.object.sound=this.sound.uuid,t}):AMTHREE.SoundObject=function(){console.warn("SoundObject.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.TrackedObjManager=function(e){function t(e,t,n){e.position.lerp(t.position,n),e.quaternion.slerp(t.quaternion,n),e.scale.lerp(t.scale,n)}function n(){r.ForEach(function(e){e.enabled&&t(e.object,e.target,i.lerp_factor)})}e=e||{};var i=this,o=new THREE.Clock(!0),r=new AMTHREE.TrackedObjManager.prototype.Holder,a=n;this.camera=e.camera,this.lerp_factor=e.lerp_factor||.8,this.timeout=e.timeout||6,this.Add=function(e,t,n,i){r.Add(e,t,n,i)},this.Remove=function(e){r.Remove(e)},this.Clear=function(){r.Clear()},this.Update=function(){r.UpdateElapsed(o.getDelta()),r.CheckTimeout(i.timeout),a()},this.Track=function(){var e=new THREE.Matrix4,n=new THREE.Object3D;return function(o,a){if(i.camera){var s=r.Get(o);if(s){var u=s.target;return e.copy(i.camera.matrixWorld),e.multiply(a),s.enabled?(e.decompose(n.position,n.quaternion,n.scale),t(u,n,i.lerp_factor)):(e.decompose(u.position,u.quaternion,u.scale),e.decompose(s.object.position,s.object.quaternion,s.object.scale)),r.Track(o),!0}console.warn("TrackedObjManager: object "+o+" not found")}else console.warn("TrackedObjManager: camera is undefined");return!1}}(),this.TrackCompose=function(){var e=new THREE.Matrix4;return function(t,n,o,r){return e.compose(n,o,r),i.Track(t,e)}}(),this.TrackComposePosit=function(){var e=new THREE.Vector3,t=new THREE.Euler,n=new THREE.Quaternion,o=new THREE.Vector3;return function(r,a,s,u){return e.x=a[0],e.y=a[1],e.z=-a[2],t.x=-Math.asin(-s[1][2]),t.y=-Math.atan2(s[0][2],s[2][2]),t.z=Math.atan2(s[1][0],s[1][1]),o.x=u,o.y=u,o.z=u,n.setFromEuler(t),i.TrackCompose(r,e,n,o)}}(),this.GetObject=function(e){var t=r.get(e);return t?t.object:void 0}},AMTHREE.TrackedObjManager.prototype.Holder=function(){var e=this,t={};this.Add=function(e,n,i,o){t[n]={object:e,target:{position:e.position.clone(),quaternion:e.quaternion.clone(),scale:e.scale.clone()},elapsed:0,on_enable:i,on_disable:o,enabled:!1}},this.Remove=function(e){var n=t[e];n.enabled&&n.on_disable&&n.on_disable(n.object),delete t[e]},this.Clear=function(){for(uuid in t)e.Remove(uuid)},this.Track=function(e){var n=t[e];n.elapsed=0,n.enabled||(n.enabled=!0,n.on_enable&&n.on_enable(n.object))},this.UpdateElapsed=function(e){for(uuid in t)t[uuid].elapsed+=e},this.CheckTimeout=function(e){for(uuid in t){var n=t[uuid];n.enabled&&n.elapsed>e&&(n.on_disable&&n.on_disable(n.object),n.enabled=!1)}},this.ForEach=function(e){for(uuid in t)e(t[uuid])},this.Get=function(e){return t[e]}}):AMTHREE.TrackedObjManager=function(){console.warn("TrackedObjManager.js: THREE undefined")};var AMTHREE=AMTHREE||{};AMTHREE.AnimatedTextureCall=function(e,t){e.traverse(function(e){e.material&&e.material.map&&e.material.map[t]&&e.material.map[t]()})},AMTHREE.PlayAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"play")},AMTHREE.StopAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"stop")},AMTHREE.PauseAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"pause")},AMTHREE.UpdateAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"update")},AMTHREE.WorldToCanvasPosition=function(e,t,n){var i=new THREE.Vector3;i.copy(e),i.project(t);var o=Math.round((i.x+1)*n.width/2),r=Math.round((-i.y+1)*n.height/2);return{x:o,y:r,z:i.z}},AMTHREE.PlayAnimations=function(e){e.traverse(function(e){if(e instanceof THREE.SkinnedMesh){var t=new THREE.Animation(e,e.geometry.animation);t.play()}})},AMTHREE.GetFilename=function(e){return e.split("/").pop().split("\\").pop()},AMTHREE.IMAGE_PATH="images/",AMTHREE.MODEL_PATH="models/",AMTHREE.VIDEO_PATH="videos/",AMTHREE.SOUND_PATH="sounds/";var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Video=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url="string"==typeof t?t:void 0},AMTHREE.Video.prototype.toJSON=function(e){var t={uuid:this.uuid,url:AMTHREE.GetFilename(this.url)};return"object"==typeof e&&(e.videos||(e.videos={}),e.videos[t.uuid]=t),t}):AMTHREE.Video=function(){console.warn("Video.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.VideoTexture=function(e,t,n,i,o,r){THREE.Texture.call(this),this.uuid="string"==typeof t?t:THREE.Math.generateUUID(),this.minFilter=THREE.NearestMipMapNearestFilter,this.videoElement=document.createElement("video"),this.needsUpdate=!1,this.set(e,n,i,o,r)},AMTHREE.VideoTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.VideoTexture.prototype.constructor=AMTHREE.VideoTexture,AMTHREE.VideoTexture.prototype.play=function(){this.videoElement&&!this.playing&&this.video&&(this.paused||(this.videoElement.src=this.video.url),this.videoElement.setAttribute("crossorigin","anonymous"),this.videoElement.play(),this.image=this.videoElement,this.playing=!0)},AMTHREE.VideoTexture.prototype.update=function(){this.videoElement&&this.videoElement.readyState==this.videoElement.HAVE_ENOUGH_DATA&&(this.needsUpdate=!0)},AMTHREE.VideoTexture.prototype.pause=function(){this.videoElement&&!this.videoElement.paused&&(this.videoElement.pause(),this.playing=!1)},AMTHREE.VideoTexture.prototype.stop=function(){this.videoElement&&(this.pause(),this.videoElement.src="",this.image=void 0,this.needsUpdate=!0)},AMTHREE.VideoTexture.prototype.set=function(e,t,n,i,o){this.stop(),this.video=e,this.videoElement.width="number"==typeof t?t:void 0,this.videoElement.height="number"==typeof n?n:void 0,this.videoElement.autoplay="bool"==typeof o?o:!1,this.videoElement.loop="bool"==typeof i?i:!0,this.playing=!1,this.videoElement.autoplay&&this.play()},AMTHREE.VideoTexture.prototype.toJSON=function(e){var t={uuid:this.uuid,video:this.video.uuid,width:this.videoElement.width,height:this.videoElement.height,loop:this.videoElement.loop,autoplay:this.videoElement.autoplay};return this.video.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.VideoTexture=function(){console.warn("VideoTexture.js: THREE undefined")};var AM=AM||{};AM.Detection=function(){function e(e,t){var n=e*t;if(n>i.length)for(;--n>=0;)i[n]=new jsfeat.keypoint_t}var t={laplacian_threshold:30,eigen_threshold:25,detection_corners_max:500,border_size:15,fast_threshold:20},n=!1,i=[],o=0,r=new jsfeat.matrix_t(32,t.detection_corners_max,jsfeat.U8_t|jsfeat.C1_t);this.Detect=function(a){e(a.cols,a.rows),o=AM.DetectKeypointsYape06(a,i,t.detection_corners_max,t.laplacian_threshold,t.eigen_threshold,t.border_size),jsfeat.orb.describe(a,i,o,r),n&&console.log("Learn : "+o+" corners")},this.SetParameters=function(e){for(name in e)"undefined"!=typeof t[name]&&(t[name]=e[name])},this.GetDescriptors=function(){return r},this.GetNumCorners=function(){return o},this.GetCorners=function(){return i}},AM.IcAngle=function(){var e=new Int32Array([15,15,15,15,14,14,14,13,13,12,11,10,9,8,6,3,0]),t=Math.PI/2;return function(n,i,o){var r=15,a=0,s=0,u=n.data,d=n.cols,c=0,h=0,f=o*d+i|0,l=0,m=0,E=0,p=0;for(c=-r;r>=c;++c)s+=c*u[f+c];for(h=1;r>=h;++h){for(l=0,m=e[h],c=-m;m>=c;++c)E=u[f+c+h*d],p=u[f+c-h*d],l+=E-p,s+=c*(E+p);a+=h*l}return AM.DiamondAngle(a,s)*t}}(),AM.DiamondAngle=function(e,t){return e>=0?t>=0?e/(t+e):1-t/(-t+e):0>t?2-e/(-t-e):3+t/(t-e)},AM.DetectKeypointsPostProc=function(e,t,n,i){n>i&&(jsfeat.math.qsort(t,0,n-1,function(e,t){return t.score<e.score}),n=i);for(var o=0;n>o;++o)t[o].angle=AM.IcAngle(e,t[o].x,t[o].y);return n},AM.DetectKeypointsYape06=function(e,t,n,i,o,r){jsfeat.yape06.laplacian_threshold=i,jsfeat.yape06.min_eigen_value_threshold=o;var a=jsfeat.yape06.detect(e,t,r);return a=AM.DetectKeypointsPostProc(e,t,a,n)},AM.DetectKeypointsFast=function(e,t,n,i,o){jsfeat.fast_corners.set_threshold(i);var r=jsfeat.fast_corners.detect(e,t,o||3);return r=AM.DetectKeypointsPostProc(e,t,r,n)};var AM=AM||{};AM.ImageFilter=function(){var e,t={blur_size:3,blur:!0};this.Filter=function(n){var i=n.width,o=n.height;e?e.resize(i,o,jsfeat.U8_t|jsfeat.C1_t):e=new jsfeat.matrix_t(i,o,jsfeat.U8_t|jsfeat.C1_t),jsfeat.imgproc.grayscale(n.data,i,o,e),t.blur&&jsfeat.imgproc.gaussian_blur(e,e,t.blur_size)},this.GetFilteredImage=function(){return e},this.SetParameters=function(e){for(name in e)"undefined"!=typeof t[name]&&(t[name]=e[name])}};var AM=AM||{};AM.MarkerTracker=function(){var e,t=new AM.Training,n={},i=new AM.ImageFilter,o=new AM.Detection,r=new AM.Matching,a=new AM.Pose,s=!1,u={match_min:8},d=!1,c=new AM.Profiler;c.add("filter"),c.add("detection"),c.add("matching"),c.add("pose"),this.ComputeImage=function(e){c.new_frame(),c.start("filter"),i.Filter(e),c.stop("filter"),c.start("detection"),o.Detect(i.GetFilteredImage()),c.stop("detection")},this.Match=function(){c.start("matching"),s=!1,e=void 0,r.SetScreenDescriptors(o.GetDescriptors());for(uuid in n){var t=n[uuid];if(t.IsActive()){r.Match(t.GetDescriptorsLevels());var i=r.GetNumMatches();if(s=i>=u.match_min,d&&console.log("nbMatches : "+i),s){var h=a.Pose(r.GetMatches(),i,o.GetCorners(),t.GetCornersLevels());if(s=h>=u.match_min,d&&console.log(" goodMatches : "+h),s){e=t;break}}}}return c.stop("matching"),s},this.GetMatchUuid=function(){return e.GetUuid()},this.GetPose=function(){if(s){c.start("pose");var t=a.GetPoseCorners(e.GetWidth(),e.GetHeight());return c.stop("pose"),t}},this.AddMarker=function(e,i){t.Train(e);var o=new AM.TrainedImage(i);t.SetResultToTrainedImage(o),t.Empty(),n[i]=o},this.RemoveMarker=function(e){n[e]&&delete n[e]},this.ActiveMarker=function(e,t){n[e]&&n[e].Active(t)},this.ActiveAllMarkers=function(e){for(uuid in n)n[uuid].Active(e)},this.ClearMarkers=function(){n={}},this.GetScreenCorners=function(){return o.GetCorners()},this.GetNumScreenCorners=function(){return o.GetNumCorners()},this.GetMatches=function(){return r.GetMatches()},this.GetMatchesMask=function(){return a.GetMatchesMask()},this.GetProfiler=function(){return c.GetProfiler()},this.GetTrainedCorners=function(){var e=n[uuid];return e.GetCornersLevels()},this.Log=function(){console.log(c.log()+(s?"<br/>match found":""))},this.SetParameters=function(e){for(name in e)"undefined"!=typeof u[name]&&(u[name]=e[name]);t.SetParameters(e),i.SetParameters(e),o.SetParameters(e),r.SetParameters(e)}};var AM=AM||{};AM.Matching=function(){function e(e){return e-=e>>1&1431655765,e=(858993459&e)+(e>>2&858993459),16843009*(e+(e>>4)&252645135)>>24}function t(e,t){var n=e.rows,i=e.buffer.i32,o=0,u=0;r=[];for(var d=0;n>d;++d){for(var c=256,h=256,f=-1,l=-1,m=0,E=t.length;E>m;++m)for(var p=t[m],g=p.rows,v=p.buffer.i32,T=0,y=0;g>y;++y){for(var w=0,R=0;8>R;++R)w+=s(i[o+R]^v[T+R]);c>w?(h=c,c=w,l=m,f=y):h>w&&(h=w),T+=8}if(c<a.match_threshold){for(;r.length<=u;)r.push(new AM.match_t);r[u].screen_idx=d,r[u].pattern_lev=l,r[u].pattern_idx=f,u++}o+=8}return r.length=u,u}var n,o,r=[],a={match_threshold:48};this.SetScreenDescriptors=function(e){n=e},this.Match=function(e){return o=t(n,e)};var s=(function(){var e=[0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8],t=255;return function(n){var i=e[n&t];return n>>=8,i+=e[n&t],n>>=8,i+=e[n&t],n>>=8,i+=e[n&t]}}(),function(){var t=[];for(i=0;i<65536;++i)t.push(e(i));var n=65535;return function(e){var i=t[e&n];return e>>=16,i+=t[e&n]}}());this.GetMatches=function(){return r},this.GetNumMatches=function(){return o},this.SetParameters=function(e){for(name in e)"undefined"!=typeof a[name]&&(a[name]=e[name])}},AM.match_t=function(e,t,n,i){this.screen_idx=e||0,this.pattern_lev=t||0,this.pattern_idx=n||0,this.distance=i||0};var AM=AM||{};AM.Pose=function(){function e(e,t,n,i,o,r){for(var a=new jsfeat.motion_model.homography2d,s=4,u=3,d=new jsfeat.ransac_params_t(s,u,.5,.99),c=[],h=[],f=0;t>f;++f){var l=e[f],m=o[l.screen_idx],E=r[l.pattern_lev][l.pattern_idx];c[f]={x:E.x,y:E.y},h[f]={x:m.x,y:m.y}}var p=!1;p=jsfeat.motion_estimator.ransac(d,a,c,h,t,n,i,1e3);var g=0;if(p){for(var f=0;t>f;++f)i.data[f]&&(c[g].x=c[f].x,c[g].y=c[f].y,h[g].x=h[f].x,h[g].y=h[f].y,g++);a.run(c,h,n,g)}else jsfeat.matmath.identity_3x3(n,1);return g}function t(e,t,n){for(var i=[{x:0,y:0},{x:t,y:0},{x:t,y:n},{x:0,y:n}],o=0,r=0,a=0,s=0;4>s;++s)r=e[0]*i[s].x+e[1]*i[s].y+e[2],a=e[3]*i[s].x+e[4]*i[s].y+e[5],o=e[6]*i[s].x+e[7]*i[s].y+e[8],i[s].x=r/o,i[s].y=a/o;return i}var n=0,i=new jsfeat.matrix_t(3,3,jsfeat.F32C1_t),o=new jsfeat.matrix_t(500,1,jsfeat.U8C1_t);this.Pose=function(t,r,a,s){return n=e(t,r,i,o,a,s)},this.GetGoodCount=function(){return n},this.GetPoseCorners=function(e,n){return t(i.data,e,n)},this.GetMatchesMask=function(){return o}},AM.PosePosit=function(){this.posit=new POS.Posit(10,1),this.pose},AM.PosePosit.prototype.Set=function(e,t,n,i){t=t||35;for(var o=[],r=0;r<e.length;++r){var a=e[r].x-n/2,s=i/2-e[r].y;o.push({x:a,y:s})}this.pose=this.posit.pose(o)},AM.PosePosit.prototype.SetFocalLength=function(e){this.posit.focalLength=e},AM.PoseThree=function(){this.position=new THREE.Vector3,this.rotation=new THREE.Euler,this.quaternion=new THREE.Quaternion,this.scale=new THREE.Vector3},AM.PoseThree.prototype.Set=function(e,t){t=t||35;var n=e.bestRotation,i=e.bestTranslation;this.scale.x=t,this.scale.y=t,this.scale.z=t,this.rotation.x=-Math.asin(-n[1][2]),this.rotation.y=-Math.atan2(n[0][2],n[2][2]),this.rotation.z=Math.atan2(n[1][0],n[1][1]),this.position.x=i[0],this.position.y=i[1],this.position.z=-i[2],this.quaternion.setFromEuler(this.rotation)};var AM=AM||{};AM.TrainedImage=function(e){var t=!0,n=[],i=[],o=0,r=0,a=e,s=!0;this.GetCorners=function(e){return n[e]},this.GetDescriptors=function(e){return i[e]},this.GetLevelNbr=function(){return Math.min(i.length,n.length)},this.GetCornersLevels=function(){return n},this.GetDescriptorsLevels=function(){return i},this.GetWidth=function(){return o},this.GetHeight=function(){return r},this.Set=function(e,a,s,u){t=!1,n=e,i=a,o=s,r=u},this.IsEmpty=function(){return t},this.Empty=function(){t=!0,n=[],i=[]},this.SetUuid=function(e){a=e},this.GetUuid=function(){return a},this.Active=function(e){s=e===!0},this.IsActive=function(){return s}};var AM=AM||{};AM.Training=function(){function e(e,n,a,s){var u=r[a],c=o[a];0!==a?(t(e,n,s),jsfeat.imgproc.gaussian_blur(n,n,d.blur_size)):jsfeat.imgproc.gaussian_blur(e,n,d.blur_size);var h=AM.DetectKeypointsYape06(n,u,d.training_corners_max,d.laplacian_threshold,d.eigen_threshold);if(u.length=h,jsfeat.orb.describe(n,u,h,c),0!==a)for(i=0;i<h;++i)u[i].x*=1/s,u[i].y*=1/s;console.log("train "+n.cols+"x"+n.rows+" points: "+h)}function t(e,t,n){if(1>n){var i=Math.round(e.cols*n),o=Math.round(e.rows*n);jsfeat.imgproc.resample(e,t,i,o)}else t.resize(e.cols,e.rows),e.copy_to(t)}function n(e,t){for(var n=0;n<d.num_train_levels;++n){r[n]=[];for(var i=r[n],a=e*t>>n;--a>=0;)i[a]=new jsfeat.keypoint_t(0,0,0,0,-1);o[n]=new jsfeat.matrix_t(32,d.training_corners_max,jsfeat.U8_t|jsfeat.C1_t)}}var o,r,a,s=0,u=0,d={num_train_levels:3,blur_size:3,image_size_max:512,training_corners_max:200,laplacian_threshold:30,eigen_threshold:25},c=Math.sqrt(2),h=[];this.Train=function(i){var a=0,h=1;o=[],r=[];var f=new jsfeat.matrix_t(i.width,i.height,jsfeat.U8_t|jsfeat.C1_t);jsfeat.imgproc.grayscale(i.data,i.width,i.height,f,jsfeat.COLOR_RGBA2GRAY);var l=Math.min(d.image_size_max/i.width,d.image_size_max/i.height),m=new jsfeat.matrix_t(i.width*l,i.height*l,jsfeat.U8_t|jsfeat.C1_t);s=m.cols,u=m.rows,t(f,m,l),n(m.cols,m.rows);var E=new jsfeat.matrix_t(m.cols,m.rows,jsfeat.U8_t|jsfeat.C1_t);for(e(m,E,0,h),a=1;a<d.num_train_levels;++a)h/=c,e(m,E,a,h)},cloneImage=function(e){var t=new jsfeat.matrix_t(e.cols,e.rows,jsfeat.U8_t|jsfeat.C1_t);return e.copy_to(t),t},this.TrainFull=function(i){var f=0,l=1;o=[],r=[],h=[];var m=new jsfeat.matrix_t(i.width,i.height,jsfeat.U8_t|jsfeat.C1_t);jsfeat.imgproc.grayscale(i.data,i.width,i.height,m,jsfeat.COLOR_RGBA2GRAY);var E=Math.min(d.image_size_max/i.width,d.image_size_max/i.height),p=new jsfeat.matrix_t(i.width*E,i.height*E,jsfeat.U8_t|jsfeat.C1_t);s=p.cols,u=p.rows,t(m,p,E),n(p.cols,p.rows);var g=new jsfeat.matrix_t(p.cols,p.rows,jsfeat.U8_t|jsfeat.C1_t);for(e(p,g,0,l),a=p,h[0]=cloneImage(g),f=1;f<d.num_train_levels;++f)l/=c,e(p,g,f,l),h[f]=cloneImage(g)},this.getGrayData=function(){return a},this.getBluredImages=function(){return h},this.SetResultToTrainedImage=function(e){e.Set(r,o,s,u)},this.IsEmpty=function(){return!o||!r},this.Empty=function(){o=void 0,r=void 0,h=void 0},this.SetParameters=function(e){for(name in e)"undefined"!=typeof d[name]&&(d[name]=e[name])},this.GetScaleIncrement=function(){return c}};