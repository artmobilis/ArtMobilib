<<<<<<< 09d61f2154fccdf22a3d1ade3874ce5da1fc64da
var compatibility=function(){var e=0,t=!0,i=window.URL||window.webkitURL||window.mozURL||window.msURL,n=function(t,i){var n=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,i){var n=(new Date).getTime(),r=Math.max(0,16-(n-e)),a=window.setTimeout(function(){t(n+r)},r);return e=n+r,a};return n.call(window,t,i)},r=function(e){var t=window.cancelAnimationFrame||function(e){clearTimeout(e)};return t.call(window,e)},a=function(e,t,i){var n=window.navigator.getUserMedia||window.navigator.mozGetUserMedia||window.navigator.webkitGetUserMedia||window.navigator.msGetUserMedia||function(e,t,i){i()};return n.call(window.navigator,e,t,i)},o=function(){var e=new ArrayBuffer(8),i=new Uint32Array(e);return i[0]=4278190080,t=!0,255===e[0]&&(t=!1),t};return{URL:i,requestAnimationFrame:n,cancelAnimationFrame:r,getUserMedia:a,detectEndian:o,isLittleEndian:t}}();!function(){AM=AM||{};var e=function(){this._listeners={}};e.prototype.AddListener=function(e,t){return"string"==typeof e&&("undefined"==typeof this._listeners[e]&&(this._listeners[e]=[]),-1==this._listeners[e].indexOf(t))?(this._listeners[e].push(t),!0):!1},e.prototype.RemoveListener=function(e,t){if("string"==typeof e){var i=this._listeners[e];if("undefined"!=typeof i){var n=i.indexOf(t);if(-1!=n)return 1!=i.length?i.splice(n,1):delete this._listeners[e],!0}}return!1},e.prototype.Fire=function(e,t){if("string"==typeof e){var i=this._listeners[e];if("undefined"!=typeof i){for(var n=0,r=i.length;r>n;++n)"function"==typeof i[n]&&i[n].apply(this,t);return!0}}return!1},AM.EventManager=e}(),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL;var AM=AM||{};!function(){function e(){function e(){return h||(a&&a.Dispose(),h=!0,a=new t(s),o=a.Load().then(function(e){r=e})),o}function i(){r&&(r.getTracks()[0].stop(),r=void 0),a&&(a.Dispose(),a=void 0),o=Promise.resolve(),h=!1}function n(){return h}var r,a,o,s=document.createElement("video"),h=!1;s.setAttribute("autoplay",!0),s.style.position="absolute",s.style.top="0px",s.style.left="0px",s.style.width="100%",s.style.height="auto",this.domElement=s,i(),this.Start=e,this.Stop=i,this.IsActive=n}function t(e){function t(e){return new Promise(function(t,i){!function n(){h&&i("loader interrupted"),e.readyState===e.HAVE_ENOUGH_DATA?t():window.requestAnimationFrame(n)}()})}function i(i){var n=new Promise(function(e,t){h&&t("loader interrupted");for(var n={video:!0,audio:!1},r=0;r!=i.length;++r){var a=i[r];"video"==a.kind&&"environment"==a.facing&&(n.video={optional:[{sourceId:a.id}]})}navigator.getUserMedia(n,e,t)});return n=n.then(function(i){return e.src=window.URL.createObjectURL(i),t(e).then(function(){return i})})}function n(e){return new Promise(function(e,t){return h&&t("loader interrupted"),MediaStreamTrack.getSources(e)})}function r(e){return Promise.resolve(function(){return h&&reject("loader interrupted"),navigator.mediaDevices.enumerateDevices()})}function a(){return s=!0,new Promise(function(e,t){h&&t("loader interrupted");var a=n();a=a.then(function(t){i(t).then(e)}),a["catch"](function(){r().then(function(t){i(t).then(e)})["catch"](t)})})}function o(){h=!0}var s=!1,h=!1;this.Load=a,this.Dispose=o}AM.FrontCamGrabbing=e}();var AM=AM||{};getGradientGreenRedColor=function(e,t){function i(e){var t=parseInt(e).toString(16);return t.length<2?"0"+t:t}var n=255*e/t,r=255*(t-e)/t;return"#"+i(n)+i(r)+"00"},AM.ImageDebugger=function(){var e,t,i,n,r,a,o,s,h,c,l,u,d,p,f,m,E,g,v,y,T=new AM.Training,w=44,b=[],M=[],R=!1,x=!0;this.DrawCorners=function(t){var i,n;if(R&&t&&(a=t.screen_corners,h=t.profiles,c=t.image_data,a.length)){for(e.fillStyle="red",i=0;i<a.length;++i)n=a[i],e.beginPath(),e.arc(n.x*u+d,n.y*u+p,3,0,2*Math.PI),e.fill();for(e.putImageData(c,m-c.width,w),i=0;i<a.length;++i)n=a[i],e.beginPath(),e.arc(n.x+m-c.width,n.y+w,3,0,2*Math.PI),e.fill();e.font="30px Arial",e.fillStyle="red",e.textAlign="left";var r="FPS: "+h.fps.toFixed(2)+"  ";for(i=0;i<h.timers.length;++i){var o=h.timers[i];r+=o[0]+": "+o[1].run_time+"ms  "}e.fillText(r,10,f-5-w)}},this.DebugMatching=function(e,t){R&&e&&t&&(n=e.corners,r=e.trained_corners,o=e.matches,s=e.matches_mask,i=t,e.uuid!=v&&(v=e.uuid,AM.LoadImage(t).then(function(e){var t=AM.ImageToImageData(e,!1);y=t,correctTrainingImageOffsets(),displayTrainingImages(!0),drawContour(),drawMatches(),x&&(displayTrainingImages(!1),drawTrainedCorners())})),y&&(correctTrainingImageOffsets(),displayTrainingImages(!0),drawContour(),drawMatches(),x&&(displayTrainingImages(!1),drawTrainedCorners())))},correctTrainingImageOffsets=function(){var e;y.width>y.height?(e=y.width-y.height,E=0,g=-Math.round(e/2)):(e=y.height-y.width,E=-Math.round(e/2),g=0)},drawContour=function(){e.strokeStyle="green",e.lineWidth=5,e.beginPath(),e.moveTo(n[0].x*u+d,n[0].y*u+p),e.lineTo(n[1].x*u+d,n[1].y*u+p),e.lineTo(n[2].x*u+d,n[2].y*u+p),e.lineTo(n[3].x*u+d,n[3].y*u+p),e.lineTo(n[0].x*u+d,n[0].y*u+p),e.stroke()},drawMatches=function(t){"undefined"==typeof t&&(t=!1),e.lineWidth=2;for(var i=0;i<o.length;++i){var n=o[i],h=s.data[i],c=r[n.pattern_lev],l=c[n.pattern_idx],f=a[n.screen_idx];h?(e.fillStyle="blue",e.strokeStyle="blue"):(e.fillStyle="red",e.strokeStyle="red");var m=l.x+E,v=l.y+g;t||(m=m*M[n.pattern_lev]+b[n.pattern_lev],v*=M[n.pattern_lev]),e.beginPath(),e.arc(m,v+w,3,0,2*Math.PI),e.fill(),e.beginPath(),e.moveTo(m,v+w),e.lineTo(f.x*u+d,f.y*u+p),e.stroke(),e.beginPath(),e.arc(f.x*u+d,f.y*u+p,3,0,2*Math.PI),e.fill()}},jsFeat2ImageData=function(t){for(var i=e.createImageData(t.cols,t.rows),n=t.data.length,r=4*n+3;n--;)i.data[r-=4]=255,i.data[r-1]=i.data[r-2]=i.data[r-3]=t.data[n];return i},displayColor=function(t,i){e.putImageData(y,t,i)},displayTrainingImages=function(t){T.Empty(),T.TrainFull(y);var i=T.getBluredImages(),n=0;b[0]=0,M[0]=1;for(var r=0;r<i.length;++r)originy=w,t||(originy=f-35-w-i[r].rows),e.putImageData(jsFeat2ImageData(i[r]),n,originy),n+=i[r].cols,b[r+1]=b[r]+i[r].cols,M[r+1]=M[r]/T.GetScaleIncrement()},drawTrainedCorners=function(t){"undefined"==typeof t&&(t=50);var i=T.getBluredImages(),n=new AM.TrainedImage(l);T.SetResultToTrainedImage(n);for(var r=0;r<n.GetLevelNbr();++r)for(var a=n.GetCorners(r),o=(n.GetDescriptors(r),f-35-w-i[r].rows),s=0;t>s;++s){var h=a[s];e.fillStyle=getGradientGreenRedColor(t-s,t);var c=h.x+E,u=h.y+g;c=c*M[r]+b[r],u*=M[r],e.beginPath(),e.arc(c,u+o,3,0,2*Math.PI),e.fill()}},this.UpdateSize=function(e,i){f=e.height,m=e.width;var n=f,r=t.videoWidth/t.videoHeight,a=m/n;if(a>r){var o=Math.round(n*r);u=o/i,d=Math.round(.5*(m-o)),p=0}else{var s=m/r;u=m/i,d=0,p=Math.round(.5*(n-s))}},this.SetData=function(i,n,r){e=i,t=n,R=r||!1},this.SetDebug=function(e){R=e||!1}};var AM=AM||{};!function(){AM.LoadImage=function(e,t){return new Promise(function(i,n){t=t||new Image,t.src=null,t.onload=function(){i(t)},t.onerror=function(e){n(e)},t.src=e})},AM.ImageToImageData=function(){var e,t;return"undefined"!=typeof document&&(e=document.createElement("canvas"),t=e.getContext("2d")),function(i,n){if(n){var r=Math.max(i.width,i.height),a=(r-i.width)/2,o=(r-i.height)/2;e.width=r,e.height=r,t.clearRect(0,0,e.width,e.height),t.drawImage(i,a,o)}else e.width=i.width,e.height=i.height,t.clearRect(0,0,e.width,e.height),t.drawImage(i,0,0,e.width,e.height);return t.getImageData(0,0,e.width,e.height)}}()}();var AM=AM||{};AM.JsonLoader=function(){function e(e,t){l=!1,o=void 0,a=void 0,r=void 0,h=void 0,s=void 0,c.progress=0,e&&e(t)}function t(){try{c.json=JSON.parse(h.responseText),e(r)}catch(t){c.json={},e(a,"failed to parse file: "+s)}}function i(t){var i="JsonLoader failed to open file: "+s;console.log(i),e(a,i)}function n(e){c.progress=e.loaded/e.total*100,o&&o()}var r,a,o,s,h,c=this,l=!1;this.json={},this.progress=0,this.IsLoading=function(){return l},this.Load=function(e,c,u,d){l||(l=!0,r=c,a=u,o=d,s=e,h=new XMLHttpRequest,h.onprogress=n,h.open("GET",e,!0),h.onload=t,h.onerror=i,h.send(null))}},AM.LoadJson=function(e){return new Promise(function(t,i){var n=new AM.JsonLoader;n.Load(e,function(){t(n.json)},i)})};var AM=AM||{};AM.LoadingManager=function(){function e(e){for(var t=0,i=e.length;i>t;++t)e[t]()}var t=[],i=[],n=0;this.Start=function(t){t=t||1,n+=t,e(i)},this.End=function(r){r=r||1,n>0&&(n-=r,e(i)),0>=n&&(n=0,e(t),t.length=0,i.length=0)},this.OnEnd=function(e){n>0?t.push(e):e()},this.OnProgress=function(e){n>0?i.push(e):e()},this.IsLoading=function(){return n>0},this.GetRemaining=function(){return n}};var AM=AM||{};!function(){var e=function(){function e(){this.start_time=0,this.stop_time=0,this.run_time=0,this.running=!1}return e.prototype.start=function(){this.start_time=(new Date).getTime(),this.running=!0},e.prototype.stop=function(){this.stop_time=(new Date).getTime(),this.run_time=this.stop_time-this.start_time,this.running=!1},e.prototype.get_runtime=function(){return this.run_time},e.prototype.reset=function(){this.run_time=0},e}(),t=function(){function e(e){this.arr=new Int32Array(e),this.begin=0,this.end=-1,this.num_el=0,this.arr_size=e}return e.prototype.push_back=function(e){this.num_el<this.arr_size?(this.end++,this.arr[this.end]=e,this.num_el++):(this.end=(this.end+1)%this.arr_size,this.begin=(this.begin+1)%this.arr_size,this.arr[this.end]=e)},e.prototype.get=function(e){return this.arr[(this.begin+e)%this.arr_size]},e.prototype.size=function(){return this.num_el},e}(),i=function(){function i(){this.fps=0,this.timers=[],this.frame_timer=new e}var n=0,r=new t(20);return i.prototype.add=function(t){this.timers.push([t,new e])},i.prototype.new_frame=function(){++n;var e=0,t=0|this.timers.length;for(e=0;t>e;++e){var i=this.timers[e][1];i.reset()}if(n>=1){this.frame_timer.stop(),r.push_back(this.frame_timer.get_runtime());var a=r.size(),o=0;for(e=0;a>e;++e)o+=r.get(e);this.fps=a/o*1e3,this.frame_timer.start()}},i.prototype.find_task=function(e){var t=0|this.timers.length,i=0;for(i=0;t>i;++i){var n=this.timers[i];if(n[0]===e)return n}return null},i.prototype.start=function(e){var t=this.find_task(e);t[1].start()},i.prototype.stop=function(e){var t=this.find_task(e);t[1].stop()},i.prototype.log=function(){var e=0|this.timers.length,t=0,i="<strong>FPS: "+this.fps.toFixed(2)+"</strong>";for(t=0;e>t;++t){var n=this.timers[t];i+="<br/>"+n[0]+": "+n[1].get_runtime()+"ms"}return i},i.prototype.log2=function(){var e=0|this.timers.length,t=0,i="FPS: "+this.fps.toFixed(2)+"  ";for(t=0;e>t;++t){var n=this.timers[t];i+=n[0]+": "+n[1].get_runtime()+"ms  "}return i},i.prototype.GetProfiler=function(){return{fps:this.fps,timers:this.timers}},i}();AM.Profiler=i}();var AM=AM||{};AM.DeviceLockScreenOrientation=function(){function e(){window.cordova?(t(),o=!0):s=!1}function t(){for(var e=0,t=h.length;t>e;++e)h[e]();h.length=0}function i(e){s&&(o?e():h.push(e))}function n(){screen.lockOrientation("landscape-primary")}function r(){screen.lockOrientation("portrait-primary")}function a(){screen.unlockOrientation()}var o=!1,s=!0,h=[];document.addEventListener("deviceready",e,!1),this.LockLandscape=function(){i(n)},this.LockPortrait=function(){i(r)},this.Unlock=function(){i(a)}};var AM=AM||{};!function(){function e(e){return e%=360,180>e?e:e-360}AM.DeviceOrientationControl=function(e){var t=this;this.object=e,this.object.rotation.reorder("YXZ"),this.alpha=0,this.beta=0,this.gamma=0;var i=!1,n=!1,r=0,a=new this.CoefMethod,o=function(e){i?(a.OnOrientationChange(e),n=!0):i=!0},s=function(){r=window.orientation||0};this.Connect=function(){s(),window.addEventListener("orientationchange",s,!1),window.addEventListener("deviceorientation",o,!1)},this.Disconnect=function(){window.removeEventListener("orientationchange",s,!1),window.removeEventListener("deviceorientation",o,!1),n=!1,i=!1},this.Update=function(){var e=function(){var e=new THREE.Vector3(0,0,1),t=new THREE.Euler,i=new THREE.Quaternion,n=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));return function(r,a,o,s,h){t.set(o,a,-s,"YXZ"),r.setFromEuler(t),r.multiply(n),r.multiply(i.setFromAxisAngle(e,-h))}}();if(n){var i=r?THREE.Math.degToRad(r):0;a.Update(),t.alpha=a.alpha,t.beta=a.beta,t.gamma=a.gamma,e(t.object.quaternion,a.alpha,a.beta,a.gamma,i)}}},AM.DeviceOrientationControl.prototype.PowerMethod=function(){function e(e,i,n){var r=t(i-e),a=Math.sign(r),o=Math.abs(r/Math.PI);return o=Math.pow(o,n),t(e+o*Math.PI*a)}var i,n=this,r=2;this.alpha=0,this.beta=0,this.gamma=0,this.OnOrientationChange=function(e){i=e},this.Update=function(){n.alpha=e(n.alpha,THREE.Math.degToRad(i.alpha),r),n.beta=e(n.beta,THREE.Math.degToRad(i.beta),r),n.gamma=e(n.gamma,THREE.Math.degToRad(i.gamma),r)}},AM.DeviceOrientationControl.prototype.CoefMethod=function(){function e(e,i,n){return e+t(i-e)*n}var i=this;this.coef=.2,this.alpha=0,this.beta=0,this.gamma=0;var n=[];this.OnOrientationChange=function(e){n.push(e)},this.Update=function(){if(n.length>0){for(var r,a=i.alpha,o=i.beta,s=i.gamma,h=0,c=n.length;c>h;++h)r=n[h],a=t(e(a,THREE.Math.degToRad(r.alpha),i.coef)),o=t(e(o,THREE.Math.degToRad(r.beta),i.coef)),s=t(e(s,THREE.Math.degToRad(r.gamma),i.coef));i.alpha=a,i.beta=o,i.gamma=s,n.length=0}}},AM.DeviceOrientationControl.prototype.AverageMethod=function(){var t=this;this.history=[],this.history_max=10,this.alpha=0,this.beta=0,this.gamma=0,this.OnOrientationChange=function(e){t.history.length>t.history_max&&t.history.shift(),t.history.push(e)},this.Update=function(i,n,r){if(0!==t.history.length){for(var a=0,o=t.history.length;o>a;a++)i+=e(t.history[a].alpha),n+=e(t.history[a].beta),r+=e(t.history[a].gamma);i/=t.history.length,n/=t.history.length,r/=t.history.length,t.alpha=THREE.Math.degToRad(i),t.beta=THREE.Math.degToRad(n),t.gamma=THREE.Math.degToRad(r)}}};var t=function(){var e=Math.PI,t=2*Math.PI;return function(i){if(i>e){do i-=t;while(i>e)}else if(-e>i)do i+=t;while(-e>i);return i}}()}();var AM=AM||{};AM.GeographicCoordinatesConverter=function(e,t){var i=this,n={latitude:0,longitude:0};this.GetLocalCoordinates=function(e,t){var r=(n.latitude+e)/2,a={x:0,y:0};return a.x=(t-n.longitude)*i.EARTH_RADIUS*Math.cos(r),a.y=(e-n.latitude)*-i.EARTH_RADIUS,a},this.GetLocalCoordinatesFromDegres=function(e,t){return i.GetLocalCoordinates(THREE.Math.degToRad(e),THREE.Math.degToRad(t))},this.SetOrigin=function(e,t){n.latitude=e,n.longitude=t},this.SetOriginFromDegres=function(e,t){n.latitude=THREE.Math.degToRad(e),n.longitude=THREE.Math.degToRad(t)},this.GetOrigin=function(){return n},this.SetOrigin(e||0,t||0)},AM.GeographicCoordinatesConverter.prototype.EARTH_RADIUS=6371e3;var AM=AM||{};AM.GeolocationControl=function(e,t){function i(e){o.copy(h.GetLocalCoordinatesFromDegres(e.coords.latitude,e.coords.longitude)),a=!0}function n(e){console.warn("geolocation failed: "+e.message),window.setTimeout(r.Connect,r.retry_connection_ms)}var r=this,a=!1,o=new THREE.Vector3,s=0,h=t,c=.1;this.object=e,this.interpolation_coefficient=.02,this.retry_connection_ms=1e3,this.Connect=function(){s=navigator.geolocation.watchPosition(i,n)},this.Disconnect=function(){navigator.geolocation.clearWatch(s),a=!1},this.Update=function(){if(a){var e=o.x-r.object.position.x,t=o.z-r.object.position.z,i=e*e+t*t;c*c>i?a=!1:(e*=r.interpolation_coefficient,t*=r.interpolation_coefficient,r.object.position.x+=e,r.object.position.z+=t)}}};var AMTHREE=AMTHREE||{};AMTHREE.ColladaLoader=function(){function e(e,i,n,r,a){var o=0;if(document.implementation&&document.implementation.createDocument){var s=new XMLHttpRequest;s.onreadystatechange=function(){4===s.readyState?0!==s.status&&200!==s.status||(s.response?(ze=n,t(s.response,void 0,e,i)):a?a():console.error("ColladaLoader: Empty or non-existing file ("+e+")")):3===s.readyState&&r&&(0===o&&(o=s.getResponseHeader("Content-Length")),r({total:o,loaded:s.responseText.length}))},s.open("GET",e,!0),s.send(null)}else alert("Don't know how to parse XML!")}function t(e,t,i,h){if(Ge=h,Pe=(new DOMParser).parseFromString(e,"text/xml"),t=t||ze,void 0!==i){var c=i.split("/");c.pop(),Ce=(c.length<1?".":c.join("/"))+"/"}n(),Te(),Fe=r("library_images image",H,"image"),Ve=r("library_materials material",B,"material"),Be=r("library_effects effect",W,"effect"),Ue=r("library_geometries geometry",I,"geometry"),Ze=r("library_cameras camera",ne,"camera"),qe=r("library_lights light",ae,"light"),Ye=r("library_controllers controller",A,"controller"),Xe=r("library_animations animation",$,"animation"),Se=r("library_visual_scenes visual_scene",k,"visual_scene"),Ne=r("library_kinematics_models kinematics_model",se,"kinematics_model"),Oe=[],Ie=[],Ae=a(),Le=new THREE.Group;for(var l=0;l<Ae.nodes.length;l++)Le.add(g(Ae.nodes[l]));Le.scale.multiplyScalar(We),s(),_e=o(),E();var u={scene:Le,morphs:Oe,skins:Ie,animations:je,kinematics:ke,dae:{images:Fe,materials:Ve,cameras:Ze,lights:qe,effects:Be,geometries:Ue,controllers:Ye,animations:Xe,visualScenes:Se,visualScene:Ae,scene:Ae,kinematicsModels:Ne,kinematicsModel:_e}};return t&&t(u),u}function i(e){Je=e}function n(){var e=Pe.querySelectorAll("asset"),t=e[0];if(t&&t.childNodes)for(var i=0;i<t.childNodes.length;i++){var n=t.childNodes[i];switch(n.nodeName){case"unit":var r=n.getAttribute("meter");r&&(We=parseFloat(r));break;case"up_axis":Ke=n.textContent.charAt(0)}}}function r(e,t,i){for(var n=Pe.querySelectorAll(e),r={},a=0,o=n.length,s=0;o>s;s++){var h=n[s],c=(new t).parse(h);c.id&&0!==c.id.length||(c.id=i+a++),r[c.id]=c}return r}function a(){var e=Pe.querySelectorAll("scene instance_visual_scene")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return Se[t.length>0?t:"visual_scene0"]}return null}function o(){var e=Pe.querySelectorAll("instance_kinematics_model")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return Ne[t.length>0?t:"kinematics_model0"]}return null}function s(){je=[],h(Le)}function h(e){var t,i,n=Ae.getChildById(e.colladaId,!0),r=null;if(n&&n.keys)for(r={fps:60,hierarchy:[{node:n,keys:n.keys,sids:n.sids}],node:e,name:"animation_"+e.name,length:0},je.push(r),t=0,i=n.keys.length;i>t;t++)r.length=Math.max(r.length,n.keys[t].time);else r={hierarchy:[{keys:[],sids:[]}]};for(t=0,i=e.children.length;i>t;t++)for(var a=h(e.children[t]),o=0,s=a.hierarchy.length;s>o;o++)r.hierarchy.push({keys:[],sids:[]});return r}function c(){var e,t=1e6,i=-t,n=0;for(var r in Xe){var a=Xe[r];e=e||a.id;for(var o=0;o<a.sampler.length;o++){var s=a.sampler[o];s.create(),t=Math.min(t,s.startTime),i=Math.max(i,s.endTime),n=Math.max(n,s.input.length)}}return{start:t,end:i,frames:n,ID:e}}function l(e,t){var i=t instanceof C?Ye[t.url]:t;if(!i||!i.morph)return void console.log("could not find morph controller!");for(var n=i.morph,r=0;r<n.targets.length;r++){var a=n.targets[r],o=Ue[a];if(o.mesh&&o.mesh.primitives&&o.mesh.primitives.length){var s=o.mesh.primitives[0].geometry;s.vertices.length===e.vertices.length&&e.morphTargets.push({name:"target_1",vertices:s.vertices})}}e.morphTargets.push({name:"target_Z",vertices:e.vertices})}function u(e,t,i,n){if(e.world=e.world||new THREE.Matrix4,e.localworld=e.localworld||new THREE.Matrix4,e.world.copy(e.matrix),e.localworld.copy(e.matrix),e.channels&&e.channels.length){var r=e.channels[0],a=r.sampler.output[i];a instanceof THREE.Matrix4&&(e.world.copy(a),e.localworld.copy(a),0===i&&e.matrix.copy(a))}n&&e.world.multiplyMatrices(n,e.world),t.push(e);for(var o=0;o<e.nodes.length;o++)u(e.nodes[o],t,i,e.world)}function d(e,t){for(var i,n=0;n<e.length;n++){var r=e[n],a=-1;if("JOINT"==r.type){for(i=0;i<t.joints.length;i++)if(r.sid===t.joints[i]){a=i;break}if(a>=0){var o=t.invBindMatrices[a];for(r.invBindMatrix=o,r.skinningMatrix=new THREE.Matrix4,r.skinningMatrix.multiplyMatrices(r.world,o),r.animatrix=new THREE.Matrix4,r.animatrix.copy(r.localworld),r.weights=[],i=0;i<t.weights.length;i++)for(var s=0;s<t.weights[i].length;s++){var h=t.weights[i][s];h.joint===a&&r.weights.push(h)}}else console.warn("ColladaLoader: Could not find joint '"+r.sid+"'."),r.skinningMatrix=new THREE.Matrix4,r.weights=[]}}}function p(e){var t=[],i=function(e,t,n){var r={};r.name=t.sid,r.parent=e,r.matrix=t.matrix;var a=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];r.matrix.decompose(a[0],a[1],a[2]),r.pos=[a[0].x,a[0].y,a[0].z],r.scl=[a[2].x,a[2].y,a[2].z],r.rotq=[a[1].x,a[1].y,a[1].z,a[1].w],n.push(r);for(var o in t.nodes)i(t.sid,t.nodes[o],n)};return i(-1,e,t),t}function f(e,t,i){var n=[];u(t,n,-1),d(n,i.skin);var r,a=new THREE.Vector3,o=[];for(r=0;r<e.vertices.length;r++)o.push(new THREE.Vector3);for(r=0;r<n.length;r++)if("JOINT"==n[r].type)for(var s=0;s<n[r].weights.length;s++){var h=n[r].weights[s],c=h.index,l=h.weight,p=e.vertices[c],f=o[c];a.x=p.x,a.y=p.y,a.z=p.z,a.applyMatrix4(n[r].skinningMatrix),f.x+=a.x*l,f.y+=a.y*l,f.z+=a.z*l}for(r=0;r<e.vertices.length;r++)e.vertices[r]=o[r]}function m(e,t,i){var n,r,a=Ye[t.url];if(i=void 0!==i?i:40,!a||!a.skin)return void console.log("ColladaLoader: Could not find skin controller.");if(!t.skeleton||!t.skeleton.length)return void console.log("ColladaLoader: Could not find the skeleton for the skin. ");var o=c(),s=Ae.getChildById(t.skeleton[0],!0)||Ae.getChildBySid(t.skeleton[0],!0),h=p(s),l=a.skin.joints,m=[];for(n=0;n<l.length;n++)for(r=0;r<h.length;r++)h[r].name===l[n]&&(m[n]=h[r]);for(n=0;n<m.length;n++)for(r=0;r<m.length;r++)m[n].parent===m[r].name&&(m[n].parent=r);var E;new THREE.Vector3;for(n=0;n<e.vertices.length;n++)e.vertices[n].applyMatrix4(a.skin.bindShapeMatrix);var g=[],v=[],y=a.skin.weights;for(n=0;n<y.length;n++){var T=new THREE.Vector4(y[n][0]?y[n][0].joint:0,y[n][1]?y[n][1].joint:0,y[n][2]?y[n][2].joint:0,y[n][3]?y[n][3].joint:0);E=new THREE.Vector4(y[n][0]?y[n][0].weight:0,y[n][1]?y[n][1].weight:0,y[n][2]?y[n][2].weight:0,y[n][3]?y[n][3].weight:0),g.push(T),v.push(E)}e.skinIndices=g,e.skinWeights=v,e.bones=m;var w={name:o.ID,fps:30,length:o.frames/30,hierarchy:[]};for(r=0;r<m.length;r++)w.hierarchy.push({parent:m[r].parent,name:m[r].name,keys:[]});for(console.log("ColladaLoader:",o.ID+" has "+m.length+" bones."),f(e,s,a),i=0;i<o.frames;i++){var b=[];for(u(s,b,i),d(b,a.skin),n=0;n<b.length;n++)for(r=0;r<w.hierarchy.length;r++)if(w.hierarchy[r].name===b[n].sid){var M={};M.time=i/30,M.matrix=b[n].animatrix,0===i&&(b[n].matrix=M.matrix);var R=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];M.matrix.decompose(R[0],R[1],R[2]),M.pos=[R[0].x,R[0].y,R[0].z],M.scl=[R[2].x,R[2].y,R[2].z],M.rot=R[1],w.hierarchy[r].keys.push(M)}e.animation=w}}function E(){if(_e&&0===_e.joints.length)return void(ke=void 0);var e={},t=function(t,i){var n=i.getAttribute("id"),r=Ae.getChildById(n,!0),a=_e.joints[t];Le.traverse(function(i){i.colladaId==n&&(e[t]={node:i,transforms:r.transforms,joint:a,position:a.zeroPosition})})};ke={joints:_e&&_e.joints,getJointValue:function(t){var i=e[t];return i?i.position:void console.log("getJointValue: joint "+t+" doesn't exist")},setJointValue:function(t,i){var r=e[t];if(r){var a=r.joint;if(i>a.limits.max||i<a.limits.min)console.log("setJointValue: joint "+t+" value "+i+" outside of limits (min: "+a.limits.min+", max: "+a.limits.max+")");else if(a["static"])console.log("setJointValue: joint "+t+" is static");else{var o=r.node,s=a.axis,h=r.transforms,c=new THREE.Matrix4,l=new THREE.Matrix4;for(n=0;n<h.length;n++){var u=h[n];if(u.sid&&-1!==u.sid.indexOf("joint"+t))switch(a.type){case"revolute":c.multiply(l.makeRotationAxis(s,THREE.Math.degToRad(i)));break;case"prismatic":c.multiply(l.makeTranslation(s.x*i,s.y*i,s.z*i));break;default:console.warn("setJointValue: unknown joint type: "+a.type)}else switch(u.type){case"matrix":c.multiply(u.obj);break;case"translate":c.multiply(l.makeTranslation(u.obj.x,u.obj.y,u.obj.z));break;case"rotate":c.multiply(l.makeRotationAxis(u.obj,u.angle))}}var d=c.elements,p=Array.prototype.slice.call(d),f=[p[0],p[4],p[8],p[12],p[1],p[5],p[9],p[13],p[2],p[6],p[10],p[14],p[3],p[7],p[11],p[15]];o.matrix.set.apply(o.matrix,f),o.matrix.decompose(o.position,o.quaternion,o.scale)}}else console.log("setJointValue: joint "+t+" doesn't exist")}};var i=Pe.querySelector("scene instance_kinematics_scene");if(i)for(var n=0;n<i.childNodes.length;n++){var r=i.childNodes[n];if(1==r.nodeType)switch(r.nodeName){case"bind_joint_axis":var a=r.getAttribute("target").split("/").pop(),o=r.querySelector("axis param").textContent,s=parseInt(o.split("joint").pop().split(".")[0]),h=Pe.querySelector('[sid="'+a+'"]');if(h){var c=h.parentElement;t(s,c)}}}}function g(e,t){var i,n,r,a,o,s=new THREE.Object3D,h=!1;for(r=0;r<e.controllers.length;r++){var c=Ye[e.controllers[r].url];switch(c.type){case"skin":if(Ue[c.skin.source])o=new O,o.url=c.skin.source,o.instance_material=e.controllers[r].instance_material,e.geometries.push(o),h=!0,i=e.controllers[r];else if(Ye[c.skin.source]){var u=Ye[c.skin.source];n=u,u.morph&&Ue[u.morph.source]&&(o=new O,o.url=u.morph.source,o.instance_material=e.controllers[r].instance_material,e.geometries.push(o))}break;case"morph":Ue[c.morph.source]&&(o=new O,o.url=c.morph.source,o.instance_material=e.controllers[r].instance_material,e.geometries.push(o),n=e.controllers[r]),console.log("ColladaLoader: Morph-controller partially supported.")}}var d={};for(r=0;r<e.geometries.length;r++){var p,f=e.geometries[r],E=f.instance_material,v=Ue[f.url],y={},T=[],w=0;if(v){if(!v.mesh||!v.mesh.primitives)continue;if(0===s.name.length&&(s.name=v.id),E)for(a=0;a<E.length;a++){var b=E[a],M=Ve[b.target],R=M.instance_effect.url,x=Be[R].shader,H=x.material;if(v.doubleSided){if(!(b.symbol in d)){var A=H.clone();A.side=THREE.DoubleSide,d[b.symbol]=A}H=d[b.symbol]}H.opacity=H.opacity?H.opacity:1,y[b.symbol]=w,T.push(H),p=H,p.name=null===M.name||""===M.name?M.id:M.name,w++}var _,j=p||new THREE.MeshLambertMaterial({color:14540253,side:v.doubleSided?THREE.DoubleSide:THREE.FrontSide}),k=v.mesh.geometry3js;w>1&&(j=new THREE.MultiMaterial(T)),void 0!==i?(m(k,i),k.morphTargets.length>0?(j.morphTargets=!0,j.skinning=!1):(j.morphTargets=!1,j.skinning=!0),_=new THREE.SkinnedMesh(k,j,!1),_.name="skin_"+Ie.length,Ie.push(_)):void 0!==n?(l(k,n),j.morphTargets=!0,_=new THREE.Mesh(k,j),_.name="morph_"+Oe.length,Oe.push(_)):_=k.isLineStrip===!0?new THREE.Line(k):new THREE.Mesh(k,j),s.add(_)}}for(r=0;r<e.cameras.length;r++){var S=e.cameras[r],N=Ze[S.url],C=new THREE.PerspectiveCamera(N.yfov,parseFloat(N.aspect_ratio),parseFloat(N.znear),parseFloat(N.zfar));s.add(C)}for(r=0;r<e.lights.length;r++){var G=null,I=e.lights[r],P=qe[I.url];if(P&&P.technique){var L=P.color.getHex(),z=P.intensity,D=P.distance,F=P.falloff_angle;switch(P.technique){case"directional":G=new THREE.DirectionalLight(L,z,D),G.position.set(0,0,1);break;case"point":G=new THREE.PointLight(L,z,D);break;case"spot":G=new THREE.SpotLight(L,z,D,F),G.position.set(0,0,1);break;case"ambient":G=new THREE.AmbientLight(L)}}G&&s.add(G)}if(s.name=e.name||e.id||"",s.colladaId=e.id||"",s.layer=e.layer||"",s.matrix=e.matrix,s.matrix.decompose(s.position,s.quaternion,s.scale),Qe.centerGeometry&&s.geometry){var X=s.geometry.center();X.multiply(s.scale),X.applyQuaternion(s.quaternion),s.position.sub(X)}for(r=0;r<e.nodes.length;r++)s.add(g(e.nodes[r],e));return s}function v(e){for(var t=Pe.querySelectorAll("library_nodes node"),i=0;i<t.length;i++){var n=t[i].attributes.getNamedItem("id");if(n&&n.value===e)return t[i]}}function y(e){var t=[],i=1e6,n=-1e6;for(var r in Xe)for(var a=Xe[r],o=0;o<a.channel.length;o++){var s=a.channel[o],h=a.sampler[o],c=s.target.split("/")[0];c==e.id&&(h.create(),s.sampler=h,i=Math.min(i,h.startTime),n=Math.max(n,h.endTime),t.push(s))}return t.length&&(e.startTime=i,e.endTime=n),t}function T(e){var t,i,n;if(e.channels&&e.channels.length){var r=[],a=[];for(t=0,il=e.channels.length;t<il;t++){var o,s=e.channels[t],h=s.fullSid,c=s.sampler,l=c.input,u=e.getTransformBySid(s.sid);if(s.arrIndices)for(o=[],i=0,jl=s.arrIndices.length;i<jl;i++)o[i]=xe(s.arrIndices[i]);else o=He(s.member);if(u)for(-1===a.indexOf(h)&&a.push(h),i=0,jl=l.length;i<jl;i++){var d=l[i],p=c.getData(u.type,i,o);if(n=w(r,d),!n){n=new ie(d);var f=b(r,d);r.splice(-1===f?r.length:f,0,n)}n.addTarget(h,u,o,p)}else console.log('Could not find transform "'+s.sid+'" in node '+e.id)}for(t=0;t<a.length;t++){var m=a[t];for(i=0;i<r.length;i++)n=r[i],n.hasTarget(m)||M(r,n,i,m)}e.keys=r,e.sids=a}}function w(e,t){for(var i=null,n=0,r=e.length;r>n&&null===i;n++){var a=e[n];if(a.time===t)i=a;else if(a.time>t)break}return i}function b(e,t){for(var i=-1,n=0,r=e.length;r>n&&-1===i;n++){var a=e[n];a.time>=t&&(i=n)}return i}function M(e,t,i,n){var r=x(e,n,i?i-1:0),a=R(e,n,i+1);if(r&&a){var o,s=(t.time-r.time)/(a.time-r.time),h=r.getTarget(n),c=a.getTarget(n).data,l=h.data;if("matrix"===h.type)o=l;else if(l.length){o=[];for(var u=0;u<l.length;++u)o[u]=l[u]+(c[u]-l[u])*s}else o=l+(c-l)*s;t.addTarget(n,h.transform,h.member,o)}}function R(e,t,i){for(;i<e.length;i++){var n=e[i];if(n.hasTarget(t))return n}return null}function x(e,t,i){for(i=i>=0?i:i+e.length;i>=0;i--){var n=e[i];if(n.hasTarget(t))return n}return null}function H(){this.id="",this.init_from=""}function A(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function _(){this.method=null,this.source=null,this.targets=null,this.weights=null}function j(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function k(){this.id="",this.name="",this.nodes=[],this.scene=new THREE.Group}function S(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE.Matrix4}function N(){this.sid="",this.type="",this.data=[],this.obj=null}function C(){this.url="",this.skeleton=[],this.instance_material=[]}function G(){this.symbol="",this.target=""}function O(){this.url="",this.instance_material=[]}function I(){this.id="",this.mesh=null}function P(e){this.geometry=e.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function L(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE.Geometry}function z(){L.call(this),this.vcount=[]}function D(){L.call(this),this.vcount=1}function F(){L.call(this),this.vcount=3}function X(){this.source="",this.count=0,this.stride=0,this.params=[]}function Y(){this.input={}}function U(){this.semantic="",this.offset=0,this.source="",this.set=0}function V(e){this.id=e,this.type=null}function B(){this.id="",this.name="",this.instance_effect=null}function Z(){this.color=new THREE.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function q(e,t){this.type=e,this.effect=t,this.material=null}function J(e){this.effect=e,this.init_from=null,this.format=null}function Q(e){this.effect=e,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function W(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function K(){this.url=""}function $(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function ee(e){this.animation=e,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function te(e){this.id="",this.animation=e,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function ie(e){this.targets=[],this.time=e}function ne(){this.id="",this.name="",this.technique=""}function re(){this.url=""}function ae(){this.id="",this.name="",this.technique=""}function oe(){this.url=""}function se(){this.id="",this.name="",this.joints=[],this.links=[]}function he(){this.sid="",this.name="",this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this["static"]=!1,this.zeroPosition=0,this.middlePosition=0}function ce(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function le(){this.joint="",this.transforms=[],this.links=[]}function ue(e){var t=e.getAttribute("id");return void 0!==De[t]?De[t]:(De[t]=new V(t).parse(e),
De[t])}function de(e){for(var t=me(e),i=[],n=0,r=t.length;r>n;n++)i.push("true"===t[n]||"1"===t[n]);return i}function pe(e){for(var t=me(e),i=[],n=0,r=t.length;r>n;n++)i.push(parseFloat(t[n]));return i}function fe(e){for(var t=me(e),i=[],n=0,r=t.length;r>n;n++)i.push(parseInt(t[n],10));return i}function me(e){return e.length>0?Ee(e).split(/\s+/):[]}function Ee(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}function ge(e,t,i){return e.hasAttribute(t)?parseInt(e.getAttribute(t),10):i}function ve(e,t){var i=new Image;i.addEventListener("load",function(e){return function(){e.needsUpdate=!0}}(e)),i.src=t,e.image=i}function ye(e,t){e.doubleSided=!1;var i=t.querySelectorAll("extra double_sided")[0];i&&i&&1===parseInt(i.textContent,10)&&(e.doubleSided=!0)}function Te(){if(Qe.convertUpAxis!==!0||Ke===Qe.upAxis)$e=null;else switch(Ke){case"X":$e="Y"===Qe.upAxis?"XtoY":"XtoZ";break;case"Y":$e="X"===Qe.upAxis?"YtoX":"YtoZ";break;case"Z":$e="X"===Qe.upAxis?"ZtoX":"ZtoY"}}function we(e,t){var i;if(Qe.convertUpAxis===!0&&Ke!==Qe.upAxis)switch($e){case"XtoY":i=e[0],e[0]=t*e[1],e[1]=i;break;case"XtoZ":i=e[2],e[2]=e[1],e[1]=e[0],e[0]=i;break;case"YtoX":i=e[0],e[0]=e[1],e[1]=t*i;break;case"YtoZ":i=e[1],e[1]=t*e[2],e[2]=i;break;case"ZtoX":i=e[0],e[0]=e[1],e[1]=e[2],e[2]=i;break;case"ZtoY":i=e[1],e[1]=e[2],e[2]=t*i}}function be(e,t){if(Qe.convertUpAxis!==!0||Ke===Qe.upAxis)return t;switch(e){case"X":t="XtoY"===$e?-1*t:t;break;case"Y":t="YtoZ"===$e||"YtoX"===$e?-1*t:t;break;case"Z":t="ZtoY"===$e?-1*t:t}return t}function Me(e,t){var i=[e[t],e[t+1],e[t+2]];return we(i,-1),new THREE.Vector3(i[0],i[1],i[2])}function Re(e){if(Qe.convertUpAxis){var t=[e[0],e[4],e[8]];we(t,-1),e[0]=t[0],e[4]=t[1],e[8]=t[2],t=[e[1],e[5],e[9]],we(t,-1),e[1]=t[0],e[5]=t[1],e[9]=t[2],t=[e[2],e[6],e[10]],we(t,-1),e[2]=t[0],e[6]=t[1],e[10]=t[2],t=[e[0],e[1],e[2]],we(t,-1),e[0]=t[0],e[1]=t[1],e[2]=t[2],t=[e[4],e[5],e[6]],we(t,-1),e[4]=t[0],e[5]=t[1],e[6]=t[2],t=[e[8],e[9],e[10]],we(t,-1),e[8]=t[0],e[9]=t[1],e[10]=t[2],t=[e[3],e[7],e[11]],we(t,-1),e[3]=t[0],e[7]=t[1],e[11]=t[2]}return(new THREE.Matrix4).set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function xe(e){if(e>-1&&3>e){var t=["X","Y","Z"],i={X:0,Y:1,Z:2};e=He(t[e]),e=i[e]}return e}function He(e){if(Qe.convertUpAxis)switch(e){case"X":switch($e){case"XtoY":case"XtoZ":case"YtoX":e="Y";break;case"ZtoX":e="Z"}break;case"Y":switch($e){case"XtoY":case"YtoX":case"ZtoX":e="X";break;case"XtoZ":case"YtoZ":case"ZtoY":e="Z"}break;case"Z":switch($e){case"XtoZ":e="X";break;case"YtoZ":case"ZtoX":case"ZtoY":e="Y"}}return e}var Ae,_e,je,ke,Se,Ne,Ce,Ge,Oe,Ie,Pe=null,Le=null,ze=null,De={},Fe={},Xe={},Ye={},Ue={},Ve={},Be={},Ze={},qe={},Je=THREE.SmoothShading,Qe={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null},We=1,Ke="Y",$e=null;return H.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];"init_from"===i.nodeName&&(this.init_from=i.textContent)}return this},A.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.type="none";for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"skin":this.skin=(new j).parse(i),this.type=i.nodeName;break;case"morph":this.morph=(new _).parse(i),this.type=i.nodeName}}return this},_.prototype.parse=function(e){var t,i,n={},r=[];for(this.method=e.getAttribute("method"),this.source=e.getAttribute("source").replace(/^#/,""),t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];if(1==a.nodeType)switch(a.nodeName){case"source":i=(new V).parse(a),n[i.id]=i;break;case"targets":r=this.parseInputs(a);break;default:console.log(a.nodeName)}}for(t=0;t<r.length;t++){var o=r[t];switch(i=n[o.source],o.semantic){case"MORPH_TARGET":this.targets=i.read();break;case"MORPH_WEIGHT":this.weights=i.read()}}return this},_.prototype.parseInputs=function(e){for(var t=[],i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"input":t.push((new U).parse(n))}}return t},j.prototype.parse=function(e){var t,i,n={};this.source=e.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1==a.nodeType)switch(a.nodeName){case"bind_shape_matrix":var o=pe(a.textContent);this.bindShapeMatrix=Re(o);break;case"source":var s=(new V).parse(a);n[s.id]=s;break;case"joints":t=a;break;case"vertex_weights":i=a;break;default:console.log(a.nodeName)}}return this.parseJoints(t,n),this.parseWeights(i,n),this},j.prototype.parseJoints=function(e,t){for(var i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"input":var r=(new U).parse(n),a=t[r.source];"JOINT"===r.semantic?this.joints=a.read():"INV_BIND_MATRIX"===r.semantic&&(this.invBindMatrices=a.read())}}},j.prototype.parseWeights=function(e,t){var i,n,r,a,o,s=[];for(r=0;r<e.childNodes.length;r++){var h=e.childNodes[r];if(1==h.nodeType)switch(h.nodeName){case"input":s.push((new U).parse(h));break;case"v":i=fe(h.textContent);break;case"vcount":n=fe(h.textContent)}}var c=0;for(r=0;r<n.length;r++){var l=n[r],u=[];for(a=0;l>a;a++){var d={};for(o=0;o<s.length;o++){var p=s[o],f=i[c+p.offset];switch(p.semantic){case"JOINT":d.joint=f;break;case"WEIGHT":d.weight=t[p.source].data[f]}}u.push(d),c+=s.length}for(a=0;a<u.length;a++)u[a].index=r;this.weights.push(u)}},k.prototype.getChildById=function(e,t){for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildById(e,t);if(n)return n}return null},k.prototype.getChildBySid=function(e,t){for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildBySid(e,t);if(n)return n}return null},k.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.nodes=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"node":this.nodes.push((new S).parse(i))}}return this},S.prototype.getChannelForTransform=function(e){for(var t=0;t<this.channels.length;t++){var i,n,r=this.channels[t],a=r.target.split("/"),o=(a.shift(),a.shift()),s=o.indexOf(".")>=0,h=o.indexOf("(")>=0;if(s)a=o.split("."),o=a.shift(),n=a.shift();else if(h){i=o.split("("),o=i.shift();for(var c=0;c<i.length;c++)i[c]=parseInt(i[c].replace(/\)/,""))}if(o===e)return r.info={sid:o,dotSyntax:s,arrSyntax:h,arrIndices:i},r}return null},S.prototype.getChildById=function(e,t){if(this.id===e)return this;if(t)for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildById(e,t);if(n)return n}return null},S.prototype.getChildBySid=function(e,t){if(this.sid===e)return this;if(t)for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildBySid(e,t);if(n)return n}return null},S.prototype.getTransformBySid=function(e){for(var t=0;t<this.transforms.length;t++)if(this.transforms[t].sid===e)return this.transforms[t];return null},S.prototype.parse=function(e){var t;this.id=e.getAttribute("id"),this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.type=e.getAttribute("type"),this.layer=e.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE.Matrix4;for(var i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"node":this.nodes.push((new S).parse(n));break;case"instance_camera":this.cameras.push((new re).parse(n));break;case"instance_controller":this.controllers.push((new C).parse(n));break;case"instance_geometry":this.geometries.push((new O).parse(n));break;case"instance_light":this.lights.push((new oe).parse(n));break;case"instance_node":t=n.getAttribute("url").replace(/^#/,"");var r=v(t);r&&this.nodes.push((new S).parse(r));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new N).parse(n));break;case"extra":break;default:console.log(n.nodeName)}}return this.channels=y(this),T(this),this.updateMatrix(),this},S.prototype.updateMatrix=function(){this.matrix.identity();for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},N.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=pe(e.textContent),this.convert(),this},N.prototype.convert=function(){switch(this.type){case"matrix":this.obj=Re(this.data);break;case"rotate":this.angle=THREE.Math.degToRad(this.data[3]);break;case"translate":we(this.data,-1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":we(this.data,1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},N.prototype.apply=function(){var e=new THREE.Matrix4;return function(t){switch(this.type){case"matrix":t.multiply(this.obj);break;case"translate":t.multiply(e.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":t.multiply(e.makeRotationAxis(this.obj,this.angle));break;case"scale":t.scale(this.obj)}}}(),N.prototype.update=function(e,t){var i=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(t)if(1===t.length)switch(t[0]){case 0:this.obj.n11=e[0],this.obj.n21=e[1],this.obj.n31=e[2],this.obj.n41=e[3];break;case 1:this.obj.n12=e[0],this.obj.n22=e[1],this.obj.n32=e[2],this.obj.n42=e[3];break;case 2:this.obj.n13=e[0],this.obj.n23=e[1],this.obj.n33=e[2],this.obj.n43=e[3];break;case 3:this.obj.n14=e[0],this.obj.n24=e[1],this.obj.n34=e[2],this.obj.n44=e[3]}else if(2===t.length){var n="n"+(t[0]+1)+(t[1]+1);this.obj[n]=e}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(e);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=i[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=i[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;case"ANGLE":this.angle=THREE.Math.degToRad(e);break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2],this.angle=THREE.Math.degToRad(e[3])}}},C.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1===i.nodeType)switch(i.nodeName){case"skeleton":this.skeleton.push(i.textContent.replace(/^#/,""));break;case"bind_material":for(var n=i.querySelectorAll("instance_material"),r=0;r<n.length;r++){var a=n[r];this.instance_material.push((new G).parse(a))}break;case"extra":}}return this},G.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},O.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType&&"bind_material"===i.nodeName){for(var n=i.querySelectorAll("instance_material"),r=0;r<n.length;r++){var a=n[r];this.instance_material.push((new G).parse(a))}break}}return this},I.prototype.parse=function(e){this.id=e.getAttribute("id"),ye(this,e);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"mesh":this.mesh=new P(this).parse(i);break;case"extra":}}return this},P.prototype.parse=function(e){var t;for(this.primitives=[],t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"source":ue(i);break;case"vertices":this.vertices=(new Y).parse(i);break;case"linestrips":this.primitives.push((new D).parse(i));break;case"triangles":this.primitives.push((new F).parse(i));break;case"polygons":this.primitives.push((new L).parse(i));break;case"polylist":this.primitives.push((new z).parse(i))}}if(this.geometry3js=new THREE.Geometry,null===this.vertices)return this;var n=De[this.vertices.input.POSITION.source].data;for(t=0;t<n.length;t+=3)this.geometry3js.vertices.push(Me(n,t).clone());for(t=0;t<this.primitives.length;t++){var r=this.primitives[t];r.setVertices(this.vertices),this.handlePrimitive(r,this.geometry3js)}return this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this},P.prototype.handlePrimitive=function(e,t){if(e instanceof D)return void(t.isLineStrip=!0);var i,n,r,a,o,s,h,c,l,u=e.p,d=e.inputs,p=0,f=3,m=0,E=[];for(i=0;i<d.length;i++){r=d[i];var g=r.offset+1;switch(m=g>m?g:m,r.semantic){case"TEXCOORD":E.push(r.set)}}for(var v=0;v<u.length;++v)for(var y=u[v],T=0;T<y.length;){var w=[],b=[],M=null,R=[];for(f=e.vcount?e.vcount.length?e.vcount[p++]:e.vcount:y.length/m,i=0;f>i;i++)for(n=0;n<d.length;n++)switch(r=d[n],s=De[r.source],a=y[T+i*m+r.offset],h=s.accessor.params.length,o=a*h,r.semantic){case"VERTEX":w.push(a);break;case"NORMAL":b.push(Me(s.data,o));break;case"TEXCOORD":M=M||{},void 0===M[r.set]&&(M[r.set]=[]),M[r.set].push(new THREE.Vector2(s.data[o],s.data[o+1]));break;case"COLOR":R.push((new THREE.Color).setRGB(s.data[o],s.data[o+1],s.data[o+2]))}if(0===b.length)if(r=this.vertices.input.NORMAL)for(s=De[r.source],h=s.accessor.params.length,c=0,l=w.length;l>c;c++)b.push(Me(s.data,w[c]*h));else t.calcNormals=!0;if(!M&&(M={},r=this.vertices.input.TEXCOORD))for(E.push(r.set),s=De[r.source],h=s.accessor.params.length,c=0,l=w.length;l>c;c++)o=w[c]*h,void 0===M[r.set]&&(M[r.set]=[]),M[r.set].push(new THREE.Vector2(s.data[o],1-s.data[o+1]));if(0===R.length&&(r=this.vertices.input.COLOR))for(s=De[r.source],h=s.accessor.params.length,c=0,l=w.length;l>c;c++)o=w[c]*h,R.push((new THREE.Color).setRGB(s.data[o],s.data[o+1],s.data[o+2]));var x,H,A=null,_=[];if(3===f)_.push(new THREE.Face3(w[0],w[1],w[2],b,R.length?R:new THREE.Color));else if(4===f)_.push(new THREE.Face3(w[0],w[1],w[3],b.length?[b[0].clone(),b[1].clone(),b[3].clone()]:[],R.length?[R[0],R[1],R[3]]:new THREE.Color)),_.push(new THREE.Face3(w[1],w[2],w[3],b.length?[b[1].clone(),b[2].clone(),b[3].clone()]:[],R.length?[R[1],R[2],R[3]]:new THREE.Color));else if(f>4&&Qe.subdivideFaces){var j=R.length?R:new THREE.Color;for(n=1;f-1>n;)_.push(new THREE.Face3(w[0],w[n],w[n+1],b.length?[b[0].clone(),b[n++].clone(),b[n].clone()]:[],j))}if(_.length)for(c=0,l=_.length;l>c;c++)for(A=_[c],A.daeMaterial=e.material,t.faces.push(A),n=0;n<E.length;n++)x=M[E[n]],H=f>4?[x[0],x[c+1],x[c+2]]:4===f?0===c?[x[0],x[1],x[3]]:[x[1].clone(),x[2],x[3].clone()]:[x[0],x[1],x[2]],void 0===t.faceVertexUvs[n]&&(t.faceVertexUvs[n]=[]),t.faceVertexUvs[n].push(H);else console.log("dropped face with vcount "+f+" for geometry with id: "+t.id);T+=m*f}},L.prototype.setVertices=function(e){for(var t=0;t<this.inputs.length;t++)this.inputs[t].source===e.id&&(this.inputs[t].source=e.input.POSITION.source)},L.prototype.parse=function(e){this.material=e.getAttribute("material"),this.count=ge(e,"count",0);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"input":this.inputs.push((new U).parse(e.childNodes[t]));break;case"vcount":this.vcount=fe(i.textContent);break;case"p":this.p.push(fe(i.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},z.prototype=Object.create(L.prototype),z.prototype.constructor=z,D.prototype=Object.create(L.prototype),D.prototype.constructor=D,F.prototype=Object.create(L.prototype),F.prototype.constructor=F,X.prototype.parse=function(e){this.params=[],this.source=e.getAttribute("source"),this.count=ge(e,"count",0),this.stride=ge(e,"stride",0);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if("param"===i.nodeName){var n={};n.name=i.getAttribute("name"),n.type=i.getAttribute("type"),this.params.push(n)}}return this},Y.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++)if("input"===e.childNodes[t].nodeName){var i=(new U).parse(e.childNodes[t]);this.input[i.semantic]=i}return this},U.prototype.parse=function(e){return this.semantic=e.getAttribute("semantic"),this.source=e.getAttribute("source").replace(/^#/,""),this.set=ge(e,"set",-1),this.offset=ge(e,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},V.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"bool_array":this.data=de(i.textContent),this.type=i.nodeName;break;case"float_array":this.data=pe(i.textContent),this.type=i.nodeName;break;case"int_array":this.data=fe(i.textContent),this.type=i.nodeName;break;case"IDREF_array":case"Name_array":this.data=me(i.textContent),this.type=i.nodeName;break;case"technique_common":for(var n=0;n<i.childNodes.length;n++)if("accessor"===i.childNodes[n].nodeName){this.accessor=(new X).parse(i.childNodes[n]);break}}}return this},V.prototype.read=function(){var e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var i=0;i<this.data.length;i+=16){var n=this.data.slice(i,i+16),r=Re(n);e.push(r)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+t.type+".")}return e},B.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++)if("instance_effect"===e.childNodes[t].nodeName){this.instance_effect=(new K).parse(e.childNodes[t]);break}return this},Z.prototype.isColor=function(){return null===this.texture},Z.prototype.isTexture=function(){return null!==this.texture},Z.prototype.parse=function(e){"transparent"===e.nodeName&&(this.opaque=e.getAttribute("opaque"));for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"color":var n=pe(i.textContent);this.color=new THREE.Color,this.color.setRGB(n[0],n[1],n[2]),this.color.a=n[3];break;case"texture":this.texture=i.getAttribute("texture"),this.texcoord=i.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(i)}}return this},Z.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&"extra"===e.childNodes[1].nodeName&&(e=e.childNodes[1],e.childNodes[1]&&"technique"===e.childNodes[1].nodeName&&(e=e.childNodes[1]));for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[i.nodeName]=parseFloat(i.textContent);break;case"wrapU":case"wrapV":"TRUE"===i.textContent.toUpperCase()?this.texOpts[i.nodeName]=1:this.texOpts[i.nodeName]=parseInt(i.textContent);break;default:this.texOpts[i.nodeName]=i.textContent}}return this},q.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"emission":case"diffuse":case"specular":case"transparent":this[i.nodeName]=(new Z).parse(i);break;case"bump":var n=i.getAttribute("bumptype");n?"heightfield"===n.toLowerCase()?this.bump=(new Z).parse(i):"normalmap"===n.toLowerCase()?this.normal=(new Z).parse(i):(console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+n+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'"),this.bump=(new Z).parse(i)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new Z).parse(i));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var r=i.querySelectorAll("float");r.length>0&&(this[i.nodeName]=parseFloat(r[0].textContent))}}return this.create(),this},q.prototype.create=function(){var e={},t=!1;if(void 0!==this.transparency&&void 0!==this.transparent){var i=(this.transparent,(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency);i>0&&(t=!0,e.transparent=!0,e.opacity=1-i)}var n={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var r in this)switch(r){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var a=this[r];if(a instanceof Z)if(a.isTexture()){var o=a.texture,s=this.effect.sampler[o];if(void 0!==s&&void 0!==s.source){var h=this.effect.surface[s.source];if(void 0!==h){var c=Fe[h.init_from];if(c){var l=c.init_from;l=Ge?Ge+l:Ce+l;var u,d=THREE.Loader.Handlers.get(l);null!==d?u=d.load(l):(u=new THREE.Texture,ve(u,l)),u.wrapS=a.texOpts.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,u.wrapT=a.texOpts.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,u.offset.x=a.texOpts.offsetU,u.offset.y=a.texOpts.offsetV,u.repeat.x=a.texOpts.repeatU,u.repeat.y=a.texOpts.repeatV,e[n[r]]=u,"emission"===r&&(e.emissive=16777215)}}}}else"diffuse"!==r&&t||("emission"===r?e.emissive=a.color.getHex():e[r]=a.color.getHex());break;case"shininess":e[r]=this[r];break;case"reflectivity":e[r]=this[r],e[r]>0&&(e.envMap=Qe.defaultEnvMap),e.combine=THREE.MixOperation;break;case"index_of_refraction":e.refractionRatio=this[r],1!==this[r]&&(e.envMap=Qe.defaultEnvMap);break;case"transparency":}switch(e.shading=Je,e.side=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide,void 0!==e.diffuse&&(e.color=e.diffuse,delete e.diffuse),this.type){case"constant":void 0!==e.emissive&&(e.color=e.emissive),this.material=new THREE.MeshBasicMaterial(e);break;case"phong":case"blinn":this.material=new THREE.MeshPhongMaterial(e);break;default:this.material=new THREE.MeshLambertMaterial(e)}return this.material},J.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"init_from":this.init_from=i.textContent;break;case"format":this.format=i.textContent;break;default:console.log("unhandled Surface prop: "+i.nodeName)}}return this},Q.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"source":this.source=i.textContent;break;case"minfilter":this.minfilter=i.textContent;break;case"magfilter":this.magfilter=i.textContent;break;case"mipfilter":this.mipfilter=i.textContent;break;case"wrap_s":this.wrap_s=i.textContent;break;case"wrap_t":this.wrap_t=i.textContent;break;default:console.log("unhandled Sampler2D prop: "+i.nodeName)}}return this},W.prototype.create=function(){return null===this.shader?null:void 0},W.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),ye(this,e),this.shader=null;for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(i))}}return this},W.prototype.parseNewparam=function(e){for(var t=e.getAttribute("sid"),i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"surface":this.surface[t]=new J(this).parse(n);break;case"sampler2D":this.sampler[t]=new Q(this).parse(n);break;case"extra":break;default:console.log(n.nodeName)}}},W.prototype.parseProfileCOMMON=function(e){for(var t,i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"profile_COMMON":this.parseProfileCOMMON(n);break;case"technique":t=n;break;case"newparam":this.parseNewparam(n);break;case"image":var r=(new H).parse(n);Fe[r.id]=r;break;case"extra":break;default:console.log(n.nodeName)}}return t},W.prototype.parseTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new q(i.nodeName,this).parse(i);break;case"extra":this.parseExtra(i)}}},W.prototype.parseExtra=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique":this.parseExtraTechnique(i)}}},W.prototype.parseExtraTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"bump":this.shader.parse(e)}}},K.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},$.prototype.parse=function(e){var t;this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.source={};for(var i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"animation":var r=(new $).parse(n);for(t in r.source)this.source[t]=r.source[t];for(var a=0;a<r.channel.length;a++)this.channel.push(r.channel[a]),this.sampler.push(r.sampler[a]);break;case"source":t=(new V).parse(n),this.source[t.id]=t;break;case"sampler":this.sampler.push(new te(this).parse(n));break;case"channel":this.channel.push(new ee(this).parse(n))}}return this},ee.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,""),this.target=e.getAttribute("target");var t=this.target.split("/"),i=(t.shift(),t.shift()),n=i.indexOf(".")>=0,r=i.indexOf("(")>=0;if(n)t=i.split("."),this.sid=t.shift(),this.member=t.shift();else if(r){var a=i.split("(");this.sid=a.shift();for(var o=0;o<a.length;o++)a[o]=parseInt(a[o].replace(/\)/,""));this.arrIndices=a}else this.sid=i;return this.fullSid=i,this.dotSyntax=n,this.arrSyntax=r,this},te.prototype.parse=function(e){this.id=e.getAttribute("id"),this.inputs=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"input":this.inputs.push((new U).parse(i))}}return this},te.prototype.create=function(){var e;for(e=0;e<this.inputs.length;e++){var t=this.inputs[e],i=this.animation.source[t.source];switch(t.semantic){case"INPUT":this.input=i.read();break;case"OUTPUT":this.output=i.read(),this.strideOut=i.accessor.stride;break;case"INTERPOLATION":this.interpolation=i.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(t.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){for(this.startTime=1e8,this.endTime=-1e8,e=0;e<this.input.length;e++)this.startTime=Math.min(this.startTime,this.input[e]),this.endTime=Math.max(this.endTime,this.input[e]);this.duration=this.endTime-this.startTime}},te.prototype.getData=function(e,t,i){var n;if("matrix"===e&&16===this.strideOut)n=this.output[t];else if(this.strideOut>1){n=[],t*=this.strideOut;for(var r=0;r<this.strideOut;++r)n[r]=this.output[t+r];if(3===this.strideOut)switch(e){case"rotate":case"translate":we(n,-1);break;case"scale":we(n,1)}else 4===this.strideOut&&"matrix"===e&&we(n,-1)}else n=this.output[t],i&&"translate"===e&&(n=be(i,n));return n},ie.prototype.addTarget=function(e,t,i,n){this.targets.push({sid:e,member:i,transform:t,data:n})},ie.prototype.apply=function(e){for(var t=0;t<this.targets.length;++t){var i=this.targets[t];e&&i.sid!==e||i.transform.update(i.data,i.member)}},ie.prototype.getTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return this.targets[t];return null},ie.prototype.hasTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return!0;return!1},ie.prototype.interpolate=function(e,t){for(var i=0,n=this.targets.length;n>i;i++){var r,a=this.targets[i],o=e.getTarget(a.sid);if("matrix"!==a.transform.type&&o){var s=(t-this.time)/(e.time-this.time),h=o.data,c=a.data;if(0>s&&(s=0),s>1&&(s=1),c.length){r=[];for(var l=0;l<c.length;++l)r[l]=c[l]+(h[l]-c[l])*s}else r=c+(h-c)*s}else r=a.data;a.transform.update(r,a.member)}},ne.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"optics":this.parseOptics(i)}}return this},ne.prototype.parseOptics=function(e){var t,i,n,r;for(t=0;t<e.childNodes.length;t++)if("technique_common"===e.childNodes[t].nodeName){var a=e.childNodes[t];for(i=0;i<a.childNodes.length;i++)if(this.technique=a.childNodes[i].nodeName,"perspective"===this.technique){var o=a.childNodes[i];for(n=0;n<o.childNodes.length;n++)switch(r=o.childNodes[n],r.nodeName){case"yfov":this.yfov=r.textContent;break;case"xfov":this.xfov=r.textContent;break;case"znear":this.znear=r.textContent;break;case"zfar":this.zfar=r.textContent;break;case"aspect_ratio":this.aspect_ratio=r.textContent}}else if("orthographic"===this.technique){var s=a.childNodes[i];for(n=0;n<s.childNodes.length;n++)switch(r=s.childNodes[n],r.nodeName){case"xmag":this.xmag=r.textContent;break;case"ymag":this.ymag=r.textContent;break;case"znear":this.znear=r.textContent;break;case"zfar":this.zfar=r.textContent;break;case"aspect_ratio":this.aspect_ratio=r.textContent}}}return this},re.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},ae.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique_common":this.parseCommon(i);break;case"technique":this.parseTechnique(i)}}return this},ae.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++)switch(e.childNodes[t].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=e.childNodes[t].nodeName;for(var i=e.childNodes[t],n=0;n<i.childNodes.length;n++){var r=i.childNodes[n];switch(r.nodeName){case"color":var a=pe(r.textContent);this.color=new THREE.Color(0),this.color.setRGB(a[0],a[1],a[2]),this.color.a=a[3];break;case"falloff_angle":this.falloff_angle=parseFloat(r.textContent);break;case"quadratic_attenuation":var o=parseFloat(r.textContent);this.distance=o?Math.sqrt(1/o):0}}}return this},ae.prototype.parseTechnique=function(e){this.profile=e.getAttribute("profile");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"intensity":this.intensity=parseFloat(i.textContent)}}return this},oe.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},se.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.joints=[],this.links=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique_common":this.parseCommon(i)}}return this},se.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(e.childNodes[t].nodeName){case"joint":this.joints.push((new he).parse(i));break;case"link":this.links.push((new ce).parse(i))}}return this},he.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this["static"]=!1,this.zeroPosition=0,this.middlePosition=0;var t=e.querySelector("axis"),i=pe(t.textContent);this.axis=Me(i,0);var n=e.querySelector("limits min")?parseFloat(e.querySelector("limits min").textContent):-360,r=e.querySelector("limits max")?parseFloat(e.querySelector("limits max").textContent):360;this.limits={min:n,max:r};for(var a=["prismatic","revolute"],o=0;o<a.length;o++){var s=a[o],h=e.querySelector(s);h&&(this.type=s)}return this.limits.min>=this.limits.max&&(this["static"]=!0),this.middlePosition=(this.limits.min+this.limits.max)/2,this},ce.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.transforms=[],this.attachments=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"attachment_full":this.attachments.push((new le).parse(i));break;case"rotate":case"translate":case"matrix":this.transforms.push((new N).parse(i))}}return this},le.prototype.parse=function(e){this.joint=e.getAttribute("joint").split("/").pop(),this.links=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"link":this.links.push((new ce).parse(i));break;case"rotate":case"translate":case"matrix":this.transforms.push((new N).parse(i))}}return this},{load:e,parse:t,setPreferredShading:i,applySkin:m,geometries:Ue,options:Qe}};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE&&!function(){
var e=new THREE.BoxGeometry(.7,.7,.7);e.uuid="71EB1490-B411-48E3-B187-D4A9B1836ACA",e.name="SELECT_BOX_GEOMETRY";var t=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,depthWrite:!1,depthTest:!1});t.uuid="0DD7A775-4B05-487D-845B-A10A2A224A55",t.name="SELECT_BOX_MATERIAL",t.transparent=!0,t.opacity=0;var i=function(){THREE.Object3D.call(this),this.model_url="",this.model_object=new THREE.Object3D,this.add(this.model_object)};i.prototype=Object.create(THREE.Object3D.prototype),i.prototype.constructor=i,i.prototype.load=function(i,n){var r=this;return new Promise(function(a,o){var s=new AMTHREE.ColladaLoader;s.options.convertUpAxis=!0,s.load(i,n,function(n){var o=new THREE.Box3,s=new THREE.Vector3,h=n.scene,c=new THREE.Mesh(e,t);c.add(h),r.model_url=i,r.model_object.remove.apply(r.model_object,r.model_object.children),r.model_object.add(c),o.setFromObject(h),o.size(c.scale),r.updateMatrix(),o.center(s),h.scale.divide(c.scale),h.position.sub(s.divide(c.scale)),h.updateMatrix(),AMTHREE.ObjectConvert(r.model_object),a(r)},void 0,o)})},i.prototype.toJSON=function(e){var t={uuid:this.uuid,type:"Collada",name:this.name,url:AMTHREE.GetFilename(this.model_url),matrix:this.matrix.toArray()};"{}"!==JSON.stringify(this.userData)&&(t.userData=this.userData),this.castShadow===!0&&(t.castShadow=!0),this.receiveShadow===!0&&(t.receiveShadow=!0),this.visible===!1&&(t.visible=!1);for(var i=[],n=0;n<this.children.length;++n)this.children[n]!==this.model_object&&i.push(this.children[n].toJSON(e).object);return i.length>0&&(t.children=i),{object:t}},AMTHREE.ColladaObject=i}();var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.GifTexture=function(e){THREE.Texture.call(this),this.minFilter=THREE.NearestMipMapNearestFilter,this.imageElement=document.createElement("img");var t=document.getElementsByTagName("script");t=t[t.length-1],t.parentNode.appendChild(this.imageElement),this.imageElement.width=this.imageElement.naturalWidth,this.imageElement.height=this.imageElement.naturalHeight,e&&this.setGif(e)},AMTHREE.GifTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.GifTexture.prototype.constructor=AMTHREE.GifTexture,AMTHREE.GifTexture.prototype.play=function(){this.anim.play(),this.image=this.gifCanvas},AMTHREE.GifTexture.prototype.update=function(){this.needsUpdate=!0},AMTHREE.GifTexture.prototype.stop=function(){this.anim.move_to(0),this.image=void 0},AMTHREE.GifTexture.prototype.pause=function(){this.anim.pause()},AMTHREE.GifTexture.prototype.setGif=function(e){e.url&&(this.image_ref=e,this.imageElement.src=e.url,this.anim=new SuperGif({gif:this.imageElement,auto_play:!1}),this.anim.load(),this.gifCanvas=this.anim.get_canvas(),this.gifCanvas.style.display="none")},AMTHREE.GifTexture.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,this.image_ref&&(t.image=this.image_ref.uuid),t.animated=!0,this.image_ref.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.GifTexture=function(){console.warn("GifTexture.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Image=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url=t},AMTHREE.Image.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,t.url=AMTHREE.GetFilename(this.url),"object"==typeof e&&(e.images||(e.images={}),e.images[t.uuid]=t),t}):AMTHREE.Image=function(){console.warn("Image.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.ImageTexture=function(e){THREE.Texture.call(this),this.image=new Image,this.image.addEventListener("load",function(e){return function(){e.needsUpdate=!0}}(this)),this.set(e)},AMTHREE.ImageTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.ImageTexture.prototype.constructor=AMTHREE.ImageTexture,AMTHREE.ImageTexture.prototype.set=function(e){this.image_ref=e,this.image.src=e.url},AMTHREE.ImageTexture.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,t.image=this.image_ref.uuid,this.image_ref.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.ImageTexture=function(){console.warn("ImageTexture.js: THREE undefined")};var AMTHREE=AMTHREE||{};!function(){function e(e){return"undefined"!=typeof e&&null!==e}function t(t){t.traverse(function(t){if(e(t.material)&&e(t.material.map)&&e(t.material.map.image)){var i=new AMTHREE.Image(void 0,t.material.map.image.src),n=new AMTHREE.ImageTexture(i);t.material.map=n,t.material.needsUpdate=!0}})}AMTHREE.ObjectConvert=t}();var AMTHREE=AMTHREE||{};!function(){function e(e,t){e=e||{};var i={};return t?i.asset_path=t+"/":i.asset_path="",i.asset_path+=e.asset_path?e.asset_path+"/":"",i.image_path=i.asset_path+(e.image_path?e.image_path:""),i.video_path=i.asset_path+(e.video_path?e.video_path:""),i.model_path=i.asset_path+(e.model_path?e.model_path:""),i.sound_path=i.asset_path+(e.sound_path?e.sound_path:""),i}function t(e,t){var i={};if(e instanceof Array){var n=new THREE.MaterialLoader;n.setTextures(t);for(var r=0,a=e.length;a>r;r++){var o=n.parse(e[r]);i[o.uuid]=o}}else console.log("materials parsing failed: json not an array");return i}function n(e){var t=[];if(e instanceof Array)for(var i=0;i<e.length;i++){var n=THREE.AnimationClip.parse(e[i]);t.push(n)}else console.log("animations parsing failed: json not an array");return t}function r(e,t){var i={};if(e instanceof Array)for(var n=0,r=e.length;r>n;++n){var a=e[n];if(void 0===a.uuid)console.warn('failed to parse sound: no "uuid" specified for sound '+n);else if(void 0===a.url)console.warn('failed to parse sound: no "url" specified for sound '+n);else{var o=new AMTHREE.Sound(a.uuid,t+"/"+a.url);i[a.uuid]=o}}return i}function a(e,t){return new Promise(function(n,r){var a={};return e instanceof Array?Promise.all(e.map(function(e){return new Promise(function(n,r){if(void 0===e.url)r('failed to parse image: no "url" specified for image '+i);else if(void 0===e.uuid)r('failed to parse image: no "uuid" specified for image '+i);else{var o=new AMTHREE.Image(e.uuid,t+"/"+e.url);a[o.uuid]=o,n()}})})).then(n(a),r):void r("images parsing failed: json not an array")})}function o(e,t){var i={};if(e instanceof Array)for(var n=0,r=e.length;r>n;n++){var a=e[n];if(void 0===a.uuid)console.warn('failed to parse video: no "uuid" specified for video '+n);else if(void 0===a.url)console.warn('failed to parse video: no "url" specified for video '+n);else{var o=new AMTHREE.Video(a.uuid,t+"/"+a.url);i[a.uuid]=o}}return i}function s(e){return"number"==typeof e?e:(console.warn("AMTHREE.ObjectLoading: Constant should be in numeric form.",e),THREE[e])}function h(e,t,i){var n={};if("undefined"==typeof SuperGif&&console.warn("AMTHREE.ObjectLoading: SuperGif is undefined"),"undefined"!=typeof e)for(var r=0,a=e.length;a>r;r++){var o=e[r],h=void 0;if(o.uuid||console.warn("failed to parse texture "+r+": no uuid provided"),void 0!==o.image||void 0!==o.video){if(void 0!==o.image){if(void 0===t[o.image]){console.warn("failed to parse texture "+o.uuid+": undefined image",o.image);continue}var c=t[o.image];if(void 0!==o.animated&&o.animated){if("undefined"==typeof SuperGif)continue;h=new AMTHREE.GifTexture(c)}else h=new AMTHREE.ImageTexture(c),h.needsUpdate=!0}else{if(void 0===i[o.video]){console.warn("failed to parse texture "+o.uuid+": undefined video",o.video);continue}var l=i[o.video];h=new AMTHREE.VideoTexture(l,o.width,o.height,o.loop,o.autoplay)}h.uuid=o.uuid,void 0!==o.name&&(h.name=o.name),void 0!==o.mapping&&(h.mapping=s(o.mapping)),void 0!==o.offset&&(h.offset=new THREE.Vector2(o.offset[0],o.offset[1])),void 0!==o.repeat&&(h.repeat=new THREE.Vector2(o.repeat[0],o.repeat[1])),void 0!==o.minFilter?h.minFilter=s(o.minFilter):h.minFilter=THREE.LinearFilter,void 0!==o.magFilter&&(h.magFilter=s(o.magFilter)),void 0!==o.anisotropy&&(h.anisotropy=o.anisotropy),Array.isArray(o.wrap)&&(h.wrapS=s(o.wrap[0]),h.wrapT=s(o.wrap[1])),n[o.uuid]=h}else console.warn('failed to parse texture: no "image" nor "video" specified for '+o.uuid)}return n}function c(e){var t={};if("undefined"!=typeof e)for(var i=new THREE.JSONLoader,n=new THREE.BufferGeometryLoader,r=0,a=e.length;a>r;r++){var o,s=e[r];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":o=new THREE[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"CubeGeometry":o=new THREE.BoxGeometry(s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleBufferGeometry":o=new THREE.CircleBufferGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CircleGeometry":o=new THREE.CircleGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":o=new THREE.CylinderGeometry(s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"SphereGeometry":o=new THREE.SphereGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"SphereBufferGeometry":o=new THREE.SphereBufferGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":o=new THREE.DodecahedronGeometry(s.radius,s.detail);break;case"IcosahedronGeometry":o=new THREE.IcosahedronGeometry(s.radius,s.detail);break;case"OctahedronGeometry":o=new THREE.OctahedronGeometry(s.radius,s.detail);break;case"TetrahedronGeometry":o=new THREE.TetrahedronGeometry(s.radius,s.detail);break;case"RingGeometry":o=new THREE.RingGeometry(s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":o=new THREE.TorusGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":o=new THREE.TorusKnotGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.p,s.q,s.heightScale);break;case"BufferGeometry":o=n.parse(s);break;case"Geometry":o=i.parse(s.data,this.texturePath).geometry;break;default:console.warn('AMTHREE.ObjectLoading: Unsupported geometry type "'+s.type+'"');continue}o.uuid=s.uuid,void 0!==s.name&&(o.name=s.name),t[s.uuid]=o}return t}function l(e,t,i){return new Promise(function(n,r){var a=new AM.JsonLoader;a.Load(e,function(){t(a.json,i).then(n,r)},function(){r("failed to load object: "+e)})})}function u(e,t){return l(e,f,t)}function d(e,t){return l(e,m,t)}function p(i,s){var l=e(i.constants,s);return a(i.images||[],l.image_path).then(function(e){var a=r(i.sounds||[],l.sound_path),s=o(i.videos||[],l.video_path),u=h(i.textures||[],e,s),d=n(i.animations||[]),p=t(i.materials||[],u),f=c(i.geometries||[]),m={constants:l,videos:s,images:e,sounds:a,textures:u,animations:d,materials:p,geometries:f};return m})}function f(e,t){return p(e,t).then(function(t){return T(e.object,t.materials,t.geometries,t.sounds,t.constants).then(function(e){return e.animations=t.animations,e})})}function m(e,t){return p(e,t).then(function(t){return w(e.objects,t.materials,t.geometries,t.sounds,t.constants)})}function E(e,t,i,n,r,a){var o=new THREE.Matrix4;if(e.uuid=t.uuid,void 0!==t.name&&(e.name=t.name),void 0!==t.matrix?(o.fromArray(t.matrix),o.decompose(e.position,e.quaternion,e.scale)):(void 0!==t.position&&e.position.fromArray(t.position),void 0!==t.rotation&&e.rotation.fromArray(t.rotation),void 0!==t.scale&&e.scale.fromArray(t.scale),void 0!==t.scaleXYZ&&(e.scale.x*=t.scaleXYZ,e.scale.y*=t.scaleXYZ,e.scale.z*=t.scaleXYZ)),void 0!==t.castShadow&&(e.castShadow=t.castShadow),void 0!==t.receiveShadow&&(e.receiveShadow=t.receiveShadow),void 0!==t.visible&&(e.visible=t.visible),void 0!==t.userData&&(e.userData=t.userData),"LOD"===t.type)for(var s=t.levels,h=0;h<s.length;h++){var c=s[h],l=e.getObjectByProperty("uuid",c.object);void 0!==l&&e.addLevel(l,c.distance)}return void 0!==t.children?w(t.children,i,n,r,a).then(function(t){for(var i=0,n=t.length;n>i;++i)e.add(t[i]);return e}):Promise.resolve(e)}function g(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get geometry: no id provided"):console.warn("failed to get geometry: no such geometry: "+e))}function v(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get material: no id provided"):console.warn("failed to get material: no such material: "+e))}function y(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get sound: no id provided"):console.warn("failed to get sound: no such sound: "+e))}function T(e,t,i,n,r){var a,o;switch(e.type){case"OBJ":return new Promise(function(a,s){if(THREE.OBJLoader){var h=new THREE.OBJLoader;o=r.model_path+"/"+e.url,h.load(o,function(o){o.traverse(function(e){e.geometry&&e.geometry.computeBoundingSphere()}),E(o,e,t,i,n,r).then(function(){a(o)},s)})}else s("failed to load "+e.uuid+": THREE.OBJLoader is undefined")});case"Collada":return a=new AMTHREE.ColladaObject,a.load(r.model_path+e.url,r.image_path).then(function(a){return E(a,e,t,i,n,r).then(function(){return a})});case"SoundObject":a=new AMTHREE.SoundObject(y(e.sound,n));break;case"Scene":a=new THREE.Scene;break;case"PerspectiveCamera":a=new THREE.PerspectiveCamera(e.fov,e.aspect,e.near,e.far);break;case"OrthographicCamera":a=new THREE.OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far);break;case"AmbientLight":a=new THREE.AmbientLight(e.color);break;case"DirectionalLight":a=new THREE.DirectionalLight(e.color,e.intensity);break;case"PointLight":a=new THREE.PointLight(e.color,e.intensity,e.distance,e.decay);break;case"SpotLight":a=new THREE.SpotLight(e.color,e.intensity,e.distance,e.angle,e.exponent,e.decay);break;case"HemisphereLight":a=new THREE.HemisphereLight(e.color,e.groundColor,e.intensity);break;case"Mesh":a=new THREE.Mesh(g(e.geometry,i),v(e.material,t));break;case"LOD":a=new THREE.LOD;break;case"Line":a=new THREE.Line(g(e.geometry,i),v(e.material,t),e.mode);break;case"PointCloud":case"Points":a=new THREE.Points(g(e.geometry,i),v(e.material,t));break;case"Sprite":a=new THREE.Sprite(v(e.material,t));break;case"Group":a=new THREE.Group;break;default:a=new THREE.Object3D}return E(a,e,t,i,n,r)}function w(e,t,i,n,r){return e instanceof Array?Promise.all(e.map(function(e){return T(e,t,i,n,r)})):Promise.reject("failed to parse object array: json not an array")}function b(e){var t=new THREE.Box3,i=new THREE.Sphere,n=new THREE.Object3D;n.add(e),t.setFromObject(e),t.getBoundingSphere(i),n.scale.multiplyScalar(1/i.radius),i.center.divideScalar(i.radius),n.position.sub(i.center),n.updateMatrix();var r=new THREE.Object3D;return r.add(n),r}function M(e){e.traverse(function(e){e instanceof THREE.Mesh&&e.geometry&&e.geometry.computeBoundingBox()})}function R(e){e.traverse(function(e){e instanceof THREE.Mesh&&e.geometry&&e.geometry.computeBoundingSphere()})}"undefined"!=typeof THREE&&(AMTHREE.ParseObject=f,AMTHREE.ParseObjectArray=m,AMTHREE.LoadObject=u,AMTHREE.LoadObjectArray=d,AMTHREE.NormalizeObject=b,AMTHREE.ComputeBoundingBox=M,AMTHREE.ComputeBoundingSphere=R)}();var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Sound=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url=t},AMTHREE.Sound.prototype.toJSON=function(e){var t={uuid:this.uuid,url:AMTHREE.GetFilename(this.url)};return e.sounds||(e.sounds={}),e.sounds[this.uuid]||(e.sounds[this.uuid]=t),t}):AMTHREE.Sound=function(){console.warn("Sound.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.SoundObject=function(e){THREE.Object3D.call(this),this.sound=e,this.audio=new Audio,this.audio.loop=!0,this.playing=!1},AMTHREE.SoundObject.prototype=Object.create(THREE.Object3D.prototype),AMTHREE.SoundObject.prototype.constructor=AMTHREE.SoundObject,AMTHREE.SoundObject.prototype.play=function(){this.playing=!0,this.audio.src=this.sound.url,this.audio.play()},AMTHREE.SoundObject.prototype.stop=function(){this.audio.src="",this.playing=!1},AMTHREE.SoundObject.prototype.pause=function(){this.audio.pause(),this.playing=!1},AMTHREE.SoundObject.prototype.setSound=function(e){this.sound=e,this.isPlaying()&&this.play()},AMTHREE.SoundObject.prototype.isPlaying=function(){return this.playing},AMTHREE.SoundObject.prototype.clone=function(){return(new AMTHREE.SoundObject).copy(this)},AMTHREE.SoundObject.prototype.copy=function(e){return this.setSound(e.sound),this},AMTHREE.SoundsCall=function(e,t){e.traverse(function(e){e instanceof AMTHREE.SoundObject&&e[t]&&e[t]()})},AMTHREE.PlaySounds=function(e){AMTHREE.SoundsCall(e,"play")},AMTHREE.PauseSounds=function(e){AMTHREE.SoundsCall(e,"pause")},AMTHREE.StopSounds=function(e){AMTHREE.SoundsCall(e,"stop")},AMTHREE.SoundObject.prototype.toJSON=function(e){var t=THREE.Object3D.prototype.toJSON.call(this,e);return this.sound.toJSON(e),t.object.type="SoundObject",t.object.sound=this.sound.uuid,t}):AMTHREE.SoundObject=function(){console.warn("SoundObject.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.TrackedObjManager=function(e){function t(e,t,i){e.position.lerp(t.position,i),e.quaternion.slerp(t.quaternion,i),e.scale.lerp(t.scale,i)}function i(){a.ForEach(function(e){e.enabled&&t(e.object,e.target,n.lerp_factor)})}e=e||{};var n=this,r=new THREE.Clock(!0),a=new AMTHREE.TrackedObjManager.prototype.Holder,o=i;this.camera=e.camera,this.lerp_factor=e.lerp_factor||.8,this.timeout=e.timeout||6,this.Add=function(e,t,i,n){a.Add(e,t,i,n)},this.Remove=function(e){a.Remove(e)},this.Clear=function(){a.Clear()},this.Update=function(){a.UpdateElapsed(r.getDelta()),a.CheckTimeout(n.timeout),o()},this.Track=function(){var e=new THREE.Matrix4,i=new THREE.Object3D;return function(r,o){if(n.camera){var s=a.Get(r);if(s){var h=s.target;return e.copy(n.camera.matrixWorld),e.multiply(o),s.enabled?(e.decompose(i.position,i.quaternion,i.scale),t(h,i,n.lerp_factor)):(e.decompose(h.position,h.quaternion,h.scale),e.decompose(s.object.position,s.object.quaternion,s.object.scale)),a.Track(r),!0}console.warn("TrackedObjManager: object "+r+" not found")}else console.warn("TrackedObjManager: camera is undefined");return!1}}(),this.TrackCompose=function(){var e=new THREE.Matrix4;return function(t,i,r,a){return e.compose(i,r,a),n.Track(t,e)}}(),this.TrackComposePosit=function(){var e=new THREE.Vector3,t=new THREE.Euler,i=new THREE.Quaternion,r=new THREE.Vector3;return function(a,o,s,h){return e.x=o[0],e.y=o[1],e.z=-o[2],t.x=-Math.asin(-s[1][2]),t.y=-Math.atan2(s[0][2],s[2][2]),t.z=Math.atan2(s[1][0],s[1][1]),r.x=h,r.y=h,r.z=h,i.setFromEuler(t),n.TrackCompose(a,e,i,r)}}(),this.GetObject=function(e){var t=a.get(e);return t?t.object:void 0}},AMTHREE.TrackedObjManager.prototype.Holder=function(){var e=this,t={};this.Add=function(e,i,n,r){t[i]={object:e,target:{position:e.position.clone(),quaternion:e.quaternion.clone(),scale:e.scale.clone()},elapsed:0,on_enable:n,on_disable:r,enabled:!1}},this.Remove=function(e){var i=t[e];i.enabled&&i.on_disable&&i.on_disable(i.object),delete t[e]},this.Clear=function(){for(var i in t)e.Remove(i)},this.Track=function(e){var i=t[e];i.elapsed=0,i.enabled||(i.enabled=!0,i.on_enable&&i.on_enable(i.object))},this.UpdateElapsed=function(e){for(var i in t)t[i].elapsed+=e},this.CheckTimeout=function(e){for(var i in t){var n=t[i];n.enabled&&n.elapsed>e&&(n.on_disable&&n.on_disable(n.object),n.enabled=!1)}},this.ForEach=function(e){for(var i in t)e(t[i])},this.Get=function(e){return t[e]}}):AMTHREE.TrackedObjManager=function(){console.warn("TrackedObjManager.js: THREE undefined")},function(){"use strict";var e=function(e){THREE.MeshBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.side=THREE.FrontSide,this.transparent=!0,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};e.prototype=Object.create(THREE.MeshBasicMaterial.prototype),e.prototype.constructor=e;var t=function(e){THREE.LineBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.transparent=!0,this.linewidth=1,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};t.prototype=Object.create(THREE.LineBasicMaterial.prototype),t.prototype.constructor=t;var i=new e({visible:!1,transparent:!1});AMTHREE.TransformGizmo=function(){this.init=function(){THREE.Object3D.call(this),this.handles=new THREE.Object3D,this.pickers=new THREE.Object3D,this.planes=new THREE.Object3D,this.add(this.handles),this.add(this.pickers),this.add(this.planes);var e=new THREE.PlaneBufferGeometry(50,50,2,2),t=new THREE.MeshBasicMaterial({visible:!1,side:THREE.DoubleSide}),i={XY:new THREE.Mesh(e,t),YZ:new THREE.Mesh(e,t),XZ:new THREE.Mesh(e,t),XYZE:new THREE.Mesh(e,t)};this.activePlane=i.XYZE,i.YZ.rotation.set(0,Math.PI/2,0),i.XZ.rotation.set(-Math.PI/2,0,0);for(var n in i)i[n].name=n,this.planes.add(i[n]),this.planes[n]=i[n];var r=function(e,t){for(var i in e)for(n=e[i].length;n--;){var r=e[i][n][0],a=e[i][n][1],o=e[i][n][2];r.name=i,a&&r.position.set(a[0],a[1],a[2]),o&&r.rotation.set(o[0],o[1],o[2]),t.add(r)}};r(this.handleGizmos,this.handles),r(this.pickerGizmos,this.pickers),this.traverse(function(e){if(e instanceof THREE.Mesh){e.updateMatrix();var t=e.geometry.clone();t.applyMatrix(e.matrix),e.geometry=t,e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1)}})},this.highlight=function(e){this.traverse(function(t){t.material&&t.material.highlight&&(t.name===e?t.material.highlight(!0):t.material.highlight(!1))})}},AMTHREE.TransformGizmo.prototype=Object.create(THREE.Object3D.prototype),AMTHREE.TransformGizmo.prototype.constructor=AMTHREE.TransformGizmo,AMTHREE.TransformGizmo.prototype.update=function(e,t){var i=new THREE.Vector3(0,0,0),n=new THREE.Vector3(0,1,0),r=new THREE.Matrix4;this.traverse(function(a){-1!==a.name.search("E")?a.quaternion.setFromRotationMatrix(r.lookAt(t,i,n)):-1===a.name.search("X")&&-1===a.name.search("Y")&&-1===a.name.search("Z")||a.quaternion.setFromEuler(e)})},AMTHREE.TransformGizmoTranslate=function(){AMTHREE.TransformGizmo.call(this);var n=new THREE.Geometry,r=new THREE.Mesh(new THREE.CylinderGeometry(0,.05,.2,12,1,!1));r.position.y=.5,r.updateMatrix(),n.merge(r.geometry,r.matrix);var a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.Float32Attribute([0,0,0,1,0,0],3));var o=new THREE.BufferGeometry;o.addAttribute("position",new THREE.Float32Attribute([0,0,0,0,1,0],3));var s=new THREE.BufferGeometry;s.addAttribute("position",new THREE.Float32Attribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new THREE.Mesh(n,new e({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(a,new t({color:16711680}))]],Y:[[new THREE.Mesh(n,new e({color:65280})),[0,.5,0]],[new THREE.Line(o,new t({color:65280}))]],Z:[[new THREE.Mesh(n,new e({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(s,new t({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.1,0),new e({color:16777215,opacity:.25})),[0,0,0],[0,0,0]]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:16776960,opacity:.25})),[.15,.15,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:65535,opacity:.25})),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:16711935,opacity:.25})),[.15,0,.15],[-Math.PI/2,0,0]]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.2,0),i)]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),i),[.2,.2,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),i),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),i),[.2,0,.2],[-Math.PI/2,0,0]]]},this.setActivePlane=function(e,t){var i=new THREE.Matrix4;t.applyMatrix4(i.getInverse(i.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"===e&&(this.activePlane=this.planes.XYZE),"XY"===e&&(this.activePlane=this.planes.XY),"YZ"===e&&(this.activePlane=this.planes.YZ),"XZ"===e&&(this.activePlane=this.planes.XZ)},this.init()},AMTHREE.TransformGizmoTranslate.prototype=Object.create(AMTHREE.TransformGizmo.prototype),AMTHREE.TransformGizmoTranslate.prototype.constructor=AMTHREE.TransformGizmoTranslate,AMTHREE.TransformGizmoRotate=function(){AMTHREE.TransformGizmo.call(this);var e=function(e,t,i){var n=new THREE.BufferGeometry,r=[];i=i?i:1;for(var a=0;64*i>=a;++a)"x"===t&&r.push(0,Math.cos(a/32*Math.PI)*e,Math.sin(a/32*Math.PI)*e),"y"===t&&r.push(Math.cos(a/32*Math.PI)*e,0,Math.sin(a/32*Math.PI)*e),"z"===t&&r.push(Math.sin(a/32*Math.PI)*e,Math.cos(a/32*Math.PI)*e,0);return n.addAttribute("position",new THREE.Float32Attribute(r,3)),n};this.handleGizmos={X:[[new THREE.Line(new e(1,"x",.5),new t({color:16711680}))]],Y:[[new THREE.Line(new e(1,"y",.5),new t({color:65280}))]],Z:[[new THREE.Line(new e(1,"z",.5),new t({color:255}))]],E:[[new THREE.Line(new e(1.25,"z",1),new t({color:13421568}))]],XYZE:[[new THREE.Line(new e(1,"z",1),new t({color:7895160}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.TorusGeometry(1,.12,4,12,Math.PI),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusGeometry(1,.12,4,12,Math.PI),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusGeometry(1,.12,4,12,Math.PI),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new THREE.Mesh(new THREE.TorusGeometry(1.25,.12,2,24),i)]],XYZE:[[new THREE.Mesh(new THREE.Geometry)]]},this.setActivePlane=function(e){"E"===e&&(this.activePlane=this.planes.XYZE),"X"===e&&(this.activePlane=this.planes.YZ),"Y"===e&&(this.activePlane=this.planes.XZ),"Z"===e&&(this.activePlane=this.planes.XY)},this.update=function(e,t){AMTHREE.TransformGizmo.prototype.update.apply(this,arguments);var i=({handles:this.handles,pickers:this.pickers},new THREE.Matrix4),n=new THREE.Euler(0,0,1),r=new THREE.Quaternion,a=new THREE.Vector3(1,0,0),o=new THREE.Vector3(0,1,0),s=new THREE.Vector3(0,0,1),h=new THREE.Quaternion,c=new THREE.Quaternion,l=new THREE.Quaternion,u=t.clone();n.copy(this.planes.XY.rotation),r.setFromEuler(n),i.makeRotationFromQuaternion(r).getInverse(i),u.applyMatrix4(i),this.traverse(function(e){r.setFromEuler(n),"X"===e.name&&(h.setFromAxisAngle(a,Math.atan2(-u.y,u.z)),r.multiplyQuaternions(r,h),e.quaternion.copy(r)),"Y"===e.name&&(c.setFromAxisAngle(o,Math.atan2(u.x,u.z)),r.multiplyQuaternions(r,c),e.quaternion.copy(r)),"Z"===e.name&&(l.setFromAxisAngle(s,Math.atan2(u.y,u.x)),r.multiplyQuaternions(r,l),e.quaternion.copy(r))})},this.init()},AMTHREE.TransformGizmoRotate.prototype=Object.create(AMTHREE.TransformGizmo.prototype),AMTHREE.TransformGizmoRotate.prototype.constructor=AMTHREE.TransformGizmoRotate,AMTHREE.TransformGizmoScale=function(){AMTHREE.TransformGizmo.call(this);var n=new THREE.Geometry,r=new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125));r.position.y=.5,r.updateMatrix(),n.merge(r.geometry,r.matrix);var a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.Float32Attribute([0,0,0,1,0,0],3));var o=new THREE.BufferGeometry;o.addAttribute("position",new THREE.Float32Attribute([0,0,0,0,1,0],3));var s=new THREE.BufferGeometry;s.addAttribute("position",new THREE.Float32Attribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new THREE.Mesh(n,new e({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(a,new t({color:16711680}))]],Y:[[new THREE.Mesh(n,new e({color:65280})),[0,.5,0]],[new THREE.Line(o,new t({color:65280}))]],Z:[[new THREE.Mesh(n,new e({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(s,new t({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125),new e({color:16777215,opacity:.25}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.BoxGeometry(.4,.4,.4),i)]]},this.setActivePlane=function(e,t){var i=new THREE.Matrix4;t.applyMatrix4(i.getInverse(i.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"===e&&(this.activePlane=this.planes.XYZE)},this.init()},AMTHREE.TransformGizmoScale.prototype=Object.create(AMTHREE.TransformGizmo.prototype),AMTHREE.TransformGizmoScale.prototype.constructor=AMTHREE.TransformGizmoScale,AMTHREE.TransformControls=function(e,t){function i(e){if(void 0!==h.object&&l!==!0&&(void 0===e.button||0===e.button)){var t=e.changedTouches?e.changedTouches[0]:e,i=s(t,u[c].pickers.children),n=null;i&&(n=i.object.name,e.preventDefault()),h.axis!==n&&(h.axis=n,h.update(),h.dispatchEvent(f))}}function n(t){if(void 0!==h.object&&l!==!0&&(void 0===t.button||0===t.button)){var i=t.changedTouches?t.changedTouches[0]:t;if(0===i.button||void 0===i.button){var n=s(i,u[c].pickers.children);if(n){t.preventDefault(),t.stopPropagation(),h.dispatchEvent(m),h.axis=n.object.name,h.update(),A.copy(Z).sub(U).normalize(),u[c].setActivePlane(h.axis,A);var r=s(i,[u[c].activePlane]);r&&(z.copy(h.object.position),D.copy(h.object.scale),F.extractRotation(h.object.matrix),B.extractRotation(h.object.matrixWorld),X.extractRotation(h.object.parent.matrixWorld),Y.setFromMatrixScale(_.getInverse(h.object.parent.matrixWorld)),w.copy(r.point),b.copy(w),b.project(e))}}l=!0}}function r(e){return 1+Math.sign(e)*e*e*5}function a(t){if(void 0!==h.object&&null!==h.axis&&l!==!1&&(void 0===t.button||0===t.button)){var i=t.changedTouches?t.changedTouches[0]:t,n=s(i,[u[c].activePlane]);if(n!==!1){if(t.preventDefault(),t.stopPropagation(),T.copy(n.point),"translate"===c)T.sub(w),T.multiply(Y),"local"===h.space&&(T.applyMatrix4(_.getInverse(B)),-1===h.axis.search("X")&&(T.x=0),-1===h.axis.search("Y")&&(T.y=0),-1===h.axis.search("Z")&&(T.z=0),T.applyMatrix4(F),h.object.position.copy(z),h.object.position.add(T)),"world"!==h.space&&-1===h.axis.search("XYZ")||(-1===h.axis.search("X")&&(T.x=0),-1===h.axis.search("Y")&&(T.y=0),-1===h.axis.search("Z")&&(T.z=0),T.applyMatrix4(_.getInverse(X)),h.object.position.copy(z),h.object.position.add(T)),null!==h.translationSnap&&("local"===h.space&&h.object.position.applyMatrix4(_.getInverse(B)),-1!==h.axis.search("X")&&(h.object.position.x=Math.round(h.object.position.x/h.translationSnap)*h.translationSnap),-1!==h.axis.search("Y")&&(h.object.position.y=Math.round(h.object.position.y/h.translationSnap)*h.translationSnap),-1!==h.axis.search("Z")&&(h.object.position.z=Math.round(h.object.position.z/h.translationSnap)*h.translationSnap),"local"===h.space&&h.object.position.applyMatrix4(B));else if("scale"===c){if(T.project(e),T.sub(b),"local"===h.space)if("XYZ"===h.axis)x=r(T.y),h.object.scale.x=D.x*x,h.object.scale.y=D.y*x,h.object.scale.z=D.z*x;else{T.applyMatrix4(_.getInverse(B)),j.copy(h.object.position),j.project(e),j.sub(b),j.normalize();var a=-(j.x*T.x+j.y*T.y+j.z*T.z);"X"===h.axis&&(h.object.scale.x=D.x*r(a)),"Y"===h.axis&&(h.object.scale.y=D.y*r(a)),"Z"===h.axis&&(h.object.scale.z=D.z*r(a))}}else"rotate"===c&&(T.sub(U),T.multiply(Y),j.copy(w).sub(U),j.multiply(Y),"E"===h.axis?(T.applyMatrix4(_.getInverse(H)),j.applyMatrix4(_.getInverse(H)),M.set(Math.atan2(T.z,T.y),Math.atan2(T.x,T.z),Math.atan2(T.y,T.x)),R.set(Math.atan2(j.z,j.y),Math.atan2(j.x,j.z),Math.atan2(j.y,j.x)),
k.setFromRotationMatrix(_.getInverse(X)),L.setFromAxisAngle(A,M.z-R.z),G.setFromRotationMatrix(B),k.multiplyQuaternions(k,L),k.multiplyQuaternions(k,G),h.object.quaternion.copy(k)):"XYZE"===h.axis?(L.setFromEuler(T.clone().cross(j).normalize()),k.setFromRotationMatrix(_.getInverse(X)),O.setFromAxisAngle(L,-T.clone().angleTo(j)),G.setFromRotationMatrix(B),k.multiplyQuaternions(k,O),k.multiplyQuaternions(k,G),h.object.quaternion.copy(k)):"local"===h.space?(T.applyMatrix4(_.getInverse(B)),j.applyMatrix4(_.getInverse(B)),M.set(Math.atan2(T.z,T.y),Math.atan2(T.x,T.z),Math.atan2(T.y,T.x)),R.set(Math.atan2(j.z,j.y),Math.atan2(j.x,j.z),Math.atan2(j.y,j.x)),G.setFromRotationMatrix(F),null!==h.rotationSnap?(O.setFromAxisAngle(S,Math.round((M.x-R.x)/h.rotationSnap)*h.rotationSnap),I.setFromAxisAngle(N,Math.round((M.y-R.y)/h.rotationSnap)*h.rotationSnap),P.setFromAxisAngle(C,Math.round((M.z-R.z)/h.rotationSnap)*h.rotationSnap)):(O.setFromAxisAngle(S,M.x-R.x),I.setFromAxisAngle(N,M.y-R.y),P.setFromAxisAngle(C,M.z-R.z)),"X"===h.axis&&G.multiplyQuaternions(G,O),"Y"===h.axis&&G.multiplyQuaternions(G,I),"Z"===h.axis&&G.multiplyQuaternions(G,P),h.object.quaternion.copy(G)):"world"===h.space&&(M.set(Math.atan2(T.z,T.y),Math.atan2(T.x,T.z),Math.atan2(T.y,T.x)),R.set(Math.atan2(j.z,j.y),Math.atan2(j.x,j.z),Math.atan2(j.y,j.x)),k.setFromRotationMatrix(_.getInverse(X)),null!==h.rotationSnap?(O.setFromAxisAngle(S,Math.round((M.x-R.x)/h.rotationSnap)*h.rotationSnap),I.setFromAxisAngle(N,Math.round((M.y-R.y)/h.rotationSnap)*h.rotationSnap),P.setFromAxisAngle(C,Math.round((M.z-R.z)/h.rotationSnap)*h.rotationSnap)):(O.setFromAxisAngle(S,M.x-R.x),I.setFromAxisAngle(N,M.y-R.y),P.setFromAxisAngle(C,M.z-R.z)),G.setFromRotationMatrix(B),"X"===h.axis&&k.multiplyQuaternions(k,O),"Y"===h.axis&&k.multiplyQuaternions(k,I),"Z"===h.axis&&k.multiplyQuaternions(k,P),k.multiplyQuaternions(k,G),h.object.quaternion.copy(k)));h.update(),h.dispatchEvent(f),h.dispatchEvent(g)}}}function o(e){void 0!==e.button&&0!==e.button||(l&&null!==h.axis&&(E.mode=c,h.dispatchEvent(E)),l=!1,i(e))}function s(i,n){var r=t.getBoundingClientRect(),a=(i.clientX-r.left)/r.width,o=(i.clientY-r.top)/r.height;y.set(2*a-1,-(2*o)+1),v.setFromCamera(y,e);var s=v.intersectObjects(n,!0);return s[0]?s[0]:!1}THREE.Object3D.call(this),t=void 0!==t?t:document,this.object=void 0,this.visible=!1,this.translationSnap=null,this.rotationSnap=null,this.space="world",this.size=1,this.axis=null;var h=this,c="translate",l=!1,u={translate:new AMTHREE.TransformGizmoTranslate,rotate:new AMTHREE.TransformGizmoRotate,scale:new AMTHREE.TransformGizmoScale};for(var d in u){var p=u[d];p.visible=d===c,this.add(p)}var f={type:"change"},m={type:"mouseDown"},E={type:"mouseUp",mode:c},g={type:"objectChange"},v=new THREE.Raycaster,y=new THREE.Vector2,T=new THREE.Vector3,w=new THREE.Vector3,b=new THREE.Vector3,M=new THREE.Vector3,R=new THREE.Vector3,x=1,H=new THREE.Matrix4,A=new THREE.Vector3,_=new THREE.Matrix4,j=new THREE.Vector3,k=new THREE.Quaternion,S=new THREE.Vector3(1,0,0),N=new THREE.Vector3(0,1,0),C=new THREE.Vector3(0,0,1),G=new THREE.Quaternion,O=new THREE.Quaternion,I=new THREE.Quaternion,P=new THREE.Quaternion,L=new THREE.Quaternion,z=new THREE.Vector3,D=new THREE.Vector3,F=new THREE.Matrix4,X=new THREE.Matrix4,Y=new THREE.Vector3,U=new THREE.Vector3,V=new THREE.Euler,B=new THREE.Matrix4,Z=new THREE.Vector3,q=new THREE.Euler;t.addEventListener("mousedown",n,!1),t.addEventListener("touchstart",n,!1),t.addEventListener("mousemove",i,!1),t.addEventListener("touchmove",i,!1),t.addEventListener("mousemove",a,!1),t.addEventListener("touchmove",a,!1),t.addEventListener("mouseup",o,!1),t.addEventListener("mouseout",o,!1),t.addEventListener("touchend",o,!1),t.addEventListener("touchcancel",o,!1),t.addEventListener("touchleave",o,!1),this.dispose=function(){t.removeEventListener("mousedown",n),t.removeEventListener("touchstart",n),t.removeEventListener("mousemove",i),t.removeEventListener("touchmove",i),t.removeEventListener("mousemove",a),t.removeEventListener("touchmove",a),t.removeEventListener("mouseup",o),t.removeEventListener("mouseout",o),t.removeEventListener("touchend",o),t.removeEventListener("touchcancel",o),t.removeEventListener("touchleave",o)},this.attach=function(e){this.object=e,this.visible=!0,this.update()},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.getMode=function(){return c},this.setMode=function(e){c=e?e:c,"scale"===c&&(h.space="local");for(var t in u)u[t].visible=t===c;this.update(),h.dispatchEvent(f)},this.setTranslationSnap=function(e){h.translationSnap=e},this.setRotationSnap=function(e){h.rotationSnap=e},this.setSize=function(e){h.size=e,this.update(),h.dispatchEvent(f)},this.setSpace=function(e){h.space=e,this.update(),h.dispatchEvent(f)},this.update=function(){void 0!==h.object&&(h.object.updateMatrixWorld(),U.setFromMatrixPosition(h.object.matrixWorld),V.setFromRotationMatrix(_.extractRotation(h.object.matrixWorld)),e.updateMatrixWorld(),Z.setFromMatrixPosition(e.matrixWorld),q.setFromRotationMatrix(_.extractRotation(e.matrixWorld)),x=U.distanceTo(Z)/6*h.size,this.position.copy(U),this.scale.set(x,x,x),A.copy(Z).sub(U).normalize(),"local"===h.space?u[c].update(V,A):"world"===h.space&&u[c].update(new THREE.Euler,A),u[c].highlight(h.axis))}},AMTHREE.TransformControls.prototype=Object.create(THREE.Object3D.prototype),AMTHREE.TransformControls.prototype.constructor=AMTHREE.TransformControls}();var AMTHREE=AMTHREE||{};AMTHREE.AnimatedTextureCall=function(e,t){e.traverse(function(e){e.material&&e.material.map&&e.material.map[t]&&e.material.map[t]()})},AMTHREE.PlayAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"play")},AMTHREE.StopAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"stop")},AMTHREE.PauseAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"pause")},AMTHREE.UpdateAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"update")},AMTHREE.WorldToCanvasPosition=function(e,t,i){var n=new THREE.Vector3;n.copy(e),n.project(t);var r=Math.round((n.x+1)*i.width/2),a=Math.round((-n.y+1)*i.height/2);return{x:r,y:a,z:n.z}},AMTHREE.GetFilename=function(e){return e.split("/").pop().split("\\").pop()},AMTHREE.IMAGE_PATH="images/",AMTHREE.MODEL_PATH="models/",AMTHREE.VIDEO_PATH="videos/",AMTHREE.SOUND_PATH="sounds/",AMTHREE.ASSET_PATH="assets/";var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Video=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url="string"==typeof t?t:void 0},AMTHREE.Video.prototype.toJSON=function(e){var t={uuid:this.uuid,url:AMTHREE.GetFilename(this.url)};return"object"==typeof e&&(e.videos||(e.videos={}),e.videos[t.uuid]=t),t}):AMTHREE.Video=function(){console.warn("Video.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.VideoTexture=function(e,t,i,n,r,a){THREE.Texture.call(this),this.uuid="string"==typeof t?t:THREE.Math.generateUUID(),this.minFilter=THREE.NearestMipMapNearestFilter,this.videoElement=document.createElement("video"),this.needsUpdate=!1,this.set(e,i,n,r,a)},AMTHREE.VideoTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.VideoTexture.prototype.constructor=AMTHREE.VideoTexture,AMTHREE.VideoTexture.prototype.play=function(){this.videoElement&&!this.playing&&this.video&&(this.paused||(this.videoElement.src=this.video.url),this.videoElement.setAttribute("crossorigin","anonymous"),this.videoElement.play(),this.image=this.videoElement,this.playing=!0)},AMTHREE.VideoTexture.prototype.update=function(){this.videoElement&&this.videoElement.readyState==this.videoElement.HAVE_ENOUGH_DATA&&(this.needsUpdate=!0)},AMTHREE.VideoTexture.prototype.pause=function(){this.videoElement&&!this.videoElement.paused&&(this.videoElement.pause(),this.playing=!1)},AMTHREE.VideoTexture.prototype.stop=function(){this.videoElement&&(this.pause(),this.videoElement.src="",this.image=void 0,this.needsUpdate=!0)},AMTHREE.VideoTexture.prototype.set=function(e,t,i,n,r){this.stop(),this.video=e,this.videoElement.width="number"==typeof t?t:void 0,this.videoElement.height="number"==typeof i?i:void 0,this.videoElement.autoplay="boolean"==typeof r?r:!1,this.videoElement.loop="boolean"==typeof n?n:!0,this.playing=!1,this.videoElement.autoplay&&this.play()},AMTHREE.VideoTexture.prototype.toJSON=function(e){var t={uuid:this.uuid,video:this.video.uuid,width:this.videoElement.width,height:this.videoElement.height,loop:this.videoElement.loop,autoplay:this.videoElement.autoplay};return this.video.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.VideoTexture=function(){console.warn("VideoTexture.js: THREE undefined")};var AM=AM||{};AM.Detection=function(){function e(e,t){var i=e*t;if(i>n.length)for(;--i>=0;)n[i]=new jsfeat.keypoint_t}var t={laplacian_threshold:30,eigen_threshold:25,detection_corners_max:500,border_size:15,fast_threshold:20},i=!1,n=[],r=0,a=new jsfeat.matrix_t(32,t.detection_corners_max,jsfeat.U8_t|jsfeat.C1_t);this.Detect=function(o){e(o.cols,o.rows),r=AM.DetectKeypointsYape06(o,n,t.detection_corners_max,t.laplacian_threshold,t.eigen_threshold,t.border_size),jsfeat.orb.describe(o,n,r,a),i&&console.log("Learn : "+r+" corners")},this.SetParameters=function(e){for(var i in e)"undefined"!=typeof t[i]&&(t[i]=e[i])},this.GetDescriptors=function(){return a},this.GetNumCorners=function(){return r},this.GetCorners=function(){return n}},AM.IcAngle=function(){function e(e,t){return e>=0?t>=0?e/(t+e):1-t/(-t+e):0>t?2-e/(-t-e):3+t/(t-e)}var t=new Int32Array([15,15,15,15,14,14,14,13,13,12,11,10,9,8,6,3,0]),i=Math.PI/2;return function(n,r,a){var o=15,s=0,h=0,c=n.data,l=n.cols,u=0,d=0,p=a*l+r|0,f=0,m=0,E=0,g=0;for(u=-o;o>=u;++u)h+=u*c[p+u];for(d=1;o>=d;++d){for(f=0,m=t[d],u=-m;m>=u;++u)E=c[p+u+d*l],g=c[p+u-d*l],f+=E-g,h+=u*(E+g);s+=d*f}e(s,h)*i}}(),AM.DetectKeypointsPostProc=function(){function e(e,t){return t.score<e.score}return function(t,i,n,r){n>r&&(jsfeat.math.qsort(i,0,n-1,e),n=r);for(var a=0;n>a;++a)i[a].angle=AM.IcAngle(t,i[a].x,i[a].y);return n}}(),AM.DetectKeypointsYape06=function(e,t,i,n,r,a){jsfeat.yape06.laplacian_threshold=n,jsfeat.yape06.min_eigen_value_threshold=r;var o=jsfeat.yape06.detect(e,t,a);return o=AM.DetectKeypointsPostProc(e,t,o,i)},AM.DetectKeypointsFast=function(e,t,i,n,r){jsfeat.fast_corners.set_threshold(n);var a=jsfeat.fast_corners.detect(e,t,r||3);return a=AM.DetectKeypointsPostProc(e,t,a,i)};var AM=AM||{};AM.ImageFilter=function(){var e,t={blur_size:3,blur:!0};this.Filter=function(i){var n=i.width,r=i.height;e?e.resize(n,r,jsfeat.U8_t|jsfeat.C1_t):e=new jsfeat.matrix_t(n,r,jsfeat.U8_t|jsfeat.C1_t),jsfeat.imgproc.grayscale(i.data,n,r,e),t.blur&&jsfeat.imgproc.gaussian_blur(e,e,t.blur_size)},this.GetFilteredImage=function(){return e},this.SetParameters=function(e){for(var i in e)"undefined"!=typeof t[i]&&(t[i]=e[i])}};var AM=AM||{};AM.MarkerTracker=function(){var e,t=new AM.Training,i={},n=new AM.ImageFilter,r=new AM.Detection,a=new AM.Matching,o=new AM.Pose,s=!1,h={match_min:8},c=!1,l=new AM.Profiler;l.add("filter"),l.add("detection"),l.add("matching"),l.add("pose"),this.ComputeImage=function(e){l.new_frame(),l.start("filter"),n.Filter(e),l.stop("filter"),l.start("detection"),r.Detect(n.GetFilteredImage()),l.stop("detection")},this.Match=function(){l.start("matching"),s=!1,e=void 0,a.SetScreenDescriptors(r.GetDescriptors());for(var t in i){var n=i[t];if(n.IsActive()){a.Match(n.GetDescriptorsLevels());var u=a.GetNumMatches();if(s=u>=h.match_min,c&&console.log("nbMatches : "+u),s){var d=o.Pose(a.GetMatches(),u,r.GetCorners(),n.GetCornersLevels());if(s=d>=h.match_min,c&&console.log(" goodMatches : "+d),s){e=n;break}}}}return l.stop("matching"),s},this.GetMatchUuid=function(){return e.GetUuid()},this.GetPose=function(){if(s){l.start("pose");var t=o.GetPoseCorners(e.GetWidth(),e.GetHeight());return l.stop("pose"),t}},this.AddMarker=function(e,n){t.Train(e);var r=new AM.TrainedImage(n);t.SetResultToTrainedImage(r),t.Empty(),i[n]=r},this.RemoveMarker=function(e){i[e]&&delete i[e]},this.ActiveMarker=function(e,t){i[e]&&i[e].Active(t)},this.ActiveAllMarkers=function(e){for(var t in i)i[t].Active(e)},this.ClearMarkers=function(){i={}},this.GetScreenCorners=function(){return r.GetCorners()},this.GetNumScreenCorners=function(){return r.GetNumCorners()},this.GetMatches=function(){return a.GetMatches()},this.GetMatchesMask=function(){return o.GetMatchesMask()},this.GetProfiler=function(){return l.GetProfiler()},this.GetTrainedCorners=function(){var t=i[e.GetUuid()];return t.GetCornersLevels()},this.Log=function(){console.log(l.log()+(s?"<br/>match found":""))},this.SetParameters=function(e){for(var i in e)"undefined"!=typeof h[i]&&(h[i]=e[i]);t.SetParameters(e),n.SetParameters(e),r.SetParameters(e),a.SetParameters(e)}};var AM=AM||{};AM.Matching=function(){function e(e){return e-=e>>1&1431655765,e=(858993459&e)+(e>>2&858993459),16843009*(e+(e>>4)&252645135)>>24}function t(e,t){var i=e.rows,n=e.buffer.i32,r=0,h=0;a=[];for(var c=0;i>c;++c){for(var l=256,u=256,d=-1,p=-1,f=0,m=t.length;m>f;++f)for(var E=t[f],g=E.rows,v=E.buffer.i32,y=0,T=0;g>T;++T){for(var w=0,b=0;8>b;++b)w+=s(n[r+b]^v[y+b]);l>w?(u=l,l=w,p=f,d=T):u>w&&(u=w),y+=8}if(l<o.match_threshold){for(;a.length<=h;)a.push(new AM.match_t);a[h].screen_idx=c,a[h].pattern_lev=p,a[h].pattern_idx=d,h++}r+=8}return a.length=h,h}var n,r,a=[],o={match_threshold:48};this.SetScreenDescriptors=function(e){n=e},this.Match=function(e){return r=t(n,e)};var s=(function(){var e=[0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8],t=255;return function(i){var n=e[i&t];return i>>=8,n+=e[i&t],i>>=8,n+=e[i&t],i>>=8,n+=e[i&t]}}(),function(){var t=[];for(i=0;i<65536;++i)t.push(e(i));var n=65535;return function(e){var i=t[e&n];return e>>=16,i+=t[e&n]}}());this.GetMatches=function(){return a},this.GetNumMatches=function(){return r},this.SetParameters=function(e){for(var t in e)"undefined"!=typeof o[t]&&(o[t]=e[t])}},AM.match_t=function(e,t,i,n){this.screen_idx=e||0,this.pattern_lev=t||0,this.pattern_idx=i||0,this.distance=n||0};var AM=AM||{};AM.Pose=function(){function e(e,t,i,n,r,a){var o,s=new jsfeat.motion_model.homography2d,h=4,c=3,l=new jsfeat.ransac_params_t(h,c,.5,.99),u=[],d=[];for(o=0;t>o;++o){var p=e[o],f=r[p.screen_idx],m=a[p.pattern_lev][p.pattern_idx];u[o]={x:m.x,y:m.y},d[o]={x:f.x,y:f.y}}var E=!1;E=jsfeat.motion_estimator.ransac(l,s,u,d,t,i,n,1e3);var g=0;if(E){for(o=0;t>o;++o)n.data[o]&&(u[g].x=u[o].x,u[g].y=u[o].y,d[g].x=d[o].x,d[g].y=d[o].y,g++);s.run(u,d,i,g)}else jsfeat.matmath.identity_3x3(i,1);return g}function t(e,t,i){for(var n=[{x:0,y:0},{x:t,y:0},{x:t,y:i},{x:0,y:i}],r=0,a=0,o=0,s=0;4>s;++s)a=e[0]*n[s].x+e[1]*n[s].y+e[2],o=e[3]*n[s].x+e[4]*n[s].y+e[5],r=e[6]*n[s].x+e[7]*n[s].y+e[8],n[s].x=a/r,n[s].y=o/r;return n}var i=0,n=new jsfeat.matrix_t(3,3,jsfeat.F32C1_t),r=new jsfeat.matrix_t(500,1,jsfeat.U8C1_t);this.Pose=function(t,a,o,s){return i=e(t,a,n,r,o,s)},this.GetGoodCount=function(){return i},this.GetPoseCorners=function(e,i){return t(n.data,e,i)},this.GetMatchesMask=function(){return r}},AM.PosePosit=function(){this.posit=new POS.Posit(10,1),this.pose=void 0},AM.PosePosit.prototype.Set=function(e,t,i,n){t=t||35;for(var r=[],a=0;a<e.length;++a){var o=e[a].x-i/2,s=n/2-e[a].y;r.push({x:o,y:s})}this.pose=this.posit.pose(r)},AM.PosePosit.prototype.SetFocalLength=function(e){this.posit.focalLength=e},AM.PoseThree=function(){this.position=new THREE.Vector3,this.rotation=new THREE.Euler,this.quaternion=new THREE.Quaternion,this.scale=new THREE.Vector3},AM.PoseThree.prototype.Set=function(e,t){t=t||35;var i=e.bestRotation,n=e.bestTranslation;this.scale.x=t,this.scale.y=t,this.scale.z=t,this.rotation.x=-Math.asin(-i[1][2]),this.rotation.y=-Math.atan2(i[0][2],i[2][2]),this.rotation.z=Math.atan2(i[1][0],i[1][1]),this.position.x=n[0],this.position.y=n[1],this.position.z=-n[2],this.quaternion.setFromEuler(this.rotation)};var AM=AM||{};AM.TrainedImage=function(e){var t=!0,i=[],n=[],r=0,a=0,o=e,s=!0;this.GetCorners=function(e){return i[e]},this.GetDescriptors=function(e){return n[e]},this.GetLevelNbr=function(){return Math.min(n.length,i.length)},this.GetCornersLevels=function(){return i},this.GetDescriptorsLevels=function(){return n},this.GetWidth=function(){return r},this.GetHeight=function(){return a},this.Set=function(e,o,s,h){t=!1,i=e,n=o,r=s,a=h},this.IsEmpty=function(){return t},this.Empty=function(){t=!0,i=[],n=[]},this.SetUuid=function(e){o=e},this.GetUuid=function(){return o},this.Active=function(e){s=e===!0},this.IsActive=function(){return s}};var AM=AM||{};AM.Training=function(){function e(e,n,o,s){var h=a[o],l=r[o];0!==o?(t(e,n,s),jsfeat.imgproc.gaussian_blur(n,n,c.blur_size)):jsfeat.imgproc.gaussian_blur(e,n,c.blur_size);var u=AM.DetectKeypointsYape06(n,h,c.training_corners_max,c.laplacian_threshold,c.eigen_threshold);if(h.length=u,jsfeat.orb.describe(n,h,u,l),0!==o)for(i=0;i<u;++i)h[i].x*=1/s,h[i].y*=1/s;console.log("train "+n.cols+"x"+n.rows+" points: "+u)}function t(e,t,i){if(1>i){var n=Math.round(e.cols*i),r=Math.round(e.rows*i);jsfeat.imgproc.resample(e,t,n,r)}else t.resize(e.cols,e.rows),e.copy_to(t)}function n(e,t){for(var i=0;i<c.num_train_levels;++i){a[i]=[];for(var n=a[i],o=e*t>>i;--o>=0;)n[o]=new jsfeat.keypoint_t(0,0,0,0,-1);r[i]=new jsfeat.matrix_t(32,c.training_corners_max,jsfeat.U8_t|jsfeat.C1_t)}}var r,a,o,s=0,h=0,c={num_train_levels:3,blur_size:3,image_size_max:512,training_corners_max:200,laplacian_threshold:30,eigen_threshold:25},l=Math.sqrt(2),u=[];this.Train=function(i){var o=0,u=1;r=[],a=[];var d=new jsfeat.matrix_t(i.width,i.height,jsfeat.U8_t|jsfeat.C1_t);jsfeat.imgproc.grayscale(i.data,i.width,i.height,d,jsfeat.COLOR_RGBA2GRAY);var p=Math.min(c.image_size_max/i.width,c.image_size_max/i.height),f=new jsfeat.matrix_t(i.width*p,i.height*p,jsfeat.U8_t|jsfeat.C1_t);s=f.cols,h=f.rows,t(d,f,p),n(f.cols,f.rows);var m=new jsfeat.matrix_t(f.cols,f.rows,jsfeat.U8_t|jsfeat.C1_t);for(e(f,m,0,u),o=1;o<c.num_train_levels;++o)u/=l,e(f,m,o,u)},cloneImage=function(e){var t=new jsfeat.matrix_t(e.cols,e.rows,jsfeat.U8_t|jsfeat.C1_t);return e.copy_to(t),t},this.TrainFull=function(i){var d=0,p=1;r=[],a=[],u=[];var f=new jsfeat.matrix_t(i.width,i.height,jsfeat.U8_t|jsfeat.C1_t);jsfeat.imgproc.grayscale(i.data,i.width,i.height,f,jsfeat.COLOR_RGBA2GRAY);var m=Math.min(c.image_size_max/i.width,c.image_size_max/i.height),E=new jsfeat.matrix_t(i.width*m,i.height*m,jsfeat.U8_t|jsfeat.C1_t);s=E.cols,h=E.rows,t(f,E,m),n(E.cols,E.rows);var g=new jsfeat.matrix_t(E.cols,E.rows,jsfeat.U8_t|jsfeat.C1_t);for(e(E,g,0,p),o=E,u[0]=cloneImage(g),d=1;d<c.num_train_levels;++d)p/=l,e(E,g,d,p),u[d]=cloneImage(g)},this.getGrayData=function(){return o},this.getBluredImages=function(){return u},this.SetResultToTrainedImage=function(e){e.Set(a,r,s,h)},this.IsEmpty=function(){return!r||!a},this.Empty=function(){r=void 0,a=void 0,u=void 0},this.SetParameters=function(e){for(var t in e)"undefined"!=typeof c[t]&&(c[t]=e[t])},this.GetScaleIncrement=function(){return l}};
=======
<<<<<<< ed2bb74fb23a50e7fc977a52c75f613d2d2de4da
var compatibility=function(){var e=0,t=!0,i=window.URL||window.webkitURL||window.mozURL||window.msURL,n=function(t,i){var n=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,i){var n=(new Date).getTime(),r=Math.max(0,16-(n-e)),a=window.setTimeout(function(){t(n+r)},r);return e=n+r,a};return n.call(window,t,i)},r=function(e){var t=window.cancelAnimationFrame||function(e){clearTimeout(e)};return t.call(window,e)},a=function(e,t,i){var n=window.navigator.getUserMedia||window.navigator.mozGetUserMedia||window.navigator.webkitGetUserMedia||window.navigator.msGetUserMedia||function(e,t,i){i()};return n.call(window.navigator,e,t,i)},o=function(){var e=new ArrayBuffer(8),i=new Uint32Array(e);return i[0]=4278190080,t=!0,255===e[0]&&(t=!1),t};return{URL:i,requestAnimationFrame:n,cancelAnimationFrame:r,getUserMedia:a,detectEndian:o,isLittleEndian:t}}();!function(){AM=AM||{};var e=function(){this._listeners={}};e.prototype.AddListener=function(e,t){return"string"==typeof e&&("undefined"==typeof this._listeners[e]&&(this._listeners[e]=[]),-1==this._listeners[e].indexOf(t))?(this._listeners[e].push(t),!0):!1},e.prototype.RemoveListener=function(e,t){if("string"==typeof e){var i=this._listeners[e];if("undefined"!=typeof i){var n=i.indexOf(t);if(-1!=n)return 1!=i.length?i.splice(n,1):delete this._listeners[e],!0}}return!1},e.prototype.Fire=function(e,t){if("string"==typeof e){var i=this._listeners[e];if("undefined"!=typeof i){for(var n=0,r=i.length;r>n;++n)"function"==typeof i[n]&&i[n].apply(this,t);return!0}}return!1},AM.EventManager=e}(),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL;var AM=AM||{};!function(){function e(){function e(){return h||(a&&a.Dispose(),h=!0,a=new t(s),o=a.Load().then(function(e){r=e})),o}function i(){r&&(r.getTracks()[0].stop(),r=void 0),a&&(a.Dispose(),a=void 0),o=Promise.resolve(),h=!1}function n(){return h}var r,a,o,s=document.createElement("video"),h=!1;s.setAttribute("autoplay",!0),s.style.position="absolute",s.style.top="0px",s.style.left="0px",s.style.width="100%",s.style.height="auto",this.domElement=s,i(),this.Start=e,this.Stop=i,this.IsActive=n}function t(e){function t(e){return new Promise(function(t,i){!function n(){h&&i("loader interrupted"),e.readyState===e.HAVE_ENOUGH_DATA?t():window.requestAnimationFrame(n)}()})}function i(i){var n=new Promise(function(e,t){h&&t("loader interrupted");for(var n={video:!0,audio:!1},r=0;r!=i.length;++r){var a=i[r];"video"==a.kind&&"environment"==a.facing&&(n.video={optional:[{sourceId:a.id}]})}navigator.getUserMedia(n,e,t)});return n=n.then(function(i){return e.src=window.URL.createObjectURL(i),t(e).then(function(){return i})})}function n(e){return new Promise(function(e,t){return h&&t("loader interrupted"),MediaStreamTrack.getSources(e)})}function r(e){return Promise.resolve(function(){return h&&reject("loader interrupted"),navigator.mediaDevices.enumerateDevices()})}function a(){return s=!0,new Promise(function(e,t){h&&t("loader interrupted");var a=n();a=a.then(function(t){i(t).then(e)}),a["catch"](function(){r().then(function(t){i(t).then(e)})["catch"](t)})})}function o(){h=!0}var s=!1,h=!1;this.Load=a,this.Dispose=o}AM.FrontCamGrabbing=e}();var AM=AM||{};getGradientGreenRedColor=function(e,t){function i(e){var t=parseInt(e).toString(16);return t.length<2?"0"+t:t}var n=255*e/t,r=255*(t-e)/t;return"#"+i(n)+i(r)+"00"},AM.ImageDebugger=function(){var e,t,i,n,r,a,o,s,h,c,u,l,d,p,f,m,g,v,E,y,T=new AM.Training,b=44,w=[],M=[],A=!1,R=!0;this.DrawCorners=function(t){var i,n;if(A&&t&&(a=t.screen_corners,h=t.profiles,c=t.image_data,a.length)){for(e.fillStyle="red",i=0;i<a.length;++i)n=a[i],e.beginPath(),e.arc(n.x*l+d,n.y*l+p,3,0,2*Math.PI),e.fill();for(e.putImageData(c,m-c.width,b),i=0;i<a.length;++i)n=a[i],e.beginPath(),e.arc(n.x+m-c.width,n.y+b,3,0,2*Math.PI),e.fill();e.font="30px Arial",e.fillStyle="red",e.textAlign="left";var r="FPS: "+h.fps.toFixed(2)+"  ";for(i=0;i<h.timers.length;++i){var o=h.timers[i];r+=o[0]+": "+o[1].run_time+"ms  "}e.fillText(r,10,f-5-b)}},this.DebugMatching=function(e,t){A&&e&&t&&(n=e.corners,r=e.trained_corners,o=e.matches,s=e.matches_mask,i=t,e.uuid!=E&&(E=e.uuid,AM.LoadImage(t).then(function(e){var t=AM.ImageToImageData(e,!1);y=t,correctTrainingImageOffsets(),displayTrainingImages(!0),drawContour(),drawMatches(),R&&(displayTrainingImages(!1),drawTrainedCorners())})),y&&(correctTrainingImageOffsets(),displayTrainingImages(!0),drawContour(),drawMatches(),R&&(displayTrainingImages(!1),drawTrainedCorners())))},correctTrainingImageOffsets=function(){var e;y.width>y.height?(e=y.width-y.height,g=0,v=-Math.round(e/2)):(e=y.height-y.width,g=-Math.round(e/2),v=0)},drawContour=function(){e.strokeStyle="green",e.lineWidth=5,e.beginPath(),e.moveTo(n[0].x*l+d,n[0].y*l+p),e.lineTo(n[1].x*l+d,n[1].y*l+p),e.lineTo(n[2].x*l+d,n[2].y*l+p),e.lineTo(n[3].x*l+d,n[3].y*l+p),e.lineTo(n[0].x*l+d,n[0].y*l+p),e.stroke()},drawMatches=function(t){"undefined"==typeof t&&(t=!1),e.lineWidth=2;for(var i=0;i<o.length;++i){var n=o[i],h=s.data[i],c=r[n.pattern_lev],u=c[n.pattern_idx],f=a[n.screen_idx];h?(e.fillStyle="blue",e.strokeStyle="blue"):(e.fillStyle="red",e.strokeStyle="red");var m=u.x+g,E=u.y+v;t||(m=m*M[n.pattern_lev]+w[n.pattern_lev],E*=M[n.pattern_lev]),e.beginPath(),e.arc(m,E+b,3,0,2*Math.PI),e.fill(),e.beginPath(),e.moveTo(m,E+b),e.lineTo(f.x*l+d,f.y*l+p),e.stroke(),e.beginPath(),e.arc(f.x*l+d,f.y*l+p,3,0,2*Math.PI),e.fill()}},jsFeat2ImageData=function(t){for(var i=e.createImageData(t.cols,t.rows),n=t.data.length,r=4*n+3;n--;)i.data[r-=4]=255,i.data[r-1]=i.data[r-2]=i.data[r-3]=t.data[n];return i},displayColor=function(t,i){e.putImageData(y,t,i)},displayTrainingImages=function(t){T.Empty(),T.TrainFull(y);var i=T.getBluredImages(),n=0;w[0]=0,M[0]=1;for(var r=0;r<i.length;++r)originy=b,t||(originy=f-35-b-i[r].rows),e.putImageData(jsFeat2ImageData(i[r]),n,originy),n+=i[r].cols,w[r+1]=w[r]+i[r].cols,M[r+1]=M[r]/T.GetScaleIncrement()},drawTrainedCorners=function(t){"undefined"==typeof t&&(t=50);var i=T.getBluredImages(),n=new AM.TrainedImage(u);T.SetResultToTrainedImage(n);for(var r=0;r<n.GetLevelNbr();++r)for(var a=n.GetCorners(r),o=(n.GetDescriptors(r),f-35-b-i[r].rows),s=0;t>s;++s){var h=a[s];e.fillStyle=getGradientGreenRedColor(t-s,t);var c=h.x+g,l=h.y+v;c=c*M[r]+w[r],l*=M[r],e.beginPath(),e.arc(c,l+o,3,0,2*Math.PI),e.fill()}},this.UpdateSize=function(e,i){f=e.height,m=e.width;var n=f,r=t.videoWidth/t.videoHeight,a=m/n;if(a>r){var o=Math.round(n*r);l=o/i,d=Math.round(.5*(m-o)),p=0}else{var s=m/r;l=m/i,d=0,p=Math.round(.5*(n-s))}},this.SetData=function(i,n,r){e=i,t=n,A=r||!1},this.SetDebug=function(e){A=e||!1}};var AM=AM||{};!function(){AM.LoadImage=function(e,t){return new Promise(function(i,n){t=t||new Image,t.src=null,t.onload=function(){i(t)},t.onerror=function(e){n(e)},t.src=e})},AM.ImageToImageData=function(){var e,t;return"undefined"!=typeof document&&(e=document.createElement("canvas"),t=e.getContext("2d")),function(i,n){if(n){var r=Math.max(i.width,i.height),a=(r-i.width)/2,o=(r-i.height)/2;e.width=r,e.height=r,t.clearRect(0,0,e.width,e.height),t.drawImage(i,a,o)}else e.width=i.width,e.height=i.height,t.clearRect(0,0,e.width,e.height),t.drawImage(i,0,0,e.width,e.height);return t.getImageData(0,0,e.width,e.height)}}()}();var AM=AM||{};AM.JsonLoader=function(){function e(e,t){u=!1,o=void 0,a=void 0,r=void 0,h=void 0,s=void 0,c.progress=0,e&&e(t)}function t(){try{c.json=JSON.parse(h.responseText),e(r)}catch(t){c.json={},e(a,"failed to parse file: "+s)}}function i(t){var i="JsonLoader failed to open file: "+s;console.log(i),e(a,i)}function n(e){c.progress=e.loaded/e.total*100,o&&o()}var r,a,o,s,h,c=this,u=!1;this.json={},this.progress=0,this.IsLoading=function(){return u},this.Load=function(e,c,l,d){u||(u=!0,r=c,a=l,o=d,s=e,h=new XMLHttpRequest,h.onprogress=n,h.open("GET",e,!0),h.onload=t,h.onerror=i,h.send(null))}},AM.LoadJson=function(e){return new Promise(function(t,i){var n=new AM.JsonLoader;n.Load(e,function(){t(n.json)},i)})};var AM=AM||{};AM.LoadingManager=function(){function e(e){for(var t=0,i=e.length;i>t;++t)e[t]()}var t=[],i=[],n=0;this.Start=function(t){t=t||1,n+=t,e(i)},this.End=function(r){r=r||1,n>0&&(n-=r,e(i)),0>=n&&(n=0,e(t),t.length=0,i.length=0)},this.OnEnd=function(e){n>0?t.push(e):e()},this.OnProgress=function(e){n>0?i.push(e):e()},this.IsLoading=function(){return n>0},this.GetRemaining=function(){return n}};var AM=AM||{};!function(){var e=function(){function e(){this.start_time=0,this.stop_time=0,this.run_time=0,this.running=!1}return e.prototype.start=function(){this.start_time=(new Date).getTime(),this.running=!0},e.prototype.stop=function(){this.stop_time=(new Date).getTime(),this.run_time=this.stop_time-this.start_time,this.running=!1},e.prototype.get_runtime=function(){return this.run_time},e.prototype.reset=function(){this.run_time=0},e}(),t=function(){function e(e){this.arr=new Int32Array(e),this.begin=0,this.end=-1,this.num_el=0,this.arr_size=e}return e.prototype.push_back=function(e){this.num_el<this.arr_size?(this.end++,this.arr[this.end]=e,this.num_el++):(this.end=(this.end+1)%this.arr_size,this.begin=(this.begin+1)%this.arr_size,this.arr[this.end]=e)},e.prototype.get=function(e){return this.arr[(this.begin+e)%this.arr_size]},e.prototype.size=function(){return this.num_el},e}(),i=function(){function i(){this.fps=0,this.timers=[],this.frame_timer=new e}var n=0,r=new t(20);return i.prototype.add=function(t){this.timers.push([t,new e])},i.prototype.new_frame=function(){++n;var e=0,t=0|this.timers.length;for(e=0;t>e;++e){var i=this.timers[e][1];i.reset()}if(n>=1){this.frame_timer.stop(),r.push_back(this.frame_timer.get_runtime());var a=r.size(),o=0;for(e=0;a>e;++e)o+=r.get(e);this.fps=a/o*1e3,this.frame_timer.start()}},i.prototype.find_task=function(e){var t=0|this.timers.length,i=0;for(i=0;t>i;++i){var n=this.timers[i];if(n[0]===e)return n}return null},i.prototype.start=function(e){var t=this.find_task(e);t[1].start()},i.prototype.stop=function(e){var t=this.find_task(e);t[1].stop()},i.prototype.log=function(){var e=0|this.timers.length,t=0,i="<strong>FPS: "+this.fps.toFixed(2)+"</strong>";for(t=0;e>t;++t){var n=this.timers[t];i+="<br/>"+n[0]+": "+n[1].get_runtime()+"ms"}return i},i.prototype.log2=function(){var e=0|this.timers.length,t=0,i="FPS: "+this.fps.toFixed(2)+"  ";for(t=0;e>t;++t){var n=this.timers[t];i+=n[0]+": "+n[1].get_runtime()+"ms  "}return i},i.prototype.GetProfiler=function(){return{fps:this.fps,timers:this.timers}},i}();AM.Profiler=i}();var AM=AM||{};AM.DeviceLockScreenOrientation=function(){function e(){window.cordova?(t(),o=!0):s=!1}function t(){for(var e=0,t=h.length;t>e;++e)h[e]();h.length=0}function i(e){s&&(o?e():h.push(e))}function n(){screen.lockOrientation("landscape-primary")}function r(){screen.lockOrientation("portrait-primary")}function a(){screen.unlockOrientation()}var o=!1,s=!0,h=[];document.addEventListener("deviceready",e,!1),this.LockLandscape=function(){i(n)},this.LockPortrait=function(){i(r)},this.Unlock=function(){i(a)}};var AM=AM||{};!function(){function e(e){return e%=360,180>e?e:e-360}AM.DeviceOrientationControl=function(e){var t=this;this.object=e,this.object.rotation.reorder("YXZ"),this.alpha=0,this.beta=0,this.gamma=0;var i=!1,n=!1,r=0,a=new this.CoefMethod,o=function(e){i?(a.OnOrientationChange(e),n=!0):i=!0},s=function(){r=window.orientation||0};this.Connect=function(){s(),window.addEventListener("orientationchange",s,!1),window.addEventListener("deviceorientation",o,!1)},this.Disconnect=function(){window.removeEventListener("orientationchange",s,!1),window.removeEventListener("deviceorientation",o,!1),n=!1,i=!1},this.Update=function(){var e=function(){var e=new THREE.Vector3(0,0,1),t=new THREE.Euler,i=new THREE.Quaternion,n=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));return function(r,a,o,s,h){t.set(o,a,-s,"YXZ"),r.setFromEuler(t),r.multiply(n),r.multiply(i.setFromAxisAngle(e,-h))}}();if(n){var i=r?THREE.Math.degToRad(r):0;a.Update(),t.alpha=a.alpha,t.beta=a.beta,t.gamma=a.gamma,e(t.object.quaternion,a.alpha,a.beta,a.gamma,i)}}},AM.DeviceOrientationControl.prototype.PowerMethod=function(){function e(e,i,n){var r=t(i-e),a=Math.sign(r),o=Math.abs(r/Math.PI);return o=Math.pow(o,n),t(e+o*Math.PI*a)}var i,n=this,r=2;this.alpha=0,this.beta=0,this.gamma=0,this.OnOrientationChange=function(e){i=e},this.Update=function(){n.alpha=e(n.alpha,THREE.Math.degToRad(i.alpha),r),n.beta=e(n.beta,THREE.Math.degToRad(i.beta),r),n.gamma=e(n.gamma,THREE.Math.degToRad(i.gamma),r)}},AM.DeviceOrientationControl.prototype.CoefMethod=function(){function e(e,i,n){return e+t(i-e)*n}var i=this;this.coef=.2,this.alpha=0,this.beta=0,this.gamma=0;var n=[];this.OnOrientationChange=function(e){n.push(e)},this.Update=function(){if(n.length>0){for(var r,a=i.alpha,o=i.beta,s=i.gamma,h=0,c=n.length;c>h;++h)r=n[h],a=t(e(a,THREE.Math.degToRad(r.alpha),i.coef)),o=t(e(o,THREE.Math.degToRad(r.beta),i.coef)),s=t(e(s,THREE.Math.degToRad(r.gamma),i.coef));i.alpha=a,i.beta=o,i.gamma=s,n.length=0}}},AM.DeviceOrientationControl.prototype.AverageMethod=function(){var t=this;this.history=[],this.history_max=10,this.alpha=0,this.beta=0,this.gamma=0,this.OnOrientationChange=function(e){t.history.length>t.history_max&&t.history.shift(),t.history.push(e)},this.Update=function(i,n,r){if(0!==t.history.length){for(var a=0,o=t.history.length;o>a;a++)i+=e(t.history[a].alpha),n+=e(t.history[a].beta),r+=e(t.history[a].gamma);i/=t.history.length,n/=t.history.length,r/=t.history.length,t.alpha=THREE.Math.degToRad(i),t.beta=THREE.Math.degToRad(n),t.gamma=THREE.Math.degToRad(r)}}};var t=function(){var e=Math.PI,t=2*Math.PI;return function(i){if(i>e){do i-=t;while(i>e)}else if(-e>i)do i+=t;while(-e>i);return i}}()}();var AM=AM||{};AM.GeographicCoordinatesConverter=function(e,t){var i=this,n={latitude:0,longitude:0};this.GetLocalCoordinates=function(e,t){var r=(n.latitude+e)/2,a={x:0,y:0};return a.x=(t-n.longitude)*i.EARTH_RADIUS*Math.cos(r),a.y=(e-n.latitude)*-i.EARTH_RADIUS,a},this.GetLocalCoordinatesFromDegres=function(e,t){return i.GetLocalCoordinates(THREE.Math.degToRad(e),THREE.Math.degToRad(t))},this.SetOrigin=function(e,t){n.latitude=e,n.longitude=t},this.SetOriginFromDegres=function(e,t){n.latitude=THREE.Math.degToRad(e),n.longitude=THREE.Math.degToRad(t)},this.GetOrigin=function(){return n},this.SetOrigin(e||0,t||0)},AM.GeographicCoordinatesConverter.prototype.EARTH_RADIUS=6371e3;var AM=AM||{};AM.GeolocationControl=function(e,t){function i(e){o.copy(h.GetLocalCoordinatesFromDegres(e.coords.latitude,e.coords.longitude)),a=!0}function n(e){console.warn("geolocation failed: "+e.message),window.setTimeout(r.Connect,r.retry_connection_ms)}var r=this,a=!1,o=new THREE.Vector3,s=0,h=t,c=.1;this.object=e,this.interpolation_coefficient=.02,this.retry_connection_ms=1e3,this.Connect=function(){s=navigator.geolocation.watchPosition(i,n)},this.Disconnect=function(){navigator.geolocation.clearWatch(s),a=!1},this.Update=function(){if(a){var e=o.x-r.object.position.x,t=o.z-r.object.position.z,i=e*e+t*t;c*c>i?a=!1:(e*=r.interpolation_coefficient,t*=r.interpolation_coefficient,r.object.position.x+=e,r.object.position.z+=t)}}};var AMTHREE=AMTHREE||{};AMTHREE.ColladaLoader=function(){function e(e,i,n,r,a){var o=0;if(document.implementation&&document.implementation.createDocument){var s=new XMLHttpRequest;s.onreadystatechange=function(){4===s.readyState?0!==s.status&&200!==s.status||(s.response?(De=n,t(s.response,void 0,e,i)):a?a():console.error("ColladaLoader: Empty or non-existing file ("+e+")")):3===s.readyState&&r&&(0===o&&(o=s.getResponseHeader("Content-Length")),r({total:o,loaded:s.responseText.length}))},s.open("GET",e,!0),s.send(null)}else alert("Don't know how to parse XML!")}function t(e,t,i,h){if(Oe=h,Le=(new DOMParser).parseFromString(e,"text/xml"),t=t||De,void 0!==i){var c=i.split("/");c.pop(),Ce=(c.length<1?".":c.join("/"))+"/"}n(),Te(),Fe=r("library_images image",x,"image"),Be=r("library_materials material",X,"material"),Xe=r("library_effects effect",K,"effect"),ze=r("library_geometries geometry",I,"geometry"),Ye=r("library_cameras camera",ne,"camera"),Je=r("library_lights light",ae,"light"),Ve=r("library_controllers controller",H,"controller"),qe=r("library_animations animation",$,"animation"),Ne=r("library_visual_scenes visual_scene",j,"visual_scene"),Se=r("library_kinematics_models kinematics_model",se,"kinematics_model"),Ge=[],Ie=[],He=a(),Pe=new THREE.Group;for(var u=0;u<He.nodes.length;u++)Pe.add(v(He.nodes[u]));Pe.scale.multiplyScalar(Ke),s(),_e=o(),g();var l={scene:Pe,morphs:Ge,skins:Ie,animations:ke,kinematics:je,dae:{images:Fe,materials:Be,cameras:Ye,lights:Je,effects:Xe,geometries:ze,controllers:Ve,animations:qe,visualScenes:Ne,visualScene:He,scene:He,kinematicsModels:Se,kinematicsModel:_e}};return t&&t(l),l}function i(e){Ze=e}function n(){var e=Le.querySelectorAll("asset"),t=e[0];if(t&&t.childNodes)for(var i=0;i<t.childNodes.length;i++){var n=t.childNodes[i];switch(n.nodeName){case"unit":var r=n.getAttribute("meter");r&&(Ke=parseFloat(r));break;case"up_axis":Qe=n.textContent.charAt(0)}}}function r(e,t,i){for(var n=Le.querySelectorAll(e),r={},a=0,o=n.length,s=0;o>s;s++){var h=n[s],c=(new t).parse(h);c.id&&0!==c.id.length||(c.id=i+a++),r[c.id]=c}return r}function a(){var e=Le.querySelectorAll("scene instance_visual_scene")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return Ne[t.length>0?t:"visual_scene0"]}return null}function o(){var e=Le.querySelectorAll("instance_kinematics_model")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return Se[t.length>0?t:"kinematics_model0"]}return null}function s(){ke=[],h(Pe)}function h(e){var t,i,n=He.getChildById(e.colladaId,!0),r=null;if(n&&n.keys)for(r={fps:60,hierarchy:[{node:n,keys:n.keys,sids:n.sids}],node:e,name:"animation_"+e.name,length:0},ke.push(r),t=0,i=n.keys.length;i>t;t++)r.length=Math.max(r.length,n.keys[t].time);else r={hierarchy:[{keys:[],sids:[]}]};for(t=0,i=e.children.length;i>t;t++)for(var a=h(e.children[t]),o=0,s=a.hierarchy.length;s>o;o++)r.hierarchy.push({keys:[],sids:[]});return r}function c(){var e,t=1e6,i=-t,n=0;for(var r in qe){var a=qe[r];e=e||a.id;for(var o=0;o<a.sampler.length;o++){var s=a.sampler[o];s.create(),t=Math.min(t,s.startTime),i=Math.max(i,s.endTime),n=Math.max(n,s.input.length)}}return{start:t,end:i,frames:n,ID:e}}function u(e,t){var i=t instanceof C?Ve[t.url]:t;if(!i||!i.morph)return void console.log("could not find morph controller!");for(var n=i.morph,r=0;r<n.targets.length;r++){var a=n.targets[r],o=ze[a];if(o.mesh&&o.mesh.primitives&&o.mesh.primitives.length){var s=o.mesh.primitives[0].geometry;s.vertices.length===e.vertices.length&&e.morphTargets.push({name:"target_1",vertices:s.vertices})}}e.morphTargets.push({name:"target_Z",vertices:e.vertices})}function l(e,t,i,n){if(e.world=e.world||new THREE.Matrix4,e.localworld=e.localworld||new THREE.Matrix4,e.world.copy(e.matrix),e.localworld.copy(e.matrix),e.channels&&e.channels.length){var r=e.channels[0],a=r.sampler.output[i];a instanceof THREE.Matrix4&&(e.world.copy(a),e.localworld.copy(a),0===i&&e.matrix.copy(a))}n&&e.world.multiplyMatrices(n,e.world),t.push(e);for(var o=0;o<e.nodes.length;o++)l(e.nodes[o],t,i,e.world)}function d(e,t){for(var i,n=0;n<e.length;n++){var r=e[n],a=-1;if("JOINT"==r.type){for(i=0;i<t.joints.length;i++)if(r.sid===t.joints[i]){a=i;break}if(a>=0){var o=t.invBindMatrices[a];for(r.invBindMatrix=o,r.skinningMatrix=new THREE.Matrix4,r.skinningMatrix.multiplyMatrices(r.world,o),r.animatrix=new THREE.Matrix4,r.animatrix.copy(r.localworld),r.weights=[],i=0;i<t.weights.length;i++)for(var s=0;s<t.weights[i].length;s++){var h=t.weights[i][s];h.joint===a&&r.weights.push(h)}}else console.warn("ColladaLoader: Could not find joint '"+r.sid+"'."),r.skinningMatrix=new THREE.Matrix4,r.weights=[]}}}function p(e){var t=[],i=function(e,t,n){var r={};r.name=t.sid,r.parent=e,r.matrix=t.matrix;var a=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];r.matrix.decompose(a[0],a[1],a[2]),r.pos=[a[0].x,a[0].y,a[0].z],r.scl=[a[2].x,a[2].y,a[2].z],r.rotq=[a[1].x,a[1].y,a[1].z,a[1].w],n.push(r);for(var o in t.nodes)i(t.sid,t.nodes[o],n)};return i(-1,e,t),t}function f(e,t,i){var n=[];l(t,n,-1),d(n,i.skin);var r,a=new THREE.Vector3,o=[];for(r=0;r<e.vertices.length;r++)o.push(new THREE.Vector3);for(r=0;r<n.length;r++)if("JOINT"==n[r].type)for(var s=0;s<n[r].weights.length;s++){var h=n[r].weights[s],c=h.index,u=h.weight,p=e.vertices[c],f=o[c];a.x=p.x,a.y=p.y,a.z=p.z,a.applyMatrix4(n[r].skinningMatrix),f.x+=a.x*u,f.y+=a.y*u,f.z+=a.z*u}for(r=0;r<e.vertices.length;r++)e.vertices[r]=o[r]}function m(e,t,i){var n,r,a=Ve[t.url];if(i=void 0!==i?i:40,!a||!a.skin)return void console.log("ColladaLoader: Could not find skin controller.");if(!t.skeleton||!t.skeleton.length)return void console.log("ColladaLoader: Could not find the skeleton for the skin. ");var o=c(),s=He.getChildById(t.skeleton[0],!0)||He.getChildBySid(t.skeleton[0],!0),h=p(s),u=a.skin.joints,m=[];for(n=0;n<u.length;n++)for(r=0;r<h.length;r++)h[r].name===u[n]&&(m[n]=h[r]);for(n=0;n<m.length;n++)for(r=0;r<m.length;r++)m[n].parent===m[r].name&&(m[n].parent=r);var g;new THREE.Vector3;for(n=0;n<e.vertices.length;n++)e.vertices[n].applyMatrix4(a.skin.bindShapeMatrix);var v=[],E=[],y=a.skin.weights;for(n=0;n<y.length;n++){var T=new THREE.Vector4(y[n][0]?y[n][0].joint:0,y[n][1]?y[n][1].joint:0,y[n][2]?y[n][2].joint:0,y[n][3]?y[n][3].joint:0);g=new THREE.Vector4(y[n][0]?y[n][0].weight:0,y[n][1]?y[n][1].weight:0,y[n][2]?y[n][2].weight:0,y[n][3]?y[n][3].weight:0),v.push(T),E.push(g)}e.skinIndices=v,e.skinWeights=E,e.bones=m;var b={name:o.ID,fps:30,length:o.frames/30,hierarchy:[]};for(r=0;r<m.length;r++)b.hierarchy.push({parent:m[r].parent,name:m[r].name,keys:[]});for(console.log("ColladaLoader:",o.ID+" has "+m.length+" bones."),f(e,s,a),i=0;i<o.frames;i++){var w=[];for(l(s,w,i),d(w,a.skin),n=0;n<w.length;n++)for(r=0;r<b.hierarchy.length;r++)if(b.hierarchy[r].name===w[n].sid){var M={};M.time=i/30,M.matrix=w[n].animatrix,0===i&&(w[n].matrix=M.matrix);var A=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];M.matrix.decompose(A[0],A[1],A[2]),M.pos=[A[0].x,A[0].y,A[0].z],M.scl=[A[2].x,A[2].y,A[2].z],M.rot=A[1],b.hierarchy[r].keys.push(M)}e.animation=b}}function g(){if(_e&&0===_e.joints.length)return void(je=void 0);var e={},t=function(t,i){var n=i.getAttribute("id"),r=He.getChildById(n,!0),a=_e.joints[t];Pe.traverse(function(i){i.colladaId==n&&(e[t]={node:i,transforms:r.transforms,joint:a,position:a.zeroPosition})})};je={joints:_e&&_e.joints,getJointValue:function(t){var i=e[t];return i?i.position:void console.log("getJointValue: joint "+t+" doesn't exist")},setJointValue:function(t,i){var r=e[t];if(r){var a=r.joint;if(i>a.limits.max||i<a.limits.min)console.log("setJointValue: joint "+t+" value "+i+" outside of limits (min: "+a.limits.min+", max: "+a.limits.max+")");else if(a["static"])console.log("setJointValue: joint "+t+" is static");else{var o=r.node,s=a.axis,h=r.transforms,c=new THREE.Matrix4,u=new THREE.Matrix4;for(n=0;n<h.length;n++){var l=h[n];if(l.sid&&-1!==l.sid.indexOf("joint"+t))switch(a.type){case"revolute":c.multiply(u.makeRotationAxis(s,THREE.Math.degToRad(i)));break;case"prismatic":c.multiply(u.makeTranslation(s.x*i,s.y*i,s.z*i));break;default:console.warn("setJointValue: unknown joint type: "+a.type)}else switch(l.type){case"matrix":c.multiply(l.obj);break;case"translate":c.multiply(u.makeTranslation(l.obj.x,l.obj.y,l.obj.z));break;case"rotate":c.multiply(u.makeRotationAxis(l.obj,l.angle))}}var d=c.elements,p=Array.prototype.slice.call(d),f=[p[0],p[4],p[8],p[12],p[1],p[5],p[9],p[13],p[2],p[6],p[10],p[14],p[3],p[7],p[11],p[15]];o.matrix.set.apply(o.matrix,f),o.matrix.decompose(o.position,o.quaternion,o.scale)}}else console.log("setJointValue: joint "+t+" doesn't exist")}};var i=Le.querySelector("scene instance_kinematics_scene");if(i)for(var n=0;n<i.childNodes.length;n++){var r=i.childNodes[n];if(1==r.nodeType)switch(r.nodeName){case"bind_joint_axis":var a=r.getAttribute("target").split("/").pop(),o=r.querySelector("axis param").textContent,s=parseInt(o.split("joint").pop().split(".")[0]),h=Le.querySelector('[sid="'+a+'"]');if(h){var c=h.parentElement;t(s,c)}}}}function v(e,t){var i,n,r,a,o,s=new THREE.Object3D,h=!1;for(r=0;r<e.controllers.length;r++){var c=Ve[e.controllers[r].url];switch(c.type){case"skin":if(ze[c.skin.source])o=new G,o.url=c.skin.source,o.instance_material=e.controllers[r].instance_material,e.geometries.push(o),h=!0,i=e.controllers[r];else if(Ve[c.skin.source]){var l=Ve[c.skin.source];n=l,l.morph&&ze[l.morph.source]&&(o=new G,o.url=l.morph.source,o.instance_material=e.controllers[r].instance_material,e.geometries.push(o))}break;case"morph":ze[c.morph.source]&&(o=new G,o.url=c.morph.source,o.instance_material=e.controllers[r].instance_material,e.geometries.push(o),n=e.controllers[r]),console.log("ColladaLoader: Morph-controller partially supported.")}}var d={};for(r=0;r<e.geometries.length;r++){var p,f=e.geometries[r],g=f.instance_material,E=ze[f.url],y={},T=[],b=0;if(E){if(!E.mesh||!E.mesh.primitives)continue;if(0===s.name.length&&(s.name=E.id),g)for(a=0;a<g.length;a++){var w=g[a],M=Be[w.target],A=M.instance_effect.url,R=Xe[A].shader,x=R.material;if(E.doubleSided){if(!(w.symbol in d)){var H=x.clone();H.side=THREE.DoubleSide,d[w.symbol]=H}x=d[w.symbol]}x.opacity=x.opacity?x.opacity:1,y[w.symbol]=b,T.push(x),p=x,p.name=null===M.name||""===M.name?M.id:M.name,b++}var _,k=p||new THREE.MeshLambertMaterial({color:14540253,side:E.doubleSided?THREE.DoubleSide:THREE.FrontSide}),j=E.mesh.geometry3js;b>1&&(k=new THREE.MultiMaterial(T)),void 0!==i?(m(j,i),j.morphTargets.length>0?(k.morphTargets=!0,k.skinning=!1):(k.morphTargets=!1,k.skinning=!0),_=new THREE.SkinnedMesh(j,k,!1),_.name="skin_"+Ie.length,Ie.push(_)):void 0!==n?(u(j,n),k.morphTargets=!0,_=new THREE.Mesh(j,k),_.name="morph_"+Ge.length,Ge.push(_)):_=j.isLineStrip===!0?new THREE.Line(j):new THREE.Mesh(j,k),s.add(_)}}for(r=0;r<e.cameras.length;r++){var N=e.cameras[r],S=Ye[N.url],C=new THREE.PerspectiveCamera(S.yfov,parseFloat(S.aspect_ratio),parseFloat(S.znear),parseFloat(S.zfar));s.add(C)}for(r=0;r<e.lights.length;r++){var O=null,I=e.lights[r],L=Je[I.url];if(L&&L.technique){var P=L.color.getHex(),D=L.intensity,U=L.distance,F=L.falloff_angle;switch(L.technique){case"directional":O=new THREE.DirectionalLight(P,D,U),O.position.set(0,0,1);break;case"point":O=new THREE.PointLight(P,D,U);break;case"spot":O=new THREE.SpotLight(P,D,U,F),O.position.set(0,0,1);break;case"ambient":O=new THREE.AmbientLight(P)}}O&&s.add(O)}if(s.name=e.name||e.id||"",s.colladaId=e.id||"",s.layer=e.layer||"",s.matrix=e.matrix,s.matrix.decompose(s.position,s.quaternion,s.scale),We.centerGeometry&&s.geometry){var q=s.geometry.center();q.multiply(s.scale),q.applyQuaternion(s.quaternion),s.position.sub(q)}for(r=0;r<e.nodes.length;r++)s.add(v(e.nodes[r],e));return s}function E(e){for(var t=Le.querySelectorAll("library_nodes node"),i=0;i<t.length;i++){var n=t[i].attributes.getNamedItem("id");if(n&&n.value===e)return t[i]}}function y(e){var t=[],i=1e6,n=-1e6;for(var r in qe)for(var a=qe[r],o=0;o<a.channel.length;o++){var s=a.channel[o],h=a.sampler[o],c=s.target.split("/")[0];c==e.id&&(h.create(),s.sampler=h,i=Math.min(i,h.startTime),n=Math.max(n,h.endTime),t.push(s))}return t.length&&(e.startTime=i,e.endTime=n),t}function T(e){var t,i,n;if(e.channels&&e.channels.length){var r=[],a=[];for(t=0,il=e.channels.length;t<il;t++){var o,s=e.channels[t],h=s.fullSid,c=s.sampler,u=c.input,l=e.getTransformBySid(s.sid);if(s.arrIndices)for(o=[],i=0,jl=s.arrIndices.length;i<jl;i++)o[i]=Re(s.arrIndices[i]);else o=xe(s.member);if(l)for(-1===a.indexOf(h)&&a.push(h),i=0,jl=u.length;i<jl;i++){var d=u[i],p=c.getData(l.type,i,o);if(n=b(r,d),!n){n=new ie(d);var f=w(r,d);r.splice(-1===f?r.length:f,0,n)}n.addTarget(h,l,o,p)}else console.log('Could not find transform "'+s.sid+'" in node '+e.id)}for(t=0;t<a.length;t++){var m=a[t];for(i=0;i<r.length;i++)n=r[i],n.hasTarget(m)||M(r,n,i,m)}e.keys=r,e.sids=a}}function b(e,t){for(var i=null,n=0,r=e.length;r>n&&null===i;n++){var a=e[n];if(a.time===t)i=a;else if(a.time>t)break}return i}function w(e,t){for(var i=-1,n=0,r=e.length;r>n&&-1===i;n++){var a=e[n];a.time>=t&&(i=n)}return i}function M(e,t,i,n){var r=R(e,n,i?i-1:0),a=A(e,n,i+1);if(r&&a){var o,s=(t.time-r.time)/(a.time-r.time),h=r.getTarget(n),c=a.getTarget(n).data,u=h.data;if("matrix"===h.type)o=u;else if(u.length){o=[];for(var l=0;l<u.length;++l)o[l]=u[l]+(c[l]-u[l])*s}else o=u+(c-u)*s;t.addTarget(n,h.transform,h.member,o)}}function A(e,t,i){for(;i<e.length;i++){var n=e[i];if(n.hasTarget(t))return n}return null}function R(e,t,i){for(i=i>=0?i:i+e.length;i>=0;i--){var n=e[i];if(n.hasTarget(t))return n}return null}function x(){this.id="",this.init_from=""}function H(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function _(){this.method=null,this.source=null,this.targets=null,this.weights=null}function k(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function j(){this.id="",this.name="",this.nodes=[],this.scene=new THREE.Group}function N(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE.Matrix4}function S(){this.sid="",this.type="",this.data=[],this.obj=null}function C(){this.url="",this.skeleton=[],this.instance_material=[]}function O(){this.symbol="",this.target=""}function G(){this.url="",this.instance_material=[]}function I(){this.id="",this.mesh=null}function L(e){this.geometry=e.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function P(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE.Geometry}function D(){P.call(this),this.vcount=[]}function U(){P.call(this),this.vcount=1}function F(){P.call(this),this.vcount=3}function q(){this.source="",this.count=0,this.stride=0,this.params=[]}function V(){this.input={}}function z(){this.semantic="",this.offset=0,this.source="",this.set=0}function B(e){this.id=e,this.type=null}function X(){this.id="",this.name="",this.instance_effect=null}function Y(){this.color=new THREE.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function J(e,t){this.type=e,this.effect=t,this.material=null}function Z(e){this.effect=e,this.init_from=null,this.format=null}function W(e){this.effect=e,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function K(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function Q(){this.url=""}function $(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function ee(e){this.animation=e,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function te(e){this.id="",this.animation=e,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function ie(e){this.targets=[],this.time=e}function ne(){this.id="",this.name="",this.technique=""}function re(){this.url=""}function ae(){this.id="",this.name="",this.technique=""}function oe(){this.url=""}function se(){this.id="",this.name="",this.joints=[],this.links=[]}function he(){this.sid="",this.name="",this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this["static"]=!1,this.zeroPosition=0,this.middlePosition=0}function ce(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function ue(){this.joint="",this.transforms=[],this.links=[]}function le(e){var t=e.getAttribute("id");return void 0!==Ue[t]?Ue[t]:(Ue[t]=new B(t).parse(e),
Ue[t])}function de(e){for(var t=me(e),i=[],n=0,r=t.length;r>n;n++)i.push("true"===t[n]||"1"===t[n]);return i}function pe(e){for(var t=me(e),i=[],n=0,r=t.length;r>n;n++)i.push(parseFloat(t[n]));return i}function fe(e){for(var t=me(e),i=[],n=0,r=t.length;r>n;n++)i.push(parseInt(t[n],10));return i}function me(e){return e.length>0?ge(e).split(/\s+/):[]}function ge(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}function ve(e,t,i){return e.hasAttribute(t)?parseInt(e.getAttribute(t),10):i}function Ee(e,t){var i=new Image;i.addEventListener("load",function(e){return function(){e.needsUpdate=!0}}(e)),i.src=t,e.image=i}function ye(e,t){e.doubleSided=!1;var i=t.querySelectorAll("extra double_sided")[0];i&&i&&1===parseInt(i.textContent,10)&&(e.doubleSided=!0)}function Te(){if(We.convertUpAxis!==!0||Qe===We.upAxis)$e=null;else switch(Qe){case"X":$e="Y"===We.upAxis?"XtoY":"XtoZ";break;case"Y":$e="X"===We.upAxis?"YtoX":"YtoZ";break;case"Z":$e="X"===We.upAxis?"ZtoX":"ZtoY"}}function be(e,t){var i;if(We.convertUpAxis===!0&&Qe!==We.upAxis)switch($e){case"XtoY":i=e[0],e[0]=t*e[1],e[1]=i;break;case"XtoZ":i=e[2],e[2]=e[1],e[1]=e[0],e[0]=i;break;case"YtoX":i=e[0],e[0]=e[1],e[1]=t*i;break;case"YtoZ":i=e[1],e[1]=t*e[2],e[2]=i;break;case"ZtoX":i=e[0],e[0]=e[1],e[1]=e[2],e[2]=i;break;case"ZtoY":i=e[1],e[1]=e[2],e[2]=t*i}}function we(e,t){if(We.convertUpAxis!==!0||Qe===We.upAxis)return t;switch(e){case"X":t="XtoY"===$e?-1*t:t;break;case"Y":t="YtoZ"===$e||"YtoX"===$e?-1*t:t;break;case"Z":t="ZtoY"===$e?-1*t:t}return t}function Me(e,t){var i=[e[t],e[t+1],e[t+2]];return be(i,-1),new THREE.Vector3(i[0],i[1],i[2])}function Ae(e){if(We.convertUpAxis){var t=[e[0],e[4],e[8]];be(t,-1),e[0]=t[0],e[4]=t[1],e[8]=t[2],t=[e[1],e[5],e[9]],be(t,-1),e[1]=t[0],e[5]=t[1],e[9]=t[2],t=[e[2],e[6],e[10]],be(t,-1),e[2]=t[0],e[6]=t[1],e[10]=t[2],t=[e[0],e[1],e[2]],be(t,-1),e[0]=t[0],e[1]=t[1],e[2]=t[2],t=[e[4],e[5],e[6]],be(t,-1),e[4]=t[0],e[5]=t[1],e[6]=t[2],t=[e[8],e[9],e[10]],be(t,-1),e[8]=t[0],e[9]=t[1],e[10]=t[2],t=[e[3],e[7],e[11]],be(t,-1),e[3]=t[0],e[7]=t[1],e[11]=t[2]}return(new THREE.Matrix4).set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function Re(e){if(e>-1&&3>e){var t=["X","Y","Z"],i={X:0,Y:1,Z:2};e=xe(t[e]),e=i[e]}return e}function xe(e){if(We.convertUpAxis)switch(e){case"X":switch($e){case"XtoY":case"XtoZ":case"YtoX":e="Y";break;case"ZtoX":e="Z"}break;case"Y":switch($e){case"XtoY":case"YtoX":case"ZtoX":e="X";break;case"XtoZ":case"YtoZ":case"ZtoY":e="Z"}break;case"Z":switch($e){case"XtoZ":e="X";break;case"YtoZ":case"ZtoX":case"ZtoY":e="Y"}}return e}var He,_e,ke,je,Ne,Se,Ce,Oe,Ge,Ie,Le=null,Pe=null,De=null,Ue={},Fe={},qe={},Ve={},ze={},Be={},Xe={},Ye={},Je={},Ze=THREE.SmoothShading,We={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null},Ke=1,Qe="Y",$e=null;return x.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];"init_from"===i.nodeName&&(this.init_from=i.textContent)}return this},H.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.type="none";for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"skin":this.skin=(new k).parse(i),this.type=i.nodeName;break;case"morph":this.morph=(new _).parse(i),this.type=i.nodeName}}return this},_.prototype.parse=function(e){var t,i,n={},r=[];for(this.method=e.getAttribute("method"),this.source=e.getAttribute("source").replace(/^#/,""),t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];if(1==a.nodeType)switch(a.nodeName){case"source":i=(new B).parse(a),n[i.id]=i;break;case"targets":r=this.parseInputs(a);break;default:console.log(a.nodeName)}}for(t=0;t<r.length;t++){var o=r[t];switch(i=n[o.source],o.semantic){case"MORPH_TARGET":this.targets=i.read();break;case"MORPH_WEIGHT":this.weights=i.read()}}return this},_.prototype.parseInputs=function(e){for(var t=[],i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"input":t.push((new z).parse(n))}}return t},k.prototype.parse=function(e){var t,i,n={};this.source=e.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1==a.nodeType)switch(a.nodeName){case"bind_shape_matrix":var o=pe(a.textContent);this.bindShapeMatrix=Ae(o);break;case"source":var s=(new B).parse(a);n[s.id]=s;break;case"joints":t=a;break;case"vertex_weights":i=a;break;default:console.log(a.nodeName)}}return this.parseJoints(t,n),this.parseWeights(i,n),this},k.prototype.parseJoints=function(e,t){for(var i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"input":var r=(new z).parse(n),a=t[r.source];"JOINT"===r.semantic?this.joints=a.read():"INV_BIND_MATRIX"===r.semantic&&(this.invBindMatrices=a.read())}}},k.prototype.parseWeights=function(e,t){var i,n,r,a,o,s=[];for(r=0;r<e.childNodes.length;r++){var h=e.childNodes[r];if(1==h.nodeType)switch(h.nodeName){case"input":s.push((new z).parse(h));break;case"v":i=fe(h.textContent);break;case"vcount":n=fe(h.textContent)}}var c=0;for(r=0;r<n.length;r++){var u=n[r],l=[];for(a=0;u>a;a++){var d={};for(o=0;o<s.length;o++){var p=s[o],f=i[c+p.offset];switch(p.semantic){case"JOINT":d.joint=f;break;case"WEIGHT":d.weight=t[p.source].data[f]}}l.push(d),c+=s.length}for(a=0;a<l.length;a++)l[a].index=r;this.weights.push(l)}},j.prototype.getChildById=function(e,t){for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildById(e,t);if(n)return n}return null},j.prototype.getChildBySid=function(e,t){for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildBySid(e,t);if(n)return n}return null},j.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.nodes=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"node":this.nodes.push((new N).parse(i))}}return this},N.prototype.getChannelForTransform=function(e){for(var t=0;t<this.channels.length;t++){var i,n,r=this.channels[t],a=r.target.split("/"),o=(a.shift(),a.shift()),s=o.indexOf(".")>=0,h=o.indexOf("(")>=0;if(s)a=o.split("."),o=a.shift(),n=a.shift();else if(h){i=o.split("("),o=i.shift();for(var c=0;c<i.length;c++)i[c]=parseInt(i[c].replace(/\)/,""))}if(o===e)return r.info={sid:o,dotSyntax:s,arrSyntax:h,arrIndices:i},r}return null},N.prototype.getChildById=function(e,t){if(this.id===e)return this;if(t)for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildById(e,t);if(n)return n}return null},N.prototype.getChildBySid=function(e,t){if(this.sid===e)return this;if(t)for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildBySid(e,t);if(n)return n}return null},N.prototype.getTransformBySid=function(e){for(var t=0;t<this.transforms.length;t++)if(this.transforms[t].sid===e)return this.transforms[t];return null},N.prototype.parse=function(e){var t;this.id=e.getAttribute("id"),this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.type=e.getAttribute("type"),this.layer=e.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE.Matrix4;for(var i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"node":this.nodes.push((new N).parse(n));break;case"instance_camera":this.cameras.push((new re).parse(n));break;case"instance_controller":this.controllers.push((new C).parse(n));break;case"instance_geometry":this.geometries.push((new G).parse(n));break;case"instance_light":this.lights.push((new oe).parse(n));break;case"instance_node":t=n.getAttribute("url").replace(/^#/,"");var r=E(t);r&&this.nodes.push((new N).parse(r));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new S).parse(n));break;case"extra":break;default:console.log(n.nodeName)}}return this.channels=y(this),T(this),this.updateMatrix(),this},N.prototype.updateMatrix=function(){this.matrix.identity();for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},S.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=pe(e.textContent),this.convert(),this},S.prototype.convert=function(){switch(this.type){case"matrix":this.obj=Ae(this.data);break;case"rotate":this.angle=THREE.Math.degToRad(this.data[3]);break;case"translate":be(this.data,-1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":be(this.data,1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},S.prototype.apply=function(){var e=new THREE.Matrix4;return function(t){switch(this.type){case"matrix":t.multiply(this.obj);break;case"translate":t.multiply(e.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":t.multiply(e.makeRotationAxis(this.obj,this.angle));break;case"scale":t.scale(this.obj)}}}(),S.prototype.update=function(e,t){var i=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(t)if(1===t.length)switch(t[0]){case 0:this.obj.n11=e[0],this.obj.n21=e[1],this.obj.n31=e[2],this.obj.n41=e[3];break;case 1:this.obj.n12=e[0],this.obj.n22=e[1],this.obj.n32=e[2],this.obj.n42=e[3];break;case 2:this.obj.n13=e[0],this.obj.n23=e[1],this.obj.n33=e[2],this.obj.n43=e[3];break;case 3:this.obj.n14=e[0],this.obj.n24=e[1],this.obj.n34=e[2],this.obj.n44=e[3]}else if(2===t.length){var n="n"+(t[0]+1)+(t[1]+1);this.obj[n]=e}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(e);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=i[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=i[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;case"ANGLE":this.angle=THREE.Math.degToRad(e);break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2],this.angle=THREE.Math.degToRad(e[3])}}},C.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1===i.nodeType)switch(i.nodeName){case"skeleton":this.skeleton.push(i.textContent.replace(/^#/,""));break;case"bind_material":for(var n=i.querySelectorAll("instance_material"),r=0;r<n.length;r++){var a=n[r];this.instance_material.push((new O).parse(a))}break;case"extra":}}return this},O.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},G.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType&&"bind_material"===i.nodeName){for(var n=i.querySelectorAll("instance_material"),r=0;r<n.length;r++){var a=n[r];this.instance_material.push((new O).parse(a))}break}}return this},I.prototype.parse=function(e){this.id=e.getAttribute("id"),ye(this,e);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"mesh":this.mesh=new L(this).parse(i);break;case"extra":}}return this},L.prototype.parse=function(e){var t;for(this.primitives=[],t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"source":le(i);break;case"vertices":this.vertices=(new V).parse(i);break;case"linestrips":this.primitives.push((new U).parse(i));break;case"triangles":this.primitives.push((new F).parse(i));break;case"polygons":this.primitives.push((new P).parse(i));break;case"polylist":this.primitives.push((new D).parse(i))}}if(this.geometry3js=new THREE.Geometry,null===this.vertices)return this;var n=Ue[this.vertices.input.POSITION.source].data;for(t=0;t<n.length;t+=3)this.geometry3js.vertices.push(Me(n,t).clone());for(t=0;t<this.primitives.length;t++){var r=this.primitives[t];r.setVertices(this.vertices),this.handlePrimitive(r,this.geometry3js)}return this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this},L.prototype.handlePrimitive=function(e,t){if(e instanceof U)return void(t.isLineStrip=!0);var i,n,r,a,o,s,h,c,u,l=e.p,d=e.inputs,p=0,f=3,m=0,g=[];for(i=0;i<d.length;i++){r=d[i];var v=r.offset+1;switch(m=v>m?v:m,r.semantic){case"TEXCOORD":g.push(r.set)}}for(var E=0;E<l.length;++E)for(var y=l[E],T=0;T<y.length;){var b=[],w=[],M=null,A=[];for(f=e.vcount?e.vcount.length?e.vcount[p++]:e.vcount:y.length/m,i=0;f>i;i++)for(n=0;n<d.length;n++)switch(r=d[n],s=Ue[r.source],a=y[T+i*m+r.offset],h=s.accessor.params.length,o=a*h,r.semantic){case"VERTEX":b.push(a);break;case"NORMAL":w.push(Me(s.data,o));break;case"TEXCOORD":M=M||{},void 0===M[r.set]&&(M[r.set]=[]),M[r.set].push(new THREE.Vector2(s.data[o],s.data[o+1]));break;case"COLOR":A.push((new THREE.Color).setRGB(s.data[o],s.data[o+1],s.data[o+2]))}if(0===w.length)if(r=this.vertices.input.NORMAL)for(s=Ue[r.source],h=s.accessor.params.length,c=0,u=b.length;u>c;c++)w.push(Me(s.data,b[c]*h));else t.calcNormals=!0;if(!M&&(M={},r=this.vertices.input.TEXCOORD))for(g.push(r.set),s=Ue[r.source],h=s.accessor.params.length,c=0,u=b.length;u>c;c++)o=b[c]*h,void 0===M[r.set]&&(M[r.set]=[]),M[r.set].push(new THREE.Vector2(s.data[o],1-s.data[o+1]));if(0===A.length&&(r=this.vertices.input.COLOR))for(s=Ue[r.source],h=s.accessor.params.length,c=0,u=b.length;u>c;c++)o=b[c]*h,A.push((new THREE.Color).setRGB(s.data[o],s.data[o+1],s.data[o+2]));var R,x,H=null,_=[];if(3===f)_.push(new THREE.Face3(b[0],b[1],b[2],w,A.length?A:new THREE.Color));else if(4===f)_.push(new THREE.Face3(b[0],b[1],b[3],w.length?[w[0].clone(),w[1].clone(),w[3].clone()]:[],A.length?[A[0],A[1],A[3]]:new THREE.Color)),_.push(new THREE.Face3(b[1],b[2],b[3],w.length?[w[1].clone(),w[2].clone(),w[3].clone()]:[],A.length?[A[1],A[2],A[3]]:new THREE.Color));else if(f>4&&We.subdivideFaces){var k=A.length?A:new THREE.Color;for(n=1;f-1>n;)_.push(new THREE.Face3(b[0],b[n],b[n+1],w.length?[w[0].clone(),w[n++].clone(),w[n].clone()]:[],k))}if(_.length)for(c=0,u=_.length;u>c;c++)for(H=_[c],H.daeMaterial=e.material,t.faces.push(H),n=0;n<g.length;n++)R=M[g[n]],x=f>4?[R[0],R[c+1],R[c+2]]:4===f?0===c?[R[0],R[1],R[3]]:[R[1].clone(),R[2],R[3].clone()]:[R[0],R[1],R[2]],void 0===t.faceVertexUvs[n]&&(t.faceVertexUvs[n]=[]),t.faceVertexUvs[n].push(x);else console.log("dropped face with vcount "+f+" for geometry with id: "+t.id);T+=m*f}},P.prototype.setVertices=function(e){for(var t=0;t<this.inputs.length;t++)this.inputs[t].source===e.id&&(this.inputs[t].source=e.input.POSITION.source)},P.prototype.parse=function(e){this.material=e.getAttribute("material"),this.count=ve(e,"count",0);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"input":this.inputs.push((new z).parse(e.childNodes[t]));break;case"vcount":this.vcount=fe(i.textContent);break;case"p":this.p.push(fe(i.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},D.prototype=Object.create(P.prototype),D.prototype.constructor=D,U.prototype=Object.create(P.prototype),U.prototype.constructor=U,F.prototype=Object.create(P.prototype),F.prototype.constructor=F,q.prototype.parse=function(e){this.params=[],this.source=e.getAttribute("source"),this.count=ve(e,"count",0),this.stride=ve(e,"stride",0);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if("param"===i.nodeName){var n={};n.name=i.getAttribute("name"),n.type=i.getAttribute("type"),this.params.push(n)}}return this},V.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++)if("input"===e.childNodes[t].nodeName){var i=(new z).parse(e.childNodes[t]);this.input[i.semantic]=i}return this},z.prototype.parse=function(e){return this.semantic=e.getAttribute("semantic"),this.source=e.getAttribute("source").replace(/^#/,""),this.set=ve(e,"set",-1),this.offset=ve(e,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},B.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"bool_array":this.data=de(i.textContent),this.type=i.nodeName;break;case"float_array":this.data=pe(i.textContent),this.type=i.nodeName;break;case"int_array":this.data=fe(i.textContent),this.type=i.nodeName;break;case"IDREF_array":case"Name_array":this.data=me(i.textContent),this.type=i.nodeName;break;case"technique_common":for(var n=0;n<i.childNodes.length;n++)if("accessor"===i.childNodes[n].nodeName){this.accessor=(new q).parse(i.childNodes[n]);break}}}return this},B.prototype.read=function(){var e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var i=0;i<this.data.length;i+=16){var n=this.data.slice(i,i+16),r=Ae(n);e.push(r)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+t.type+".")}return e},X.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++)if("instance_effect"===e.childNodes[t].nodeName){this.instance_effect=(new Q).parse(e.childNodes[t]);break}return this},Y.prototype.isColor=function(){return null===this.texture},Y.prototype.isTexture=function(){return null!==this.texture},Y.prototype.parse=function(e){"transparent"===e.nodeName&&(this.opaque=e.getAttribute("opaque"));for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"color":var n=pe(i.textContent);this.color=new THREE.Color,this.color.setRGB(n[0],n[1],n[2]),this.color.a=n[3];break;case"texture":this.texture=i.getAttribute("texture"),this.texcoord=i.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(i)}}return this},Y.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&"extra"===e.childNodes[1].nodeName&&(e=e.childNodes[1],e.childNodes[1]&&"technique"===e.childNodes[1].nodeName&&(e=e.childNodes[1]));for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[i.nodeName]=parseFloat(i.textContent);break;case"wrapU":case"wrapV":"TRUE"===i.textContent.toUpperCase()?this.texOpts[i.nodeName]=1:this.texOpts[i.nodeName]=parseInt(i.textContent);break;default:this.texOpts[i.nodeName]=i.textContent}}return this},J.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"emission":case"diffuse":case"specular":case"transparent":this[i.nodeName]=(new Y).parse(i);break;case"bump":var n=i.getAttribute("bumptype");n?"heightfield"===n.toLowerCase()?this.bump=(new Y).parse(i):"normalmap"===n.toLowerCase()?this.normal=(new Y).parse(i):(console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+n+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'"),this.bump=(new Y).parse(i)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new Y).parse(i));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var r=i.querySelectorAll("float");r.length>0&&(this[i.nodeName]=parseFloat(r[0].textContent))}}return this.create(),this},J.prototype.create=function(){var e={},t=!1;if(void 0!==this.transparency&&void 0!==this.transparent){var i=(this.transparent,(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency);i>0&&(t=!0,e.transparent=!0,e.opacity=1-i)}var n={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var r in this)switch(r){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var a=this[r];if(a instanceof Y)if(a.isTexture()){var o=a.texture,s=this.effect.sampler[o];if(void 0!==s&&void 0!==s.source){var h=this.effect.surface[s.source];if(void 0!==h){var c=Fe[h.init_from];if(c){var u=c.init_from;u=Oe?Oe+u:Ce+u;var l,d=THREE.Loader.Handlers.get(u);null!==d?l=d.load(u):(l=new THREE.Texture,Ee(l,u)),l.wrapS=a.texOpts.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,l.wrapT=a.texOpts.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,l.offset.x=a.texOpts.offsetU,l.offset.y=a.texOpts.offsetV,l.repeat.x=a.texOpts.repeatU,l.repeat.y=a.texOpts.repeatV,e[n[r]]=l,"emission"===r&&(e.emissive=16777215)}}}}else"diffuse"!==r&&t||("emission"===r?e.emissive=a.color.getHex():e[r]=a.color.getHex());break;case"shininess":e[r]=this[r];break;case"reflectivity":e[r]=this[r],e[r]>0&&(e.envMap=We.defaultEnvMap),e.combine=THREE.MixOperation;break;case"index_of_refraction":e.refractionRatio=this[r],1!==this[r]&&(e.envMap=We.defaultEnvMap);break;case"transparency":}switch(e.shading=Ze,e.side=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide,void 0!==e.diffuse&&(e.color=e.diffuse,delete e.diffuse),this.type){case"constant":void 0!==e.emissive&&(e.color=e.emissive),this.material=new THREE.MeshBasicMaterial(e);break;case"phong":case"blinn":this.material=new THREE.MeshPhongMaterial(e);break;default:this.material=new THREE.MeshLambertMaterial(e)}return this.material},Z.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"init_from":this.init_from=i.textContent;break;case"format":this.format=i.textContent;break;default:console.log("unhandled Surface prop: "+i.nodeName)}}return this},W.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"source":this.source=i.textContent;break;case"minfilter":this.minfilter=i.textContent;break;case"magfilter":this.magfilter=i.textContent;break;case"mipfilter":this.mipfilter=i.textContent;break;case"wrap_s":this.wrap_s=i.textContent;break;case"wrap_t":this.wrap_t=i.textContent;break;default:console.log("unhandled Sampler2D prop: "+i.nodeName)}}return this},K.prototype.create=function(){return null===this.shader?null:void 0},K.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),ye(this,e),this.shader=null;for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(i))}}return this},K.prototype.parseNewparam=function(e){for(var t=e.getAttribute("sid"),i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"surface":this.surface[t]=new Z(this).parse(n);break;case"sampler2D":this.sampler[t]=new W(this).parse(n);break;case"extra":break;default:console.log(n.nodeName)}}},K.prototype.parseProfileCOMMON=function(e){for(var t,i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"profile_COMMON":this.parseProfileCOMMON(n);break;case"technique":t=n;break;case"newparam":this.parseNewparam(n);break;case"image":var r=(new x).parse(n);Fe[r.id]=r;break;case"extra":break;default:console.log(n.nodeName)}}return t},K.prototype.parseTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new J(i.nodeName,this).parse(i);break;case"extra":this.parseExtra(i)}}},K.prototype.parseExtra=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique":this.parseExtraTechnique(i)}}},K.prototype.parseExtraTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"bump":this.shader.parse(e)}}},Q.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},$.prototype.parse=function(e){var t;this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.source={};for(var i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"animation":var r=(new $).parse(n);for(t in r.source)this.source[t]=r.source[t];for(var a=0;a<r.channel.length;a++)this.channel.push(r.channel[a]),this.sampler.push(r.sampler[a]);break;case"source":t=(new B).parse(n),this.source[t.id]=t;break;case"sampler":this.sampler.push(new te(this).parse(n));break;case"channel":this.channel.push(new ee(this).parse(n))}}return this},ee.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,""),this.target=e.getAttribute("target");var t=this.target.split("/"),i=(t.shift(),t.shift()),n=i.indexOf(".")>=0,r=i.indexOf("(")>=0;if(n)t=i.split("."),this.sid=t.shift(),this.member=t.shift();else if(r){var a=i.split("(");this.sid=a.shift();for(var o=0;o<a.length;o++)a[o]=parseInt(a[o].replace(/\)/,""));this.arrIndices=a}else this.sid=i;return this.fullSid=i,this.dotSyntax=n,this.arrSyntax=r,this},te.prototype.parse=function(e){this.id=e.getAttribute("id"),this.inputs=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"input":this.inputs.push((new z).parse(i))}}return this},te.prototype.create=function(){var e;for(e=0;e<this.inputs.length;e++){var t=this.inputs[e],i=this.animation.source[t.source];switch(t.semantic){case"INPUT":this.input=i.read();break;case"OUTPUT":this.output=i.read(),this.strideOut=i.accessor.stride;break;case"INTERPOLATION":this.interpolation=i.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(t.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){for(this.startTime=1e8,this.endTime=-1e8,e=0;e<this.input.length;e++)this.startTime=Math.min(this.startTime,this.input[e]),this.endTime=Math.max(this.endTime,this.input[e]);this.duration=this.endTime-this.startTime}},te.prototype.getData=function(e,t,i){var n;if("matrix"===e&&16===this.strideOut)n=this.output[t];else if(this.strideOut>1){n=[],t*=this.strideOut;for(var r=0;r<this.strideOut;++r)n[r]=this.output[t+r];if(3===this.strideOut)switch(e){case"rotate":case"translate":be(n,-1);break;case"scale":be(n,1)}else 4===this.strideOut&&"matrix"===e&&be(n,-1)}else n=this.output[t],i&&"translate"===e&&(n=we(i,n));return n},ie.prototype.addTarget=function(e,t,i,n){this.targets.push({sid:e,member:i,transform:t,data:n})},ie.prototype.apply=function(e){for(var t=0;t<this.targets.length;++t){var i=this.targets[t];e&&i.sid!==e||i.transform.update(i.data,i.member)}},ie.prototype.getTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return this.targets[t];return null},ie.prototype.hasTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return!0;return!1},ie.prototype.interpolate=function(e,t){for(var i=0,n=this.targets.length;n>i;i++){var r,a=this.targets[i],o=e.getTarget(a.sid);if("matrix"!==a.transform.type&&o){var s=(t-this.time)/(e.time-this.time),h=o.data,c=a.data;if(0>s&&(s=0),s>1&&(s=1),c.length){r=[];for(var u=0;u<c.length;++u)r[u]=c[u]+(h[u]-c[u])*s}else r=c+(h-c)*s}else r=a.data;a.transform.update(r,a.member)}},ne.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"optics":this.parseOptics(i)}}return this},ne.prototype.parseOptics=function(e){var t,i,n,r;for(t=0;t<e.childNodes.length;t++)if("technique_common"===e.childNodes[t].nodeName){var a=e.childNodes[t];for(i=0;i<a.childNodes.length;i++)if(this.technique=a.childNodes[i].nodeName,"perspective"===this.technique){var o=a.childNodes[i];for(n=0;n<o.childNodes.length;n++)switch(r=o.childNodes[n],r.nodeName){case"yfov":this.yfov=r.textContent;break;case"xfov":this.xfov=r.textContent;break;case"znear":this.znear=r.textContent;break;case"zfar":this.zfar=r.textContent;break;case"aspect_ratio":this.aspect_ratio=r.textContent}}else if("orthographic"===this.technique){var s=a.childNodes[i];for(n=0;n<s.childNodes.length;n++)switch(r=s.childNodes[n],r.nodeName){case"xmag":this.xmag=r.textContent;break;case"ymag":this.ymag=r.textContent;break;case"znear":this.znear=r.textContent;break;case"zfar":this.zfar=r.textContent;break;case"aspect_ratio":this.aspect_ratio=r.textContent}}}return this},re.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},ae.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique_common":this.parseCommon(i);break;case"technique":this.parseTechnique(i)}}return this},ae.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++)switch(e.childNodes[t].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=e.childNodes[t].nodeName;for(var i=e.childNodes[t],n=0;n<i.childNodes.length;n++){var r=i.childNodes[n];switch(r.nodeName){case"color":var a=pe(r.textContent);this.color=new THREE.Color(0),this.color.setRGB(a[0],a[1],a[2]),this.color.a=a[3];break;case"falloff_angle":this.falloff_angle=parseFloat(r.textContent);break;case"quadratic_attenuation":var o=parseFloat(r.textContent);this.distance=o?Math.sqrt(1/o):0}}}return this},ae.prototype.parseTechnique=function(e){this.profile=e.getAttribute("profile");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"intensity":this.intensity=parseFloat(i.textContent)}}return this},oe.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},se.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.joints=[],this.links=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique_common":this.parseCommon(i)}}return this},se.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(e.childNodes[t].nodeName){case"joint":this.joints.push((new he).parse(i));break;case"link":this.links.push((new ce).parse(i))}}return this},he.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this["static"]=!1,this.zeroPosition=0,this.middlePosition=0;var t=e.querySelector("axis"),i=pe(t.textContent);this.axis=Me(i,0);var n=e.querySelector("limits min")?parseFloat(e.querySelector("limits min").textContent):-360,r=e.querySelector("limits max")?parseFloat(e.querySelector("limits max").textContent):360;this.limits={min:n,max:r};for(var a=["prismatic","revolute"],o=0;o<a.length;o++){var s=a[o],h=e.querySelector(s);h&&(this.type=s)}return this.limits.min>=this.limits.max&&(this["static"]=!0),this.middlePosition=(this.limits.min+this.limits.max)/2,this},ce.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.transforms=[],this.attachments=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"attachment_full":this.attachments.push((new ue).parse(i));break;case"rotate":case"translate":case"matrix":this.transforms.push((new S).parse(i))}}return this},ue.prototype.parse=function(e){this.joint=e.getAttribute("joint").split("/").pop(),this.links=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"link":this.links.push((new ce).parse(i));break;case"rotate":case"translate":case"matrix":this.transforms.push((new S).parse(i))}}return this},{load:e,parse:t,setPreferredShading:i,applySkin:m,geometries:ze,options:We}};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE&&!function(){
var e=new THREE.BoxGeometry(.7,.7,.7);e.uuid="71EB1490-B411-48E3-B187-D4A9B1836ACA",e.name="SELECT_BOX_GEOMETRY";var t=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,depthWrite:!1,depthTest:!1});t.uuid="0DD7A775-4B05-487D-845B-A10A2A224A55",t.name="SELECT_BOX_MATERIAL",t.transparent=!0,t.opacity=0;var i=function(){THREE.Object3D.call(this),this.model_url="",this.model_object=new THREE.Object3D,this.add(this.model_object)};i.prototype=Object.create(THREE.Object3D.prototype),i.prototype.constructor=i,i.prototype.load=function(i,n){var r=this;return new Promise(function(a,o){var s=new AMTHREE.ColladaLoader;s.options.convertUpAxis=!0,s.load(i,n,function(n){var o=new THREE.Box3,s=new THREE.Vector3,h=n.scene,c=new THREE.Mesh(e,t);c.add(h),r.model_url=i,r.model_object.remove.apply(r.model_object,r.model_object.children),r.model_object.add(c),o.setFromObject(h),o.size(c.scale),r.updateMatrix(),o.center(s),h.scale.divide(c.scale),h.position.sub(s.divide(c.scale)),h.updateMatrix(),AMTHREE.ObjectConvert(r.model_object),a(r)},void 0,o)})},i.prototype.toJSON=function(e){var t={uuid:this.uuid,type:"Collada",name:this.name,url:AMTHREE.GetFilename(this.model_url),matrix:this.matrix.toArray()};"{}"!==JSON.stringify(this.userData)&&(t.userData=this.userData),this.castShadow===!0&&(t.castShadow=!0),this.receiveShadow===!0&&(t.receiveShadow=!0),this.visible===!1&&(t.visible=!1);for(var i=[],n=0;n<this.children.length;++n)this.children[n]!==this.model_object&&i.push(this.children[n].toJSON(e).object);return i.length>0&&(t.children=i),{object:t}},AMTHREE.ColladaObject=i}();var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.GifTexture=function(e){THREE.Texture.call(this),this.minFilter=THREE.NearestMipMapNearestFilter,this.imageElement=document.createElement("img");var t=document.getElementsByTagName("script");t=t[t.length-1],t.parentNode.appendChild(this.imageElement),this.imageElement.width=this.imageElement.naturalWidth,this.imageElement.height=this.imageElement.naturalHeight,e&&this.setGif(e)},AMTHREE.GifTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.GifTexture.prototype.constructor=AMTHREE.GifTexture,AMTHREE.GifTexture.prototype.play=function(){this.anim.play(),this.image=this.gifCanvas},AMTHREE.GifTexture.prototype.update=function(){this.needsUpdate=!0},AMTHREE.GifTexture.prototype.stop=function(){this.anim.move_to(0),this.image=void 0},AMTHREE.GifTexture.prototype.pause=function(){this.anim.pause()},AMTHREE.GifTexture.prototype.setGif=function(e){e.url&&(this.image_ref=e,this.imageElement.src=e.url,this.anim=new SuperGif({gif:this.imageElement,auto_play:!1}),this.anim.load(),this.gifCanvas=this.anim.get_canvas(),this.gifCanvas.style.display="none")},AMTHREE.GifTexture.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,this.image_ref&&(t.image=this.image_ref.uuid),t.animated=!0,this.image_ref.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.GifTexture=function(){console.warn("GifTexture.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Image=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url=t},AMTHREE.Image.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,t.url=AMTHREE.GetFilename(this.url),"object"==typeof e&&(e.images||(e.images={}),e.images[t.uuid]=t),t}):AMTHREE.Image=function(){console.warn("Image.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.ImageTexture=function(e){THREE.Texture.call(this),this.image=new Image,this.image.addEventListener("load",function(e){return function(){e.needsUpdate=!0}}(this)),this.set(e)},AMTHREE.ImageTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.ImageTexture.prototype.constructor=AMTHREE.ImageTexture,AMTHREE.ImageTexture.prototype.set=function(e){this.image_ref=e,this.image.src=e.url},AMTHREE.ImageTexture.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,t.image=this.image_ref.uuid,this.image_ref.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.ImageTexture=function(){console.warn("ImageTexture.js: THREE undefined")};var AMTHREE=AMTHREE||{};!function(){function e(e){return"undefined"!=typeof e&&null!==e}function t(t){t.traverse(function(t){if(e(t.material)&&e(t.material.map)&&e(t.material.map.image)){var i=new AMTHREE.Image(void 0,t.material.map.image.src),n=new AMTHREE.ImageTexture(i);t.material.map=n,t.material.needsUpdate=!0}})}AMTHREE.ObjectConvert=t}();var AMTHREE=AMTHREE||{};!function(){function e(e,t){e=e||{};var i={};return t?i.asset_path=t+"/":i.asset_path="",i.asset_path+=e.asset_path?e.asset_path+"/":"",i.image_path=i.asset_path+(e.image_path?e.image_path:""),i.video_path=i.asset_path+(e.video_path?e.video_path:""),i.model_path=i.asset_path+(e.model_path?e.model_path:""),i.sound_path=i.asset_path+(e.sound_path?e.sound_path:""),i}function t(e,t){var i={};if(e instanceof Array){var n=new THREE.MaterialLoader;n.setTextures(t);for(var r=0,a=e.length;a>r;r++){var o=n.parse(e[r]);i[o.uuid]=o}}else console.log("materials parsing failed: json not an array");return i}function n(e){var t=[];if(e instanceof Array)for(var i=0;i<e.length;i++){var n=THREE.AnimationClip.parse(e[i]);t.push(n)}else console.log("animations parsing failed: json not an array");return t}function r(e,t){var i={};if(e instanceof Array)for(var n=0,r=e.length;r>n;++n){var a=e[n];if(void 0===a.uuid)console.warn('failed to parse sound: no "uuid" specified for sound '+n);else if(void 0===a.url)console.warn('failed to parse sound: no "url" specified for sound '+n);else{var o=new AMTHREE.Sound(a.uuid,t+"/"+a.url);i[a.uuid]=o}}return i}function a(e,t){return new Promise(function(n,r){var a={};return e instanceof Array?Promise.all(e.map(function(e){return new Promise(function(n,r){if(void 0===e.url)r('failed to parse image: no "url" specified for image '+i);else if(void 0===e.uuid)r('failed to parse image: no "uuid" specified for image '+i);else{var o=new AMTHREE.Image(e.uuid,t+"/"+e.url);a[o.uuid]=o,n()}})})).then(n(a),r):void r("images parsing failed: json not an array")})}function o(e,t){var i={};if(e instanceof Array)for(var n=0,r=e.length;r>n;n++){var a=e[n];if(void 0===a.uuid)console.warn('failed to parse video: no "uuid" specified for video '+n);else if(void 0===a.url)console.warn('failed to parse video: no "url" specified for video '+n);else{var o=new AMTHREE.Video(a.uuid,t+"/"+a.url);i[a.uuid]=o}}return i}function s(e){return"number"==typeof e?e:(console.warn("AMTHREE.ObjectLoading: Constant should be in numeric form.",e),THREE[e])}function h(e,t,i){var n={};if("undefined"==typeof SuperGif&&console.warn("AMTHREE.ObjectLoading: SuperGif is undefined"),"undefined"!=typeof e)for(var r=0,a=e.length;a>r;r++){var o=e[r],h=void 0;if(o.uuid||console.warn("failed to parse texture "+r+": no uuid provided"),void 0!==o.image||void 0!==o.video){if(void 0!==o.image){if(void 0===t[o.image]){console.warn("failed to parse texture "+o.uuid+": undefined image",o.image);continue}var c=t[o.image];if(void 0!==o.animated&&o.animated){if("undefined"==typeof SuperGif)continue;h=new AMTHREE.GifTexture(c)}else h=new AMTHREE.ImageTexture(c),h.needsUpdate=!0}else{if(void 0===i[o.video]){console.warn("failed to parse texture "+o.uuid+": undefined video",o.video);continue}var u=i[o.video];h=new AMTHREE.VideoTexture(u,o.width,o.height,o.loop,o.autoplay)}h.uuid=o.uuid,void 0!==o.name&&(h.name=o.name),void 0!==o.mapping&&(h.mapping=s(o.mapping)),void 0!==o.offset&&(h.offset=new THREE.Vector2(o.offset[0],o.offset[1])),void 0!==o.repeat&&(h.repeat=new THREE.Vector2(o.repeat[0],o.repeat[1])),void 0!==o.minFilter?h.minFilter=s(o.minFilter):h.minFilter=THREE.LinearFilter,void 0!==o.magFilter&&(h.magFilter=s(o.magFilter)),void 0!==o.anisotropy&&(h.anisotropy=o.anisotropy),Array.isArray(o.wrap)&&(h.wrapS=s(o.wrap[0]),h.wrapT=s(o.wrap[1])),n[o.uuid]=h}else console.warn('failed to parse texture: no "image" nor "video" specified for '+o.uuid)}return n}function c(e){var t={};if("undefined"!=typeof e)for(var i=new THREE.JSONLoader,n=new THREE.BufferGeometryLoader,r=0,a=e.length;a>r;r++){var o,s=e[r];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":o=new THREE[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"CubeGeometry":o=new THREE.BoxGeometry(s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleBufferGeometry":o=new THREE.CircleBufferGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CircleGeometry":o=new THREE.CircleGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":o=new THREE.CylinderGeometry(s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"SphereGeometry":o=new THREE.SphereGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"SphereBufferGeometry":o=new THREE.SphereBufferGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":o=new THREE.DodecahedronGeometry(s.radius,s.detail);break;case"IcosahedronGeometry":o=new THREE.IcosahedronGeometry(s.radius,s.detail);break;case"OctahedronGeometry":o=new THREE.OctahedronGeometry(s.radius,s.detail);break;case"TetrahedronGeometry":o=new THREE.TetrahedronGeometry(s.radius,s.detail);break;case"RingGeometry":o=new THREE.RingGeometry(s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":o=new THREE.TorusGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":o=new THREE.TorusKnotGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.p,s.q,s.heightScale);break;case"BufferGeometry":o=n.parse(s);break;case"Geometry":o=i.parse(s.data,this.texturePath).geometry;break;default:console.warn('AMTHREE.ObjectLoading: Unsupported geometry type "'+s.type+'"');continue}o.uuid=s.uuid,void 0!==s.name&&(o.name=s.name),t[s.uuid]=o}return t}function u(e,t,i){return new Promise(function(n,r){var a=new AM.JsonLoader;a.Load(e,function(){t(a.json,i).then(n,r)},function(){r("failed to load object: "+e)})})}function l(e,t){return u(e,f,t)}function d(e,t){return u(e,m,t)}function p(i,s){var u=e(i.constants,s);return a(i.images||[],u.image_path).then(function(e){var a=r(i.sounds||[],u.sound_path),s=o(i.videos||[],u.video_path),l=h(i.textures||[],e,s),d=n(i.animations||[]),p=t(i.materials||[],l),f=c(i.geometries||[]),m={constants:u,videos:s,images:e,sounds:a,textures:l,animations:d,materials:p,geometries:f};return m})}function f(e,t){return p(e,t).then(function(t){return T(e.object,t.materials,t.geometries,t.sounds,t.constants).then(function(e){return e.animations=t.animations,e})})}function m(e,t){return p(e,t).then(function(t){return b(e.objects,t.materials,t.geometries,t.sounds,t.constants)})}function g(e,t,i,n,r,a){var o=new THREE.Matrix4;if(e.uuid=t.uuid,void 0!==t.name&&(e.name=t.name),void 0!==t.matrix?(o.fromArray(t.matrix),o.decompose(e.position,e.quaternion,e.scale)):(void 0!==t.position&&e.position.fromArray(t.position),void 0!==t.rotation&&e.rotation.fromArray(t.rotation),void 0!==t.scale&&e.scale.fromArray(t.scale),void 0!==t.scaleXYZ&&(e.scale.x*=t.scaleXYZ,e.scale.y*=t.scaleXYZ,e.scale.z*=t.scaleXYZ)),void 0!==t.castShadow&&(e.castShadow=t.castShadow),void 0!==t.receiveShadow&&(e.receiveShadow=t.receiveShadow),void 0!==t.visible&&(e.visible=t.visible),void 0!==t.userData&&(e.userData=t.userData),"LOD"===t.type)for(var s=t.levels,h=0;h<s.length;h++){var c=s[h],u=e.getObjectByProperty("uuid",c.object);void 0!==u&&e.addLevel(u,c.distance)}return void 0!==t.children?b(t.children,i,n,r,a).then(function(t){for(var i=0,n=t.length;n>i;++i)e.add(t[i]);return e}):Promise.resolve(e)}function v(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get geometry: no id provided"):console.warn("failed to get geometry: no such geometry: "+e))}function E(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get material: no id provided"):console.warn("failed to get material: no such material: "+e))}function y(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get sound: no id provided"):console.warn("failed to get sound: no such sound: "+e))}function T(e,t,i,n,r){var a,o;switch(e.type){case"OBJ":return new Promise(function(a,s){if(THREE.OBJLoader){var h=new THREE.OBJLoader;o=r.model_path+"/"+e.url,h.load(o,function(o){o.traverse(function(e){e.geometry&&e.geometry.computeBoundingSphere()}),g(o,e,t,i,n,r).then(function(){a(o)},s)})}else s("failed to load "+e.uuid+": THREE.OBJLoader is undefined")});case"Collada":return a=new AMTHREE.ColladaObject,a.load(r.model_path+e.url,r.image_path).then(function(a){return g(a,e,t,i,n,r).then(function(){return a})});case"SoundObject":a=new AMTHREE.SoundObject(y(e.sound,n));break;case"Scene":a=new THREE.Scene;break;case"PerspectiveCamera":a=new THREE.PerspectiveCamera(e.fov,e.aspect,e.near,e.far);break;case"OrthographicCamera":a=new THREE.OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far);break;case"AmbientLight":a=new THREE.AmbientLight(e.color);break;case"DirectionalLight":a=new THREE.DirectionalLight(e.color,e.intensity);break;case"PointLight":a=new THREE.PointLight(e.color,e.intensity,e.distance,e.decay);break;case"SpotLight":a=new THREE.SpotLight(e.color,e.intensity,e.distance,e.angle,e.exponent,e.decay);break;case"HemisphereLight":a=new THREE.HemisphereLight(e.color,e.groundColor,e.intensity);break;case"Mesh":a=new THREE.Mesh(v(e.geometry,i),E(e.material,t));break;case"LOD":a=new THREE.LOD;break;case"Line":a=new THREE.Line(v(e.geometry,i),E(e.material,t),e.mode);break;case"PointCloud":case"Points":a=new THREE.Points(v(e.geometry,i),E(e.material,t));break;case"Sprite":a=new THREE.Sprite(E(e.material,t));break;case"Group":a=new THREE.Group;break;default:a=new THREE.Object3D}return g(a,e,t,i,n,r)}function b(e,t,i,n,r){return e instanceof Array?Promise.all(e.map(function(e){return T(e,t,i,n,r)})):Promise.reject("failed to parse object array: json not an array")}function w(e){var t=new THREE.Box3,i=new THREE.Sphere,n=new THREE.Object3D;n.add(e),t.setFromObject(e),t.getBoundingSphere(i),n.scale.multiplyScalar(1/i.radius),i.center.divideScalar(i.radius),n.position.sub(i.center),n.updateMatrix();var r=new THREE.Object3D;return r.add(n),r}function M(e){e.traverse(function(e){e instanceof THREE.Mesh&&e.geometry&&e.geometry.computeBoundingBox()})}function A(e){e.traverse(function(e){e instanceof THREE.Mesh&&e.geometry&&e.geometry.computeBoundingSphere()})}"undefined"!=typeof THREE&&(AMTHREE.ParseObject=f,AMTHREE.ParseObjectArray=m,AMTHREE.LoadObject=l,AMTHREE.LoadObjectArray=d,AMTHREE.NormalizeObject=w,AMTHREE.ComputeBoundingBox=M,AMTHREE.ComputeBoundingSphere=A)}();var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Sound=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url=t},AMTHREE.Sound.prototype.toJSON=function(e){var t={uuid:this.uuid,url:AMTHREE.GetFilename(this.url)};return e.sounds||(e.sounds={}),e.sounds[this.uuid]||(e.sounds[this.uuid]=t),t}):AMTHREE.Sound=function(){console.warn("Sound.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.SoundObject=function(e){THREE.Object3D.call(this),this.sound=e,this.audio=new Audio,this.audio.loop=!0,this.playing=!1},AMTHREE.SoundObject.prototype=Object.create(THREE.Object3D.prototype),AMTHREE.SoundObject.prototype.constructor=AMTHREE.SoundObject,AMTHREE.SoundObject.prototype.play=function(){this.playing=!0,this.audio.src=this.sound.url,this.audio.play()},AMTHREE.SoundObject.prototype.stop=function(){this.audio.src="",this.playing=!1},AMTHREE.SoundObject.prototype.pause=function(){this.audio.pause(),this.playing=!1},AMTHREE.SoundObject.prototype.setSound=function(e){this.sound=e,this.isPlaying()&&this.play()},AMTHREE.SoundObject.prototype.isPlaying=function(){return this.playing},AMTHREE.SoundObject.prototype.clone=function(){return(new AMTHREE.SoundObject).copy(this)},AMTHREE.SoundObject.prototype.copy=function(e){return this.setSound(e.sound),this},AMTHREE.SoundsCall=function(e,t){e.traverse(function(e){e instanceof AMTHREE.SoundObject&&e[t]&&e[t]()})},AMTHREE.PlaySounds=function(e){AMTHREE.SoundsCall(e,"play")},AMTHREE.PauseSounds=function(e){AMTHREE.SoundsCall(e,"pause")},AMTHREE.StopSounds=function(e){AMTHREE.SoundsCall(e,"stop")},AMTHREE.SoundObject.prototype.toJSON=function(e){var t=THREE.Object3D.prototype.toJSON.call(this,e);return this.sound.toJSON(e),t.object.type="SoundObject",t.object.sound=this.sound.uuid,t}):AMTHREE.SoundObject=function(){console.warn("SoundObject.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.TrackedObjManager=function(e){function t(e,t,i){e.position.lerp(t.position,i),e.quaternion.slerp(t.quaternion,i),e.scale.lerp(t.scale,i)}function i(){a.ForEach(function(e){e.enabled&&t(e.object,e.target,n.lerp_factor)})}e=e||{};var n=this,r=new THREE.Clock(!0),a=new AMTHREE.TrackedObjManager.prototype.Holder,o=i;this.camera=e.camera,this.lerp_factor=e.lerp_factor||.8,this.timeout=e.timeout||6,this.Add=function(e,t,i,n){a.Add(e,t,i,n)},this.Remove=function(e){a.Remove(e)},this.Clear=function(){a.Clear()},this.Update=function(){a.UpdateElapsed(r.getDelta()),a.CheckTimeout(n.timeout),o()},this.Track=function(){var e=new THREE.Matrix4,i=new THREE.Object3D;return function(r,o){if(n.camera){var s=a.Get(r);if(s){var h=s.target;return e.copy(n.camera.matrixWorld),e.multiply(o),s.enabled?(e.decompose(i.position,i.quaternion,i.scale),t(h,i,n.lerp_factor)):(e.decompose(h.position,h.quaternion,h.scale),e.decompose(s.object.position,s.object.quaternion,s.object.scale)),a.Track(r),!0}console.warn("TrackedObjManager: object "+r+" not found")}else console.warn("TrackedObjManager: camera is undefined");return!1}}(),this.TrackCompose=function(){var e=new THREE.Matrix4;return function(t,i,r,a){return e.compose(i,r,a),n.Track(t,e)}}(),this.TrackComposePosit=function(){var e=new THREE.Vector3,t=new THREE.Euler,i=new THREE.Quaternion,r=new THREE.Vector3;return function(a,o,s,h){return e.x=o[0],e.y=o[1],e.z=-o[2],t.x=-Math.asin(-s[1][2]),t.y=-Math.atan2(s[0][2],s[2][2]),t.z=Math.atan2(s[1][0],s[1][1]),r.x=h,r.y=h,r.z=h,i.setFromEuler(t),n.TrackCompose(a,e,i,r)}}(),this.GetObject=function(e){var t=a.get(e);return t?t.object:void 0}},AMTHREE.TrackedObjManager.prototype.Holder=function(){var e=this,t={};this.Add=function(e,i,n,r){t[i]={object:e,target:{position:e.position.clone(),quaternion:e.quaternion.clone(),scale:e.scale.clone()},elapsed:0,on_enable:n,on_disable:r,enabled:!1}},this.Remove=function(e){var i=t[e];i.enabled&&i.on_disable&&i.on_disable(i.object),delete t[e]},this.Clear=function(){for(var i in t)e.Remove(i)},this.Track=function(e){var i=t[e];i.elapsed=0,i.enabled||(i.enabled=!0,i.on_enable&&i.on_enable(i.object))},this.UpdateElapsed=function(e){for(var i in t)t[i].elapsed+=e},this.CheckTimeout=function(e){for(var i in t){var n=t[i];n.enabled&&n.elapsed>e&&(n.on_disable&&n.on_disable(n.object),n.enabled=!1)}},this.ForEach=function(e){for(var i in t)e(t[i])},this.Get=function(e){return t[e]}}):AMTHREE.TrackedObjManager=function(){console.warn("TrackedObjManager.js: THREE undefined")};var AMTHREE=AMTHREE||{};AMTHREE.AnimatedTextureCall=function(e,t){e.traverse(function(e){e.material&&e.material.map&&e.material.map[t]&&e.material.map[t]()})},AMTHREE.PlayAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"play")},AMTHREE.StopAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"stop")},AMTHREE.PauseAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"pause")},AMTHREE.UpdateAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"update")},AMTHREE.WorldToCanvasPosition=function(e,t,i){var n=new THREE.Vector3;n.copy(e),n.project(t);var r=Math.round((n.x+1)*i.width/2),a=Math.round((-n.y+1)*i.height/2);return{x:r,y:a,z:n.z}},AMTHREE.GetFilename=function(e){return e.split("/").pop().split("\\").pop()},AMTHREE.IMAGE_PATH="images/",AMTHREE.MODEL_PATH="models/",AMTHREE.VIDEO_PATH="videos/",AMTHREE.SOUND_PATH="sounds/",AMTHREE.ASSET_PATH="assets/";var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Video=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url="string"==typeof t?t:void 0},AMTHREE.Video.prototype.toJSON=function(e){var t={uuid:this.uuid,url:AMTHREE.GetFilename(this.url)};return"object"==typeof e&&(e.videos||(e.videos={}),e.videos[t.uuid]=t),t}):AMTHREE.Video=function(){console.warn("Video.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.VideoTexture=function(e,t,i,n,r,a){THREE.Texture.call(this),this.uuid="string"==typeof t?t:THREE.Math.generateUUID(),this.minFilter=THREE.NearestMipMapNearestFilter,this.videoElement=document.createElement("video"),this.needsUpdate=!1,this.set(e,i,n,r,a)},AMTHREE.VideoTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.VideoTexture.prototype.constructor=AMTHREE.VideoTexture,AMTHREE.VideoTexture.prototype.play=function(){this.videoElement&&!this.playing&&this.video&&(this.paused||(this.videoElement.src=this.video.url),this.videoElement.setAttribute("crossorigin","anonymous"),this.videoElement.play(),this.image=this.videoElement,this.playing=!0)},AMTHREE.VideoTexture.prototype.update=function(){this.videoElement&&this.videoElement.readyState==this.videoElement.HAVE_ENOUGH_DATA&&(this.needsUpdate=!0)},AMTHREE.VideoTexture.prototype.pause=function(){this.videoElement&&!this.videoElement.paused&&(this.videoElement.pause(),this.playing=!1)},AMTHREE.VideoTexture.prototype.stop=function(){this.videoElement&&(this.pause(),this.videoElement.src="",this.image=void 0,this.needsUpdate=!0)},AMTHREE.VideoTexture.prototype.set=function(e,t,i,n,r){this.stop(),this.video=e,this.videoElement.width="number"==typeof t?t:void 0,this.videoElement.height="number"==typeof i?i:void 0,this.videoElement.autoplay="boolean"==typeof r?r:!1,this.videoElement.loop="boolean"==typeof n?n:!0,this.playing=!1,this.videoElement.autoplay&&this.play()},AMTHREE.VideoTexture.prototype.toJSON=function(e){var t={uuid:this.uuid,video:this.video.uuid,width:this.videoElement.width,height:this.videoElement.height,loop:this.videoElement.loop,autoplay:this.videoElement.autoplay};return this.video.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.VideoTexture=function(){console.warn("VideoTexture.js: THREE undefined")};var AM=AM||{};AM.Detection=function(){function e(e,t){var i=e*t;if(i>n.length)for(;--i>=0;)n[i]=new jsfeat.keypoint_t}var t={laplacian_threshold:30,eigen_threshold:25,detection_corners_max:500,border_size:15,fast_threshold:20},i=!1,n=[],r=0,a=new jsfeat.matrix_t(32,t.detection_corners_max,jsfeat.U8_t|jsfeat.C1_t);this.Detect=function(o){e(o.cols,o.rows),r=AM.DetectKeypointsYape06(o,n,t.detection_corners_max,t.laplacian_threshold,t.eigen_threshold,t.border_size),jsfeat.orb.describe(o,n,r,a),i&&console.log("Learn : "+r+" corners")},this.SetParameters=function(e){for(var i in e)"undefined"!=typeof t[i]&&(t[i]=e[i])},this.GetDescriptors=function(){return a},this.GetNumCorners=function(){return r},this.GetCorners=function(){return n}},AM.IcAngle=function(){var e=new Int32Array([15,15,15,15,14,14,14,13,13,12,11,10,9,8,6,3,0]),t=Math.PI/2;return function(i,n,r){var a=15,o=0,s=0,h=i.data,c=i.cols,u=0,l=0,d=r*c+n|0,p=0,f=0,m=0,g=0;for(u=-a;a>=u;++u)s+=u*h[d+u];for(l=1;a>=l;++l){for(p=0,f=e[l],u=-f;f>=u;++u)m=h[d+u+l*c],g=h[d+u-l*c],p+=m-g,s+=u*(m+g);o+=l*p}return AM.DiamondAngle(o,s)*t}}(),AM.DiamondAngle=function(e,t){return e>=0?t>=0?e/(t+e):1-t/(-t+e):0>t?2-e/(-t-e):3+t/(t-e)},AM.DetectKeypointsPostProc=function(e,t,i,n){i>n&&(jsfeat.math.qsort(t,0,i-1,function(e,t){return t.score<e.score}),i=n);for(var r=0;i>r;++r)t[r].angle=AM.IcAngle(e,t[r].x,t[r].y);return i},AM.DetectKeypointsYape06=function(e,t,i,n,r,a){jsfeat.yape06.laplacian_threshold=n,jsfeat.yape06.min_eigen_value_threshold=r;var o=jsfeat.yape06.detect(e,t,a);return o=AM.DetectKeypointsPostProc(e,t,o,i)},AM.DetectKeypointsFast=function(e,t,i,n,r){jsfeat.fast_corners.set_threshold(n);var a=jsfeat.fast_corners.detect(e,t,r||3);return a=AM.DetectKeypointsPostProc(e,t,a,i)};var AM=AM||{};AM.ImageFilter=function(){var e,t={blur_size:3,blur:!0};this.Filter=function(i){var n=i.width,r=i.height;e?e.resize(n,r,jsfeat.U8_t|jsfeat.C1_t):e=new jsfeat.matrix_t(n,r,jsfeat.U8_t|jsfeat.C1_t),jsfeat.imgproc.grayscale(i.data,n,r,e),t.blur&&jsfeat.imgproc.gaussian_blur(e,e,t.blur_size)},this.GetFilteredImage=function(){return e},this.SetParameters=function(e){for(var i in e)"undefined"!=typeof t[i]&&(t[i]=e[i])}};var AM=AM||{};AM.MarkerTracker=function(){var e,t=new AM.Training,i={},n=new AM.ImageFilter,r=new AM.Detection,a=new AM.Matching,o=new AM.Pose,s=!1,h={match_min:8},c=!1,u=new AM.Profiler;u.add("filter"),u.add("detection"),u.add("matching"),u.add("pose"),this.ComputeImage=function(e){u.new_frame(),u.start("filter"),n.Filter(e),u.stop("filter"),u.start("detection"),r.Detect(n.GetFilteredImage()),u.stop("detection")},this.Match=function(){u.start("matching"),s=!1,e=void 0,a.SetScreenDescriptors(r.GetDescriptors());for(var t in i){var n=i[t];if(n.IsActive()){a.Match(n.GetDescriptorsLevels());var l=a.GetNumMatches();if(s=l>=h.match_min,c&&console.log("nbMatches : "+l),s){var d=o.Pose(a.GetMatches(),l,r.GetCorners(),n.GetCornersLevels());if(s=d>=h.match_min,c&&console.log(" goodMatches : "+d),s){e=n;break}}}}return u.stop("matching"),s},this.GetMatchUuid=function(){return e.GetUuid()},this.GetPose=function(){if(s){u.start("pose");var t=o.GetPoseCorners(e.GetWidth(),e.GetHeight());return u.stop("pose"),t}},this.AddMarker=function(e,n){t.Train(e);var r=new AM.TrainedImage(n);t.SetResultToTrainedImage(r),t.Empty(),i[n]=r},this.RemoveMarker=function(e){i[e]&&delete i[e]},this.ActiveMarker=function(e,t){i[e]&&i[e].Active(t)},this.ActiveAllMarkers=function(e){for(var t in i)i[t].Active(e)},this.ClearMarkers=function(){i={}},this.GetScreenCorners=function(){return r.GetCorners()},this.GetNumScreenCorners=function(){return r.GetNumCorners()},this.GetMatches=function(){return a.GetMatches()},this.GetMatchesMask=function(){return o.GetMatchesMask()},this.GetProfiler=function(){return u.GetProfiler()},this.GetTrainedCorners=function(){var t=i[e.GetUuid()];return t.GetCornersLevels()},this.Log=function(){console.log(u.log()+(s?"<br/>match found":""))},this.SetParameters=function(e){for(var i in e)"undefined"!=typeof h[i]&&(h[i]=e[i]);t.SetParameters(e),n.SetParameters(e),r.SetParameters(e),a.SetParameters(e)}};var AM=AM||{};AM.Matching=function(){function e(e){return e-=e>>1&1431655765,e=(858993459&e)+(e>>2&858993459),16843009*(e+(e>>4)&252645135)>>24}function t(e,t){var i=e.rows,n=e.buffer.i32,r=0,h=0;a=[];for(var c=0;i>c;++c){for(var u=256,l=256,d=-1,p=-1,f=0,m=t.length;m>f;++f)for(var g=t[f],v=g.rows,E=g.buffer.i32,y=0,T=0;v>T;++T){for(var b=0,w=0;8>w;++w)b+=s(n[r+w]^E[y+w]);u>b?(l=u,u=b,p=f,d=T):l>b&&(l=b),y+=8}if(u<o.match_threshold){for(;a.length<=h;)a.push(new AM.match_t);a[h].screen_idx=c,a[h].pattern_lev=p,a[h].pattern_idx=d,h++}r+=8}return a.length=h,h}var n,r,a=[],o={match_threshold:48};this.SetScreenDescriptors=function(e){n=e},this.Match=function(e){return r=t(n,e)};var s=(function(){var e=[0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8],t=255;return function(i){var n=e[i&t];return i>>=8,n+=e[i&t],i>>=8,n+=e[i&t],i>>=8,n+=e[i&t]}}(),function(){var t=[];for(i=0;i<65536;++i)t.push(e(i));var n=65535;return function(e){var i=t[e&n];return e>>=16,i+=t[e&n]}}());this.GetMatches=function(){return a},this.GetNumMatches=function(){return r},this.SetParameters=function(e){for(var t in e)"undefined"!=typeof o[t]&&(o[t]=e[t])}},AM.match_t=function(e,t,i,n){this.screen_idx=e||0,this.pattern_lev=t||0,this.pattern_idx=i||0,this.distance=n||0};var AM=AM||{};AM.Pose=function(){function e(e,t,i,n,r,a){var o,s=new jsfeat.motion_model.homography2d,h=4,c=3,u=new jsfeat.ransac_params_t(h,c,.5,.99),l=[],d=[];for(o=0;t>o;++o){var p=e[o],f=r[p.screen_idx],m=a[p.pattern_lev][p.pattern_idx];l[o]={x:m.x,y:m.y},d[o]={x:f.x,y:f.y}}var g=!1;g=jsfeat.motion_estimator.ransac(u,s,l,d,t,i,n,1e3);var v=0;if(g){for(o=0;t>o;++o)n.data[o]&&(l[v].x=l[o].x,l[v].y=l[o].y,d[v].x=d[o].x,d[v].y=d[o].y,v++);s.run(l,d,i,v)}else jsfeat.matmath.identity_3x3(i,1);return v}function t(e,t,i){for(var n=[{x:0,y:0},{x:t,y:0},{x:t,y:i},{x:0,y:i}],r=0,a=0,o=0,s=0;4>s;++s)a=e[0]*n[s].x+e[1]*n[s].y+e[2],o=e[3]*n[s].x+e[4]*n[s].y+e[5],r=e[6]*n[s].x+e[7]*n[s].y+e[8],n[s].x=a/r,n[s].y=o/r;return n}var i=0,n=new jsfeat.matrix_t(3,3,jsfeat.F32C1_t),r=new jsfeat.matrix_t(500,1,jsfeat.U8C1_t);this.Pose=function(t,a,o,s){return i=e(t,a,n,r,o,s)},this.GetGoodCount=function(){return i},this.GetPoseCorners=function(e,i){return t(n.data,e,i)},this.GetMatchesMask=function(){return r}},AM.PosePosit=function(){this.posit=new POS.Posit(10,1),this.pose=void 0},AM.PosePosit.prototype.Set=function(e,t,i,n){t=t||35;for(var r=[],a=0;a<e.length;++a){var o=e[a].x-i/2,s=n/2-e[a].y;r.push({x:o,y:s})}this.pose=this.posit.pose(r)},AM.PosePosit.prototype.SetFocalLength=function(e){this.posit.focalLength=e},AM.PoseThree=function(){this.position=new THREE.Vector3,this.rotation=new THREE.Euler,this.quaternion=new THREE.Quaternion,this.scale=new THREE.Vector3},AM.PoseThree.prototype.Set=function(e,t){t=t||35;var i=e.bestRotation,n=e.bestTranslation;this.scale.x=t,this.scale.y=t,this.scale.z=t,this.rotation.x=-Math.asin(-i[1][2]),this.rotation.y=-Math.atan2(i[0][2],i[2][2]),this.rotation.z=Math.atan2(i[1][0],i[1][1]),this.position.x=n[0],this.position.y=n[1],this.position.z=-n[2],this.quaternion.setFromEuler(this.rotation)};var AM=AM||{};AM.TrainedImage=function(e){var t=!0,i=[],n=[],r=0,a=0,o=e,s=!0;this.GetCorners=function(e){return i[e]},this.GetDescriptors=function(e){return n[e]},this.GetLevelNbr=function(){return Math.min(n.length,i.length)},this.GetCornersLevels=function(){return i},this.GetDescriptorsLevels=function(){return n},this.GetWidth=function(){return r},this.GetHeight=function(){return a},this.Set=function(e,o,s,h){t=!1,i=e,n=o,r=s,a=h},this.IsEmpty=function(){return t},this.Empty=function(){t=!0,i=[],n=[]},this.SetUuid=function(e){o=e},this.GetUuid=function(){return o},this.Active=function(e){s=e===!0},this.IsActive=function(){return s}};var AM=AM||{};AM.Training=function(){function e(e,n,o,s){var h=a[o],u=r[o];0!==o?(t(e,n,s),jsfeat.imgproc.gaussian_blur(n,n,c.blur_size)):jsfeat.imgproc.gaussian_blur(e,n,c.blur_size);var l=AM.DetectKeypointsYape06(n,h,c.training_corners_max,c.laplacian_threshold,c.eigen_threshold);if(h.length=l,jsfeat.orb.describe(n,h,l,u),0!==o)for(i=0;i<l;++i)h[i].x*=1/s,h[i].y*=1/s;console.log("train "+n.cols+"x"+n.rows+" points: "+l)}function t(e,t,i){if(1>i){var n=Math.round(e.cols*i),r=Math.round(e.rows*i);jsfeat.imgproc.resample(e,t,n,r)}else t.resize(e.cols,e.rows),e.copy_to(t)}function n(e,t){for(var i=0;i<c.num_train_levels;++i){a[i]=[];for(var n=a[i],o=e*t>>i;--o>=0;)n[o]=new jsfeat.keypoint_t(0,0,0,0,-1);r[i]=new jsfeat.matrix_t(32,c.training_corners_max,jsfeat.U8_t|jsfeat.C1_t)}}var r,a,o,s=0,h=0,c={num_train_levels:3,blur_size:3,image_size_max:512,training_corners_max:200,laplacian_threshold:30,eigen_threshold:25},u=Math.sqrt(2),l=[];this.Train=function(i){var o=0,l=1;r=[],a=[];var d=new jsfeat.matrix_t(i.width,i.height,jsfeat.U8_t|jsfeat.C1_t);jsfeat.imgproc.grayscale(i.data,i.width,i.height,d,jsfeat.COLOR_RGBA2GRAY);var p=Math.min(c.image_size_max/i.width,c.image_size_max/i.height),f=new jsfeat.matrix_t(i.width*p,i.height*p,jsfeat.U8_t|jsfeat.C1_t);
s=f.cols,h=f.rows,t(d,f,p),n(f.cols,f.rows);var m=new jsfeat.matrix_t(f.cols,f.rows,jsfeat.U8_t|jsfeat.C1_t);for(e(f,m,0,l),o=1;o<c.num_train_levels;++o)l/=u,e(f,m,o,l)},cloneImage=function(e){var t=new jsfeat.matrix_t(e.cols,e.rows,jsfeat.U8_t|jsfeat.C1_t);return e.copy_to(t),t},this.TrainFull=function(i){var d=0,p=1;r=[],a=[],l=[];var f=new jsfeat.matrix_t(i.width,i.height,jsfeat.U8_t|jsfeat.C1_t);jsfeat.imgproc.grayscale(i.data,i.width,i.height,f,jsfeat.COLOR_RGBA2GRAY);var m=Math.min(c.image_size_max/i.width,c.image_size_max/i.height),g=new jsfeat.matrix_t(i.width*m,i.height*m,jsfeat.U8_t|jsfeat.C1_t);s=g.cols,h=g.rows,t(f,g,m),n(g.cols,g.rows);var v=new jsfeat.matrix_t(g.cols,g.rows,jsfeat.U8_t|jsfeat.C1_t);for(e(g,v,0,p),o=g,l[0]=cloneImage(v),d=1;d<c.num_train_levels;++d)p/=u,e(g,v,d,p),l[d]=cloneImage(v)},this.getGrayData=function(){return o},this.getBluredImages=function(){return l},this.SetResultToTrainedImage=function(e){e.Set(a,r,s,h)},this.IsEmpty=function(){return!r||!a},this.Empty=function(){r=void 0,a=void 0,l=void 0},this.SetParameters=function(e){for(var t in e)"undefined"!=typeof c[t]&&(c[t]=e[t])},this.GetScaleIncrement=function(){return u}};
=======
var compatibility=function(){var e=0,t=!0,i=window.URL||window.webkitURL||window.mozURL||window.msURL,n=function(t,i){var n=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,i){var n=(new Date).getTime(),r=Math.max(0,16-(n-e)),a=window.setTimeout(function(){t(n+r)},r);return e=n+r,a};return n.call(window,t,i)},r=function(e){var t=window.cancelAnimationFrame||function(e){clearTimeout(e)};return t.call(window,e)},a=function(e,t,i){var n=window.navigator.getUserMedia||window.navigator.mozGetUserMedia||window.navigator.webkitGetUserMedia||window.navigator.msGetUserMedia||function(e,t,i){i()};return n.call(window.navigator,e,t,i)},o=function(){var e=new ArrayBuffer(8),i=new Uint32Array(e);return i[0]=4278190080,t=!0,255===e[0]&&(t=!1),t};return{URL:i,requestAnimationFrame:n,cancelAnimationFrame:r,getUserMedia:a,detectEndian:o,isLittleEndian:t}}();!function(){AM=AM||{};var e=function(){this._listeners={}};e.prototype.AddListener=function(e,t){return"string"==typeof e&&("undefined"==typeof this._listeners[e]&&(this._listeners[e]=[]),-1==this._listeners[e].indexOf(t))?(this._listeners[e].push(t),!0):!1},e.prototype.RemoveListener=function(e,t){if("string"==typeof e){var i=this._listeners[e];if("undefined"!=typeof i){var n=i.indexOf(t);if(-1!=n)return 1!=i.length?i.splice(n,1):delete this._listeners[e],!0}}return!1},e.prototype.Fire=function(e,t){if("string"==typeof e){var i=this._listeners[e];if("undefined"!=typeof i){for(var n=0,r=i.length;r>n;++n)"function"==typeof i[n]&&i[n].apply(this,t);return!0}}return!1},AM.EventManager=e}(),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL;var AM=AM||{};!function(){function e(){function e(){return h||(a&&a.Dispose(),h=!0,a=new t(s),o=a.Load().then(function(e){r=e})),o}function i(){r&&(r.getTracks()[0].stop(),r=void 0),a&&(a.Dispose(),a=void 0),o=Promise.resolve(),h=!1}function n(){return h}var r,a,o,s=document.createElement("video"),h=!1;s.setAttribute("autoplay",!0),s.style.position="absolute",s.style.top="0px",s.style.left="0px",s.style.width="100%",s.style.height="auto",this.domElement=s,i(),this.Start=e,this.Stop=i,this.IsActive=n}function t(e){function t(e){return new Promise(function(t,i){!function n(){h&&i("loader interrupted"),e.readyState===e.HAVE_ENOUGH_DATA?t():window.requestAnimationFrame(n)}()})}function i(i){var n=new Promise(function(e,t){h&&t("loader interrupted");for(var n={video:!0,audio:!1},r=0;r!=i.length;++r){var a=i[r];"video"==a.kind&&"environment"==a.facing&&(n.video={optional:[{sourceId:a.id}]})}navigator.getUserMedia(n,e,t)});return n=n.then(function(i){return e.src=window.URL.createObjectURL(i),t(e).then(function(){return i})})}function n(e){return new Promise(function(e,t){return h&&t("loader interrupted"),MediaStreamTrack.getSources(e)})}function r(e){return Promise.resolve(function(){return h&&reject("loader interrupted"),navigator.mediaDevices.enumerateDevices()})}function a(){return s=!0,new Promise(function(e,t){h&&t("loader interrupted");var a=n();a=a.then(function(t){i(t).then(e)}),a["catch"](function(){r().then(function(t){i(t).then(e)})["catch"](t)})})}function o(){h=!0}var s=!1,h=!1;this.Load=a,this.Dispose=o}AM.FrontCamGrabbing=e}();var AM=AM||{};getGradientGreenRedColor=function(e,t){function i(e){var t=parseInt(e).toString(16);return t.length<2?"0"+t:t}var n=255*e/t,r=255*(t-e)/t;return"#"+i(n)+i(r)+"00"},AM.ImageDebugger=function(){var e,t,n,r,a,o,s,h,c,u,l,d,p,f,m,g,v,E,y,T,w=this,b=new AM.Training,M=document.createElement("canvas"),A=(M.getContext("2d"),44),R=[],x=[],H=new AM.ImageLoader,_=!1,k=!0;drawLargePoint=function(e,t,n,r,a,o){for(i=-1;i<2;++i)ind=4*(r+i)*a+4*n,e.data[ind+0]=t[0],e.data[ind+1]=t[1],e.data[ind+2]=t[2],e.data[ind+4]=t[0],e.data[ind+5]=t[1],e.data[ind+6]=t[2],e.data[ind+7]=t[3],e.data[ind+8]=t[0],e.data[ind+9]=t[1],e.data[ind+10]=t[2],e.data[ind+11]=t[3]},this.DrawCorners=function(t){w.DrawCornerswithContext(t),e.font="30px Arial",e.fillStyle="red",e.textAlign="left";var n="FPS: "+c.fps.toFixed(2)+"  ";for(i=0;i<c.timers.length;++i){var r=c.timers[i];n+=r[0]+": "+r[1].run_time+"ms  "}e.fillText(n,10,m-5-A)},this.DrawCornerswithContext=function(t){var i,n;if(_&&t&&(o=t.screen_corners,c=t.profiles,u=t.image_data,o.length))for(e.fillStyle="red",e.putImageData(u,g-u.width,A),i=0;i<o.length;++i)n=o[i],e.fillRect(Math.round(n.x*d+p-2),Math.round(n.y*d+f-2),4,4),e.fillRect(Math.round(n.x+g-u.width-2),Math.round(n.y+A-2),4,4)},this.DrawCornerswithImageData=function(t){var i,n;if(_&&t&&(o=t.screen_corners,c=t.profiles,u=t.image_data,o.length)){var r=e.getImageData(0,0,g,m);for(i=0;i<o.length;++i){n=o[i];var a=Math.round(n.x*d+p),s=Math.round(n.y*d+f);drawLargePoint(r,[255,0,0,255],a,s,g,m)}for(e.putImageData(r,0,0),e.putImageData(u,g-u.width,A),i=0;i<o.length;++i){n=o[i];var a=Math.round(n.x+g-u.width),s=Math.round(n.y),h=4*s*u.width+4*a;r.data[h+0]=255,r.data[h+1]=0,r.data[h+2]=0,r.data[h+3]=255}e.putImageData(r,0,0)}},this.DebugMatching=function(e,t){_&&e&&t&&(r=e.corners,a=e.trained_corners,s=e.matches,h=e.matches_mask,n=t,e.uuid!=y&&(y=e.uuid,H.GetImageData(t,function(e){T=e,correctTrainingImageOffsets(),displayTrainingImages(!0),drawContour(),drawMatches(),k&&(displayTrainingImages(!1),drawTrainedCorners())},!1)),T&&(correctTrainingImageOffsets(),displayTrainingImages(!0),drawContour(),drawMatches(),k&&(displayTrainingImages(!1),drawTrainedCorners())))},correctTrainingImageOffsets=function(){var e;T.width>T.height?(e=T.width-T.height,v=0,E=-Math.round(e/2)):(e=T.height-T.width,v=-Math.round(e/2),E=0)},drawContour=function(){e.strokeStyle="green",e.lineWidth=5,e.beginPath(),e.moveTo(r[0].x*d+p,r[0].y*d+f),e.lineTo(r[1].x*d+p,r[1].y*d+f),e.lineTo(r[2].x*d+p,r[2].y*d+f),e.lineTo(r[3].x*d+p,r[3].y*d+f),e.lineTo(r[0].x*d+p,r[0].y*d+f),e.stroke()},drawMatches=function(t){"undefined"==typeof t&&(t=!1),e.lineWidth=2;for(var i=0;i<s.length;++i){var n=s[i],r=h.data[i],c=a[n.pattern_lev],u=c[n.pattern_idx],l=o[n.screen_idx];r?(e.fillStyle="blue",e.strokeStyle="blue"):(e.fillStyle="red",e.strokeStyle="red");var m=u.x+v,g=u.y+E;t||(m=m*x[n.pattern_lev]+R[n.pattern_lev],g*=x[n.pattern_lev]),e.fillRect(Math.round(m-2),Math.round(g+A-2),4,4),e.beginPath(),e.moveTo(m,g+A),e.lineTo(l.x*d+p,l.y*d+f),e.stroke(),e.fillRect(Math.round(l.x*d+p-2),Math.round(l.y*d+f-2),4,4)}},jsFeat2ImageData=function(t){for(var i=e.createImageData(t.cols,t.rows),n=t.data.length,r=4*n+3;n--;)i.data[r-=4]=255,i.data[r-1]=i.data[r-2]=i.data[r-3]=t.data[n];return i},displayColor=function(t,i){e.putImageData(T,t,i)},displayTrainingImages=function(t){b.Empty(),b.TrainFull(T);var i=b.getBluredImages(),n=0;R[0]=0,x[0]=1;for(var r=0;r<i.length;++r)originy=A,t||(originy=m-35-A-i[r].rows),e.putImageData(jsFeat2ImageData(i[r]),n,originy),n+=i[r].cols,R[r+1]=R[r]+i[r].cols,x[r+1]=x[r]/b.GetScaleIncrement()},drawTrainedCorners=function(t){"undefined"==typeof t&&(t=50);var i=b.getBluredImages(),n=new AM.TrainedImage(l);b.SetResultToTrainedImage(n);for(var r=0;r<n.GetLevelNbr();++r)for(var a=n.GetCorners(r),o=(n.GetDescriptors(r),m-35-A-i[r].rows),s=0;t>s;++s){var h=a[s];e.fillStyle=getGradientGreenRedColor(t-s,t);var c=h.x+v,u=h.y+E;c=c*x[r]+R[r],u*=x[r],e.fillRect(Math.round(c-2),Math.round(u+o-2),4,4)}},this.UpdateSize=function(e,i){m=e.height,g=e.width;var n=m,r=t.videoWidth/t.videoHeight,a=g/n;if(a>r){var o=Math.round(n*r);d=o/i,p=Math.round(.5*(g-o)),f=0}else{var s=g/r;d=g/i,p=0,f=Math.round(.5*(n-s))}},this.SetData=function(i,n,r){e=i,t=n,_=r||!1},this.SetDebug=function(e){_=e||!1}};var AM=AM||{};AM.ImageLoader=function(){var e=document.createElement("canvas"),t=e.getContext("2d");this.GetImageData=function(i,n,r){var a=new Image;a.onload=function(i,n,r){return function(){if(r){var a=Math.max(i.width,i.height),o=(a-i.width)/2,s=(a-i.height)/2;e.width=a,e.height=a,t.drawImage(i,o,s)}else e.width=i.width,e.height=i.height,t.drawImage(i,0,0,e.width,e.height);var h=t.getImageData(0,0,e.width,e.height);n(h)}}(a,n,r),a.src=i}};var AM=AM||{};AM.JsonLoader=function(){function e(e,t){u=!1,o=void 0,a=void 0,r=void 0,h=void 0,s=void 0,c.progress=0,e&&e(t)}function t(){try{c.json=JSON.parse(h.responseText),e(r)}catch(t){c.json={},e(a,"failed to parse file: "+s)}}function i(t){var i="JsonLoader failed to open file: "+s;console.log(i),e(a,i)}function n(e){c.progress=e.loaded/e.total*100,o&&o()}var r,a,o,s,h,c=this,u=!1;this.json={},this.progress=0,this.IsLoading=function(){return u},this.Load=function(e,c,l,d){u||(u=!0,r=c,a=l,o=d,s=e,h=new XMLHttpRequest,h.onprogress=n,h.open("GET",e,!0),h.onload=t,h.onerror=i,h.send(null))}},AM.LoadJson=function(e){return new Promise(function(t,i){var n=new AM.JsonLoader;n.Load(e,function(){t(n.json)},i)})};var AM=AM||{};AM.LoadingManager=function(){function e(e){for(var t=0,i=e.length;i>t;++t)e[t]()}var t=[],i=[],n=0;this.Start=function(t){t=t||1,n+=t,e(i)},this.End=function(r){r=r||1,n>0&&(n-=r,e(i)),0>=n&&(n=0,e(t),t.length=0,i.length=0)},this.OnEnd=function(e){n>0?t.push(e):e()},this.OnProgress=function(e){n>0?i.push(e):e()},this.IsLoading=function(){return n>0},this.GetRemaining=function(){return n}};var AM=AM||{};!function(){var e=function(){function e(){this.start_time=0,this.stop_time=0,this.run_time=0,this.running=!1}return e.prototype.start=function(){this.start_time=(new Date).getTime(),this.running=!0},e.prototype.stop=function(){this.stop_time=(new Date).getTime(),this.run_time=this.stop_time-this.start_time,this.running=!1},e.prototype.get_runtime=function(){return this.run_time},e.prototype.reset=function(){this.run_time=0},e}(),t=function(){function e(e){this.arr=new Int32Array(e),this.begin=0,this.end=-1,this.num_el=0,this.arr_size=e}return e.prototype.push_back=function(e){this.num_el<this.arr_size?(this.end++,this.arr[this.end]=e,this.num_el++):(this.end=(this.end+1)%this.arr_size,this.begin=(this.begin+1)%this.arr_size,this.arr[this.end]=e)},e.prototype.get=function(e){return this.arr[(this.begin+e)%this.arr_size]},e.prototype.size=function(){return this.num_el},e}(),i=function(){function i(){this.fps=0,this.timers=[],this.frame_timer=new e}var n=0,r=new t(20);return i.prototype.add=function(t){this.timers.push([t,new e])},i.prototype.new_frame=function(){++n;var e=0,t=0|this.timers.length;for(e=0;t>e;++e){var i=this.timers[e][1];i.reset()}if(n>=1){this.frame_timer.stop(),r.push_back(this.frame_timer.get_runtime());var a=r.size(),o=0;for(e=0;a>e;++e)o+=r.get(e);this.fps=a/o*1e3,this.frame_timer.start()}},i.prototype.find_task=function(e){var t=0|this.timers.length,i=0;for(i=0;t>i;++i){var n=this.timers[i];if(n[0]===e)return n}return null},i.prototype.start=function(e){var t=this.find_task(e);t[1].start()},i.prototype.stop=function(e){var t=this.find_task(e);t[1].stop()},i.prototype.log=function(){var e=0|this.timers.length,t=0,i="<strong>FPS: "+this.fps.toFixed(2)+"</strong>";for(t=0;e>t;++t){var n=this.timers[t];i+="<br/>"+n[0]+": "+n[1].get_runtime()+"ms"}return i},i.prototype.log2=function(){var e=0|this.timers.length,t=0,i="FPS: "+this.fps.toFixed(2)+"  ";for(t=0;e>t;++t){var n=this.timers[t];i+=n[0]+": "+n[1].get_runtime()+"ms  "}return i},i.prototype.GetProfiler=function(){return{fps:this.fps,timers:this.timers}},i}();AM.Profiler=i}();var AM=AM||{};AM.DeviceLockScreenOrientation=function(){function e(){window.cordova?(t(),o=!0):s=!1}function t(){for(var e=0,t=h.length;t>e;++e)h[e]();h.length=0}function i(e){s&&(o?e():h.push(e))}function n(){screen.lockOrientation("landscape-primary")}function r(){screen.lockOrientation("portrait-primary")}function a(){screen.unlockOrientation()}var o=!1,s=!0,h=[];document.addEventListener("deviceready",e,!1),this.LockLandscape=function(){i(n)},this.LockPortrait=function(){i(r)},this.Unlock=function(){i(a)}};var AM=AM||{};AM.DeviceOrientationControl=function(e){var t=this;this.object=e,this.object.rotation.reorder("YXZ");var i=!1,n=!1,r=0,a=new this.CoefMethod,o=function(e){i?(a.OnOrientationChange(e),n=!0):i=!0},s=function(){r=window.orientation||0};this.Connect=function(){s(),window.addEventListener("orientationchange",s,!1),window.addEventListener("deviceorientation",o,!1)},this.Disconnect=function(){window.removeEventListener("orientationchange",s,!1),window.removeEventListener("deviceorientation",o,!1),n=!1,i=!1},this.Update=function(){var e=function(){var e=new THREE.Vector3(0,0,1),t=new THREE.Euler,i=new THREE.Quaternion,n=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));return function(r,a,o,s,h){t.set(o,a,-s,"YXZ"),r.setFromEuler(t),r.multiply(n),r.multiply(i.setFromAxisAngle(e,-h))}}();if(n){var i=r?THREE.Math.degToRad(r):0;a.Update(),e(t.object.quaternion,a.alpha,a.beta,a.gamma,i)}}},AM.DeviceOrientationControl.prototype.PowerMethod=function(){function e(e,t,i){var n=AM.DeviceOrientationControl.prototype.Mod2Pi(t-e),r=Math.sign(n),a=Math.abs(n/Math.PI);return a=Math.pow(a,i),AM.DeviceOrientationControl.prototype.Mod2Pi(e+a*Math.PI*r)}var t,i=this,n=2;this.alpha=0,this.beta=0,this.gamma=0,this.OnOrientationChange=function(e){t=e},this.Update=function(){i.alpha=e(i.alpha,THREE.Math.degToRad(t.alpha),n),i.beta=e(i.beta,THREE.Math.degToRad(t.beta),n),i.gamma=e(i.gamma,THREE.Math.degToRad(t.gamma),n)}},AM.DeviceOrientationControl.prototype.CoefMethod=function(){function e(e,t,i){return e+AM.DeviceOrientationControl.prototype.Mod2Pi(t-e)*i}var t=this;this.coef=.2,this.alpha=0,this.beta=0,this.gamma=0;var i=!1;this.OnOrientationChange=function(e){i=e},this.Update=function(){if(i){var n=e(t.alpha,THREE.Math.degToRad(i.alpha),t.coef),r=e(t.beta,THREE.Math.degToRad(i.beta),t.coef),a=e(t.gamma,THREE.Math.degToRad(i.gamma),t.coef);t.alpha=n,t.beta=r,t.gamma=a}}},AM.DeviceOrientationControl.prototype.AverageMethod=function(){var e=this;this.history=[],this.history_max=10,this.alpha=0,this.beta=0,this.gamma=0,this.OnOrientationChange=function(t){e.history.length>e.history_max&&e.history.shift(),e.history.push(t)},this.Update=function(t,i,n){if(0!==e.history.length){for(var r=0,a=e.history.length;a>r;r++)t+=AM.DeviceOrientationControl.prototype.Mod360(e.history[r].alpha),i+=AM.DeviceOrientationControl.prototype.Mod360(e.history[r].beta),n+=AM.DeviceOrientationControl.prototype.Mod360(e.history[r].gamma);t/=e.history.length,i/=e.history.length,n/=e.history.length,e.alpha=THREE.Math.degToRad(t),e.beta=THREE.Math.degToRad(i),e.gamma=THREE.Math.degToRad(n)}}},AM.DeviceOrientationControl.prototype.Mod2Pi=function(){var e=Math.PI,t=2*Math.PI;return function(i){if(i>e){do i-=t;while(i>e)}else if(-e>i)do i+=t;while(-e>i);return i}}(),AM.DeviceOrientationControl.prototype.Mod360=function(e){return e%=360,180>e?e:e-360};var AM=AM||{};AM.GeographicCoordinatesConverter=function(e,t){var i=this,n={latitude:0,longitude:0};this.GetLocalCoordinates=function(e,t){var r=(n.latitude+e)/2,a={x:0,y:0};return a.x=(t-n.longitude)*i.EARTH_RADIUS*Math.cos(r),a.y=(e-n.latitude)*-i.EARTH_RADIUS,a},this.GetLocalCoordinatesFromDegres=function(e,t){return i.GetLocalCoordinates(THREE.Math.degToRad(e),THREE.Math.degToRad(t))},this.SetOrigin=function(e,t){n.latitude=e,n.longitude=t},this.SetOriginFromDegres=function(e,t){n.latitude=THREE.Math.degToRad(e),n.longitude=THREE.Math.degToRad(t)},this.GetOrigin=function(){return n},this.SetOrigin(e||0,t||0)},AM.GeographicCoordinatesConverter.prototype.EARTH_RADIUS=6371e3;var AM=AM||{};AM.GeolocationControl=function(e,t){function i(e){o.copy(h.GetLocalCoordinatesFromDegres(e.coords.latitude,e.coords.longitude)),a=!0}function n(e){console.warn("geolocation failed: "+e.message),window.setTimeout(r.Connect,r.retry_connection_ms)}var r=this,a=!1,o=new THREE.Vector3,s=0,h=t,c=.1;this.object=e,this.interpolation_coefficient=.02,this.retry_connection_ms=1e3,this.Connect=function(){s=navigator.geolocation.watchPosition(i,n)},this.Disconnect=function(){navigator.geolocation.clearWatch(s),a=!1},this.Update=function(){if(a){var e=o.x-r.object.position.x,t=o.z-r.object.position.z,i=e*e+t*t;c*c>i?a=!1:(e*=r.interpolation_coefficient,t*=r.interpolation_coefficient,r.object.position.x+=e,r.object.position.z+=t)}}};var AMTHREE=AMTHREE||{};AMTHREE.ColladaLoader=function(){function e(e,i,n,r,a){var o=0;if(document.implementation&&document.implementation.createDocument){var s=new XMLHttpRequest;s.onreadystatechange=function(){4===s.readyState?0!==s.status&&200!==s.status||(s.response?(Pe=n,t(s.response,void 0,e,i)):a?a():console.error("ColladaLoader: Empty or non-existing file ("+e+")")):3===s.readyState&&r&&(0===o&&(o=s.getResponseHeader("Content-Length")),r({total:o,loaded:s.responseText.length}))},s.open("GET",e,!0),s.send(null)}else alert("Don't know how to parse XML!")}function t(e,t,i,h){if(Oe=h,De=(new DOMParser).parseFromString(e,"text/xml"),t=t||Pe,void 0!==i){var c=i.split("/");c.pop(),Ce=(c.length<1?".":c.join("/"))+"/"}n(),Te(),Fe=r("library_images image",x,"image"),Be=r("library_materials material",X,"material"),Xe=r("library_effects effect",K,"effect"),ze=r("library_geometries geometry",I,"geometry"),Ye=r("library_cameras camera",ne,"camera"),Je=r("library_lights light",ae,"light"),Ve=r("library_controllers controller",H,"controller"),qe=r("library_animations animation",$,"animation"),Ne=r("library_visual_scenes visual_scene",j,"visual_scene"),Se=r("library_kinematics_models kinematics_model",se,"kinematics_model"),Ge=[],Ie=[],He=a(),Le=new THREE.Group;for(var u=0;u<He.nodes.length;u++)Le.add(v(He.nodes[u]));Le.scale.multiplyScalar(Ke),s(),_e=o(),g();var l={scene:Le,morphs:Ge,skins:Ie,animations:ke,kinematics:je,dae:{images:Fe,materials:Be,cameras:Ye,lights:Je,effects:Xe,geometries:ze,controllers:Ve,animations:qe,visualScenes:Ne,visualScene:He,scene:He,kinematicsModels:Se,kinematicsModel:_e}};return t&&t(l),l}function i(e){Ze=e}function n(){var e=De.querySelectorAll("asset"),t=e[0];if(t&&t.childNodes)for(var i=0;i<t.childNodes.length;i++){var n=t.childNodes[i];switch(n.nodeName){case"unit":var r=n.getAttribute("meter");r&&(Ke=parseFloat(r));break;case"up_axis":Qe=n.textContent.charAt(0)}}}function r(e,t,i){for(var n=De.querySelectorAll(e),r={},a=0,o=n.length,s=0;o>s;s++){var h=n[s],c=(new t).parse(h);c.id&&0!==c.id.length||(c.id=i+a++),r[c.id]=c}return r}function a(){var e=De.querySelectorAll("scene instance_visual_scene")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return Ne[t.length>0?t:"visual_scene0"]}return null}function o(){var e=De.querySelectorAll("instance_kinematics_model")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return Se[t.length>0?t:"kinematics_model0"]}return null}function s(){ke=[],h(Le)}function h(e){var t=He.getChildById(e.colladaId,!0),i=null;if(t&&t.keys){i={fps:60,hierarchy:[{node:t,keys:t.keys,sids:t.sids}],node:e,name:"animation_"+e.name,length:0},ke.push(i);for(var n=0,r=t.keys.length;r>n;n++)i.length=Math.max(i.length,t.keys[n].time)}else i={hierarchy:[{keys:[],sids:[]}]};for(var n=0,r=e.children.length;r>n;n++)for(var a=h(e.children[n]),o=0,s=a.hierarchy.length;s>o;o++)i.hierarchy.push({keys:[],sids:[]});return i}function c(){var e,t=1e6,i=-t,n=0;for(var r in qe){var a=qe[r];e=e||a.id;for(var o=0;o<a.sampler.length;o++){var s=a.sampler[o];s.create(),t=Math.min(t,s.startTime),i=Math.max(i,s.endTime),n=Math.max(n,s.input.length)}}return{start:t,end:i,frames:n,ID:e}}function u(e,t){var i=t instanceof C?Ve[t.url]:t;if(!i||!i.morph)return void console.log("could not find morph controller!");for(var n=i.morph,r=0;r<n.targets.length;r++){var a=n.targets[r],o=ze[a];if(o.mesh&&o.mesh.primitives&&o.mesh.primitives.length){var s=o.mesh.primitives[0].geometry;s.vertices.length===e.vertices.length&&e.morphTargets.push({name:"target_1",vertices:s.vertices})}}e.morphTargets.push({name:"target_Z",vertices:e.vertices})}function l(e,t,i,n){if(e.world=e.world||new THREE.Matrix4,e.localworld=e.localworld||new THREE.Matrix4,e.world.copy(e.matrix),e.localworld.copy(e.matrix),e.channels&&e.channels.length){var r=e.channels[0],a=r.sampler.output[i];a instanceof THREE.Matrix4&&(e.world.copy(a),e.localworld.copy(a),0===i&&e.matrix.copy(a))}n&&e.world.multiplyMatrices(n,e.world),t.push(e);for(var o=0;o<e.nodes.length;o++)l(e.nodes[o],t,i,e.world)}function d(e,t){for(var i=0;i<e.length;i++){var n=e[i],r=-1;if("JOINT"==n.type){for(var a=0;a<t.joints.length;a++)if(n.sid===t.joints[a]){r=a;break}if(r>=0){var o=t.invBindMatrices[r];n.invBindMatrix=o,n.skinningMatrix=new THREE.Matrix4,n.skinningMatrix.multiplyMatrices(n.world,o),n.animatrix=new THREE.Matrix4,n.animatrix.copy(n.localworld),n.weights=[];for(var a=0;a<t.weights.length;a++)for(var s=0;s<t.weights[a].length;s++){var h=t.weights[a][s];h.joint===r&&n.weights.push(h)}}else console.warn("ColladaLoader: Could not find joint '"+n.sid+"'."),n.skinningMatrix=new THREE.Matrix4,n.weights=[]}}}function p(e){var t=[],i=function(e,t,n){var r={};r.name=t.sid,r.parent=e,r.matrix=t.matrix;var a=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];r.matrix.decompose(a[0],a[1],a[2]),r.pos=[a[0].x,a[0].y,a[0].z],r.scl=[a[2].x,a[2].y,a[2].z],r.rotq=[a[1].x,a[1].y,a[1].z,a[1].w],n.push(r);for(var o in t.nodes)i(t.sid,t.nodes[o],n)};return i(-1,e,t),t}function f(e,t,i){var n=[];l(t,n,-1),d(n,i.skin);for(var r=new THREE.Vector3,a=[],o=0;o<e.vertices.length;o++)a.push(new THREE.Vector3);for(o=0;o<n.length;o++)if("JOINT"==n[o].type)for(var s=0;s<n[o].weights.length;s++){var h=n[o].weights[s],c=h.index,u=h.weight,p=e.vertices[c],f=a[c];r.x=p.x,r.y=p.y,r.z=p.z,r.applyMatrix4(n[o].skinningMatrix),f.x+=r.x*u,f.y+=r.y*u,f.z+=r.z*u}for(var o=0;o<e.vertices.length;o++)e.vertices[o]=a[o]}function m(e,t,i){var n=Ve[t.url];if(i=void 0!==i?i:40,!n||!n.skin)return void console.log("ColladaLoader: Could not find skin controller.");if(!t.skeleton||!t.skeleton.length)return void console.log("ColladaLoader: Could not find the skeleton for the skin. ");for(var r=c(),a=He.getChildById(t.skeleton[0],!0)||He.getChildBySid(t.skeleton[0],!0),o=p(a),s=n.skin.joints,h=[],u=0;u<s.length;u++)for(var m=0;m<o.length;m++)o[m].name===s[u]&&(h[u]=o[m]);for(var u=0;u<h.length;u++)for(var m=0;m<h.length;m++)h[u].parent===h[m].name&&(h[u].parent=m);var u,m,g;new THREE.Vector3;for(u=0;u<e.vertices.length;u++)e.vertices[u].applyMatrix4(n.skin.bindShapeMatrix);for(var v=[],E=[],y=n.skin.weights,u=0;u<y.length;u++){var T=new THREE.Vector4(y[u][0]?y[u][0].joint:0,y[u][1]?y[u][1].joint:0,y[u][2]?y[u][2].joint:0,y[u][3]?y[u][3].joint:0),g=new THREE.Vector4(y[u][0]?y[u][0].weight:0,y[u][1]?y[u][1].weight:0,y[u][2]?y[u][2].weight:0,y[u][3]?y[u][3].weight:0);v.push(T),E.push(g)}e.skinIndices=v,e.skinWeights=E,e.bones=h;for(var w={name:r.ID,fps:30,length:r.frames/30,hierarchy:[]},m=0;m<h.length;m++)w.hierarchy.push({parent:h[m].parent,name:h[m].name,keys:[]});for(console.log("ColladaLoader:",r.ID+" has "+h.length+" bones."),f(e,a,n),i=0;i<r.frames;i++){var b=[];l(a,b,i),d(b,n.skin);for(var u=0;u<b.length;u++)for(var m=0;m<w.hierarchy.length;m++)if(w.hierarchy[m].name===b[u].sid){var M={};M.time=i/30,M.matrix=b[u].animatrix,0===i&&(b[u].matrix=M.matrix);var A=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];M.matrix.decompose(A[0],A[1],A[2]),M.pos=[A[0].x,A[0].y,A[0].z],M.scl=[A[2].x,A[2].y,A[2].z],M.rot=A[1],w.hierarchy[m].keys.push(M)}e.animation=w}}function g(){if(_e&&0===_e.joints.length)return void(je=void 0);var e={},t=function(t,i){var n=i.getAttribute("id"),r=He.getChildById(n,!0),a=_e.joints[t];Le.traverse(function(i){i.colladaId==n&&(e[t]={node:i,transforms:r.transforms,joint:a,position:a.zeroPosition})})};je={joints:_e&&_e.joints,getJointValue:function(t){var i=e[t];return i?i.position:void console.log("getJointValue: joint "+t+" doesn't exist")},setJointValue:function(t,i){var r=e[t];if(r){var a=r.joint;if(i>a.limits.max||i<a.limits.min)console.log("setJointValue: joint "+t+" value "+i+" outside of limits (min: "+a.limits.min+", max: "+a.limits.max+")");else if(a["static"])console.log("setJointValue: joint "+t+" is static");else{var o=r.node,s=a.axis,h=r.transforms,c=new THREE.Matrix4;for(n=0;n<h.length;n++){var u=h[n];if(u.sid&&-1!==u.sid.indexOf("joint"+t))switch(a.type){case"revolute":c.multiply(l.makeRotationAxis(s,THREE.Math.degToRad(i)));break;case"prismatic":c.multiply(l.makeTranslation(s.x*i,s.y*i,s.z*i));break;default:console.warn("setJointValue: unknown joint type: "+a.type)}else{var l=new THREE.Matrix4;switch(u.type){case"matrix":c.multiply(u.obj);break;case"translate":c.multiply(l.makeTranslation(u.obj.x,u.obj.y,u.obj.z));break;case"rotate":c.multiply(l.makeRotationAxis(u.obj,u.angle))}}}var d=c.elements,p=Array.prototype.slice.call(d),f=[p[0],p[4],p[8],p[12],p[1],p[5],p[9],p[13],p[2],p[6],p[10],p[14],p[3],p[7],p[11],p[15]];o.matrix.set.apply(o.matrix,f),o.matrix.decompose(o.position,o.quaternion,o.scale)}}else console.log("setJointValue: joint "+t+" doesn't exist")}};var i=De.querySelector("scene instance_kinematics_scene");if(i)for(var n=0;n<i.childNodes.length;n++){var r=i.childNodes[n];if(1==r.nodeType)switch(r.nodeName){case"bind_joint_axis":var a=r.getAttribute("target").split("/").pop(),o=r.querySelector("axis param").textContent,s=parseInt(o.split("joint").pop().split(".")[0]),h=De.querySelector('[sid="'+a+'"]');if(h){var c=h.parentElement;t(s,c)}}}}function v(e,t){var i,n,r,a,o=new THREE.Object3D,s=!1;for(r=0;r<e.controllers.length;r++){var h=Ve[e.controllers[r].url];switch(h.type){case"skin":if(ze[h.skin.source]){var c=new G;c.url=h.skin.source,c.instance_material=e.controllers[r].instance_material,e.geometries.push(c),s=!0,i=e.controllers[r]}else if(Ve[h.skin.source]){var l=Ve[h.skin.source];if(n=l,l.morph&&ze[l.morph.source]){var c=new G;c.url=l.morph.source,c.instance_material=e.controllers[r].instance_material,e.geometries.push(c)}}break;case"morph":if(ze[h.morph.source]){var c=new G;c.url=h.morph.source,c.instance_material=e.controllers[r].instance_material,e.geometries.push(c),n=e.controllers[r]}console.log("ColladaLoader: Morph-controller partially supported.")}}var d={};for(r=0;r<e.geometries.length;r++){var p,f=e.geometries[r],g=f.instance_material,E=ze[f.url],y={},T=[],w=0;if(E){if(!E.mesh||!E.mesh.primitives)continue;if(0===o.name.length&&(o.name=E.id),g)for(a=0;a<g.length;a++){var b=g[a],M=Be[b.target],A=M.instance_effect.url,R=Xe[A].shader,x=R.material;if(E.doubleSided){if(!(b.symbol in d)){var H=x.clone();H.side=THREE.DoubleSide,d[b.symbol]=H}x=d[b.symbol]}x.opacity=x.opacity?x.opacity:1,y[b.symbol]=w,T.push(x),p=x,p.name=null===M.name||""===M.name?M.id:M.name,w++}var _,k=p||new THREE.MeshLambertMaterial({color:14540253,side:E.doubleSided?THREE.DoubleSide:THREE.FrontSide}),j=E.mesh.geometry3js;w>1&&(k=new THREE.MultiMaterial(T)),void 0!==i?(m(j,i),j.morphTargets.length>0?(k.morphTargets=!0,k.skinning=!1):(k.morphTargets=!1,k.skinning=!0),_=new THREE.SkinnedMesh(j,k,!1),_.name="skin_"+Ie.length,Ie.push(_)):void 0!==n?(u(j,n),k.morphTargets=!0,_=new THREE.Mesh(j,k),_.name="morph_"+Ge.length,Ge.push(_)):_=j.isLineStrip===!0?new THREE.Line(j):new THREE.Mesh(j,k),o.add(_)}}for(r=0;r<e.cameras.length;r++){var N=e.cameras[r],S=Ye[N.url],C=new THREE.PerspectiveCamera(S.yfov,parseFloat(S.aspect_ratio),parseFloat(S.znear),parseFloat(S.zfar));o.add(C)}for(r=0;r<e.lights.length;r++){var O=null,I=e.lights[r],D=Je[I.url];if(D&&D.technique){var L=D.color.getHex(),P=D.intensity,U=D.distance,F=D.falloff_angle;switch(D.technique){case"directional":O=new THREE.DirectionalLight(L,P,U),O.position.set(0,0,1);break;case"point":O=new THREE.PointLight(L,P,U);break;case"spot":O=new THREE.SpotLight(L,P,U,F),O.position.set(0,0,1);break;case"ambient":O=new THREE.AmbientLight(L)}}O&&o.add(O)}if(o.name=e.name||e.id||"",o.colladaId=e.id||"",o.layer=e.layer||"",o.matrix=e.matrix,o.matrix.decompose(o.position,o.quaternion,o.scale),We.centerGeometry&&o.geometry){var q=o.geometry.center();q.multiply(o.scale),q.applyQuaternion(o.quaternion),o.position.sub(q)}for(r=0;r<e.nodes.length;r++)o.add(v(e.nodes[r],e));return o}function E(e){for(var t=De.querySelectorAll("library_nodes node"),i=0;i<t.length;i++){var n=t[i].attributes.getNamedItem("id");if(n&&n.value===e)return t[i]}}function y(e){var t=[],i=1e6,n=-1e6;for(var r in qe)for(var a=qe[r],o=0;o<a.channel.length;o++){var s=a.channel[o],h=a.sampler[o],r=s.target.split("/")[0];r==e.id&&(h.create(),s.sampler=h,i=Math.min(i,h.startTime),n=Math.max(n,h.endTime),t.push(s))}return t.length&&(e.startTime=i,e.endTime=n),t}function T(e){if(e.channels&&e.channels.length){for(var t=[],i=[],n=0,r=e.channels.length;r>n;n++){var a,o=e.channels[n],s=o.fullSid,h=o.sampler,c=h.input,u=e.getTransformBySid(o.sid);if(o.arrIndices){a=[];for(var l=0,d=o.arrIndices.length;d>l;l++)a[l]=Re(o.arrIndices[l])}else a=xe(o.member);if(u){-1===i.indexOf(s)&&i.push(s);for(var l=0,d=c.length;d>l;l++){var p=c[l],f=h.getData(u.type,l,a),m=w(t,p);if(!m){m=new ie(p);var g=b(t,p);t.splice(-1===g?t.length:g,0,m)}m.addTarget(s,u,a,f)}}else console.log('Could not find transform "'+o.sid+'" in node '+e.id)}for(var n=0;n<i.length;n++)for(var v=i[n],l=0;l<t.length;l++){var m=t[l];m.hasTarget(v)||M(t,m,l,v)}e.keys=t,e.sids=i}}function w(e,t){for(var i=null,n=0,r=e.length;r>n&&null===i;n++){var a=e[n];if(a.time===t)i=a;else if(a.time>t)break}return i}function b(e,t){for(var i=-1,n=0,r=e.length;r>n&&-1===i;n++){var a=e[n];a.time>=t&&(i=n)}return i}function M(e,t,i,n){var r=R(e,n,i?i-1:0),a=A(e,n,i+1);if(r&&a){var o,s=(t.time-r.time)/(a.time-r.time),h=r.getTarget(n),c=a.getTarget(n).data,u=h.data;if("matrix"===h.type)o=u;else if(u.length){o=[];for(var l=0;l<u.length;++l)o[l]=u[l]+(c[l]-u[l])*s}else o=u+(c-u)*s;t.addTarget(n,h.transform,h.member,o)}}function A(e,t,i){for(;i<e.length;i++){var n=e[i];if(n.hasTarget(t))return n}return null}function R(e,t,i){for(i=i>=0?i:i+e.length;i>=0;i--){var n=e[i];if(n.hasTarget(t))return n}return null}function x(){this.id="",this.init_from=""}function H(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function _(){this.method=null,this.source=null,this.targets=null,this.weights=null}function k(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function j(){this.id="",this.name="",this.nodes=[],this.scene=new THREE.Group}function N(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE.Matrix4}function S(){this.sid="",this.type="",this.data=[],this.obj=null}function C(){this.url="",this.skeleton=[],this.instance_material=[]}function O(){this.symbol="",this.target=""}function G(){this.url="",this.instance_material=[]}function I(){this.id="",this.mesh=null}function D(e){this.geometry=e.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function L(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE.Geometry}function P(){L.call(this),this.vcount=[]}function U(){L.call(this),this.vcount=1}function F(){L.call(this),this.vcount=3}function q(){this.source="",this.count=0,this.stride=0,this.params=[]}function V(){this.input={}}function z(){this.semantic="",this.offset=0,this.source="",this.set=0}function B(e){this.id=e,this.type=null}function X(){this.id="",this.name="",this.instance_effect=null}function Y(){this.color=new THREE.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function J(e,t){this.type=e,this.effect=t,this.material=null}function Z(e){this.effect=e,this.init_from=null,this.format=null}function W(e){this.effect=e,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function K(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function Q(){this.url=""}function $(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function ee(e){this.animation=e,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,
this.arrIndices=null,this.member=null}function te(e){this.id="",this.animation=e,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function ie(e){this.targets=[],this.time=e}function ne(){this.id="",this.name="",this.technique=""}function re(){this.url=""}function ae(){this.id="",this.name="",this.technique=""}function oe(){this.url=""}function se(){this.id="",this.name="",this.joints=[],this.links=[]}function he(){this.sid="",this.name="",this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this["static"]=!1,this.zeroPosition=0,this.middlePosition=0}function ce(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function ue(){this.joint="",this.transforms=[],this.links=[]}function le(e){var t=e.getAttribute("id");return void 0!=Ue[t]?Ue[t]:(Ue[t]=new B(t).parse(e),Ue[t])}function de(e){for(var t=me(e),i=[],n=0,r=t.length;r>n;n++)i.push("true"===t[n]||"1"===t[n]);return i}function pe(e){for(var t=me(e),i=[],n=0,r=t.length;r>n;n++)i.push(parseFloat(t[n]));return i}function fe(e){for(var t=me(e),i=[],n=0,r=t.length;r>n;n++)i.push(parseInt(t[n],10));return i}function me(e){return e.length>0?ge(e).split(/\s+/):[]}function ge(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}function ve(e,t,i){return e.hasAttribute(t)?parseInt(e.getAttribute(t),10):i}function Ee(e,t){var i=new Image;i.addEventListener("load",function(e){return function(){e.needsUpdate=!0}}(e)),i.src=t,e.image=i}function ye(e,t){e.doubleSided=!1;var i=t.querySelectorAll("extra double_sided")[0];i&&i&&1===parseInt(i.textContent,10)&&(e.doubleSided=!0)}function Te(){if(We.convertUpAxis!==!0||Qe===We.upAxis)$e=null;else switch(Qe){case"X":$e="Y"===We.upAxis?"XtoY":"XtoZ";break;case"Y":$e="X"===We.upAxis?"YtoX":"YtoZ";break;case"Z":$e="X"===We.upAxis?"ZtoX":"ZtoY"}}function we(e,t){if(We.convertUpAxis===!0&&Qe!==We.upAxis)switch($e){case"XtoY":var i=e[0];e[0]=t*e[1],e[1]=i;break;case"XtoZ":var i=e[2];e[2]=e[1],e[1]=e[0],e[0]=i;break;case"YtoX":var i=e[0];e[0]=e[1],e[1]=t*i;break;case"YtoZ":var i=e[1];e[1]=t*e[2],e[2]=i;break;case"ZtoX":var i=e[0];e[0]=e[1],e[1]=e[2],e[2]=i;break;case"ZtoY":var i=e[1];e[1]=e[2],e[2]=t*i}}function be(e,t){if(We.convertUpAxis!==!0||Qe===We.upAxis)return t;switch(e){case"X":t="XtoY"===$e?-1*t:t;break;case"Y":t="YtoZ"===$e||"YtoX"===$e?-1*t:t;break;case"Z":t="ZtoY"===$e?-1*t:t}return t}function Me(e,t){var i=[e[t],e[t+1],e[t+2]];return we(i,-1),new THREE.Vector3(i[0],i[1],i[2])}function Ae(e){if(We.convertUpAxis){var t=[e[0],e[4],e[8]];we(t,-1),e[0]=t[0],e[4]=t[1],e[8]=t[2],t=[e[1],e[5],e[9]],we(t,-1),e[1]=t[0],e[5]=t[1],e[9]=t[2],t=[e[2],e[6],e[10]],we(t,-1),e[2]=t[0],e[6]=t[1],e[10]=t[2],t=[e[0],e[1],e[2]],we(t,-1),e[0]=t[0],e[1]=t[1],e[2]=t[2],t=[e[4],e[5],e[6]],we(t,-1),e[4]=t[0],e[5]=t[1],e[6]=t[2],t=[e[8],e[9],e[10]],we(t,-1),e[8]=t[0],e[9]=t[1],e[10]=t[2],t=[e[3],e[7],e[11]],we(t,-1),e[3]=t[0],e[7]=t[1],e[11]=t[2]}return(new THREE.Matrix4).set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function Re(e){if(e>-1&&3>e){var t=["X","Y","Z"],i={X:0,Y:1,Z:2};e=xe(t[e]),e=i[e]}return e}function xe(e){if(We.convertUpAxis)switch(e){case"X":switch($e){case"XtoY":case"XtoZ":case"YtoX":e="Y";break;case"ZtoX":e="Z"}break;case"Y":switch($e){case"XtoY":case"YtoX":case"ZtoX":e="X";break;case"XtoZ":case"YtoZ":case"ZtoY":e="Z"}break;case"Z":switch($e){case"XtoZ":e="X";break;case"YtoZ":case"ZtoX":case"ZtoY":e="Y"}}return e}var He,_e,ke,je,Ne,Se,Ce,Oe,Ge,Ie,De=null,Le=null,Pe=null,Ue={},Fe={},qe={},Ve={},ze={},Be={},Xe={},Ye={},Je={},Ze=THREE.SmoothShading,We={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null},Ke=1,Qe="Y",$e=null;return x.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];"init_from"===i.nodeName&&(this.init_from=i.textContent)}return this},H.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.type="none";for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"skin":this.skin=(new k).parse(i),this.type=i.nodeName;break;case"morph":this.morph=(new _).parse(i),this.type=i.nodeName}}return this},_.prototype.parse=function(e){var t,i={},n=[];for(this.method=e.getAttribute("method"),this.source=e.getAttribute("source").replace(/^#/,""),t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"source":var a=(new B).parse(r);i[a.id]=a;break;case"targets":n=this.parseInputs(r);break;default:console.log(r.nodeName)}}for(t=0;t<n.length;t++){var o=n[t],a=i[o.source];switch(o.semantic){case"MORPH_TARGET":this.targets=a.read();break;case"MORPH_WEIGHT":this.weights=a.read()}}return this},_.prototype.parseInputs=function(e){for(var t=[],i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"input":t.push((new z).parse(n))}}return t},k.prototype.parse=function(e){var t,i,n={};this.source=e.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1==a.nodeType)switch(a.nodeName){case"bind_shape_matrix":var o=pe(a.textContent);this.bindShapeMatrix=Ae(o);break;case"source":var s=(new B).parse(a);n[s.id]=s;break;case"joints":t=a;break;case"vertex_weights":i=a;break;default:console.log(a.nodeName)}}return this.parseJoints(t,n),this.parseWeights(i,n),this},k.prototype.parseJoints=function(e,t){for(var i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"input":var r=(new z).parse(n),a=t[r.source];"JOINT"===r.semantic?this.joints=a.read():"INV_BIND_MATRIX"===r.semantic&&(this.invBindMatrices=a.read())}}},k.prototype.parseWeights=function(e,t){for(var i,n,r=[],a=0;a<e.childNodes.length;a++){var o=e.childNodes[a];if(1==o.nodeType)switch(o.nodeName){case"input":r.push((new z).parse(o));break;case"v":i=fe(o.textContent);break;case"vcount":n=fe(o.textContent)}}for(var s=0,a=0;a<n.length;a++){for(var h=n[a],c=[],u=0;h>u;u++){for(var l={},d=0;d<r.length;d++){var p=r[d],f=i[s+p.offset];switch(p.semantic){case"JOINT":l.joint=f;break;case"WEIGHT":l.weight=t[p.source].data[f]}}c.push(l),s+=r.length}for(var u=0;u<c.length;u++)c[u].index=a;this.weights.push(c)}},j.prototype.getChildById=function(e,t){for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildById(e,t);if(n)return n}return null},j.prototype.getChildBySid=function(e,t){for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildBySid(e,t);if(n)return n}return null},j.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.nodes=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"node":this.nodes.push((new N).parse(i))}}return this},N.prototype.getChannelForTransform=function(e){for(var t=0;t<this.channels.length;t++){var i,n,r=this.channels[t],a=r.target.split("/"),o=(a.shift(),a.shift()),s=o.indexOf(".")>=0,h=o.indexOf("(")>=0;if(s)a=o.split("."),o=a.shift(),n=a.shift();else if(h){i=o.split("("),o=i.shift();for(var c=0;c<i.length;c++)i[c]=parseInt(i[c].replace(/\)/,""))}if(o===e)return r.info={sid:o,dotSyntax:s,arrSyntax:h,arrIndices:i},r}return null},N.prototype.getChildById=function(e,t){if(this.id===e)return this;if(t)for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildById(e,t);if(n)return n}return null},N.prototype.getChildBySid=function(e,t){if(this.sid===e)return this;if(t)for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildBySid(e,t);if(n)return n}return null},N.prototype.getTransformBySid=function(e){for(var t=0;t<this.transforms.length;t++)if(this.transforms[t].sid===e)return this.transforms[t];return null},N.prototype.parse=function(e){var t;this.id=e.getAttribute("id"),this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.type=e.getAttribute("type"),this.layer=e.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE.Matrix4;for(var i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"node":this.nodes.push((new N).parse(n));break;case"instance_camera":this.cameras.push((new re).parse(n));break;case"instance_controller":this.controllers.push((new C).parse(n));break;case"instance_geometry":this.geometries.push((new G).parse(n));break;case"instance_light":this.lights.push((new oe).parse(n));break;case"instance_node":t=n.getAttribute("url").replace(/^#/,"");var r=E(t);r&&this.nodes.push((new N).parse(r));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new S).parse(n));break;case"extra":break;default:console.log(n.nodeName)}}return this.channels=y(this),T(this),this.updateMatrix(),this},N.prototype.updateMatrix=function(){this.matrix.identity();for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},S.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=pe(e.textContent),this.convert(),this},S.prototype.convert=function(){switch(this.type){case"matrix":this.obj=Ae(this.data);break;case"rotate":this.angle=THREE.Math.degToRad(this.data[3]);case"translate":we(this.data,-1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":we(this.data,1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},S.prototype.apply=function(){var e=new THREE.Matrix4;return function(t){switch(this.type){case"matrix":t.multiply(this.obj);break;case"translate":t.multiply(e.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":t.multiply(e.makeRotationAxis(this.obj,this.angle));break;case"scale":t.scale(this.obj)}}}(),S.prototype.update=function(e,t){var i=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(t)if(1===t.length)switch(t[0]){case 0:this.obj.n11=e[0],this.obj.n21=e[1],this.obj.n31=e[2],this.obj.n41=e[3];break;case 1:this.obj.n12=e[0],this.obj.n22=e[1],this.obj.n32=e[2],this.obj.n42=e[3];break;case 2:this.obj.n13=e[0],this.obj.n23=e[1],this.obj.n33=e[2],this.obj.n43=e[3];break;case 3:this.obj.n14=e[0],this.obj.n24=e[1],this.obj.n34=e[2],this.obj.n44=e[3]}else if(2===t.length){var n="n"+(t[0]+1)+(t[1]+1);this.obj[n]=e}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(e);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=i[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=i[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;case"ANGLE":this.angle=THREE.Math.degToRad(e);break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2],this.angle=THREE.Math.degToRad(e[3])}}},C.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1===i.nodeType)switch(i.nodeName){case"skeleton":this.skeleton.push(i.textContent.replace(/^#/,""));break;case"bind_material":for(var n=i.querySelectorAll("instance_material"),r=0;r<n.length;r++){var a=n[r];this.instance_material.push((new O).parse(a))}break;case"extra":}}return this},O.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},G.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType&&"bind_material"===i.nodeName){for(var n=i.querySelectorAll("instance_material"),r=0;r<n.length;r++){var a=n[r];this.instance_material.push((new O).parse(a))}break}}return this},I.prototype.parse=function(e){this.id=e.getAttribute("id"),ye(this,e);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"mesh":this.mesh=new D(this).parse(i);break;case"extra":}}return this},D.prototype.parse=function(e){this.primitives=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"source":le(i);break;case"vertices":this.vertices=(new V).parse(i);break;case"linestrips":this.primitives.push((new U).parse(i));break;case"triangles":this.primitives.push((new F).parse(i));break;case"polygons":this.primitives.push((new L).parse(i));break;case"polylist":this.primitives.push((new P).parse(i))}}if(this.geometry3js=new THREE.Geometry,null===this.vertices)return this;for(var n=Ue[this.vertices.input.POSITION.source].data,t=0;t<n.length;t+=3)this.geometry3js.vertices.push(Me(n,t).clone());for(var t=0;t<this.primitives.length;t++){var r=this.primitives[t];r.setVertices(this.vertices),this.handlePrimitive(r,this.geometry3js)}return this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this},D.prototype.handlePrimitive=function(e,t){if(e instanceof U)return void(t.isLineStrip=!0);var i,n,r,a,o,s,h,c=e.p,u=e.inputs,l=0,d=3,p=0,f=[];for(i=0;i<u.length;i++){r=u[i];var m=r.offset+1;switch(p=m>p?m:p,r.semantic){case"TEXCOORD":f.push(r.set)}}for(var g=0;g<c.length;++g)for(var v=c[g],E=0;E<v.length;){var y=[],T=[],w=null,b=[];for(d=e.vcount?e.vcount.length?e.vcount[l++]:e.vcount:v.length/p,i=0;d>i;i++)for(n=0;n<u.length;n++)switch(r=u[n],s=Ue[r.source],a=v[E+i*p+r.offset],h=s.accessor.params.length,o=a*h,r.semantic){case"VERTEX":y.push(a);break;case"NORMAL":T.push(Me(s.data,o));break;case"TEXCOORD":w=w||{},void 0===w[r.set]&&(w[r.set]=[]),w[r.set].push(new THREE.Vector2(s.data[o],s.data[o+1]));break;case"COLOR":b.push((new THREE.Color).setRGB(s.data[o],s.data[o+1],s.data[o+2]))}if(0===T.length)if(r=this.vertices.input.NORMAL){s=Ue[r.source],h=s.accessor.params.length;for(var M=0,A=y.length;A>M;M++)T.push(Me(s.data,y[M]*h))}else t.calcNormals=!0;if(!w&&(w={},r=this.vertices.input.TEXCOORD)){f.push(r.set),s=Ue[r.source],h=s.accessor.params.length;for(var M=0,A=y.length;A>M;M++)o=y[M]*h,void 0===w[r.set]&&(w[r.set]=[]),w[r.set].push(new THREE.Vector2(s.data[o],1-s.data[o+1]))}if(0===b.length&&(r=this.vertices.input.COLOR)){s=Ue[r.source],h=s.accessor.params.length;for(var M=0,A=y.length;A>M;M++)o=y[M]*h,b.push((new THREE.Color).setRGB(s.data[o],s.data[o+1],s.data[o+2]))}var R,x,H=null,_=[];if(3===d)_.push(new THREE.Face3(y[0],y[1],y[2],T,b.length?b:new THREE.Color));else if(4===d)_.push(new THREE.Face3(y[0],y[1],y[3],T.length?[T[0].clone(),T[1].clone(),T[3].clone()]:[],b.length?[b[0],b[1],b[3]]:new THREE.Color)),_.push(new THREE.Face3(y[1],y[2],y[3],T.length?[T[1].clone(),T[2].clone(),T[3].clone()]:[],b.length?[b[1],b[2],b[3]]:new THREE.Color));else if(d>4&&We.subdivideFaces){var k=b.length?b:new THREE.Color;for(n=1;d-1>n;)_.push(new THREE.Face3(y[0],y[n],y[n+1],T.length?[T[0].clone(),T[n++].clone(),T[n].clone()]:[],k))}if(_.length)for(var M=0,A=_.length;A>M;M++)for(H=_[M],H.daeMaterial=e.material,t.faces.push(H),n=0;n<f.length;n++)R=w[f[n]],x=d>4?[R[0],R[M+1],R[M+2]]:4===d?0===M?[R[0],R[1],R[3]]:[R[1].clone(),R[2],R[3].clone()]:[R[0],R[1],R[2]],void 0===t.faceVertexUvs[n]&&(t.faceVertexUvs[n]=[]),t.faceVertexUvs[n].push(x);else console.log("dropped face with vcount "+d+" for geometry with id: "+t.id);E+=p*d}},L.prototype.setVertices=function(e){for(var t=0;t<this.inputs.length;t++)this.inputs[t].source===e.id&&(this.inputs[t].source=e.input.POSITION.source)},L.prototype.parse=function(e){this.material=e.getAttribute("material"),this.count=ve(e,"count",0);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"input":this.inputs.push((new z).parse(e.childNodes[t]));break;case"vcount":this.vcount=fe(i.textContent);break;case"p":this.p.push(fe(i.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},P.prototype=Object.create(L.prototype),P.prototype.constructor=P,U.prototype=Object.create(L.prototype),U.prototype.constructor=U,F.prototype=Object.create(L.prototype),F.prototype.constructor=F,q.prototype.parse=function(e){this.params=[],this.source=e.getAttribute("source"),this.count=ve(e,"count",0),this.stride=ve(e,"stride",0);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if("param"===i.nodeName){var n={};n.name=i.getAttribute("name"),n.type=i.getAttribute("type"),this.params.push(n)}}return this},V.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++)if("input"===e.childNodes[t].nodeName){var i=(new z).parse(e.childNodes[t]);this.input[i.semantic]=i}return this},z.prototype.parse=function(e){return this.semantic=e.getAttribute("semantic"),this.source=e.getAttribute("source").replace(/^#/,""),this.set=ve(e,"set",-1),this.offset=ve(e,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},B.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"bool_array":this.data=de(i.textContent),this.type=i.nodeName;break;case"float_array":this.data=pe(i.textContent),this.type=i.nodeName;break;case"int_array":this.data=fe(i.textContent),this.type=i.nodeName;break;case"IDREF_array":case"Name_array":this.data=me(i.textContent),this.type=i.nodeName;break;case"technique_common":for(var n=0;n<i.childNodes.length;n++)if("accessor"===i.childNodes[n].nodeName){this.accessor=(new q).parse(i.childNodes[n]);break}}}return this},B.prototype.read=function(){var e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var i=0;i<this.data.length;i+=16){var n=this.data.slice(i,i+16),r=Ae(n);e.push(r)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+t.type+".")}return e},X.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++)if("instance_effect"===e.childNodes[t].nodeName){this.instance_effect=(new Q).parse(e.childNodes[t]);break}return this},Y.prototype.isColor=function(){return null===this.texture},Y.prototype.isTexture=function(){return null!=this.texture},Y.prototype.parse=function(e){"transparent"===e.nodeName&&(this.opaque=e.getAttribute("opaque"));for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"color":var n=pe(i.textContent);this.color=new THREE.Color,this.color.setRGB(n[0],n[1],n[2]),this.color.a=n[3];break;case"texture":this.texture=i.getAttribute("texture"),this.texcoord=i.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(i)}}return this},Y.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&"extra"===e.childNodes[1].nodeName&&(e=e.childNodes[1],e.childNodes[1]&&"technique"===e.childNodes[1].nodeName&&(e=e.childNodes[1]));for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[i.nodeName]=parseFloat(i.textContent);break;case"wrapU":case"wrapV":"TRUE"===i.textContent.toUpperCase()?this.texOpts[i.nodeName]=1:this.texOpts[i.nodeName]=parseInt(i.textContent);break;default:this.texOpts[i.nodeName]=i.textContent}}return this},J.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"emission":case"diffuse":case"specular":case"transparent":this[i.nodeName]=(new Y).parse(i);break;case"bump":var n=i.getAttribute("bumptype");n?"heightfield"===n.toLowerCase()?this.bump=(new Y).parse(i):"normalmap"===n.toLowerCase()?this.normal=(new Y).parse(i):(console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+n+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'"),this.bump=(new Y).parse(i)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new Y).parse(i));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var r=i.querySelectorAll("float");r.length>0&&(this[i.nodeName]=parseFloat(r[0].textContent))}}return this.create(),this},J.prototype.create=function(){var e={},t=!1;if(void 0!==this.transparency&&void 0!==this.transparent){var i=(this.transparent,(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency);i>0&&(t=!0,e.transparent=!0,e.opacity=1-i)}var n={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var r in this)switch(r){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var a=this[r];if(a instanceof Y)if(a.isTexture()){var o=a.texture,s=this.effect.sampler[o];if(void 0!==s&&void 0!==s.source){var h=this.effect.surface[s.source];if(void 0!==h){var c=Fe[h.init_from];if(c){var u=c.init_from;u=Oe?Oe+u:Ce+u;var l,d=THREE.Loader.Handlers.get(u);null!==d?l=d.load(u):(l=new THREE.Texture,Ee(l,u)),l.wrapS=a.texOpts.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,l.wrapT=a.texOpts.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,l.offset.x=a.texOpts.offsetU,l.offset.y=a.texOpts.offsetV,l.repeat.x=a.texOpts.repeatU,l.repeat.y=a.texOpts.repeatV,e[n[r]]=l,"emission"===r&&(e.emissive=16777215)}}}}else"diffuse"!==r&&t||("emission"===r?e.emissive=a.color.getHex():e[r]=a.color.getHex());break;case"shininess":e[r]=this[r];break;case"reflectivity":e[r]=this[r],e[r]>0&&(e.envMap=We.defaultEnvMap),e.combine=THREE.MixOperation;break;case"index_of_refraction":e.refractionRatio=this[r],1!==this[r]&&(e.envMap=We.defaultEnvMap);break;case"transparency":}switch(e.shading=Ze,e.side=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide,void 0!==e.diffuse&&(e.color=e.diffuse,delete e.diffuse),this.type){case"constant":void 0!=e.emissive&&(e.color=e.emissive),this.material=new THREE.MeshBasicMaterial(e);break;case"phong":case"blinn":this.material=new THREE.MeshPhongMaterial(e);break;case"lambert":default:this.material=new THREE.MeshLambertMaterial(e)}return this.material},Z.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"init_from":this.init_from=i.textContent;break;case"format":this.format=i.textContent;break;default:console.log("unhandled Surface prop: "+i.nodeName)}}return this},W.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"source":this.source=i.textContent;break;case"minfilter":this.minfilter=i.textContent;break;case"magfilter":this.magfilter=i.textContent;break;case"mipfilter":this.mipfilter=i.textContent;break;case"wrap_s":this.wrap_s=i.textContent;break;case"wrap_t":this.wrap_t=i.textContent;break;default:console.log("unhandled Sampler2D prop: "+i.nodeName)}}return this},K.prototype.create=function(){return null===this.shader?null:void 0},K.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),ye(this,e),this.shader=null;for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(i))}}return this},K.prototype.parseNewparam=function(e){for(var t=e.getAttribute("sid"),i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"surface":this.surface[t]=new Z(this).parse(n);break;case"sampler2D":this.sampler[t]=new W(this).parse(n);break;case"extra":break;default:console.log(n.nodeName)}}},K.prototype.parseProfileCOMMON=function(e){for(var t,i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"profile_COMMON":this.parseProfileCOMMON(n);break;case"technique":t=n;break;case"newparam":this.parseNewparam(n);break;case"image":var r=(new x).parse(n);Fe[r.id]=r;break;case"extra":break;default:console.log(n.nodeName)}}return t},K.prototype.parseTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new J(i.nodeName,this).parse(i);break;case"extra":this.parseExtra(i)}}},K.prototype.parseExtra=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique":this.parseExtraTechnique(i)}}},K.prototype.parseExtraTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"bump":this.shader.parse(e)}}},Q.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},$.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.source={};for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"animation":var n=(new $).parse(i);for(var r in n.source)this.source[r]=n.source[r];for(var a=0;a<n.channel.length;a++)this.channel.push(n.channel[a]),this.sampler.push(n.sampler[a]);break;case"source":var r=(new B).parse(i);this.source[r.id]=r;break;case"sampler":this.sampler.push(new te(this).parse(i));break;case"channel":this.channel.push(new ee(this).parse(i))}}return this},ee.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,""),this.target=e.getAttribute("target");var t=this.target.split("/"),i=(t.shift(),t.shift()),n=i.indexOf(".")>=0,r=i.indexOf("(")>=0;if(n)t=i.split("."),this.sid=t.shift(),this.member=t.shift();else if(r){var a=i.split("(");this.sid=a.shift();for(var o=0;o<a.length;o++)a[o]=parseInt(a[o].replace(/\)/,""));this.arrIndices=a}else this.sid=i;return this.fullSid=i,this.dotSyntax=n,this.arrSyntax=r,this},te.prototype.parse=function(e){this.id=e.getAttribute("id"),this.inputs=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"input":this.inputs.push((new z).parse(i))}}return this},te.prototype.create=function(){for(var e=0;e<this.inputs.length;e++){var t=this.inputs[e],i=this.animation.source[t.source];switch(t.semantic){case"INPUT":this.input=i.read();break;case"OUTPUT":this.output=i.read(),this.strideOut=i.accessor.stride;break;case"INTERPOLATION":this.interpolation=i.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(t.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(var e=0;e<this.input.length;e++)this.startTime=Math.min(this.startTime,this.input[e]),this.endTime=Math.max(this.endTime,this.input[e]);this.duration=this.endTime-this.startTime}},te.prototype.getData=function(e,t,i){var n;if("matrix"===e&&16===this.strideOut)n=this.output[t];else if(this.strideOut>1){n=[],t*=this.strideOut;for(var r=0;r<this.strideOut;++r)n[r]=this.output[t+r];if(3===this.strideOut)switch(e){case"rotate":case"translate":we(n,-1);break;case"scale":we(n,1)}else 4===this.strideOut&&"matrix"===e&&we(n,-1)}else n=this.output[t],i&&"translate"===e&&(n=be(i,n));return n},ie.prototype.addTarget=function(e,t,i,n){this.targets.push({sid:e,member:i,transform:t,data:n})},ie.prototype.apply=function(e){for(var t=0;t<this.targets.length;++t){var i=this.targets[t];e&&i.sid!==e||i.transform.update(i.data,i.member)}},ie.prototype.getTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return this.targets[t];return null},ie.prototype.hasTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return!0;return!1},ie.prototype.interpolate=function(e,t){for(var i=0,n=this.targets.length;n>i;i++){var r,a=this.targets[i],o=e.getTarget(a.sid);if("matrix"!==a.transform.type&&o){var s=(t-this.time)/(e.time-this.time),h=o.data,c=a.data;if(0>s&&(s=0),s>1&&(s=1),c.length){r=[];for(var u=0;u<c.length;++u)r[u]=c[u]+(h[u]-c[u])*s}else r=c+(h-c)*s}else r=a.data;a.transform.update(r,a.member)}},ne.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"optics":this.parseOptics(i)}}return this},ne.prototype.parseOptics=function(e){for(var t=0;t<e.childNodes.length;t++)if("technique_common"===e.childNodes[t].nodeName)for(var i=e.childNodes[t],n=0;n<i.childNodes.length;n++)if(this.technique=i.childNodes[n].nodeName,"perspective"===this.technique)for(var r=i.childNodes[n],a=0;a<r.childNodes.length;a++){var o=r.childNodes[a];switch(o.nodeName){case"yfov":this.yfov=o.textContent;break;case"xfov":this.xfov=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}}else if("orthographic"===this.technique)for(var s=i.childNodes[n],a=0;a<s.childNodes.length;a++){var o=s.childNodes[a];switch(o.nodeName){case"xmag":this.xmag=o.textContent;break;case"ymag":this.ymag=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}}return this},re.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},ae.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique_common":this.parseCommon(i);break;case"technique":this.parseTechnique(i)}}return this},ae.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++)switch(e.childNodes[t].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=e.childNodes[t].nodeName;for(var i=e.childNodes[t],n=0;n<i.childNodes.length;n++){var r=i.childNodes[n];switch(r.nodeName){case"color":var a=pe(r.textContent);this.color=new THREE.Color(0),this.color.setRGB(a[0],a[1],a[2]),this.color.a=a[3];break;case"falloff_angle":this.falloff_angle=parseFloat(r.textContent);break;case"quadratic_attenuation":var o=parseFloat(r.textContent);this.distance=o?Math.sqrt(1/o):0}}}return this},ae.prototype.parseTechnique=function(e){this.profile=e.getAttribute("profile");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"intensity":this.intensity=parseFloat(i.textContent)}}return this},oe.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},se.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.joints=[],this.links=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique_common":this.parseCommon(i)}}return this},se.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(e.childNodes[t].nodeName){case"joint":this.joints.push((new he).parse(i));break;case"link":this.links.push((new ce).parse(i))}}return this},he.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this["static"]=!1,this.zeroPosition=0,this.middlePosition=0;var t=e.querySelector("axis"),i=pe(t.textContent);this.axis=Me(i,0);var n=e.querySelector("limits min")?parseFloat(e.querySelector("limits min").textContent):-360,r=e.querySelector("limits max")?parseFloat(e.querySelector("limits max").textContent):360;this.limits={min:n,max:r};for(var a=["prismatic","revolute"],o=0;o<a.length;o++){var s=a[o],h=e.querySelector(s);h&&(this.type=s)}return this.limits.min>=this.limits.max&&(this["static"]=!0),
this.middlePosition=(this.limits.min+this.limits.max)/2,this},ce.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.transforms=[],this.attachments=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"attachment_full":this.attachments.push((new ue).parse(i));break;case"rotate":case"translate":case"matrix":this.transforms.push((new S).parse(i))}}return this},ue.prototype.parse=function(e){this.joint=e.getAttribute("joint").split("/").pop(),this.links=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"link":this.links.push((new ce).parse(i));break;case"rotate":case"translate":case"matrix":this.transforms.push((new S).parse(i))}}return this},{load:e,parse:t,setPreferredShading:i,applySkin:m,geometries:ze,options:We}};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE&&!function(){var e=new THREE.BoxGeometry(.7,.7,.7);e.uuid="71EB1490-B411-48E3-B187-D4A9B1836ACA",e.name="SELECT_BOX_GEOMETRY";var t=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,depthWrite:!1,depthTest:!1});t.uuid="0DD7A775-4B05-487D-845B-A10A2A224A55",t.name="SELECT_BOX_MATERIAL",t.transparent=!0,t.opacity=0;var i=function(){THREE.Object3D.call(this),this.model_url="",this.model_object=new THREE.Object3D,this.add(this.model_object)};i.prototype=Object.create(THREE.Object3D.prototype),i.prototype.constructor=i,i.prototype.load=function(i,n){var r=this;return new Promise(function(a,o){var s=new AMTHREE.ColladaLoader;s.options.convertUpAxis=!0,s.load(i,n,function(n){var o=new THREE.Box3,s=new THREE.Vector3,h=n.scene,c=new THREE.Mesh(e,t);for(c.add(h),r.model_url=i;0!==r.model_object.children.length;)r.model_object.remove(r.model_object.children[0]);r.model_object.add(c),o.setFromObject(h),o.size(c.scale),r.updateMatrix(),o.center(s),h.scale.divide(c.scale),h.position.sub(s.divide(c.scale)),h.updateMatrix(),AMTHREE.ObjectConvert(r.model_object),a(r)},void 0,o)})},i.prototype.toJSON=function(e){var t={uuid:this.uuid,type:"Collada",name:this.name,url:AMTHREE.GetFilename(this.model_url),matrix:this.matrix.toArray()};"{}"!==JSON.stringify(this.userData)&&(t.userData=this.userData),this.castShadow===!0&&(t.castShadow=!0),this.receiveShadow===!0&&(t.receiveShadow=!0),this.visible===!1&&(t.visible=!1);for(var i=[],n=0;n<this.children.length;++n)this.children[n]!==this.model_object&&i.push(this.children[n].toJSON(e).object);return i.length>0&&(t.children=i),{object:t}},AMTHREE.ColladaObject=i}();var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.GifTexture=function(e){THREE.Texture.call(this),this.minFilter=THREE.NearestMipMapNearestFilter,this.imageElement=document.createElement("img");var t=document.getElementsByTagName("script");t=t[t.length-1],t.parentNode.appendChild(this.imageElement),this.imageElement.width=this.imageElement.naturalWidth,this.imageElement.height=this.imageElement.naturalHeight,e&&this.setGif(e)},AMTHREE.GifTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.GifTexture.prototype.constructor=AMTHREE.GifTexture,AMTHREE.GifTexture.prototype.play=function(){this.anim.play(),this.image=this.gifCanvas},AMTHREE.GifTexture.prototype.update=function(){this.needsUpdate=!0},AMTHREE.GifTexture.prototype.stop=function(){this.anim.move_to(0),this.image=void 0},AMTHREE.GifTexture.prototype.pause=function(){this.anim.pause()},AMTHREE.GifTexture.prototype.setGif=function(e){e.url&&(this.image_ref=e,this.imageElement.src=e.url,this.anim=new SuperGif({gif:this.imageElement,auto_play:!1}),this.anim.load(),this.gifCanvas=this.anim.get_canvas(),this.gifCanvas.style.display="none")},AMTHREE.GifTexture.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,this.image_ref&&(t.image=this.image_ref.uuid),t.animated=!0,this.image_ref.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.GifTexture=function(){console.warn("GifTexture.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Image=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url=t},AMTHREE.Image.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,t.url=AMTHREE.GetFilename(this.url),"object"==typeof e&&(e.images||(e.images={}),e.images[t.uuid]=t),t}):AMTHREE.Image=function(){console.warn("Image.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.ImageTexture=function(e){THREE.Texture.call(this),this.image=new Image,this.image.addEventListener("load",function(e){return function(){e.needsUpdate=!0}}(this)),this.set(e)},AMTHREE.ImageTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.ImageTexture.prototype.constructor=AMTHREE.ImageTexture,AMTHREE.ImageTexture.prototype.set=function(e){this.image_ref=e,this.image.src=e.url},AMTHREE.ImageTexture.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,t.image=this.image_ref.uuid,this.image_ref.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.ImageTexture=function(){console.warn("ImageTexture.js: THREE undefined")};var AMTHREE=AMTHREE||{};!function(){function e(e){return"undefined"!=typeof e&&null!=e}function t(t){t.traverse(function(t){if(e(t.material)&&e(t.material.map)&&e(t.material.map.image)){var i=new AMTHREE.Image(void 0,t.material.map.image.src),n=new AMTHREE.ImageTexture(i);t.material.map=n,t.material.needsUpdate=!0}})}AMTHREE.ObjectConvert=t}();var AMTHREE=AMTHREE||{};!function(){function e(e,t){e=e||{};var i={};return t?i.asset_path=t+"/":i.asset_path="",i.asset_path+=e.asset_path?e.asset_path+"/":"",i.image_path=i.asset_path+(e.image_path?e.image_path:""),i.video_path=i.asset_path+(e.video_path?e.video_path:""),i.model_path=i.asset_path+(e.model_path?e.model_path:""),i.sound_path=i.asset_path+(e.sound_path?e.sound_path:""),i}function t(e,t){var i={};if(e instanceof Array){var n=new THREE.MaterialLoader;n.setTextures(t);for(var r=0,a=e.length;a>r;r++){var o=n.parse(e[r]);i[o.uuid]=o}}else console.log("materials parsing failed: json not an array");return i}function n(e){var t=[];if(e instanceof Array)for(var i=0;i<e.length;i++){var n=THREE.AnimationClip.parse(e[i]);t.push(n)}else console.log("animations parsing failed: json not an array");return t}function r(e,t){var i={};if(e instanceof Array)for(var n=0,r=e.length;r>n;++n){var a=e[n];if(void 0===a.uuid)console.warn('failed to parse sound: no "uuid" specified for sound '+n);else if(void 0===a.url)console.warn('failed to parse sound: no "url" specified for sound '+n);else{var o=new AMTHREE.Sound(a.uuid,t+"/"+a.url);i[a.uuid]=o}}return i}function a(e,t){return new Promise(function(n,r){var a={};return e instanceof Array?Promise.all(e.map(function(e){return new Promise(function(n,r){if(void 0===e.url)r('failed to parse image: no "url" specified for image '+i);else if(void 0===e.uuid)r('failed to parse image: no "uuid" specified for image '+i);else{var o=new AMTHREE.Image(e.uuid,t+"/"+e.url);a[o.uuid]=o,n()}})})).then(n(a),r):void r("images parsing failed: json not an array")})}function o(e,t){var i={};if(e instanceof Array)for(var n=0,r=e.length;r>n;n++){var a=e[n];if(void 0===a.uuid)console.warn('failed to parse video: no "uuid" specified for video '+n);else if(void 0===a.url)console.warn('failed to parse video: no "url" specified for video '+n);else{var o=new AMTHREE.Video(a.uuid,t+"/"+a.url);i[a.uuid]=o}}return i}function s(e){return"number"==typeof e?e:(console.warn("AMTHREE.ObjectLoading: Constant should be in numeric form.",e),THREE[e])}function h(e,t,i){var n={};if("undefined"==typeof SuperGif&&console.warn("AMTHREE.ObjectLoading: SuperGif is undefined"),"undefined"!=typeof e)for(var r=0,a=e.length;a>r;r++){var o=e[r],h=void 0;if(o.uuid||console.warn("failed to parse texture "+r+": no uuid provided"),void 0!==o.image||void 0!==o.video){if(void 0!==o.image){if(void 0===t[o.image]){console.warn("failed to parse texture "+o.uuid+": undefined image",o.image);continue}var c=t[o.image];if(void 0!==o.animated&&o.animated){if("undefined"==typeof SuperGif)continue;h=new AMTHREE.GifTexture(c)}else h=new AMTHREE.ImageTexture(c),h.needsUpdate=!0}else{if(void 0===i[o.video]){console.warn("failed to parse texture "+o.uuid+": undefined video",o.video);continue}var u=i[o.video];h=new AMTHREE.VideoTexture(u,o.width,o.height,o.loop,o.autoplay)}h.uuid=o.uuid,void 0!==o.name&&(h.name=o.name),void 0!==o.mapping&&(h.mapping=s(o.mapping)),void 0!==o.offset&&(h.offset=new THREE.Vector2(o.offset[0],o.offset[1])),void 0!==o.repeat&&(h.repeat=new THREE.Vector2(o.repeat[0],o.repeat[1])),void 0!==o.minFilter?h.minFilter=s(o.minFilter):h.minFilter=THREE.LinearFilter,void 0!==o.magFilter&&(h.magFilter=s(o.magFilter)),void 0!==o.anisotropy&&(h.anisotropy=o.anisotropy),Array.isArray(o.wrap)&&(h.wrapS=s(o.wrap[0]),h.wrapT=s(o.wrap[1])),n[o.uuid]=h}else console.warn('failed to parse texture: no "image" nor "video" specified for '+o.uuid)}return n}function c(e){var t={};if("undefined"!=typeof e)for(var i=new THREE.JSONLoader,n=new THREE.BufferGeometryLoader,r=0,a=e.length;a>r;r++){var o,s=e[r];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":o=new THREE[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"CubeGeometry":o=new THREE.BoxGeometry(s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleBufferGeometry":o=new THREE.CircleBufferGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CircleGeometry":o=new THREE.CircleGeometry(s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":o=new THREE.CylinderGeometry(s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"SphereGeometry":o=new THREE.SphereGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"SphereBufferGeometry":o=new THREE.SphereBufferGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":o=new THREE.DodecahedronGeometry(s.radius,s.detail);break;case"IcosahedronGeometry":o=new THREE.IcosahedronGeometry(s.radius,s.detail);break;case"OctahedronGeometry":o=new THREE.OctahedronGeometry(s.radius,s.detail);break;case"TetrahedronGeometry":o=new THREE.TetrahedronGeometry(s.radius,s.detail);break;case"RingGeometry":o=new THREE.RingGeometry(s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":o=new THREE.TorusGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":o=new THREE.TorusKnotGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.p,s.q,s.heightScale);break;case"BufferGeometry":o=n.parse(s);break;case"Geometry":o=i.parse(s.data,this.texturePath).geometry;break;default:console.warn('AMTHREE.ObjectLoading: Unsupported geometry type "'+s.type+'"');continue}o.uuid=s.uuid,void 0!==s.name&&(o.name=s.name),t[s.uuid]=o}return t}function u(e,t,i){return new Promise(function(n,r){var a=new AM.JsonLoader;a.Load(e,function(){t(a.json,i).then(n,r)},function(){r("failed to load object: "+e)})})}function l(e,t){return u(e,f,t)}function d(e,t){return u(e,m,t)}function p(i,s){var u=e(i.constants,s);return a(i.images||[],u.image_path).then(function(e){var a=r(i.sounds||[],u.sound_path),s=o(i.videos||[],u.video_path),l=h(i.textures||[],e,s),d=n(i.animations||[]),p=t(i.materials||[],l),f=c(i.geometries||[]),m={constants:u,videos:s,images:e,sounds:a,textures:l,animations:d,materials:p,geometries:f};return m})}function f(e,t){return p(e,t).then(function(t){return T(e.object,t.materials,t.geometries,t.sounds,t.constants).then(function(e){return e.animations=t.animations,e})})}function m(e,t){return p(e,t).then(function(t){return w(e.objects,t.materials,t.geometries,t.sounds,t.constants)})}function g(e,t,i,n,r,a){var o=new THREE.Matrix4;if(e.uuid=t.uuid,void 0!==t.name&&(e.name=t.name),void 0!==t.matrix?(o.fromArray(t.matrix),o.decompose(e.position,e.quaternion,e.scale)):(void 0!==t.position&&e.position.fromArray(t.position),void 0!==t.rotation&&e.rotation.fromArray(t.rotation),void 0!==t.scale&&e.scale.fromArray(t.scale),void 0!==t.scaleXYZ&&(e.scale.x*=t.scaleXYZ,e.scale.y*=t.scaleXYZ,e.scale.z*=t.scaleXYZ)),void 0!==t.castShadow&&(e.castShadow=t.castShadow),void 0!==t.receiveShadow&&(e.receiveShadow=t.receiveShadow),void 0!==t.visible&&(e.visible=t.visible),void 0!==t.userData&&(e.userData=t.userData),"LOD"===t.type)for(var s=t.levels,h=0;h<s.length;h++){var c=s[h],u=e.getObjectByProperty("uuid",c.object);void 0!==u&&e.addLevel(u,c.distance)}return void 0!==t.children?w(t.children,i,n,r,a).then(function(t){for(var i=0,n=t.length;n>i;++i)e.add(t[i]);return e}):Promise.resolve(e)}function v(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get geometry: no id provided"):console.warn("failed to get geometry: no such geometry: "+e))}function E(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get material: no id provided"):console.warn("failed to get material: no such material: "+e))}function y(e,t){return void 0!==t[e]?t[e]:void(void 0===e?console.warn("failed to get sound: no id provided"):console.warn("failed to get sound: no such sound: "+e))}function T(e,t,i,n,r){var a,o;switch(e.type){case"OBJ":return new Promise(function(a,s){if(THREE.OBJLoader){var h=new THREE.OBJLoader;o=r.model_path+"/"+e.url,h.load(o,function(o){o.traverse(function(e){e.geometry&&e.geometry.computeBoundingSphere()}),g(o,e,t,i,n,r).then(function(){a(o)},s)})}else s("failed to load "+e.uuid+": THREE.OBJLoader is undefined")});case"Collada":return a=new AMTHREE.ColladaObject,a.load(r.model_path+e.url,r.image_path).then(function(a){return g(a,e,t,i,n,r).then(function(){return a})});case"SoundObject":a=new AMTHREE.SoundObject(y(e.sound,n));break;case"Scene":a=new THREE.Scene;break;case"PerspectiveCamera":a=new THREE.PerspectiveCamera(e.fov,e.aspect,e.near,e.far);break;case"OrthographicCamera":a=new THREE.OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far);break;case"AmbientLight":a=new THREE.AmbientLight(e.color);break;case"DirectionalLight":a=new THREE.DirectionalLight(e.color,e.intensity);break;case"PointLight":a=new THREE.PointLight(e.color,e.intensity,e.distance,e.decay);break;case"SpotLight":a=new THREE.SpotLight(e.color,e.intensity,e.distance,e.angle,e.exponent,e.decay);break;case"HemisphereLight":a=new THREE.HemisphereLight(e.color,e.groundColor,e.intensity);break;case"Mesh":a=new THREE.Mesh(v(e.geometry,i),E(e.material,t));break;case"LOD":a=new THREE.LOD;break;case"Line":a=new THREE.Line(v(e.geometry,i),E(e.material,t),e.mode);break;case"PointCloud":case"Points":a=new THREE.Points(v(e.geometry,i),E(e.material,t));break;case"Sprite":a=new THREE.Sprite(E(e.material,t));break;case"Group":a=new THREE.Group;break;default:a=new THREE.Object3D}return g(a,e,t,i,n,r)}function w(e,t,i,n,r){return e instanceof Array?Promise.all(e.map(function(e){return T(e,t,i,n,r)})):Promise.reject("failed to parse object array: json not an array")}function b(e){var t=new THREE.Box3,i=new THREE.Sphere,n=new THREE.Object3D;n.add(e),t.setFromObject(e),t.getBoundingSphere(i),n.scale.multiplyScalar(1/i.radius),i.center.divideScalar(i.radius),n.position.sub(i.center),n.updateMatrix();var r=new THREE.Object3D;return r.add(n),r}function M(e){e.traverse(function(e){e instanceof THREE.Mesh&&e.geometry&&e.geometry.computeBoundingBox()})}function A(e){e.traverse(function(e){e instanceof THREE.Mesh&&e.geometry&&e.geometry.computeBoundingSphere()})}"undefined"!=typeof THREE&&(AMTHREE.ParseObject=f,AMTHREE.ParseObjectArray=m,AMTHREE.LoadObject=l,AMTHREE.LoadObjectArray=d,AMTHREE.NormalizeObject=b,AMTHREE.ComputeBoundingBox=M,AMTHREE.ComputeBoundingSphere=A)}();var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Sound=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url=t},AMTHREE.Sound.prototype.toJSON=function(e){var t={uuid:this.uuid,url:AMTHREE.GetFilename(this.url)};return e.sounds||(e.sounds={}),e.sounds[this.uuid]||(e.sounds[this.uuid]=t),t}):AMTHREE.Sound=function(){console.warn("Sound.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.SoundObject=function(e){THREE.Object3D.call(this),this.sound=e,this.audio=new Audio,this.audio.loop=!0,this.playing=!1},AMTHREE.SoundObject.prototype=Object.create(THREE.Object3D.prototype),AMTHREE.SoundObject.prototype.constructor=AMTHREE.SoundObject,AMTHREE.SoundObject.prototype.play=function(){this.playing=!0,this.audio.src=this.sound.url,this.audio.play()},AMTHREE.SoundObject.prototype.stop=function(){this.audio.src="",this.playing=!1},AMTHREE.SoundObject.prototype.pause=function(){this.audio.pause(),this.playing=!1},AMTHREE.SoundObject.prototype.setSound=function(e){this.sound=e,this.isPlaying()&&this.play()},AMTHREE.SoundObject.prototype.isPlaying=function(){return this.playing},AMTHREE.SoundObject.prototype.clone=function(){return(new AMTHREE.SoundObject).copy(this)},AMTHREE.SoundObject.prototype.copy=function(e){return this.setSound(e.sound),this},AMTHREE.SoundsCall=function(e,t){e.traverse(function(e){e instanceof AMTHREE.SoundObject&&e[t]&&e[t]()})},AMTHREE.PlaySounds=function(e){AMTHREE.SoundsCall(e,"play")},AMTHREE.PauseSounds=function(e){AMTHREE.SoundsCall(e,"pause")},AMTHREE.StopSounds=function(e){AMTHREE.SoundsCall(e,"stop")},AMTHREE.SoundObject.prototype.toJSON=function(e){var t=THREE.Object3D.prototype.toJSON.call(this,e);return this.sound.toJSON(e),t.object.type="SoundObject",t.object.sound=this.sound.uuid,t}):AMTHREE.SoundObject=function(){console.warn("SoundObject.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.TrackedObjManager=function(e){function t(e,t,i){e.position.lerp(t.position,i),e.quaternion.slerp(t.quaternion,i),e.scale.lerp(t.scale,i)}function i(){a.ForEach(function(e){e.enabled&&t(e.object,e.target,n.lerp_factor)})}e=e||{};var n=this,r=new THREE.Clock(!0),a=new AMTHREE.TrackedObjManager.prototype.Holder,o=i;this.camera=e.camera,this.lerp_factor=e.lerp_factor||.8,this.timeout=e.timeout||6,this.Add=function(e,t,i,n){a.Add(e,t,i,n)},this.Remove=function(e){a.Remove(e)},this.Clear=function(){a.Clear()},this.Update=function(){a.UpdateElapsed(r.getDelta()),a.CheckTimeout(n.timeout),o()},this.Track=function(){var e=new THREE.Matrix4,i=new THREE.Object3D;return function(r,o){if(n.camera){var s=a.Get(r);if(s){var h=s.target;return e.copy(n.camera.matrixWorld),e.multiply(o),s.enabled?(e.decompose(i.position,i.quaternion,i.scale),t(h,i,n.lerp_factor)):(e.decompose(h.position,h.quaternion,h.scale),e.decompose(s.object.position,s.object.quaternion,s.object.scale)),a.Track(r),!0}console.warn("TrackedObjManager: object "+r+" not found")}else console.warn("TrackedObjManager: camera is undefined");return!1}}(),this.TrackCompose=function(){var e=new THREE.Matrix4;return function(t,i,r,a){return e.compose(i,r,a),n.Track(t,e)}}(),this.TrackComposePosit=function(){var e=new THREE.Vector3,t=new THREE.Euler,i=new THREE.Quaternion,r=new THREE.Vector3;return function(a,o,s,h){return e.x=o[0],e.y=o[1],e.z=-o[2],t.x=-Math.asin(-s[1][2]),t.y=-Math.atan2(s[0][2],s[2][2]),t.z=Math.atan2(s[1][0],s[1][1]),r.x=h,r.y=h,r.z=h,i.setFromEuler(t),n.TrackCompose(a,e,i,r)}}(),this.GetObject=function(e){var t=a.get(e);return t?t.object:void 0}},AMTHREE.TrackedObjManager.prototype.Holder=function(){var e=this,t={};this.Add=function(e,i,n,r){t[i]={object:e,target:{position:e.position.clone(),quaternion:e.quaternion.clone(),scale:e.scale.clone()},elapsed:0,on_enable:n,on_disable:r,enabled:!1}},this.Remove=function(e){var i=t[e];i.enabled&&i.on_disable&&i.on_disable(i.object),delete t[e]},this.Clear=function(){for(var i in t)e.Remove(i)},this.Track=function(e){var i=t[e];i.elapsed=0,i.enabled||(i.enabled=!0,i.on_enable&&i.on_enable(i.object))},this.UpdateElapsed=function(e){for(var i in t)t[i].elapsed+=e},this.CheckTimeout=function(e){for(var i in t){var n=t[i];n.enabled&&n.elapsed>e&&(n.on_disable&&n.on_disable(n.object),n.enabled=!1)}},this.ForEach=function(e){for(var i in t)e(t[i])},this.Get=function(e){return t[e]}}):AMTHREE.TrackedObjManager=function(){console.warn("TrackedObjManager.js: THREE undefined")};var AMTHREE=AMTHREE||{};AMTHREE.AnimatedTextureCall=function(e,t){e.traverse(function(e){e.material&&e.material.map&&e.material.map[t]&&e.material.map[t]()})},AMTHREE.PlayAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"play")},AMTHREE.StopAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"stop")},AMTHREE.PauseAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"pause")},AMTHREE.UpdateAnimatedTextures=function(e){AMTHREE.AnimatedTextureCall(e,"update")},AMTHREE.WorldToCanvasPosition=function(e,t,i){var n=new THREE.Vector3;n.copy(e),n.project(t);var r=Math.round((n.x+1)*i.width/2),a=Math.round((-n.y+1)*i.height/2);return{x:r,y:a,z:n.z}},AMTHREE.PlayAnimations=function(e){e.traverse(function(e){if(e instanceof THREE.SkinnedMesh){var t=new THREE.Animation(e,e.geometry.animation);t.play()}})},AMTHREE.GetFilename=function(e){return e.split("/").pop().split("\\").pop()},AMTHREE.IMAGE_PATH="images/",AMTHREE.MODEL_PATH="models/",AMTHREE.VIDEO_PATH="videos/",AMTHREE.SOUND_PATH="sounds/",AMTHREE.ASSET_PATH="assets/";var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.Video=function(e,t){this.uuid=e||THREE.Math.generateUUID(),this.url="string"==typeof t?t:void 0},AMTHREE.Video.prototype.toJSON=function(e){var t={uuid:this.uuid,url:AMTHREE.GetFilename(this.url)};return"object"==typeof e&&(e.videos||(e.videos={}),e.videos[t.uuid]=t),t}):AMTHREE.Video=function(){console.warn("Video.js: THREE undefined")};var AMTHREE=AMTHREE||{};"undefined"!=typeof THREE?(AMTHREE.VideoTexture=function(e,t,i,n,r,a){THREE.Texture.call(this),this.uuid="string"==typeof t?t:THREE.Math.generateUUID(),this.minFilter=THREE.NearestMipMapNearestFilter,this.videoElement=document.createElement("video"),this.needsUpdate=!1,this.set(e,i,n,r,a)},AMTHREE.VideoTexture.prototype=Object.create(THREE.Texture.prototype),AMTHREE.VideoTexture.prototype.constructor=AMTHREE.VideoTexture,AMTHREE.VideoTexture.prototype.play=function(){this.videoElement&&!this.playing&&this.video&&(this.paused||(this.videoElement.src=this.video.url),this.videoElement.setAttribute("crossorigin","anonymous"),this.videoElement.play(),this.image=this.videoElement,this.playing=!0)},AMTHREE.VideoTexture.prototype.update=function(){this.videoElement&&this.videoElement.readyState==this.videoElement.HAVE_ENOUGH_DATA&&(this.needsUpdate=!0)},AMTHREE.VideoTexture.prototype.pause=function(){this.videoElement&&!this.videoElement.paused&&(this.videoElement.pause(),this.playing=!1)},AMTHREE.VideoTexture.prototype.stop=function(){this.videoElement&&(this.pause(),this.videoElement.src="",this.image=void 0,this.needsUpdate=!0)},AMTHREE.VideoTexture.prototype.set=function(e,t,i,n,r){this.stop(),this.video=e,this.videoElement.width="number"==typeof t?t:void 0,this.videoElement.height="number"==typeof i?i:void 0,this.videoElement.autoplay="boolean"==typeof r?r:!1,this.videoElement.loop="boolean"==typeof n?n:!0,this.playing=!1,this.videoElement.autoplay&&this.play()},AMTHREE.VideoTexture.prototype.toJSON=function(e){var t={uuid:this.uuid,video:this.video.uuid,width:this.videoElement.width,height:this.videoElement.height,loop:this.videoElement.loop,autoplay:this.videoElement.autoplay};return this.video.toJSON(e),"object"==typeof e&&(e.textures||(e.textures={}),e.textures[t.uuid]=t),t}):AMTHREE.VideoTexture=function(){console.warn("VideoTexture.js: THREE undefined")};var AM=AM||{};AM.Detection=function(){function e(e,t){var i=e*t;if(i>n.length)for(;--i>=0;)n[i]=new jsfeat.keypoint_t}var t={laplacian_threshold:30,eigen_threshold:25,detection_corners_max:500,border_size:15,fast_threshold:20},i=!1,n=[],r=0,a=new jsfeat.matrix_t(32,t.detection_corners_max,jsfeat.U8_t|jsfeat.C1_t);this.Detect=function(o){e(o.cols,o.rows),r=AM.DetectKeypointsYape06(o,n,t.detection_corners_max,t.laplacian_threshold,t.eigen_threshold,t.border_size),jsfeat.orb.describe(o,n,r,a),i&&console.log("Learn : "+r+" corners")},this.SetParameters=function(e){for(var i in e)"undefined"!=typeof t[i]&&(t[i]=e[i])},this.GetDescriptors=function(){return a},this.GetNumCorners=function(){return r},this.GetCorners=function(){return n}},AM.IcAngle=function(){var e=new Int32Array([15,15,15,15,14,14,14,13,13,12,11,10,9,8,6,3,0]),t=Math.PI/2;return function(i,n,r){var a=15,o=0,s=0,h=i.data,c=i.cols,u=0,l=0,d=r*c+n|0,p=0,f=0,m=0,g=0;for(u=-a;a>=u;++u)s+=u*h[d+u];for(l=1;a>=l;++l){for(p=0,f=e[l],u=-f;f>=u;++u)m=h[d+u+l*c],g=h[d+u-l*c],p+=m-g,s+=u*(m+g);o+=l*p}return AM.DiamondAngle(o,s)*t}}(),AM.DiamondAngle=function(e,t){return e>=0?t>=0?e/(t+e):1-t/(-t+e):0>t?2-e/(-t-e):3+t/(t-e)},AM.DetectKeypointsPostProc=function(e,t,i,n){i>n&&(jsfeat.math.qsort(t,0,i-1,function(e,t){return t.score<e.score}),i=n);for(var r=0;i>r;++r)t[r].angle=AM.IcAngle(e,t[r].x,t[r].y);return i},AM.DetectKeypointsYape06=function(e,t,i,n,r,a){jsfeat.yape06.laplacian_threshold=n,jsfeat.yape06.min_eigen_value_threshold=r;var o=jsfeat.yape06.detect(e,t,a);return o=AM.DetectKeypointsPostProc(e,t,o,i)},AM.DetectKeypointsFast=function(e,t,i,n,r){jsfeat.fast_corners.set_threshold(n);var a=jsfeat.fast_corners.detect(e,t,r||3);return a=AM.DetectKeypointsPostProc(e,t,a,i)};var AM=AM||{};AM.ImageFilter=function(){var e,t={blur_size:3,blur:!0};this.Filter=function(i){var n=i.width,r=i.height;e?e.resize(n,r,jsfeat.U8_t|jsfeat.C1_t):e=new jsfeat.matrix_t(n,r,jsfeat.U8_t|jsfeat.C1_t),jsfeat.imgproc.grayscale(i.data,n,r,e),t.blur&&jsfeat.imgproc.gaussian_blur(e,e,t.blur_size)},this.GetFilteredImage=function(){return e},this.SetParameters=function(e){for(var i in e)"undefined"!=typeof t[i]&&(t[i]=e[i])}};var AM=AM||{};AM.MarkerTracker=function(){var e,t=new AM.Training,i={},n=new AM.ImageFilter,r=new AM.Detection,a=new AM.Matching,o=new AM.Pose,s=!1,h={match_min:8},c=!1,u=new AM.Profiler;u.add("filter"),u.add("detection"),u.add("matching"),u.add("pose"),this.ComputeImage=function(e){u.new_frame(),u.start("filter"),n.Filter(e),u.stop("filter"),u.start("detection"),r.Detect(n.GetFilteredImage()),u.stop("detection")},this.Match=function(){u.start("matching"),s=!1,e=void 0,a.SetScreenDescriptors(r.GetDescriptors());for(var t in i){var n=i[t];if(n.IsActive()){a.Match(n.GetDescriptorsLevels());var l=a.GetNumMatches();if(s=l>=h.match_min,c&&console.log("nbMatches : "+l),s){var d=o.Pose(a.GetMatches(),l,r.GetCorners(),n.GetCornersLevels());if(s=d>=h.match_min,c&&console.log(" goodMatches : "+d),s){e=n;break}}}}return u.stop("matching"),s},this.GetMatchUuid=function(){return e.GetUuid()},this.GetPose=function(){if(s){u.start("pose");var t=o.GetPoseCorners(e.GetWidth(),e.GetHeight());return u.stop("pose"),t}},this.AddMarker=function(e,n){t.Train(e);var r=new AM.TrainedImage(n);t.SetResultToTrainedImage(r),t.Empty(),i[n]=r},this.RemoveMarker=function(e){i[e]&&delete i[e]},this.ActiveMarker=function(e,t){i[e]&&i[e].Active(t)},this.ActiveAllMarkers=function(e){for(var t in i)i[t].Active(e)},this.ClearMarkers=function(){i={}},this.GetScreenCorners=function(){return r.GetCorners()},this.GetNumScreenCorners=function(){return r.GetNumCorners()},this.GetMatches=function(){return a.GetMatches()},this.GetMatchesMask=function(){return o.GetMatchesMask()},this.GetProfiler=function(){return u.GetProfiler()},this.GetTrainedCorners=function(){var t=i[e.GetUuid()];return t.GetCornersLevels()},this.Log=function(){console.log(u.log()+(s?"<br/>match found":""))},this.SetParameters=function(e){for(var i in e)"undefined"!=typeof h[i]&&(h[i]=e[i]);t.SetParameters(e),n.SetParameters(e),r.SetParameters(e),a.SetParameters(e)}};var AM=AM||{};AM.Matching=function(){function e(e){return e-=e>>1&1431655765,e=(858993459&e)+(e>>2&858993459),16843009*(e+(e>>4)&252645135)>>24}function t(e,t){var i=e.rows,n=e.buffer.i32,r=0,h=0;a=[];for(var c=0;i>c;++c){for(var u=256,l=256,d=-1,p=-1,f=0,m=t.length;m>f;++f)for(var g=t[f],v=g.rows,E=g.buffer.i32,y=0,T=0;v>T;++T){for(var w=0,b=0;8>b;++b)w+=s(n[r+b]^E[y+b]);u>w?(l=u,u=w,p=f,d=T):l>w&&(l=w),y+=8}if(u<o.match_threshold){for(;a.length<=h;)a.push(new AM.match_t);a[h].screen_idx=c,a[h].pattern_lev=p,a[h].pattern_idx=d,h++}r+=8}return a.length=h,h}var n,r,a=[],o={match_threshold:48};this.SetScreenDescriptors=function(e){n=e},this.Match=function(e){return r=t(n,e)};var s=(function(){var e=[0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8],t=255;return function(i){var n=e[i&t];return i>>=8,n+=e[i&t],i>>=8,n+=e[i&t],i>>=8,n+=e[i&t]}}(),function(){var t=[];for(i=0;i<65536;++i)t.push(e(i));var n=65535;return function(e){var i=t[e&n];return e>>=16,i+=t[e&n]}}());this.GetMatches=function(){return a},this.GetNumMatches=function(){return r},this.SetParameters=function(e){for(var t in e)"undefined"!=typeof o[t]&&(o[t]=e[t])}},AM.match_t=function(e,t,i,n){this.screen_idx=e||0,this.pattern_lev=t||0,this.pattern_idx=i||0,this.distance=n||0};var AM=AM||{};AM.Pose=function(){function e(e,t,i,n,r,a){var o,s=new jsfeat.motion_model.homography2d,h=4,c=3,u=new jsfeat.ransac_params_t(h,c,.5,.99),l=[],d=[];for(o=0;t>o;++o){var p=e[o],f=r[p.screen_idx],m=a[p.pattern_lev][p.pattern_idx];l[o]={x:m.x,y:m.y},d[o]={x:f.x,y:f.y}}var g=!1;g=jsfeat.motion_estimator.ransac(u,s,l,d,t,i,n,1e3);var v=0;if(g){for(o=0;t>o;++o)n.data[o]&&(l[v].x=l[o].x,l[v].y=l[o].y,d[v].x=d[o].x,d[v].y=d[o].y,v++);s.run(l,d,i,v)}else jsfeat.matmath.identity_3x3(i,1);return v}function t(e,t,i){for(var n=[{x:0,y:0},{x:t,y:0},{x:t,y:i},{x:0,y:i}],r=0,a=0,o=0,s=0;4>s;++s)a=e[0]*n[s].x+e[1]*n[s].y+e[2],o=e[3]*n[s].x+e[4]*n[s].y+e[5],r=e[6]*n[s].x+e[7]*n[s].y+e[8],n[s].x=a/r,n[s].y=o/r;return n}var i=0,n=new jsfeat.matrix_t(3,3,jsfeat.F32C1_t),r=new jsfeat.matrix_t(500,1,jsfeat.U8C1_t);this.Pose=function(t,a,o,s){return i=e(t,a,n,r,o,s)},this.GetGoodCount=function(){return i},this.GetPoseCorners=function(e,i){return t(n.data,e,i)},this.GetMatchesMask=function(){return r}},AM.PosePosit=function(){this.posit=new POS.Posit(10,1),this.pose=void 0},AM.PosePosit.prototype.Set=function(e,t,i,n){t=t||35;for(var r=[],a=0;a<e.length;++a){var o=e[a].x-i/2,s=n/2-e[a].y;r.push({x:o,y:s})}this.pose=this.posit.pose(r)},AM.PosePosit.prototype.SetFocalLength=function(e){this.posit.focalLength=e},AM.PoseThree=function(){this.position=new THREE.Vector3,this.rotation=new THREE.Euler,this.quaternion=new THREE.Quaternion,this.scale=new THREE.Vector3},AM.PoseThree.prototype.Set=function(e,t){t=t||35;var i=e.bestRotation,n=e.bestTranslation;this.scale.x=t,this.scale.y=t,this.scale.z=t,this.rotation.x=-Math.asin(-i[1][2]),this.rotation.y=-Math.atan2(i[0][2],i[2][2]),this.rotation.z=Math.atan2(i[1][0],i[1][1]),this.position.x=n[0],this.position.y=n[1],this.position.z=-n[2],this.quaternion.setFromEuler(this.rotation)};var AM=AM||{};AM.TrainedImage=function(e){var t=!0,i=[],n=[],r=0,a=0,o=e,s=!0;this.GetCorners=function(e){return i[e]},this.GetDescriptors=function(e){return n[e]},this.GetLevelNbr=function(){return Math.min(n.length,i.length)},this.GetCornersLevels=function(){return i},this.GetDescriptorsLevels=function(){return n},this.GetWidth=function(){return r},this.GetHeight=function(){return a},this.Set=function(e,o,s,h){t=!1,i=e,n=o,r=s,a=h},this.IsEmpty=function(){return t},this.Empty=function(){t=!0,i=[],n=[]},this.SetUuid=function(e){o=e},this.GetUuid=function(){return o},this.Active=function(e){s=e===!0},this.IsActive=function(){return s}};var AM=AM||{};AM.Training=function(){
function e(e,n,o,s){var h=a[o],u=r[o];0!==o?(t(e,n,s),jsfeat.imgproc.gaussian_blur(n,n,c.blur_size)):jsfeat.imgproc.gaussian_blur(e,n,c.blur_size);var l=AM.DetectKeypointsYape06(n,h,c.training_corners_max,c.laplacian_threshold,c.eigen_threshold);if(h.length=l,jsfeat.orb.describe(n,h,l,u),0!==o)for(i=0;i<l;++i)h[i].x*=1/s,h[i].y*=1/s;console.log("train "+n.cols+"x"+n.rows+" points: "+l)}function t(e,t,i){if(1>i){var n=Math.round(e.cols*i),r=Math.round(e.rows*i);jsfeat.imgproc.resample(e,t,n,r)}else t.resize(e.cols,e.rows),e.copy_to(t)}function n(e,t){for(var i=0;i<c.num_train_levels;++i){a[i]=[];for(var n=a[i],o=e*t>>i;--o>=0;)n[o]=new jsfeat.keypoint_t(0,0,0,0,-1);r[i]=new jsfeat.matrix_t(32,c.training_corners_max,jsfeat.U8_t|jsfeat.C1_t)}}var r,a,o,s=0,h=0,c={num_train_levels:3,blur_size:3,image_size_max:512,training_corners_max:200,laplacian_threshold:30,eigen_threshold:25},u=Math.sqrt(2),l=[];this.Train=function(i){var o=0,l=1;r=[],a=[];var d=new jsfeat.matrix_t(i.width,i.height,jsfeat.U8_t|jsfeat.C1_t);jsfeat.imgproc.grayscale(i.data,i.width,i.height,d,jsfeat.COLOR_RGBA2GRAY);var p=Math.min(c.image_size_max/i.width,c.image_size_max/i.height),f=new jsfeat.matrix_t(i.width*p,i.height*p,jsfeat.U8_t|jsfeat.C1_t);s=f.cols,h=f.rows,t(d,f,p),n(f.cols,f.rows);var m=new jsfeat.matrix_t(f.cols,f.rows,jsfeat.U8_t|jsfeat.C1_t);for(e(f,m,0,l),o=1;o<c.num_train_levels;++o)l/=u,e(f,m,o,l)},cloneImage=function(e){var t=new jsfeat.matrix_t(e.cols,e.rows,jsfeat.U8_t|jsfeat.C1_t);return e.copy_to(t),t},this.TrainFull=function(i){var d=0,p=1;r=[],a=[],l=[];var f=new jsfeat.matrix_t(i.width,i.height,jsfeat.U8_t|jsfeat.C1_t);jsfeat.imgproc.grayscale(i.data,i.width,i.height,f,jsfeat.COLOR_RGBA2GRAY);var m=Math.min(c.image_size_max/i.width,c.image_size_max/i.height),g=new jsfeat.matrix_t(i.width*m,i.height*m,jsfeat.U8_t|jsfeat.C1_t);s=g.cols,h=g.rows,t(f,g,m),n(g.cols,g.rows);var v=new jsfeat.matrix_t(g.cols,g.rows,jsfeat.U8_t|jsfeat.C1_t);for(e(g,v,0,p),o=g,l[0]=cloneImage(v),d=1;d<c.num_train_levels;++d)p/=u,e(g,v,d,p),l[d]=cloneImage(v)},this.getGrayData=function(){return o},this.getBluredImages=function(){return l},this.SetResultToTrainedImage=function(e){e.Set(a,r,s,h)},this.IsEmpty=function(){return!r||!a},this.Empty=function(){r=void 0,a=void 0,l=void 0},this.SetParameters=function(e){for(var t in e)"undefined"!=typeof c[t]&&(c[t]=e[t])},this.GetScaleIncrement=function(){return u}};
>>>>>>> accelerate debugging using fillRect instead of arc.
>>>>>>> accelerate debugging using fillRect instead of arc.
